<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diya Motors - Mark Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
            box-sizing: border-box;
            position: relative;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
        }
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            z-index: 100;
            font-size: 1.1em;
            font-weight: 600;
            color: #3498db;
        }
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .form-section {
            display: none; /* Hidden by default, shown after GPS check */
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
            vertical-align: middle;
        }
        input[type="radio"] + label {
            display: inline-block;
            margin-right: 20px;
            font-weight: 400;
            color: #333;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            box-sizing: border-box;
            margin-top: 10px;
        }
        button.secondary-btn {
            background-color: #007bff;
        }
        button.secondary-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button.logout-btn {
            background-color: #f44336;
            margin-top: 20px;
        }
        button.logout-btn:hover:not(:disabled) {
            background-color: #d32f2f;
        }
        button:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .error-modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .error-modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-sizing: border-box;
        }
        .error-modal-content h2 {
            color: #dc3545;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .error-modal-content p {
            margin-bottom: 25px;
            line-height: 1.6;
            color: #666;
        }
        .error-modal-content button {
            background-color: #007bff;
            width: auto;
            padding: 10px 20px;
        }
        .error-modal-content button:hover {
            background-color: #0056b3;
        }
        .gps-info {
            margin-top: 20px;
            font-size: 0.9em;
            color: #777;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .gps-info p {
            margin: 5px 0;
        }
        .admin-override {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px dashed #eee;
            color: #888;
            font-size: 0.9em;
        }
        .user-info {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 15px;
            word-break: break-all; /* Ensures long IDs wrap */
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container {
                margin: 20px;
                padding: 25px;
            }
            h1 {
                font-size: 1.6em;
            }
            button {
                padding: 10px 20px;
                font-size: 1em;
            }
            .error-modal-content {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Diya Motors Attendance</h1>

        <div class="user-info">
            <p><strong>User ID:</strong> <span id="userIdDisplay">Loading...</span></p>
        </div>

        <!-- Loader Overlay -->
        <div id="loaderOverlay" class="loader-overlay">
            <div class="loader-spinner"></div>
            <p>Checking your location...</p>
            <p>Please ensure GPS is enabled and allow location access.</p>
        </div>

        <!-- Attendance Form Section -->
        <div id="attendanceFormSection" class="form-section">
            <p id="branchNameDisplay" style="font-weight: 600; margin-bottom: 15px; color: #444;"></p>
            <form id="attendanceForm">
                <div class="form-group">
                    <label>Mark Status:</label><br>
                    <input type="radio" id="morning" name="status" value="Morning" required>
                    <label for="morning">Morning</label>
                    <input type="radio" id="an" name="status" value="AN" required>
                    <label for="an">AN</label>
                </div>
                <button type="submit" id="markAttendanceBtn">Mark Attendance</button>
                <button type="button" id="refreshLocationBtn" class="secondary-btn">Refresh Location</button>
            </form>

            <div class="gps-info">
                <p><strong>Your Location:</strong> <span id="userLat">N/A</span>, <span id="userLng">N/A</span></p>
                <p><strong>Branch Location:</strong> <span id="branchLat">N/A</span>, <span id="branchLng">N/A</span> (Radius: <span id="branchRadius">N/A</span> m)</p>
                <p><strong>Distance to Branch:</strong> <span id="distanceToBranch">N/A</span></p>
            </div>

            <div class="admin-override">
                <p><em>(Admin override option coming soon)</em></p>
            </div>
        </div>
        <button type="button" id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <!-- Error Modal -->
    <div id="errorModalOverlay" class="error-modal-overlay">
        <div class="error-modal-content">
            <h2 id="errorModalTitle">Location Error</h2>
            <p id="errorModalMessage">Could not determine your location or you are outside the allowed radius.</p>
            <button id="errorModalCloseBtn">OK</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Global variables for Firebase instances and user data
        let app;
        let db;
        let auth;
        let userId = null;
        let userBranch = null;
        let branchData = null; // {lat, lng, radius}
        let userLocation = null; // {latitude, longitude}
        let isGpsCheckPassed = false;

        // Mandatorily provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements
        const loaderOverlay = document.getElementById('loaderOverlay');
        const attendanceFormSection = document.getElementById('attendanceFormSection');
        const attendanceForm = document.getElementById('attendanceForm');
        const markAttendanceBtn = document.getElementById('markAttendanceBtn');
        const refreshLocationBtn = document.getElementById('refreshLocationBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorModalOverlay = document.getElementById('errorModalOverlay');
        const errorModalTitle = document.getElementById('errorModalTitle');
        const errorModalMessage = document.getElementById('errorModalMessage');
        const errorModalCloseBtn = document.getElementById('errorModalCloseBtn');
        const branchNameDisplay = document.getElementById('branchNameDisplay');
        const userLatDisplay = document.getElementById('userLat');
        const userLngDisplay = document.getElementById('userLng');
        const branchLatDisplay = document.getElementById('branchLat');
        const branchLngDisplay = document.getElementById('branchLng');
        const branchRadiusDisplay = document.getElementById('branchRadius');
        const distanceToBranchDisplay = document.getElementById('distanceToBranch');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId; // Display user ID
                        console.log("User ID:", userId);
                        // Once user is authenticated, proceed with location check
                        checkLocationAndLoadForm();
                    } else {
                        // If no user is logged in, redirect to login page
                        if (!initialAuthToken) { // Only redirect if not using Canvas's initial token
                            window.location.href = 'login.html'; // Redirect to your login page
                        } else {
                            // For Canvas environment where initialAuthToken might be used for anonymous sign-in,
                            // if it's not provided, we still need to handle the case where a user is not signed in.
                            // If initialAuthToken is present, it will attempt to sign in; if not, it means no user
                            // is authenticated via custom token.
                            userId = null;
                            userIdDisplay.textContent = "Not logged in";
                            console.log("No user is signed in.");
                            showErrorModal("Authentication Required", "Please log in to mark attendance.", true);
                            loaderOverlay.style.display = 'none';
                            attendanceFormSection.style.display = 'none'; // Hide form if not logged in
                            markAttendanceBtn.disabled = true;
                            refreshLocationBtn.disabled = true;
                        }
                    }
                });

                // Attempt to sign in with custom token if available (for Canvas environment)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                }

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                showErrorModal("Initialization Error", "Failed to initialize the application. Please try again later.");
                loaderOverlay.style.display = 'none';
            }
        }

        // --- Geolocation and Distance Calculation ---

        /**
         * Calculates the distance between two points on Earth using the Haversine formula.
         * @param {number} lat1 - Latitude of point 1 (in degrees).
         * @param {number} lon1 - Longitude of point 1 (in degrees).
         * @param {number} lat2 - Latitude of point 2 (in degrees).
         * @param {number} lon2 - Longitude of point 2 (in degrees).
         * @returns {number} Distance in meters.
         */
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres (Earth's radius in meters)
            const φ1 = lat1 * Math.PI / 180; // φ, λ in radians
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // in metres
            return d;
        }

        /**
         * Fetches user's current GPS location.
         * @returns {Promise<{latitude: number, longitude: number}>} Resolves with location data, rejects on error.
         */
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return reject(new Error('Geolocation is not supported by your browser.'));
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("User GPS:", position.coords.latitude, position.coords.longitude);
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    (error) => {
                        let errorMessage = "Unknown error.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Location access denied. Please enable location services.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Location information is unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "The request to get user location timed out.";
                                break;
                        }
                        console.error("Geolocation error:", error.code, errorMessage);
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // --- Main Location Check and UI Update Logic ---

        async function checkLocationAndLoadForm() {
            if (!userId) {
                console.warn("User ID not available yet. Waiting for authentication.");
                return;
            }

            // Show loader during location check
            loaderOverlay.style.display = 'flex';
            attendanceFormSection.style.display = 'none'; // Hide form while checking
            markAttendanceBtn.disabled = true;
            refreshLocationBtn.disabled = true;

            try {
                // 1. Fetch user's branch
                const userBranchDocRef = doc(db, `artifacts/${appId}/users/${userId}/branch/user_branch`);
                const userBranchDocSnap = await getDoc(userBranchDocRef);

                if (!userBranchDocSnap.exists()) {
                    showErrorModal("Configuration Error", "Your branch information is not set. Please contact HR.");
                    return;
                }
                userBranch = userBranchDocSnap.data().name;
                branchNameDisplay.textContent = `Branch: ${userBranch}`;
                console.log("User Branch:", userBranch);

                // 2. Fetch branch GPS data
                const branchDocRef = doc(db, `artifacts/${appId}/public/data/branches/${userBranch}`);
                const branchDocSnap = await getDoc(branchDocRef);

                if (!branchDocSnap.exists()) {
                    showErrorModal("Configuration Error", `GPS data for branch '${userBranch}' not found.`);
                    return;
                }
                branchData = branchDocSnap.data();
                console.log("Branch GPS Data:", branchData);

                // Update branch display info
                branchLatDisplay.textContent = branchData.lat.toFixed(6);
                branchLngDisplay.textContent = branchData.lng.toFixed(6);
                branchRadiusDisplay.textContent = branchData.radius;

                // 3. Get current user GPS
                userLocation = await getUserLocation();
                userLatDisplay.textContent = userLocation.latitude.toFixed(6);
                userLngDisplay.textContent = userLocation.longitude.toFixed(6);

                // 4. Calculate distance
                const distance = haversineDistance(
                    userLocation.latitude, userLocation.longitude,
                    branchData.lat, branchData.lng
                );
                distanceToBranchDisplay.textContent = `${distance.toFixed(2)} m`;
                console.log("Distance to branch:", distance, "m");

                // 5. Validate distance
                if (distance <= branchData.radius) {
                    isGpsCheckPassed = true;
                    attendanceFormSection.style.display = 'block';
                    markAttendanceBtn.disabled = false;
                    refreshLocationBtn.disabled = false;
                } else {
                    isGpsCheckPassed = false;
                    showErrorModal("Location Out of Range",
                        `You are ${distance.toFixed(2)}m away from your branch. Please ensure you are within ${branchData.radius}m.`);
                    markAttendanceBtn.disabled = true;
                    refreshLocationBtn.disabled = false;
                }

            } catch (error) {
                console.error("Error during location check:", error);
                isGpsCheckPassed = false;
                showErrorModal("Location Check Failed", error.message || "An unexpected error occurred during location verification.");
                markAttendanceBtn.disabled = true;
                refreshLocationBtn.disabled = false;
            } finally {
                loaderOverlay.style.display = 'none'; // Always hide loader
            }
        }

        // --- Attendance Submission ---

        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isGpsCheckPassed) {
                showErrorModal("GPS Check Required", "You must be within your branch's radius to mark attendance.");
                return;
            }

            if (!userId) {
                showErrorModal("Authentication Error", "User not authenticated. Please refresh the page.");
                return;
            }

            const status = document.querySelector('input[name="status"]:checked')?.value;
            if (!status) {
                showErrorModal("Selection Required", "Please select either Morning or AN status.");
                return;
            }

            markAttendanceBtn.disabled = true; // Disable button to prevent double submission
            markAttendanceBtn.textContent = "Saving...";
            refreshLocationBtn.disabled = true; // Disable refresh during submission

            try {
                const today = new Date();
                const dateString = today.toISOString().split('T')[0]; //YYYY-MM-DD
                const attendanceDocRef = doc(db, `artifacts/${appId}/users/${userId}/attendance/${dateString}`);

                // Fetch existing attendance to prevent overwriting if both morning and AN are marked
                const attendanceDocSnap = await getDoc(attendanceDocRef);
                let attendanceData = attendanceDocSnap.exists() ? attendanceDocSnap.data() : {};

                if (attendanceData[status]) {
                    showErrorModal("Already Marked", `You have already marked your ${status} attendance for today.`);
                    return;
                }

                // Add or update attendance record
                attendanceData[status] = {
                    timestamp: new Date(),
                    latitude: userLocation.latitude,
                    longitude: userLocation.longitude,
                    branch: userBranch,
                    distance_to_branch_m: haversineDistance(
                        userLocation.latitude, userLocation.longitude,
                        branchData.lat, branchData.lng
                    ).toFixed(2)
                };

                await setDoc(attendanceDocRef, attendanceData, { merge: true });
                console.log("Attendance marked successfully!");
                showErrorModal("Success!", `Your ${status} attendance has been marked successfully.`, false); // Use modal for success too
                attendanceForm.reset(); // Clear form after submission

            } catch (error) {
                console.error("Error marking attendance:", error);
                showErrorModal("Submission Error", "Failed to mark attendance. Please try again.");
            } finally {
                markAttendanceBtn.disabled = false;
                markAttendanceBtn.textContent = "Mark Attendance";
                refreshLocationBtn.disabled = false;
            }
        });

        // --- Event Listeners for new buttons ---
        refreshLocationBtn.addEventListener('click', () => {
            checkLocationAndLoadForm(); // Re-run the location check
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("User signed out.");
                window.location.href = 'login.html'; // Redirect to login page after logout
            } catch (error) {
                console.error("Error signing out:", error);
                showErrorModal("Logout Error", "Failed to log out. Please try again.");
            }
        });

        // --- Modal Functions ---
        function showErrorModal(title, message, isError = true) {
            errorModalTitle.textContent = title;
            errorModalMessage.textContent = message;
            errorModalOverlay.style.display = 'flex';
            if (isError) {
                errorModalTitle.style.color = '#dc3545';
            } else {
                errorModalTitle.style.color = '#28a745'; // Green for success
            }
        }

        errorModalCloseBtn.addEventListener('click', () => {
            errorModalOverlay.style.display = 'none';
        });

        // --- Initial Load ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
