
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AbsentEase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" href="./icon-192.png" type="image/png">
    <meta name="theme-color" content="#000000">




    <style>
        input::placeholder,
textarea::placeholder {
  color: rgba(0, 0, 0, 0.20); /* Light grey placeholder */
  font-style: italic;
}

        :root {
            --primary: #283751;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #0c1e01;
            --danger: #f72585;
            --warning: #f8961e;
            --administrator: #9d4edd;
            --admin: #6dd10f;
            --principal: #ee911f;
            --teacher: #ecf000;
            --table: black;
            --border-radius: 12px;
            --box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --greyed-out: #e9ecef;
            --gradient-primary: linear-gradient(120deg, #bccb08 0%, #2d00b7 100%);
            --gradient-secondary: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            --gradient-success: linear-gradient(135deg, #ce0000 0%, #d2aa17 100%);
            --gradient-danger: linear-gradient(135deg, #f72585 0%, #d81b60 100%);
            --gradient-warning: linear-gradient(135deg, #f8961e 0%, #f57c00 100%);
            --gradient-table: linear-gradient(135deg, #0a332269 0%, #0e434f9e 100%);
            --gradient-viewallbtn: linear-gradient(135deg, #0a332269 0%, #0e434f9e 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            background: linear-gradient(135deg, #f5f7fb 0%, #e6e9ff 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    /* Replace gradient with background image */
    background: url('https://cdn.imgchest.com/files/4jdcv9jpo24.jpg') no-repeat center center;
    background-size: cover; /* Ensures image covers full screen */

    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    transition: opacity 0.5s ease;

}
.overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
}

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #splash-logo {
            width: 140px;
            height: auto;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        

        #message {
            color: rgb(255, 255, 255);
            font-size: 2rem;
            text-align: center;
            margin-top: 20px;
            font-weight: 20;
             font-size: .95rem; /* Increase from 0.85rem */
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2); /* Subtle depth */
        }
        

        #login-screen, #main-screen, #attendance-screen, #admin-panel {
            display: none;
            padding: 30px 0;
            animation: fadeIn 0.5s ease;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            margin-bottom: 30px;
            padding: 15px 25px;
            background: #410a0a00;

            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border-bottom: 1px solid #e9ecef; 
            gap: 15px; 
        }

        #header-logo, #attendance-header-logo, #admin-header-logo {
            width: auto;
            height: auto;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            align-items: flex-start; 
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
            white-space: nowrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .user-name {
            font-weight: 500;
            color: #000000;
        }
        
        .header-actions {
            display: flex;
            gap: 10px; 
            align-items: center;
        }

        .btn {
            padding: 12px 20px;
            font-size: 1rem;
            min-width: 100px;
            border: none;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            text-decoration: none; 
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .btn:hover::before {
            transform: translateX(100%);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn i {
            font-size: 1.1rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a56d4 0%, #3630b5 100%);
        }

        .btn-secondary { 
            background: linear-gradient(99deg, #000000cc 0%, #022885 100%);
            color: white;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
        }
        
        .btn-logout {
            background-color: #f8f9fa; 
            color: var(--dark); 
            border: 1px solid #dee2e6; 
            padding: 8px 15px; 
            font-size: 0.9rem; 
            font-weight: 500;
            min-width: auto; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }

        .btn-logout:hover {
            background-color: #e9ecef; 
            border-color: #ced4da;
            color: var(--dark);
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.07); 
        }
        
        .btn-logout i {
            font-size: 1rem; 
        }


        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #3ab7d8 0%, #2a9cc4 100%);
        }
        
        .btn-administrator {
            background: linear-gradient(135deg, var(--administrator) 0%, #8c3fd8 100%);
            color: white;
        }
        
        .btn-admin { 
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-principal {
            background: var(--gradient-warning);
            color: white;
        }
        
        .btn-teacher { 
            background: var(--gradient-success);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .role-badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .badge-administrator {
            background: linear-gradient(135deg, var(--administrator) 0%, #8c3fd8 100%);
            color: white;
        }
        
        .badge-admin {
            background: var(--gradient-primary);
            color: white;
        }
        
        .badge-principal {
            background: var(--gradient-warning);
            color: white;
        }
        
        .badge-teacher {
            background: var(--gradient-success);
            color: white;
        }

        .control-panel {
            background: #c0c7cd94;
;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label i {
            font-size: 1.1rem;
            color: var(--primary);
        }

        select, input[type="text"], input[type="password"], input[type="date"], input[type="email"] {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid #ddd;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: #f9f9ff;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        select:focus, input[type="text"]:focus, input[type="password"]:focus, 
        input[type="date"]:focus, input[type="email"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            background: white;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .results-container {
            background: #c2e2ff94;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            overflow-x: auto;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 18px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        td .btn-edit-attendance { /* Specific style for edit button in table */
            padding: 5px 10px;
            font-size: 0.8rem;
            min-width: auto;
        }


        th {
            background: var(--gradient-table);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1; /* Ensure header stays above scrolling content */
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .error-message {
            color: var(--danger);
            background: linear-gradient(135deg, rgba(247, 37, 133, 0.1) 0%, rgba(247, 37, 133, 0.05) 100%);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
            border: 1px solid rgba(247, 37, 133, 0.2);
        }

        .success-message {
            color: #2e7d32;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s ease;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            gap: 5px;
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: #555;
            text-align: center; /* Center text in tab */
        }

        .tab:hover {
            background: #f0f2f5;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
            background: rgba(67, 97, 238, 0.05);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .disabled-option {
            background-color: var(--greyed-out);
            color: #6c757d;
            cursor: not-allowed;
        }

        .back-btn { 
            margin-right: 15px; 
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .summary-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .summary-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
            margin: 10px 0;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .summary-card .subtext {
            font-size: 0.95rem;
            color: #6c757d;
        }


        .admin-actions {
            display: flex;
            gap: 10px;
        }

        .admin-actions .btn {
            min-width: auto;
            padding: 8px 15px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title i {
            font-size: 1.3em; /* Make icon slightly larger than text */
        }


        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow form groups to wrap */
        }

        .form-row .form-group {
            flex: 1 1 250px; /* Allow shrinking, basis of 250px, can grow */
            margin-bottom: 0;
        }


        .user-role-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .role-option {
            padding: 10px 20px;
            border-radius: 50px;
            background: #f0f2f5;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .role-option.selected {
            background: var(--gradient-primary);
            color: white;
        }

        .admin-user-list, .activity-log-list, .attendance-management-list { /* Shared style for lists */
            max-height: 400px; /* Or more if needed */
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
        }
        .admin-user-list table, .activity-log-list table, .attendance-management-list table { /* Ensure tables inside these lists are full width */
             width: 100%;
        }


        .admin-user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: var(--transition);
        }
        .admin-user-item:last-child {
            border-bottom: none;
        }


        .admin-user-item:hover {
            background: #f8f9fa;
        }

        .admin-user-info {
            flex: 1;
        }

        .admin-user-email {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .admin-user-role {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .admin-user-class { 
            font-size: 0.85rem;
            color: #888;
            margin-top: 3px;
        }


        .admin-user-actions {
            display: flex;
            gap: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-present {
            background-color: var(--success);
        }

        .status-absent {
            background-color: var(--danger);
        }

        .class-assign-group {
            display: none;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: 1050; /* Ensure modal is on top */
            justify-content: center;
            align-items: center;
            animation: fadeInModal 0.3s ease-out;
        }
        @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }


        .modal-content {
            background: #cbcf0e4a;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px; /* Default max width */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .modal-content.modal-lg { /* For larger modals if needed */
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem; /* Larger close icon */
            cursor: pointer;
            color: #aaa;
            transition: color 0.2s ease;
        }
        .close-modal:hover {
            color: var(--dark);
        }


        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .modern-login-btn {
          background: linear-gradient(135deg, #4cc9f0, #4361ee);
          color: #fff;
          font-weight: 600;
          letter-spacing: 0.5px;
          padding: 14px 28px;
          font-size: 1rem;
          border-radius: 40px;
          transition: all 0.3s ease;
          box-shadow: 0 6px 14px rgba(67, 97, 238, 0.4);
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .modern-login-btn i {
          font-size: 1.2rem;
        }

        .modern-login-btn:hover {
          background: linear-gradient(135deg, #4361ee, #3a56d4);
          transform: translateY(-2px);
          box-shadow: 0 10px 20px rgba(67, 97, 238, 0.5);
        }

        .modern-login-btn:active {
          transform: scale(0.98);
          box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        #global-loader {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255,255,255,0.8);
          display: none; 
          align-items: center;
          justify-content: center;
          z-index: 9999;
        }

        .loader-spinner {
          border: 6px solid #eee;
          border-top: 6px solid var(--primary);
          border-radius: 50%;
          width: 48px;
          height: 48px;
          animation: spin 1s linear infinite;
        }


        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }
            
            .btn { 
                width: 90%;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            header { 
                flex-direction: column !important; 
                align-items: center !important; 
                text-align: center !important; 
                gap: 10px; 
            }
            
            #header-logo, #attendance-header-logo, #admin-header-logo {
                margin-bottom: -9px; 
            }

            .header-content {
                align-items: center !important; 
                width: 100% !important;
                text-align: center;
            }

            .app-title {
                flex-direction: column !important; 
                gap: 20px !important;
                align-items: center !important;
            }

            .user-info {
                flex-direction: column !important; 
                align-items: center !important;
                width: 100% !important;
                margin-top: 8px;
            }

            .header-actions {
                flex-direction: column !important; 
                align-items: center !important;
                width: 100% !important;
                gap: 10px !important;
                margin-left: 0 !important; 
                margin-top: 10px; 
            }
            
            .back-btn { 
                margin-right: 0; 
                margin-bottom: 10px; 
            }


            .form-row {
                flex-direction: column;
                gap: 15px;
            }
             .container {
                padding: 0 10px !important;
            }

            select,
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="date"] {
                width: 100% !important;
                box-sizing: border-box;
            }

            .results-container, .admin-user-list, .activity-log-list, .attendance-management-list {
                overflow-x: auto !important;
                padding: 15px !important; 
            }

            table {
                width: 100% !important;
                min-width: unset !important;
                display: block; 
            }

            th, td {
                padding: 10px 12px !important;
                font-size: 0.9rem; 
                text-align: left;
            }
            .tab {
                text-align: center !important;
                width: 100% !important; /* Make tabs full width on mobile */
                font-size: 0.9rem;
                padding: 10px 15px;
                flex-grow: 1; /* Allow tabs to share space if they wrap */
            }
            .modern-login-btn {
                width: 100% !important;
                justify-content: center !important;
            }
            .admin-user-item {
                flex-direction: column !important;
                align-items: flex-start;
                gap: 10px;
            }

            .admin-user-actions {
                width: 100% !important;
                justify-content: flex-start; 
            }
            .admin-user-actions .btn {
                flex-grow: 1; 
            }

            .modal-content {
                width: 95% !important;
            }
            
            .btn#back-btn,
            .btn#admin-back-btn {
                font-size: 0.9rem !important; 
                padding: 8px 15px !important;
                min-width: auto !important;
            }

            .btn#back-btn i,
            .btn#admin-back-btn i {
                font-size: 1rem !important; 
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem !important; 
            }
            
            #header-logo, #attendance-header-logo, #admin-header-logo {
                width: 99px; 
            }
            
            .btn { 
                font-size: 0.9rem !important;
                padding: 8px 15px !important;
            }

            .card-title {
                font-size: 1.3rem !important;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        .modal-content-lg {
    max-width: 800px !important;
}
.device-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 15px;
}
.device-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.device-info {
    font-size: 0.9rem;
}
.device-actions {
    margin-top: 5px;
}
.site-subtext-wrapper {
    overflow: hidden;
    white-space: nowrap;
    width: 100%;
    box-sizing: border-box;
    padding: 5px 0;
    margin-bottom: 20px;
}

.site-subtext {
    display: inline-block;
    padding-left: 100%;
    animation: scroll-left 15s linear infinite;
    font-size: 0.85rem;
    color: #6c757d;
}

@keyframes scroll-left {
    0% {
        transform: translateX(0%);
    }
    100% {
        transform: translateX(-100%);
    }
}
.whatsapp-all {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background-color: #25D366;
  color: white;
  font-size: 15px;
  font-weight: 500;
  padding: 10px 15px;
  border-radius: 50px;
  box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  z-index: 9999;
  animation: float 2s ease-in-out infinite;
}

.whatsapp-all img {
  width: 24px;
  height: 24px;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}
</style>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/device-detector-js@2.2.10/dist/device-detector.min.js"></script>

</head>
<body>
    <div id="splash-screen">
        <img id="splash-logo" src="https://cdn.imgchest.com/files/yxkcza8jnz7.png" alt="AbsentEase Logo">
        <p id="message"></p>
    </div>
    <div id="global-loader">
      <div class="loader-spinner"></div>
    </div>


    <div id="login-screen">
        <div class="container">
            <div class="control-panel">
                <h2 style="margin-bottom: 25px; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-lock"></i> Login to AbsentEase
                </h2>
                <div class="form-group">
                    <label for="email-input"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="email-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="password-input"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password-input" placeholder="Enter your password">
                </div>
                <div class="btn-group">
                    <button id="login-btn" class="btn btn-primary modern-login-btn">
                      <i class="fas fa-arrow-right-to-bracket"></i>
                      <span>Login</span>
                    </button>
                </div>
                <div id="login-error" class="error-message"></div>
            </div>
        </div>
    </div>

    <div id="main-screen">
        <div class="container">
            <header>
                <img id="header-logo" src="https://cdn.imgchest.com/files/7mmc9jrkvv7.png" alt="Logo">
                <div class="header-content">
                    <div class="app-title">
                        <h1>  </h1>
                        <span id="user-role-badge" class="role-badge badge-teacher">Teacher</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="user-display-name">John Doe</span></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="admin-panel-btn" class="btn btn-administrator" style="display: none;">
                        <i class="fas fa-cog"></i> Admin
                    </button>
                    <button id="attendance-btn" class="btn btn-secondary"> 
                        <i class="fas fa-history"></i> Attendance
                    </button>
                    <button id="logout-btn" class="btn btn-logout"> 
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>
            


            <div class="control-panel">
                <div class="error-message" id="error-message"></div>
                <div class="success-message" id="success-message"></div>
                
                <div class="form-group">
                    <label for="class-selector"><i class="fas fa-users"></i> Select Class</label>
                    <select id="class-selector">
                        <!-- Options loaded by JS -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="roll-input"><i class="fas fa-id-card"></i> Enter Roll Numbers</label>
                    <input type="text" id="roll-input" placeholder="Example: 1, 5, 7 or 1 5 7">
                </div>

                <div class="btn-group">
                    <button id="search-btn" class="btn btn-primary">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <button id="view-all-btn" class="btn btn-secondary">
                        <i class="fas fa-list"></i> View All
                    </button>
                    <button id="share-btn" class="btn btn-success" style="display: none;">
                        <i class="fas fa-share-alt"></i> Save & Share
                    </button>
                    <!-- 🛠️ Correction Panel -->
<div id="correction-ui" style="display: none; margin-top: 30px;">
  <h3><i class="fas fa-tools"></i> Correction Panel (within 5 Hours)</h3>
  <input type="text" id="corrected-rolls" placeholder="Enter roll numbers to add/remove (e.g. 2, 7, 15)">
  <div class="btn-group" style="margin-top: 10px;">
    <button id="add-rolls-btn" class="btn btn-success"><i class="fas fa-plus"></i> Add</button>
    <button id="remove-rolls-btn" class="btn btn-danger"><i class="fas fa-minus"></i> Remove</button>
  </div>
</div>


                </div>
            </div>
<div class="site-subtext-wrapper">
    <div class="site-subtext">"Built with Passion🔥 by Karthik, Devanandan, Aromal, Sreehari MS & Abhinav P – Team AbsentEase"</div>
</div>

            <div class="results-container">
                <table>
                    <thead>
                        <tr>
                            <th>Roll No.</th>
                            <th>Student Name</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="attendance-screen">
        <div class="container">
            <header>
<button id="attendance-logout-btn" class="btn btn-logout"> 
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                <img id="attendance-header-logo" src="https://cdn.imgchest.com/files/7mmc9jrkvv7.png" alt="Logo">
                <div class="header-content">
                    <div class="app-title">
                        <h1>Attendance Records</h1>
                        <span id="attendance-role-badge" class="role-badge badge-teacher">Teacher</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="attendance-user-name">John Doe</span></span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="admin-panel-btn2" class="btn btn-administrator" style="display: none;">
                        <i class="fas fa-cog"></i> Admin
                    </button>
                    
                <button id="back-btn" class="btn btn-secondary back-btn"> 
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                </div>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="class">Class Attendance</div>
                <div class="tab" data-tab="individual">Individual Attendance</div>
            </div>

            <div class="tab-content active" id="class-tab">
                <div class="control-panel">
                    <div id="attendance-error" class="error-message"></div>
                    <div id="attendance-success" class="success-message"></div>
                    
                    <div class="form-group">
                        <label for="attendance-class-selector"><i class="fas fa-users"></i> Select Class</label>
                        <select id="attendance-class-selector">
                           <!-- Options loaded by JS -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="date-selector"><i class="fas fa-calendar"></i> Select Date</label>
                        <input type="date" id="date-selector">
                    </div>
                    
                    <div class="btn-group">
                        <button id="load-attendance-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Attendance
                        </button>
                        
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Total Students</h3>
                        <div class="value" id="total-students">0</div>
                        <div class="subtext">in class</div>
                    </div>
                    <div class="summary-card">
                        <h3>Absent Today</h3>
                        <div class="value" id="absent-today">0</div>
                        <div class="subtext">students</div>
                    </div>
                    <div class="summary-card">
                        <h3>Attendance Rate</h3>
                        <div class="value" id="attendance-rate">0%</div>
                        <div class="subtext">for this class</div>
                    </div>
                </div>
                <div class="btn-group center-buttons" style="margin-bottom: 20px;">
    <button id="download-class-attendance-pdf" class="btn btn-success">
        <i class="fas fa-file-pdf"></i> Download PDF
    </button>
</div>

                <div class="results-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Roll No.</th>
                                <th>Student Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body">
                            <tr><td colspan="3" style="text-align: center;">Select a class and date to view attendance</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="individual-tab">
                <div class="control-panel">
                    <div id="individual-error" class="error-message"></div>
                    <div id="individual-success" class="success-message"></div>
                    
                    <div class="form-group">
                        <label for="student-class-selector"><i class="fas fa-users"></i> Select Class</label>
                        <select id="student-class-selector">
                           <!-- Options loaded by JS -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="student-roll-input"><i class="fas fa-id-card"></i> Enter Roll Number</label>
                        <input type="text" id="student-roll-input" placeholder="Enter student roll number">
                    </div>
                    
                    <div class="btn-group">
                        <button id="load-student-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Student Records
                        </button>
                    </div>
                </div>
               <div class="btn-group center-buttons" style="margin-bottom: 20px;">
    <button id="download-individual-attendance-pdf" class="btn btn-success">
        <i class="fas fa-file-pdf"></i> Download PDF
    </button>
</div>

                <div class="results-container">
                    <h3 style="margin-bottom: 15px;">Attendance History for <span id="student-name-display">-</span></h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="student-attendance-body">
                            <tr><td colspan="2" style="text-align: center;">Select a class and student to view records</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <div class="container">
            <header>
                <button id="admin-logout-btn" class="btn btn-logout"> 
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                <img id="admin-header-logo" src="https://cdn.imgchest.com/files/7mmc9jrkvv7.png" alt="Logo">
                <div class="header-content">
                    <div class="app-title">
                        <h1>Admin Panel</h1>
                        <span id="admin-role-badge" class="role-badge badge-administrator">Administrator</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name"><i class="fas fa-user"></i> <span id="admin-user-name">Administrator</span></span>
                    </div>
                </div>
                <div class="header-actions">
                    
                    <button id="admin-back-btn" class="btn btn-secondary back-btn"> 
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                    
                </div>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="users"><i class="fas fa-users-cog"></i> User Management</div>
                <div class="tab" data-tab="attendance-mgmt"><i class="fas fa-calendar-check"></i> Attendance Management</div>
                <div class="tab" data-tab="activity-logs"><i class="fas fa-history"></i> Activity Logs</div>
                <div class="tab" data-tab="settings"><i class="fas fa-cogs"></i> System Settings</div>
            </div>

            <!-- User Management Tab -->
            <div class="tab-content active" id="users-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-user-plus"></i> Add New User</h2>
                    <div id="admin-user-error" class="error-message"></div> <!-- Specific error for user add -->
                    <div id="admin-user-success" class="success-message"></div> <!-- Specific success for user add -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-user-email"><i class="fas fa-envelope"></i> Email Address</label>
                            <input type="email" id="new-user-email" placeholder="Enter user email">
                        </div>
                        <div class="form-group">
                            <label for="new-user-password"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="new-user-password" placeholder="Set a password">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-user-name"><i class="fas fa-user"></i> Full Name</label>
                            <input type="text" id="new-user-name" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-user-tag"></i> User Role</label>
                            <div class="user-role-select">
                                <div class="role-option" data-role="teacher">Teacher</div>
                                <div class="role-option" data-role="admin">Admin</div>
                                <div class="role-option" data-role="principal">Principal</div>
                                <div class="role-option" data-role="administrator">Administrator</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group class-assign-group" id="class-assign-group">
                        <label for="new-user-class"><i class="fas fa-chalkboard-teacher"></i> Assign Class (for Teachers)</label>
                        <select id="new-user-class">
                           <!-- Options loaded by JS -->
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="add-user-btn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-users"></i> Manage Users</h2>
                    <div class="admin-user-list" id="user-list-table-container">
                        <!-- User table will be loaded here by JS -->
                         <table><thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Class</th><th>Actions</th></tr></thead><tbody id="user-list-tbody"></tbody></table>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="devices-tab">
</div>


            <!-- Attendance Management Tab -->
            <div class="tab-content" id="attendance-mgmt-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Manage Attendance Records</h2>
                    <div id="mgmt-attendance-error" class="error-message"></div>
                    <div id="mgmt-attendance-success" class="success-message"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mgmt-att-start-date"><i class="fas fa-calendar-day"></i> Start Date</label>
                            <input type="date" id="mgmt-att-start-date">
                        </div>
                        <div class="form-group">
                            <label for="mgmt-att-end-date"><i class="fas fa-calendar-day"></i> End Date</label>
                            <input type="date" id="mgmt-att-end-date">
                        </div>
                        <div class="form-group">
                            <label for="mgmt-att-class-selector"><i class="fas fa-users"></i> Class</label>
                            <select id="mgmt-att-class-selector">
                                <!-- Options loaded by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="load-mgmt-attendance-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Records
                        </button>
                    </div>
                </div>
                <div class="card">
                     <h3 class="card-title" style="font-size: 1.2rem; margin-bottom: 15px;"><i class="fas fa-clipboard-list"></i> Attendance Data</h3>
                    <div class="results-container attendance-management-list">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Roll No.</th>
                                    <th>Student Name</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="mgmt-attendance-table-body">
                                <tr><td colspan="6" style="text-align:center;">Use filters to load attendance records.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="card-title"><i class="fas fa-cog"></i> Attendance Settings</h2>
                     <div id="attendance-settings-error" class="error-message"></div>
                     <div id="attendance-settings-success" class="success-message"></div>
                    <div class="form-group">
                        <label for="attendance-start-date-setting"><i class="fas fa-calendar-alt"></i> Attendance Data Starting Date</label>
                        <input type="date" id="attendance-start-date-setting">
                        <small>This date can be used as a global reference for data queries or retention policies (currently informational).</small>
                    </div>
                    <div class="btn-group">
                        <button id="save-attendance-settings-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Setting
                        </button>
                    </div>
                </div>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-content" id="activity-logs-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-stream"></i> View Activity Logs</h2>
                    <div id="activity-log-error" class="error-message"></div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="log-start-date"><i class="fas fa-calendar-day"></i> Start Date</label>
                            <input type="date" id="log-start-date">
                        </div>
                        <div class="form-group">
                            <label for="log-end-date"><i class="fas fa-calendar-day"></i> End Date</label>
                            <input type="date" id="log-end-date">
                        </div>
                        <div class="form-group">
                            <label for="log-user-email"><i class="fas fa-user-circle"></i> User Email (Optional)</label>
                            <input type="email" id="log-user-email" placeholder="Filter by user email">
                        </div>
                         <div class="form-group">
                            <label for="log-action-type"><i class="fas fa-tags"></i> Action Type (Optional)</label>
                            <input type="text" id="log-action-type" placeholder="e.g., login, create_user">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button id="load-activity-logs-btn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Load Logs
                        </button>
                    </div>
                </div>
                 <div class="card">
                    <h3 class="card-title" style="font-size: 1.2rem; margin-bottom: 15px;"><i class="fas fa-list-alt"></i> Log Entries</h3>
                    <div class="results-container activity-log-list">
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="activity-logs-table-body">
                               <tr><td colspan="4" style="text-align:center;">Use filters to load activity logs.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
  <h3 class="card-title"><i class="fas fa-broom"></i> Clear Activity Logs</h3>

  <div class="form-group">
    <label for="clear-log-type"><i class="fas fa-trash-alt"></i> Clear Log Option</label>
    <select id="clear-log-type">
      <option value="">-- Select --</option>
      <option value="user">Clear Logs by User Email</option>
      <option value="admin">Clear All Admin Logs</option>
      <option value="administrator">Clear Only Administrator Logs</option>
      <option value="all">Clear All Logs (Super Admin)</option>
    </select>
  </div>

  <div class="form-group" id="log-email-group" style="display:none;">
    <label for="clear-log-email"><i class="fas fa-envelope"></i> User Email</label>
    <input type="email" id="clear-log-email" placeholder="Enter user email">
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="clear-start-date"><i class="fas fa-calendar-day"></i> Start Date (optional)</label>
      <input type="date" id="clear-start-date">
    </div>
    <div class="form-group">
      <label for="clear-end-date"><i class="fas fa-calendar-day"></i> End Date (optional)</label>
      <input type="date" id="clear-end-date">
    </div>
  </div>

  <small style="margin-top: -10px; color: #6c757d; font-size: 0.85rem;">
    🗓️ If set, only logs between these dates will be deleted (inclusive).
  </small>

  <div class="btn-group" style="margin-top: 10px;">
    <button id="clear-log-btn" class="btn btn-danger">
      <i class="fas fa-trash"></i> Clear Logs
    </button>
  </div>
</div>

            </div>


            
            <!-- System Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-tools"></i> System Configuration</h2>
                     <div id="system-settings-error" class="error-message"></div>
                     <div id="system-settings-success" class="success-message"></div>
                    <div class="form-group">
                        <label for="system-name"><i class="fas fa-school"></i> School Name</label>
                        <input type="text" id="system-name" placeholder="Enter school name" value="AbsentEase Academy">
                    </div>
                    <div class="form-group">
                        <label for="logo-url"><i class="fas fa-image"></i> Logo URL</label>
                        <input type="text" id="logo-url" placeholder="Enter logo URL" value="https://cdn.imgchest.com/files/7mmc9jrkvv7.png">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-bell"></i> Notification Settings</label>
                        <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                                <input type="checkbox" id="email-notifications-setting" checked> Email Notifications
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                                <input type="checkbox" id="inapp-notifications-setting" checked> In-App Notifications
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
  <label><i class="fas fa-shield-alt"></i> Enable Administrator Logging</label>
  <select id="admin-log-toggle">
    <option value="true">Enabled ✅</option>
    <option value="false">Disabled ❌</option>
  </select>
</div>
<div class="btn-group">
  <button id="save-admin-log-setting" class="btn btn-primary">
    <i class="fas fa-save"></i> Save Logging Setting
  </button>
</div>
                    <div class="btn-group">
                        <button id="save-system-settings-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save System Settings
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-shield-alt"></i> Security</h2>
                     <div id="security-settings-error" class="error-message"></div>
                     <div id="security-settings-success" class="success-message"></div>
                    <div class="form-group">
                        <label for="password-policy"><i class="fas fa-key"></i> Password Policy</label>
                        <select id="password-policy">
                            <option value="low">Low (6 characters minimum)</option>
                            <option value="medium" selected>Medium (8 characters with letters and numbers)</option>
                            <option value="high">High (10 characters with letters, numbers and symbols)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="session-timeout"><i class="fas fa-clock"></i> Session Timeout</label>
                        <select id="session-timeout">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="60">60 minutes</option>
                            <option value="120">2 hours</option>
                            <option value="0">No timeout (Not Recommended)</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button id="save-security-settings-btn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Security Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Edit Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h3>
                <button class="close-modal" id="close-edit-user-modal">&times;</button>
            </div>
            <div id="edit-user-error" class="error-message"></div>
            <div id="edit-user-success" class="success-message"></div>
            <div class="form-group">
                <label for="edit-user-name-modal"><i class="fas fa-user"></i> Full Name</label>
                <input type="text" id="edit-user-name-modal" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="edit-user-role-modal"><i class="fas fa-user-tag"></i> User Role</label>
                <select id="edit-user-role-modal">
                    <option value="teacher">Teacher</option>
                    <option value="admin">Admin</option>
                    <option value="principal">Principal</option>
                    <option value="administrator">Administrator</option>
                </select>
            </div>
            <div class="form-group" id="edit-class-assign-group-modal">
                <label for="edit-user-class-modal"><i class="fas fa-chalkboard-teacher"></i> Assign Class</label>
                <select id="edit-user-class-modal">
                   <!-- Options loaded by JS -->
                </select>
            </div>
            <div class="modal-buttons">
                <button id="save-user-changes-btn" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                <button id="cancel-edit-user-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Record Modal -->
    <div id="edit-attendance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-clock"></i> Edit Attendance Status</h3>
                <button class="close-modal" id="close-edit-attendance-modal">&times;</button>
            </div>
            <div id="edit-attendance-error" class="error-message"></div>
            <div id="edit-attendance-success" class="success-message"></div>
            <p>Editing attendance for: <strong id="edit-attendance-student-info"></strong> on <strong id="edit-attendance-date-info"></strong> for Class <strong id="edit-attendance-class-info"></strong>.</p>
            <div class="form-group">
                <label for="edit-attendance-status-select"><i class="fas fa-check-circle"></i> New Status</label>
                <select id="edit-attendance-status-select">
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button id="save-attendance-change-btn" class="btn btn-primary"><i class="fas fa-save"></i> Save Status</button>
                <button id="cancel-edit-attendance-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBBSXXDKjH2kk7c8oaMPEZLDPrbi9L4is4",
            authDomain: "cvkm-52da0.firebaseapp.com",
            databaseURL: "https://cvkm-52da0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "cvkm-52da0",
            storageBucket: "cvkm-52da0.appspot.com", 
            messagingSenderId: "733824760937",
            appId: "1:733824760937:web:5ff6522ac364e55f9d36f8",
            measurementId: "G-R330EPDEMG"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        function showLoader() { document.getElementById("global-loader").style.display = "flex"; }
        function hideLoader() { document.getElementById("global-loader").style.display = "none"; }

        let currentUser = null;
        let userRole = 'teacher'; 
        let userDisplayName = 'Guest User'; 
        let userAssignedClass = null; 
        let allClassesData = {}; // Store class data { A1: ["Student1", ...], B2: [...] }
        let allStudentNames = {}; // Store { className: { roll: name } } for quick lookup
        let usersLoaded = false; 

        // Centralized function to display messages
        function showMessage(elementId, message, isSuccess = true) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = message;
            el.className = isSuccess ? 'success-message' : 'error-message'; // Ensure correct class for styling
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
        
        // Function to log activities
async function logActivity(action, details = {}) {
    // First, check if logging for administrators is enabled
    try {
        const adminLoggingSnap = await database.ref('settings/adminLogging').once('value');
        const isLoggingEnabled = adminLoggingSnap.val() !== false; // Default to true if not set

        // If the current user is an admin and logging is disabled, skip logging.
        if (userRole === 'administrator' && !isLoggingEnabled) {
            return;
        }
    } catch (error) {
        console.error("Could not check admin logging setting:", error);
        // Proceed with logging as a fallback
    }

    if (!currentUser) {
        console.warn("Attempted to log activity without a current user.", action, details);
        return;
    }
    const logEntry = {
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        userName: userDisplayName, // Correctly uses the name from the database
        action: action,
        details: details,
        device: details.device || getDeviceDetails(),
        ip: await fetch('https://api.ipify.org?format=json').then(res => res.json()).then(data => data.ip).catch(() => 'Unknown')
    };
    try {
        const logRef = database.ref('activityLogs').push();
        await logRef.set(logEntry);
    } catch (error) {
        console.error("Error logging activity:", error, logEntry);
    }
}
        document.addEventListener("DOMContentLoaded", function () {
            // Screen elements
            const splashScreen = document.getElementById("splash-screen");
            const loginScreen = document.getElementById("login-screen");
            const mainScreen = document.getElementById("main-screen");
            const attendanceScreen = document.getElementById("attendance-screen");
            const adminPanel = document.getElementById("admin-panel");
            const messageEl = document.getElementById("message");
            
            // Modals
            const editUserModal = document.getElementById("edit-user-modal");
            const editAttendanceModal = document.getElementById("edit-attendance-modal");

            // Login elements
            const loginBtn = document.getElementById("login-btn");
            const emailInput = document.getElementById("email-input");
            const passwordInput = document.getElementById("password-input");
            const loginError = document.getElementById("login-error");
            
            // Logout buttons
            const logoutButtons = [
                document.getElementById("logout-btn"),
                document.getElementById("attendance-logout-btn"),
                document.getElementById("admin-logout-btn")
            ];

            // Navigation buttons
            const attendanceBtn = document.getElementById("attendance-btn");
            const backBtn = document.getElementById("back-btn"); 
            const adminBackBtn = document.getElementById("admin-back-btn"); 
            const adminPanelBtn = document.getElementById("admin-panel-btn"); 
            const adminPanelBtn2 = document.getElementById("admin-panel-btn2"); 

            // Main screen (absentee sharing) elements
            const mainErrorMessage = document.getElementById("error-message");
            const mainSuccessMessage = document.getElementById("success-message");
            const rollInput = document.getElementById("roll-input");
            const searchBtn = document.getElementById("search-btn");
            const viewAllBtn = document.getElementById("view-all-btn");
            const shareBtn = document.getElementById("share-btn");
            const resultsTableBody = document.getElementById("results-table-body");
            const classSelectorMain = document.getElementById('class-selector');

            // Attendance screen elements
            const attendanceClassSelector = document.getElementById('attendance-class-selector');
            const dateSelectorAttendance = document.getElementById('date-selector');
            const loadAttendanceBtn = document.getElementById('load-attendance-btn');
            const attendanceTableBody = document.getElementById('attendance-table-body');
            const studentClassSelectorIndividual = document.getElementById('student-class-selector');
            const studentRollInputIndividual = document.getElementById('student-roll-input');
            const loadStudentBtnIndividual = document.getElementById('load-student-btn');
            const studentAttendanceBodyIndividual = document.getElementById('student-attendance-body');
            const studentNameDisplayIndividual = document.getElementById('student-name-display');


            // Admin Panel - User Management
            const addUserBtn = document.getElementById("add-user-btn");
            const newUserEmailInput = document.getElementById("new-user-email");
            const newUserPasswordInput = document.getElementById("new-user-password");
            const newUserNameInput = document.getElementById("new-user-name");
            const roleOptionsContainer = document.querySelector(".user-role-select");
            const userListTbody = document.getElementById("user-list-tbody");
            const adminUserError = document.getElementById("admin-user-error");
            const adminUserSuccess = document.getElementById("admin-user-success");
            const classAssignGroupForNewUser = document.getElementById("class-assign-group");
            const newUserClassSelect = document.getElementById("new-user-class");

            // Admin Panel - User Edit Modal elements
            const editUserNameModalInput = document.getElementById("edit-user-name-modal"); 
            const editUserRoleModalSelect = document.getElementById("edit-user-role-modal"); 
            const editUserClassModalSelect = document.getElementById("edit-user-class-modal"); 
            const editClassAssignGroupModal = document.getElementById("edit-class-assign-group-modal");
            const saveUserChangesBtn = document.getElementById("save-user-changes-btn");
            const closeEditUserModalBtn = document.getElementById("close-edit-user-modal");
            const cancelEditUserBtn = document.getElementById("cancel-edit-user-btn");
            const editUserModalError = document.getElementById("edit-user-error");
            const editUserModalSuccess = document.getElementById("edit-user-success");

            // Admin Panel - Attendance Management
            const mgmtAttStartDateInput = document.getElementById('mgmt-att-start-date');
            const mgmtAttEndDateInput = document.getElementById('mgmt-att-end-date');
            const mgmtAttClassSelector = document.getElementById('mgmt-att-class-selector');
            const loadMgmtAttendanceBtn = document.getElementById('load-mgmt-attendance-btn');
            const mgmtAttendanceTableBody = document.getElementById('mgmt-attendance-table-body');
            const attendanceStartDateSettingInput = document.getElementById('attendance-start-date-setting');
            const saveAttendanceSettingsBtn = document.getElementById('save-attendance-settings-btn');
            const mgmtAttendanceError = document.getElementById('mgmt-attendance-error');
            const mgmtAttendanceSuccess = document.getElementById('mgmt-attendance-success');
            const attendanceSettingsError = document.getElementById('attendance-settings-error');
            const attendanceSettingsSuccess = document.getElementById('attendance-settings-success');


            // Admin Panel - Edit Attendance Modal elements
            const editAttendanceStudentInfo = document.getElementById('edit-attendance-student-info');
            const editAttendanceDateInfo = document.getElementById('edit-attendance-date-info');
            const editAttendanceClassInfo = document.getElementById('edit-attendance-class-info');
            const editAttendanceStatusSelect = document.getElementById('edit-attendance-status-select');
            const saveAttendanceChangeBtn = document.getElementById('save-attendance-change-btn');
            const closeEditAttendanceModalBtn = document.getElementById('close-edit-attendance-modal');
            const cancelEditAttendanceBtn = document.getElementById('cancel-edit-attendance-btn');
            const editAttendanceError = document.getElementById('edit-attendance-error');
            const editAttendanceSuccess = document.getElementById('edit-attendance-success');
            let currentEditingAttendanceRecord = null; // To store data for the record being edited


            // Admin Panel - Activity Logs
            const logStartDateInput = document.getElementById('log-start-date');
            const logEndDateInput = document.getElementById('log-end-date');
            const logUserEmailInput = document.getElementById('log-user-email');
            const logActionTypeInput = document.getElementById('log-action-type');
            const loadActivityLogsBtn = document.getElementById('load-activity-logs-btn');
            const activityLogsTableBody = document.getElementById('activity-logs-table-body');
            const activityLogError = document.getElementById('activity-log-error');

            // Admin Panel - System Settings
            const systemNameInput = document.getElementById('system-name');
            const logoUrlInput = document.getElementById('logo-url');
            const emailNotificationsSettingCheckbox = document.getElementById('email-notifications-setting');
            const inAppNotificationsSettingCheckbox = document.getElementById('inapp-notifications-setting');
            const saveSystemSettingsBtn = document.getElementById('save-system-settings-btn');
            const passwordPolicySelect = document.getElementById('password-policy');
            const sessionTimeoutSelect = document.getElementById('session-timeout');
            const saveSecuritySettingsBtn = document.getElementById('save-security-settings-btn');
            const systemSettingsError = document.getElementById('system-settings-error');
            const systemSettingsSuccess = document.getElementById('system-settings-success');
            const securitySettingsError = document.getElementById('security-settings-error');
            const securitySettingsSuccess = document.getElementById('security-settings-success');


            let usersDataRef = database.ref('users');
            let currentEditUserUID = null; 

            const welcomeMessage = "Welcome To AbsentEase!\nMade By 2023-25 CS Students...";

            // --- Initial Setup ---
            async function initializeApp() {
                await loadAllClassesData(); // Load class data first
                populateClassSelectors(); // Then populate selectors
                auth.onAuthStateChanged(handleAuthStateChange); // Setup auth listener
                setupAdminPanelTabs();
                setupModalCloseButtons();
                setTodaysDateForDateInputs();
                loadSystemSettings(); // Load system settings on init
                loadAttendanceSettings(); // Load attendance settings on init
                loadDeviceSettings();
            }

            async function loadAllClassesData() {
                try {
                    const snapshot = await database.ref('classes').once('value');
                    allClassesData = snapshot.val() || {};
                    allStudentNames = {}; // Reset
                    for (const className in allClassesData) {
                        allStudentNames[className] = {};
                        if (Array.isArray(allClassesData[className])) {
                            allClassesData[className].forEach((name, roll) => {
                                if (name && name !== "Coming Soon" && name !== "\"Coming Soon\"") {
                                    allStudentNames[className][roll] = name;
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error("Error loading class data:", error);
                    showMessage(mainErrorMessage.id, "Failed to load class data.", false);
                }
            }
            
            function populateClassSelectors() {
                const classNames = Object.keys(allClassesData);
                const selectorsToPopulate = [
                    classSelectorMain, attendanceClassSelector, studentClassSelectorIndividual,
                    newUserClassSelect, editUserClassModalSelect, mgmtAttClassSelector
                ];

                selectorsToPopulate.forEach(selector => {
                    if (selector) {
                        selector.innerHTML = ''; // Clear existing
                        if (classNames.length === 0) {
                            const defaultOption = document.createElement('option');
                            defaultOption.textContent = "No classes available";
                            defaultOption.disabled = true;
                            selector.appendChild(defaultOption);
                        } else {
                             classNames.forEach(clsName => {
                                const option = document.createElement('option');
                                option.value = clsName;
                                option.textContent = `Class ${clsName}`;
                                selector.appendChild(option);
                            });
                        }
                        // Trigger change for the main class selector to set initial studentsDataRef
                        if (selector.id === 'class-selector' && classNames.length > 0) {
                             selector.dispatchEvent(new Event('change'));
                        }
                    }
                });
            }
            
            function setTodaysDateForDateInputs() {
                const today = new Date().toISOString().split('T')[0];
                const dateInputs = [
                    dateSelectorAttendance, mgmtAttStartDateInput, mgmtAttEndDateInput,
                    logStartDateInput, logEndDateInput
                ];
                dateInputs.forEach(input => { if(input) input.value = today; });
            }


            function setupAdminPanelTabs() {
                const adminTabs = document.querySelectorAll('#admin-panel .tabs .tab');
                const adminTabContents = document.querySelectorAll('#admin-panel .tab-content');
                adminTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        adminTabs.forEach(t => t.classList.remove('active'));
                        adminTabContents.forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        const tabId = tab.getAttribute('data-tab');
                        const activeContent = document.getElementById(`${tabId}-tab`);
                        if (activeContent) activeContent.classList.add('active');
                        logActivity('admin_navigate_tab', { tab: tabId });
                    });
                });
            }
            
            function setupModalCloseButtons() {
                // User Edit Modal
                if(closeEditUserModalBtn) closeEditUserModalBtn.addEventListener('click', () => editUserModal.style.display = 'none');
                if(cancelEditUserBtn) cancelEditUserBtn.addEventListener('click', () => editUserModal.style.display = 'none');
                
                // Attendance Edit Modal
                if(closeEditAttendanceModalBtn) closeEditAttendanceModalBtn.addEventListener('click', () => editAttendanceModal.style.display = 'none');
                if(cancelEditAttendanceBtn) cancelEditAttendanceBtn.addEventListener('click', () => editAttendanceModal.style.display = 'none');

                window.addEventListener('click', (e) => {
                    if (e.target === editUserModal) editUserModal.style.display = 'none';
                    if (e.target === editAttendanceModal) editAttendanceModal.style.display = 'none';
                });
                // Add this inside the DOMContentLoaded event listener
const saveAdminLogSettingBtn = document.getElementById("save-admin-log-setting");
if(saveAdminLogSettingBtn) {
    saveAdminLogSettingBtn.addEventListener("click", function () {
      const enableLogging = document.getElementById("admin-log-toggle").value === "true";
      showLoader();
      database.ref("settings/adminLogging").set(enableLogging)
        .then(() => {
          hideLoader();
          showMessage('system-settings-success', "Administrator logging setting updated!");
          logActivity('setting_change', { setting: 'adminLogging', value: enableLogging });
        })
        .catch((err) => {
          hideLoader();
          showMessage('system-settings-error', "Failed to save setting: " + err.message, false);
        });
    });
}
            }


async function handleSplashScreen() {
    await typeMessage(welcomeMessage, messageEl);

    // Fade out splash
    const splashScreen = document.getElementById("splash-screen");
    splashScreen.classList.add("fade-out");

    // Wait for fade-out animation to finish
    setTimeout(() => {
        // ✅ Finally show WhatsApp button
        const whatsappBtn = document.getElementById("whatsapp-button");
        if (whatsappBtn) whatsappBtn.style.display = 'flex';
    }, 600); // 500ms (fade duration) + 100ms buffer
}


            function typeMessage(msg, element) {
                return new Promise(resolve => {
                    let index = 0;
                    function type() {
                        if (index < msg.length) {
                            element.innerHTML += msg[index] === '\n' ? '<br>' : msg[index];
                            index++;
                            setTimeout(type, 50);
                        } else {
                            setTimeout(resolve, 1500);
                        }
                    }
                    type();
                });
            }

            function updateUserUIDisplay() {
                const roleBadgeElements = [
                    document.getElementById('user-role-badge'),
                    document.getElementById('attendance-role-badge'),
                    document.getElementById('admin-role-badge')
                ];
                roleBadgeElements.forEach(badge => {
                    if (badge) {
                        badge.className = 'role-badge'; 
                        badge.classList.add(`badge-${userRole}`);
                        badge.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
                    }
                });
                
                document.getElementById('user-display-name').textContent = userDisplayName;
                document.getElementById('attendance-user-name').textContent = userDisplayName;
                document.getElementById('admin-user-name').textContent = userDisplayName;
                
                const showAdminAccess = userRole === 'administrator';
                adminPanelBtn.style.display = showAdminAccess ? 'inline-flex' : 'none';
                adminPanelBtn2.style.display = showAdminAccess ? 'inline-flex' : 'none';
                
                updateRoleBasedClassSelectors();
            }
            
            function updateRoleBasedClassSelectors() {
                const selectorsForRoleFiltering = [attendanceClassSelector, studentClassSelectorIndividual];
                const classNames = Object.keys(allClassesData);

                selectorsForRoleFiltering.forEach(selector => {
                    if (!selector) return;
                    const currentVal = selector.value;
                    selector.innerHTML = ''; 
                    
                    if (userRole === 'teacher' && userAssignedClass) {
                        if (classNames.includes(userAssignedClass)) {
                            const option = document.createElement('option');
                            option.value = userAssignedClass;
                            option.textContent = `Class ${userAssignedClass}`;
                            selector.appendChild(option);
                        } else {
                            selector.innerHTML = '<option disabled>No assigned class found</option>';
                        }
                    } else { // Admins, principals, or general class selector
                        if (classNames.length === 0) {
                             selector.innerHTML = '<option disabled>No classes available</option>';
                        } else {
                            classNames.forEach(clsName => {
                                const option = document.createElement('option');
                                option.value = clsName;
                                option.textContent = `Class ${clsName}`;
                                selector.appendChild(option);
                            });
                            if (currentVal && classNames.includes(currentVal)) {
                                selector.value = currentVal; // Preserve selection if possible
                            }
                        }
                    }
                });
            }
function showCorrectionPanel(absenteesList) {
  document.getElementById("correction-ui").style.display = "block";
  document.getElementById("add-rolls-btn").onclick = () => modifyRolls("add", absenteesList);
  document.getElementById("remove-rolls-btn").onclick = () => modifyRolls("remove", absenteesList);
}
function modifyRolls(action, currentList) {
  const input = document.getElementById("corrected-rolls").value;
  const rolls = input.split(/[\s,]+/).map(r => parseInt(r)).filter(r => !isNaN(r));

  const classId = classSelectorMain.value;
  const date = new Date().toISOString().split('T')[0];

  let updated = [...currentList];
  if (action === "add") {
    updated = Array.from(new Set([...updated, ...rolls]));
  } else if (action === "remove") {
    updated = updated.filter(r => !rolls.includes(r));
  }

  // Step 1: Update sharedAbsentees
  const sharedRef = firebase.database().ref(`sharedAbsentees/${classId}/${date}/absentees`);
  sharedRef.set(updated).then(() => {

    // Step 2: Update main attendance path
    const fullAbsentees = updated.map(roll => ({
      roll: roll.toString(),
      name: allStudentNames[classId]?.[roll] || "Unknown"
    }));

    const attendanceRef = firebase.database().ref(`attendance/${date}/${classId}/absentees`);
    attendanceRef.set(fullAbsentees).then(() => {
      alert("✅ Absentees list updated.");
      showCorrectionPanel(updated); // Refresh with new list
    });

  });
}

function checkCorrectionWindow() {
  const classId = classSelectorMain.value;
  const date = new Date().toISOString().split('T')[0];
  const cooldownMs = 5 * 60 * 60 * 1000;

  firebase.database().ref(`sharedAbsentees/${classId}/${date}`).once("value").then(snapshot => {
    const data = snapshot.val();
    if (!data) return;

    const submittedAt = data.timestamp || 0;
    const now = Date.now();

    if (now - submittedAt <= cooldownMs) {
      showCorrectionPanel(data.absentees);
    } else {
      document.getElementById("correction-ui").style.display = "none";
    }
  });
}

            async function handleAuthStateChange(user) {
                if (!splashScreen.classList.contains('fade-out')) { // Ensure splash is handled first
                    await handleSplashScreen();
                }
                showLoader();
                if (user) {
                    currentUser = user;
                    try {
                        const userRef = database.ref(`users/${user.uid}`);
                        const snapshot = await userRef.once('value');
                        
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            userRole = userData.role || 'teacher'; 
                            userDisplayName = userData.name || user.email.split('@')[0];
                            userAssignedClass = userData.class || null;
                            
                            updateUserUIDisplay(); 
                            
                            loginScreen.style.display = "none";
                            const currentHash = window.location.hash;
                            if (currentHash === '#admin' && userRole === 'administrator') {
                                adminPanel.style.display = "block";
                                mainScreen.style.display = "none"; attendanceScreen.style.display = "none";
                            } else if (currentHash === '#attendance') {
                                attendanceScreen.style.display = "block";
                                mainScreen.style.display = "none"; adminPanel.style.display = "none";
                            } else {
                                mainScreen.style.display = "block";
                                attendanceScreen.style.display = "none"; adminPanel.style.display = "none";
                                if (currentHash && currentHash !== '#') window.location.hash = ''; 
                            }
                            
                            if (userRole === 'administrator' && !usersLoaded) {  
                                loadUsersForAdminTable();
                                usersLoaded = true;
                            }
                            // Log login after user data is loaded
                            // Avoid logging if it's just a page refresh and user was already logged in (tricky to detect perfectly client-side)
                            // For simplicity, we might log every time onAuthStateChanged confirms an active user.
                            // Or, add a flag to only log on explicit login action.
                            // For now, let's log it, assuming this function is primarily hit after explicit login or initial load.
                            // Consider adding a session flag if more precise "new login" logging is needed.
                            // logActivity('login_session_active'); 

                        } else {
                            console.error("User data not found in database. Logging out.");
                            await logActivity('auth_error', { error: 'User data not found in DB', email: user.email });
                            auth.signOut(); 
                        }
                    } catch (error) {
                        console.error("Error fetching user data:", error);
                        await logActivity('auth_error', { error: 'Failed to fetch user data', message: error.message });
                        auth.signOut(); 
                    }
                } else { 
                    currentUser = null; userRole = 'guest'; userDisplayName = 'Guest';
                    mainScreen.style.display = "none"; attendanceScreen.style.display = "none";
                    adminPanel.style.display = "none"; loginScreen.style.display = "block";
                    usersLoaded = false; 
                    if (window.location.hash) window.location.hash = ''; 
                }
                hideLoader(); 
            }
            
            if(loginBtn) {
                loginBtn.addEventListener("click", () => {
                    showLoader();
                    const email = emailInput.value.trim();
                    const password = passwordInput.value;

                    if (!email || !password) {
                        loginError.textContent = "Please fill in both fields.";
                        loginError.style.display = "block";
                        hideLoader();
                        return;
                    }

                    auth.signInWithEmailAndPassword(email, password)
                        .then(async (userCredential) => { 
                            await logActivity('login_success', { email: email });
                            loginError.style.display = "none";
                            // onAuthStateChanged will handle UI and further loading
                        })
                        .catch(async (error) => {
                            loginError.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
                            loginError.style.display = "block";
                            await logActivity('login_failure', { email: email, error: error.message });
                            hideLoader();
                        });
                });
            }
            
            function handleLogoutAction() {
                showLoader();
                const emailBeforeLogout = currentUser ? currentUser.email : 'unknown_user';
                auth.signOut()
                    .then(async () => { // onAuthStateChanged will handle UI changes
                        await logActivity('logout', { email: emailBeforeLogout });
                        // hideLoader() will be called by onAuthStateChanged
                    })
                    .catch(async (error) => { 
                        console.error("Logout error:", error);
                        await logActivity('logout_failure', { email: emailBeforeLogout, error: error.message });
                        hideLoader(); 
                    });
            }
            logoutButtons.forEach(btn => { if(btn) btn.addEventListener("click", handleLogoutAction); });
            
            // --- Navigation ---
            if(attendanceBtn) attendanceBtn.addEventListener("click", () => {
                mainScreen.style.display = "none"; attendanceScreen.style.display = "block"; adminPanel.style.display = "none";
                window.location.hash = '#attendance';
                logActivity('navigate', { to: 'attendance_screen' });
            });
            
            if(backBtn) backBtn.addEventListener("click", () => { // Back from attendance to main
                attendanceScreen.style.display = "none"; mainScreen.style.display = "block"; adminPanel.style.display = "none";
                window.location.hash = '';
                logActivity('navigate', { to: 'main_screen', from: 'attendance_screen' });
            });
            
            if(adminBackBtn) adminBackBtn.addEventListener("click", () => { // Back from admin to main
                adminPanel.style.display = "none"; mainScreen.style.display = "block"; attendanceScreen.style.display = "none";
                window.location.hash = '';
                logActivity('navigate', { to: 'main_screen', from: 'admin_panel' });
            });
            
            function showAdminPanelScreen() {
                if (userRole !== 'administrator') {
                    showMessage(mainErrorMessage.id, "Access denied. Administrator rights required.", false);
                    return;
                }
                mainScreen.style.display = "none"; attendanceScreen.style.display = "none"; adminPanel.style.display = "block";
                window.location.hash = '#admin';
                logActivity('navigate', { to: 'admin_panel' });
                if (!usersLoaded) { // Load users if not already loaded
                    loadUsersForAdminTable();
                    usersLoaded = true;
                }
            }
            if(adminPanelBtn) adminPanelBtn.addEventListener("click", showAdminPanelScreen);
            if(adminPanelBtn2) adminPanelBtn2.addEventListener("click", showAdminPanelScreen);

            // --- Main Screen (Absentee Sharing) Logic ---
            let studentsDataRefMain; 
            if(classSelectorMain) {
                classSelectorMain.addEventListener('change', (e) => {
                    const selectedClass = e.target.value;
                    if (selectedClass) {
                        studentsDataRefMain = database.ref(`classes/${selectedClass}`);
                    }
                });
            }

            if(searchBtn) searchBtn.addEventListener('click', async () => {
                if (!studentsDataRefMain) {
                    showMessage(mainErrorMessage.id, "Please select a class first.", false); return;
                }
                showLoader();
                const rollInputVal = rollInput.value.trim();
                const rollNumbers = [...new Set(rollInputVal.split(/[,\s]+/).map(num => parseInt(num)).filter(n => !isNaN(n)))];
                if (!rollNumbers.length) {
                    showMessage(mainErrorMessage.id, "Please enter valid roll numbers.", false); hideLoader(); return;
                }
                try {
                    const snapshot = await studentsDataRefMain.once('value');
                    const studentArray = snapshot.val() || [];
                    const results = rollNumbers.map(roll => ({
                        roll, name: studentArray[roll],
                        isValid: studentArray[roll] && studentArray[roll] !== "Coming Soon" && studentArray[roll] !== "\"Coming Soon\""
                    })).sort((a, b) => a.roll - b.roll)
                       .map(item => item.isValid ? `<tr><td>${item.roll}</td><td>${item.name}</td></tr>`
                                                 : `<tr class="error-row"><td>${item.roll}</td><td>Not Found</td></tr>`);
                    resultsTableBody.innerHTML = results.join('') || `<tr><td colspan="2">No students found for the given rolls.</td></tr>`;
                    shareBtn.style.display = results.some(r => !r.includes("Not Found")) ? 'inline-flex' : 'none';
                    logActivity('search_students', { class: classSelectorMain.value, rolls: rollNumbers.join(',') });
                } catch (error) {
                    showMessage(mainErrorMessage.id, `Error fetching data: ${error.message}`, false);
                    logActivity('search_students_error', { class: classSelectorMain.value, error: error.message });
                }
                hideLoader();
            });
            
            if(viewAllBtn) viewAllBtn.addEventListener('click', async () => {
                if (!classSelectorMain.value || !allStudentNames[classSelectorMain.value]) {
                     showMessage(mainErrorMessage.id, "Please select a valid class first.", false); return;
                }
                showLoader();
                const selectedClass = classSelectorMain.value;
                const studentsInClass = allStudentNames[selectedClass] || {};
                let resultsHTML = '';
                Object.entries(studentsInClass).sort((a,b) => parseInt(a[0]) - parseInt(b[0])).forEach(([roll, name]) => {
                    resultsHTML += `<tr><td>${roll}</td><td>${name}</td></tr>`;
                });

                resultsTableBody.innerHTML = resultsHTML || `<tr><td colspan="2">No students found in this class.</td></tr>`;
                shareBtn.style.display = resultsHTML ? 'inline-flex' : 'none';
                rollInput.value = '';
                logActivity('view_all_students', { class: selectedClass });
                hideLoader();
            });

            if(shareBtn) shareBtn.addEventListener('click', async () => {
                showLoader();
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
                const yyyy = today.getFullYear();
                const todayFormatted = `${dd}-${mm}-${yyyy}`;
                const todayDB = `${yyyy}-${mm}-${dd}`; // YYYY-MM-DD for DB
                
                const rows = resultsTableBody.querySelectorAll('tr');
                if (rows.length === 0) {
                    showMessage(mainErrorMessage.id, "No absentees to share.", false); hideLoader(); return;
                }
                
                const selectedClass = classSelectorMain.value;
                const absentees = [];
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length === 2 && cells[1].textContent !== "Not Found") {
                        absentees.push({ roll: cells[0].textContent, name: cells[1].textContent });
                    }
                });
                
                if (absentees.length === 0) {
                    showMessage(mainErrorMessage.id, "No valid absentees to share.", false); hideLoader(); return;
                }

                try {
                    const attendanceRef = database.ref(`attendance/${todayDB}/${selectedClass}`);
                    await attendanceRef.set({ date: todayDB, class: selectedClass, absentees: absentees, recordedBy: currentUser.uid, recordedAt: firebase.database.ServerValue.TIMESTAMP });
                    showMessage(mainSuccessMessage.id, "Attendance saved successfully!");
                    await logActivity('share_attendance_success', { class: selectedClass, date: todayDB, count: absentees.length });
                    // ✅ Save data for correction window (5 hour logic)
const sharedAbsenteesRef = database.ref(`sharedAbsentees/${selectedClass}/${todayDB}`);
await sharedAbsenteesRef.set({
  sharedBy: currentUser.email,
  timestamp: Date.now(),
  absentees: absentees.map(a => parseInt(a.roll))
});
checkCorrectionWindow();


                    let shareText = `Today's Absentees (${todayFormatted}) - Class ${selectedClass}\n------------------------------------------\n`;
                    absentees.forEach(item => { shareText += `${item.name}\n`; });

                    if (navigator.share) {
                        await navigator.share({ title: `Absentees - ${todayFormatted} - Class ${selectedClass}`, text: shareText });
                    } else {
                        fallbackShareText(shareText, mainSuccessMessage.id, "Absentees list copied to clipboard!");
                    }
                } catch (error) {
                    showMessage(mainErrorMessage.id, `Error: ${error.message}`, false);
                    await logActivity('share_attendance_error', { class: selectedClass, date: todayDB, error: error.message });
                }
                // ✅ Save shared absentees separately for correction window


                hideLoader();
            });
            function showCorrectionPanel(absenteesList) {
  document.getElementById("correction-ui").style.display = "block";
  document.getElementById("add-rolls-btn").onclick = () => modifyRolls("add", absenteesList);
  document.getElementById("remove-rolls-btn").onclick = () => modifyRolls("remove", absenteesList);
}

            function fallbackShareText(text, messageElementId, successText) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessage(messageElementId, successText, true);
                } catch (err) {
                    showMessage(messageElementId, "Could not copy. Please copy manually.", false);
                    console.error('Fallback copy error:', err);
                    // Avoid alert() if possible, rely on the message display
                }
                document.body.removeChild(textarea);
            }
            
            // --- Attendance Screen Logic ---
            if(loadAttendanceBtn) loadAttendanceBtn.addEventListener('click', async () => {
                showLoader();
                const selectedClass = attendanceClassSelector.value;
                const selectedDate = dateSelectorAttendance.value;
                const errorElId = 'attendance-error'; // Assuming this ID exists for this section
                
                if (!selectedClass || !selectedDate) {
                    showMessage(errorElId, "Please select both class and date.", false); hideLoader(); return;
                }
                
                try {
                    const studentsInClass = allStudentNames[selectedClass] || {};
                    const totalStudentsCount = Object.keys(studentsInClass).length;
                    document.getElementById('total-students').textContent = totalStudentsCount;
                    
                    const attendanceRef = database.ref(`attendance/${selectedDate}/${selectedClass}`);
                    const attendanceSnapshot = await attendanceRef.once('value');
                    const attendanceData = attendanceSnapshot.val();
                    
                    let absentCount = 0;
                    let tableHTML = '';
                    const absentRolls = new Set(attendanceData && attendanceData.absentees ? attendanceData.absentees.map(a => a.roll.toString()) : []);

                    Object.entries(studentsInClass).sort((a,b) => parseInt(a[0]) - parseInt(b[0])).forEach(([roll, name]) => {
                        const isAbsent = absentRolls.has(roll);
                        if (isAbsent) absentCount++;
                        tableHTML += `
                            <tr>
                                <td>${roll}</td><td>${name}</td>
                                <td>${isAbsent ? '<span style="color: var(--danger);"><i class="fas fa-times"></i> <span class="status-indicator status-absent"></span>Absent</span>' 
                                              : '<span style="color: var(--success);"><i class="fas fa-check"></i> <span class="status-indicator status-present"></span>Present</span>'}</td>
                            </tr>`;
                    });
                    
                    attendanceTableBody.innerHTML = tableHTML || `<tr><td colspan="3" style="text-align:center;">No student data for this class.</td></tr>`;
                    document.getElementById('absent-today').textContent = absentCount;
                    const attendanceRate = totalStudentsCount > 0 ? Math.round(((totalStudentsCount - absentCount) / totalStudentsCount) * 100) : 0;
                    document.getElementById('attendance-rate').textContent = `${attendanceRate}%`;
                    await logActivity('load_class_attendance_view', { class: selectedClass, date: selectedDate });
                } catch (error) {
                    showMessage(errorElId, `Error loading attendance: ${error.message}`, false);
                    await logActivity('load_class_attendance_error', { class: selectedClass, date: selectedDate, error: error.message });
                }
                hideLoader();
            });
            
            if(loadStudentBtnIndividual) loadStudentBtnIndividual.addEventListener('click', async () => {
                showLoader();
                const selectedClass = studentClassSelectorIndividual.value;
                const rollNumber = studentRollInputIndividual.value.trim();
                const errorElId = 'individual-error'; // Assuming this ID exists
                
                if (!selectedClass || !rollNumber) {
                    showMessage(errorElId, "Please select class and enter roll number.", false); hideLoader(); return;
                }
                
                try {
                    const studentName = (allStudentNames[selectedClass] && allStudentNames[selectedClass][rollNumber]) || "N/A";
                    if (studentName === "N/A") {
                         showMessage(errorElId, "Student not found in this class.", false); hideLoader(); return;
                    }
                    studentNameDisplayIndividual.textContent = `${studentName} (Roll: ${rollNumber})`;
                    
                    const attendanceRecordsRef = database.ref(`attendance`); 
                    const snapshot = await attendanceRecordsRef.orderByKey().once('value'); // Order by date (key)
                    const allAttendanceData = snapshot.val();
                    
                    let tableHTML = '';
                    if (allAttendanceData) {
                        Object.keys(allAttendanceData).forEach(dateKey => { 
                            if (allAttendanceData[dateKey][selectedClass] && allAttendanceData[dateKey][selectedClass].absentees) {
                                const isAbsent = allAttendanceData[dateKey][selectedClass].absentees.some(a => a.roll.toString() === rollNumber);
                                const [year, month, day] = dateKey.split('-');
                                const formattedDate = `${day}-${month}-${year}`;
                                tableHTML += `
                                    <tr>
                                        <td>${formattedDate}</td>
                                        <td>${isAbsent ? '<span style="color: var(--danger);"><i class="fas fa-times"></i> <span class="status-indicator status-absent"></span>Absent</span>' 
                                                      : '<span style="color: var(--success);"><i class="fas fa-check"></i> <span class="status-indicator status-present"></span>Present</span>'}</td>
                                    </tr>`;
                            }
                        });
                    }
                    studentAttendanceBodyIndividual.innerHTML = tableHTML || `<tr><td colspan="2" style="text-align:center;">No records found.</td></tr>`;
                    await logActivity('load_individual_attendance_view', { class: selectedClass, roll: rollNumber });
                } catch (error) {
                    showMessage(errorElId, `Error: ${error.message}`, false);
                     await logActivity('load_individual_attendance_error', { class: selectedClass, roll: rollNumber, error: error.message });
                }
                hideLoader();
            });

            // --- Admin Panel - User Management ---
            let selectedRoleForNewUser = 'teacher'; 
            if(roleOptionsContainer) {
                const roleOptionDivs = roleOptionsContainer.querySelectorAll(".role-option");
                roleOptionDivs.forEach(option => {
                    option.addEventListener('click', () => {
                        roleOptionDivs.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        selectedRoleForNewUser = option.getAttribute('data-role');
                        classAssignGroupForNewUser.style.display = selectedRoleForNewUser === 'teacher' ? 'block' : 'none';
                    });
                });
                // Default selection
                const defaultRoleOption = roleOptionsContainer.querySelector('.role-option[data-role="teacher"]');
                if (defaultRoleOption) {
                    defaultRoleOption.classList.add('selected');
                    classAssignGroupForNewUser.style.display = 'block';
                }
            }


            if(addUserBtn) addUserBtn.addEventListener('click', async () => {
                showLoader();
                const email = newUserEmailInput.value.trim();
                const password = newUserPasswordInput.value;
                const name = newUserNameInput.value.trim();
                const classAssignment = selectedRoleForNewUser === 'teacher' ? newUserClassSelect.value : null;

                if (!email || !password || !name) {
                    showMessage(adminUserError.id, "⚠️ Please fill in all fields!", false); hideLoader(); return;
                }
                if (password.length < 6) {
                    showMessage(adminUserError.id, "🔐 Password must be at least 6 characters!", false); hideLoader(); return;
                }

                try {
                    const tempAppName = `secondaryApp_${Date.now()}`; // Unique name for temp app
                    const secondaryApp = firebase.initializeApp(firebaseConfig, tempAppName);
                    const secondaryAuth = secondaryApp.auth();

                    const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                    const newUser = userCredential.user;

                    await database.ref('users/' + newUser.uid).set({
                        email: email, name: name, role: selectedRoleForNewUser, class: classAssignment, createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    await newUser.updateProfile({ displayName: name }); 

                    showMessage(adminUserSuccess.id, `✅ User "${email}" created successfully!`);
                    await logActivity('create_user_success', { createdUserEmail: email, role: selectedRoleForNewUser });
                    newUserEmailInput.value = ''; newUserPasswordInput.value = ''; newUserNameInput.value = '';
                    
                    await secondaryAuth.signOut(); 
                    await secondaryApp.delete(); 
                } catch (error) {
                    showMessage(adminUserError.id, `❌ Error: ${error.message}`, false);
                    await logActivity('create_user_error', { inputEmail: email, error: error.message });
                }
                hideLoader();
            });
            
            function loadUsersForAdminTable() {
                usersDataRef.on('value', (snapshot) => { 
                    userListTbody.innerHTML = ''; 
                    snapshot.forEach((childSnapshot) => {
                        const uid = childSnapshot.key;
                        const userData = childSnapshot.val();
                        
                        const tr = userListTbody.insertRow();
                        tr.innerHTML = `
                            <td>${userData.email}</td>
                            <td>${userData.name}</td>
                            <td><span class="role-badge badge-${userData.role}">${userData.role.charAt(0).toUpperCase() + userData.role.slice(1)}</span></td>
                            <td>${userData.class || 'N/A'}</td>
                            <td class="admin-user-actions">
                                <button class="btn btn-primary btn-edit-user" data-uid="${uid}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-delete-user" data-uid="${uid}"><i class="fas fa-trash"></i></button>
                            </td>`;
                        
                        tr.querySelector('.btn-edit-user').addEventListener('click', () => openEditUserModalDialog(uid, userData));
                        tr.querySelector('.btn-delete-user').addEventListener('click', () => confirmUserDeletion(uid, userData));
                    });
                }, (error) => {
                    console.error("Error loading users for admin:", error);
                    showMessage(adminUserError.id, "Failed to load users.", false);
                });
            }
            
            function openEditUserModalDialog(uid, userData) {
                currentEditUserUID = uid; 
                editUserNameModalInput.value = userData.name;
                editUserRoleModalSelect.value = userData.role;
                editClassAssignGroupModal.style.display = userData.role === 'teacher' ? 'block' : 'none';
                if (userData.role === 'teacher') editUserClassModalSelect.value = userData.class || (Object.keys(allClassesData)[0] || ''); 
                editUserModal.style.display = 'flex';
            }
            
            if(editUserRoleModalSelect) editUserRoleModalSelect.addEventListener('change', function() {
                editClassAssignGroupModal.style.display = this.value === 'teacher' ? 'block' : 'none';
            });

            if(saveUserChangesBtn) saveUserChangesBtn.addEventListener('click', async () => {
                if (!currentEditUserUID) return;
                showLoader();
                const newName = editUserNameModalInput.value.trim();
                const newRole = editUserRoleModalSelect.value;
                const newClass = newRole === 'teacher' ? editUserClassModalSelect.value : null;
                
                if (!newName) {
                    showMessage(editUserModalError.id, "Name cannot be empty.", false); hideLoader(); return;
                }
                
                try {
                    const updates = { name: newName, role: newRole, class: newClass, updatedAt: firebase.database.ServerValue.TIMESTAMP };
                    await usersDataRef.child(currentEditUserUID).update(updates);
                    
                    if (currentUser && currentUser.uid === currentEditUserUID) {
                        userDisplayName = newName; userRole = newRole; userAssignedClass = newClass;
                        updateUserUIDisplay(); 
                    }
                    showMessage(editUserModalSuccess.id, "User updated successfully!");
                    await logActivity('edit_user_success', { targetUserUID: currentEditUserUID, changes: updates });
                    setTimeout(() => { editUserModal.style.display = 'none'; }, 2000);
                } catch (error) {
                    showMessage(editUserModalError.id, `Error: ${error.message}`, false);
                     await logActivity('edit_user_error', { targetUserUID: currentEditUserUID, error: error.message });
                }
                hideLoader();
            });
            
            function confirmUserDeletion(uid, userData) {
                if (userData.role === 'administrator') {
                    // Using custom message for admin panel
                    showMessage(adminUserError.id, "❌ Administrator accounts cannot be deleted through this panel.", false);
                    return;
                }
                // Replace confirm with a custom modal in a real app for better UX
                if (window.confirm(`Are you sure you want to delete user ${userData.email}? This action is irreversible from the database (auth record may persist).`)) {
                    deleteUserFromDatabase(uid, userData.email);
                }
            }

            async function deleteUserFromDatabase(uid, email) {
                showLoader();
                try {
                    await usersDataRef.child(uid).remove();
                    showMessage(adminUserSuccess.id, `User ${email} removed from database.`);
                    await logActivity('delete_user_db_success', { deletedUserUID: uid, email: email });
                } catch (error) {
                    showMessage(adminUserError.id, `Error deleting user from DB: ${error.message}`, false);
                    await logActivity('delete_user_db_error', { targetUserUID: uid, error: error.message });
                }
                hideLoader();
            }

            // --- Admin Panel - Attendance Management ---
            if(loadMgmtAttendanceBtn) loadMgmtAttendanceBtn.addEventListener('click', async () => {
                showLoader();
                const startDate = mgmtAttStartDateInput.value;
                const endDate = mgmtAttEndDateInput.value;
                const selectedClass = mgmtAttClassSelector.value;

                if (!startDate || !endDate || !selectedClass) {
                    showMessage(mgmtAttendanceError.id, "Please select start date, end date, and class.", false);
                    hideLoader(); return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    showMessage(mgmtAttendanceError.id, "Start date cannot be after end date.", false);
                    hideLoader(); return;
                }

                mgmtAttendanceTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>`;
                try {
                    const attendanceRef = database.ref('attendance');
                    // Querying by date range directly in Firebase RTDB is complex. Fetch all and filter client-side for simplicity here.
                    // For large datasets, server-side filtering or Firestore would be better.
                    const snapshot = await attendanceRef.orderByKey().startAt(startDate).endAt(endDate).once('value');
                    const allDataForRange = snapshot.val() || {};
                    
                    let tableHTML = "";
                    let recordsFound = 0;

                    Object.keys(allDataForRange).forEach(dateKey => {
                        if (allDataForRange[dateKey][selectedClass]) {
                            const classAttendance = allDataForRange[dateKey][selectedClass];
                            const studentsInThisClass = allStudentNames[selectedClass] || {};
                            const absentRollsOnDate = new Set((classAttendance.absentees || []).map(a => a.roll.toString()));

                            Object.entries(studentsInThisClass).forEach(([roll, name]) => {
                                recordsFound++;
                                const isAbsent = absentRollsOnDate.has(roll);
                                tableHTML += `
                                    <tr data-date="${dateKey}" data-class="${selectedClass}" data-roll="${roll}" data-name="${name}">
                                        <td>${dateKey}</td>
                                        <td>${selectedClass}</td>
                                        <td>${roll}</td>
                                        <td>${name}</td>
                                        <td>${isAbsent ? '<span class="status-indicator status-absent"></span>Absent' : '<span class="status-indicator status-present"></span>Present'}</td>
                                        <td><button class="btn btn-primary btn-edit-attendance"><i class="fas fa-edit"></i> Edit</button></td>
                                    </tr>`;
                            });
                        }
                    });
                    mgmtAttendanceTableBody.innerHTML = recordsFound > 0 ? tableHTML : `<tr><td colspan="6" style="text-align:center;">No records found for the selected criteria.</td></tr>`;
                    
                    // Add event listeners to new edit buttons
                    mgmtAttendanceTableBody.querySelectorAll('.btn-edit-attendance').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const row = e.target.closest('tr');
                            currentEditingAttendanceRecord = {
                                date: row.dataset.date,
                                class: row.dataset.class,
                                roll: row.dataset.roll,
                                name: row.dataset.name,
                                currentStatus: row.cells[4].textContent.trim().toLowerCase() // "absent" or "present"
                            };
                            editAttendanceStudentInfo.textContent = `${currentEditingAttendanceRecord.name} (Roll: ${currentEditingAttendanceRecord.roll})`;
                            editAttendanceDateInfo.textContent = currentEditingAttendanceRecord.date;
                            editAttendanceClassInfo.textContent = currentEditingAttendanceRecord.class;
                            editAttendanceStatusSelect.value = currentEditingAttendanceRecord.currentStatus.includes('absent') ? 'absent' : 'present';
                            editAttendanceModal.style.display = 'flex';
                        });
                    });
                    await logActivity('load_mgmt_attendance', { startDate, endDate, class: selectedClass, recordsFound });

                } catch (error) {
                    showMessage(mgmtAttendanceError.id, `Error loading attendance records: ${error.message}`, false);
                     await logActivity('load_mgmt_attendance_error', { error: error.message });
                }
                hideLoader();
            });

            if(saveAttendanceChangeBtn) saveAttendanceChangeBtn.addEventListener('click', async () => {
                if (!currentEditingAttendanceRecord) return;
                showLoader();
                const newStatus = editAttendanceStatusSelect.value; // "present" or "absent"
                const { date, class: className, roll, name } = currentEditingAttendanceRecord;

                try {
                    const dayAttendanceRef = database.ref(`attendance/${date}/${className}`);
                    const snapshot = await dayAttendanceRef.once('value');
                    let dayData = snapshot.val() || { date: date, class: className, absentees: [] };
                    dayData.absentees = dayData.absentees || [];

                    const studentIndex = dayData.absentees.findIndex(s => s.roll.toString() === roll);

                    if (newStatus === 'absent') {
                        if (studentIndex === -1) { // If not already absent, add
                            dayData.absentees.push({ roll: roll, name: name });
                        }
                    } else { // present
                        if (studentIndex !== -1) { // If was absent, remove
                            dayData.absentees.splice(studentIndex, 1);
                        }
                    }
                    dayData.lastEditedBy = currentUser.uid;
                    dayData.lastEditedAt = firebase.database.ServerValue.TIMESTAMP;

                    await dayAttendanceRef.set(dayData);
                    showMessage(editAttendanceSuccess.id, `Attendance for ${name} on ${date} updated to ${newStatus}.`);
                    await logActivity('edit_attendance_record_success', { date, class: className, roll, name, newStatus });
                    editAttendanceModal.style.display = 'none';
                    loadMgmtAttendanceBtn.click(); // Refresh the table
                } catch (error) {
                    showMessage(editAttendanceError.id, `Error updating attendance: ${error.message}`, false);
                    await logActivity('edit_attendance_record_error', { date, class: className, roll, name, error: error.message });
                }
                hideLoader();
            });
            
            if(saveAttendanceSettingsBtn) saveAttendanceSettingsBtn.addEventListener('click', async () => {
                showLoader();
                const startDate = attendanceStartDateSettingInput.value;
                if (!startDate) {
                    showMessage(attendanceSettingsError.id, "Please select a starting date.", false);
                    hideLoader(); return;
                }
                try {
                    await database.ref('settings/attendanceConfiguration').update({ globalAttendanceStartDate: startDate, lastSetBy: currentUser.uid, lastSetAt: firebase.database.ServerValue.TIMESTAMP });
                    showMessage(attendanceSettingsSuccess.id, "Attendance starting date saved.");
                    await logActivity('save_attendance_setting', { setting: 'globalAttendanceStartDate', value: startDate });
                } catch (error) {
                    showMessage(attendanceSettingsError.id, `Error saving setting: ${error.message}`, false);
                    await logActivity('save_attendance_setting_error', { error: error.message });
                }
                hideLoader();
            });
            

            async function loadAttendanceSettings() {
                try {
                    const snapshot = await database.ref('settings/attendanceConfiguration/globalAttendanceStartDate').once('value');
                    if (snapshot.exists() && attendanceStartDateSettingInput) {
                        attendanceStartDateSettingInput.value = snapshot.val();
                    }
                } catch (error) { console.error("Error loading attendance start date setting:", error); }
            }


            // --- Admin Panel - Activity Logs ---
            if(loadActivityLogsBtn) loadActivityLogsBtn.addEventListener('click', async () => {
                showLoader();
                const startDate = logStartDateInput.value;
                const endDate = logEndDateInput.value;
                const userEmailFilter = logUserEmailInput.value.trim().toLowerCase();
                const actionTypeFilter = logActionTypeInput.value.trim().toLowerCase();

                if (!startDate || !endDate) {
                    showMessage(activityLogError.id, "Please select start and end dates for logs.", false);
                    hideLoader(); return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    showMessage(activityLogError.id, "Start date cannot be after end date.", false);
                    hideLoader(); return;
                }
                
                activityLogsTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Loading logs...</td></tr>`;
                try {
                    // Firebase RTDB does not support complex multi-field filtering efficiently client-side for large datasets.
                    // We'll fetch by timestamp range and then filter other fields client-side.
                    // For production with many logs, consider Firestore or server-side processing/indexing.
                    const logsRef = database.ref('activityLogs');
                    // Convert dates to timestamps for comparison if needed, or use string comparison if dates are YYYY-MM-DD
                    // For server timestamps, we'd need to query by child 'timestamp'.
                    // Here, we'll fetch all and filter. This is NOT scalable for many logs.
                    const snapshot = await logsRef.orderByChild('timestamp').once('value'); // Fetch all, then filter
                    const allLogs = snapshot.val() || {};
                    
                    let tableHTML = "";
                    let logsFound = 0;
                    const startTimestamp = new Date(startDate).getTime();
                    const endTimestamp = new Date(endDate).setHours(23, 59, 59, 999); // End of day

                    Object.values(allLogs).filter(log => {
                        if (!log.timestamp || log.timestamp < startTimestamp || log.timestamp > endTimestamp) return false;
                        if (userEmailFilter && (!log.userEmail || !log.userEmail.toLowerCase().includes(userEmailFilter))) return false;
                        if (actionTypeFilter && (!log.action || !log.action.toLowerCase().includes(actionTypeFilter))) return false;
                        return true;
                    }).sort((a,b) => b.timestamp - a.timestamp) // Sort newest first
                      .forEach(log => {
                        logsFound++;
                        const logDate = new Date(log.timestamp).toLocaleString();
                        tableHTML += `
                            <tr>
                                <td>${logDate}</td>
                                <td>${log.userName || log.userEmail || 'N/A'}</td>
                                <td>${log.action}</td>
                                <td>${log.details ? JSON.stringify(log.details, null, 2).substring(0, 100) + (JSON.stringify(log.details).length > 100 ? '...' : '') : 'N/A'}</td>
                            </tr>`;
                    });

                    activityLogsTableBody.innerHTML = logsFound > 0 ? tableHTML : `<tr><td colspan="4" style="text-align:center;">No logs found for the selected criteria.</td></tr>`;
                    await logActivity('load_activity_logs_view', { startDate, endDate, userFilter: userEmailFilter, actionFilter: actionTypeFilter, logsFound });
                } catch (error) {
                    showMessage(activityLogError.id, `Error loading activity logs: ${error.message}`, false);
                     await logActivity('load_activity_logs_error', { error: error.message });
                }
                hideLoader();
            });

            // --- Admin Panel - System Settings ---
            if(saveSystemSettingsBtn) saveSystemSettingsBtn.addEventListener('click', async () => {
                showLoader();
                const settings = {
                    schoolName: systemNameInput.value,
                    logoUrl: logoUrlInput.value,
                    notifications: {
                        email: emailNotificationsSettingCheckbox.checked,
                        inApp: inAppNotificationsSettingCheckbox.checked
                    },
                    lastUpdatedBy: currentUser.uid,
                    lastUpdatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                try {
                    await database.ref('settings/systemConfiguration').update(settings);
                    showMessage(systemSettingsSuccess.id, "System settings saved successfully.");
                    await logActivity('save_system_settings_success', settings);
                    // Update live elements if necessary (e.g., logo on current page)
                    document.querySelectorAll('#header-logo, #attendance-header-logo, #admin-header-logo').forEach(logo => {
                        if(logo) logo.src = settings.logoUrl;
                    });
                    document.querySelectorAll('h1').forEach(title => { // Simplistic title update, might need refinement
                        if(title.textContent.includes("AbsentEase") && systemNameInput.value) {
                            // This is a bit broad, might update more than intended.
                            // A more specific selector or logic would be better if titles vary.
                        }
                    });

                } catch (error) {
                    showMessage(systemSettingsError.id, `Error saving system settings: ${error.message}`, false);
                    await logActivity('save_system_settings_error', { error: error.message });
                }
                hideLoader();
            });
            
            if(saveSecuritySettingsBtn) saveSecuritySettingsBtn.addEventListener('click', async () => {
                showLoader();
                const settings = {
                    passwordPolicy: passwordPolicySelect.value,
                    sessionTimeoutMinutes: parseInt(sessionTimeoutSelect.value),
                    lastUpdatedBy: currentUser.uid,
                    lastUpdatedAt: firebase.database.ServerValue.TIMESTAMP
                };
                try {
                    await database.ref('settings/securityConfiguration').update(settings);
                    showMessage(securitySettingsSuccess.id, "Security settings saved successfully.");
                    await logActivity('save_security_settings_success', settings);
                } catch (error) {
                    showMessage(securitySettingsError.id, `Error saving security settings: ${error.message}`, false);
                    await logActivity('save_security_settings_error', { error: error.message });
                }
                hideLoader();
            });

            async function loadSystemSettings() {
                try {
                    const sysConfigSnap = await database.ref('settings/systemConfiguration').once('value');
                    if (sysConfigSnap.exists()) {
                        const config = sysConfigSnap.val();
                        if(systemNameInput) systemNameInput.value = config.schoolName || 'AbsentEase Academy';
                        if(logoUrlInput) logoUrlInput.value = config.logoUrl || 'https://cdn.imgchest.com/files/7mmc9jrkvv7.png';
                        if(emailNotificationsSettingCheckbox && config.notifications) emailNotificationsSettingCheckbox.checked = config.notifications.email !== false; // Default true
                        if(inAppNotificationsSettingCheckbox && config.notifications) inAppNotificationsSettingCheckbox.checked = config.notifications.inApp !== false; // Default true
                        // Apply logo immediately
                         document.querySelectorAll('#header-logo, #attendance-header-logo, #admin-header-logo').forEach(logo => {
                            if(logo && config.logoUrl) logo.src = config.logoUrl;
                        });
                    }
                    const secConfigSnap = await database.ref('settings/securityConfiguration').once('value');
                     if (secConfigSnap.exists()) {
                        const config = secConfigSnap.val();
                        if(passwordPolicySelect) passwordPolicySelect.value = config.passwordPolicy || 'medium';
                        if(sessionTimeoutSelect) sessionTimeoutSelect.value = config.sessionTimeoutMinutes !== undefined ? config.sessionTimeoutMinutes.toString() : '30';
                    }
                } catch (error) {
                    console.error("Error loading system settings:", error);
                }
                // Add this inside the loadSystemSettings function
const adminLogSnap = await database.ref('settings/adminLogging').once('value');
if (adminLogSnap.exists() && document.getElementById('admin-log-toggle')) {
    document.getElementById('admin-log-toggle').value = adminLogSnap.val().toString();
}
            }
            
            // --- Initialize App ---
            initializeApp();
            // Add this to initializeApp() function
setupAttendanceTabs();

function setupAttendanceTabs() {
    const attendanceTabs = document.querySelectorAll('#attendance-screen .tabs .tab');
    const attendanceTabContents = document.querySelectorAll('#attendance-screen .tab-content');
    
    attendanceTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active classes
            attendanceTabs.forEach(t => t.classList.remove('active'));
            attendanceTabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Show corresponding content
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        });
    });
}
        });
        
        // Function to get device and browser details
function getDeviceDetails() {
    return {
        deviceType: /Mobi|Android|iPhone/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
        browser: navigator.userAgentData?.brands?.[0]?.brand || 'Unknown',
        os: navigator.userAgentData?.platform || 'Unknown',
        screen: `${window.screen.width}x${window.screen.height}`,
        time: new Date().toISOString()
    };
}

// Updated login handler
loginBtn.addEventListener("click", () => {
    const deviceDetails = getDeviceDetails();
    // ... existing login code
    then(async (userCredential) => { 
        await logActivity('login_success', { 
            email: email,
            device: deviceDetails
        });
    })
});

// Updated logout handler
function handleLogoutAction() {
    const deviceDetails = getDeviceDetails();
    // ... existing logout code
    then(async () => {
        await logActivity('logout', {
            email: emailBeforeLogout,
            device: deviceDetails
        });
    })
}
        
    </script>
    <!-- PDF export logic to be added at the bottom of your HTML, just before </body> -->
<!-- PDF export logic to be added at the bottom of your HTML, just before </body> -->
<!-- PDF export logic to be added at the bottom of your HTML, just before </body> -->
<script>
  function formatDateToDDMMYYYY(timestamp) {
    const now = new Date(timestamp);
    const dd = String(now.getDate()).padStart(2, '0');
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const yyyy = now.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  window.addEventListener('DOMContentLoaded', () => {
    if (window.jspdf && window.jspdf.jsPDF) {
      const { jsPDF } = window.jspdf;

      const classBtn = document.getElementById("download-class-attendance-pdf");
      const individualBtn = document.getElementById("download-individual-attendance-pdf");

      const getFormattedDate = () => {
        const now = new Date();
        const day = now.toLocaleString('en-US', { weekday: 'long' });
        return `${day}, ${formatDateToDDMMYYYY(now)}`;
      };

      const getCurrentClassName = () => {
        const select = document.getElementById("attendance-class-selector");
        return select?.options[select.selectedIndex]?.value || "Class";
      };

      const getClassTeacherName = (className) => {
        const classTeachers = {
          "A2": "Julie Vargheese",
          "B2": "Deepti",
          "C2": "Harin SK",
          "D2": "Anulekshmi V"
        };
        return classTeachers[className] || "NIL";
      };

      if (classBtn) {
        classBtn.addEventListener("click", () => {
          const doc = new jsPDF();
          const table = document.querySelector("#attendance-table-body")?.closest("table");
          if (!table) return alert("Attendance table not found");

          const className = getCurrentClassName();
          const teacherName = getClassTeacherName(className);

          doc.text("Class Attendance Report", 14, 16);
          doc.text(getFormattedDate(), 14, 26);
          doc.text(`Class: ${className}`, 14, 36);
          doc.text(`Class Teacher: ${teacherName}`, 14, 46);
          doc.autoTable({ html: table, startY: 52 });
          doc.save("class-attendance.pdf");
        });
      }

      if (individualBtn) {
        individualBtn.addEventListener("click", () => {
          const doc = new jsPDF();
          const name = document.getElementById("student-name-display")?.innerText || "Student";
          const table = document.querySelector("#student-attendance-body")?.closest("table");
          if (!table) return alert("Student attendance table not found");

          doc.text(`Attendance Report for ${name}`, 14, 16);
          doc.text(getFormattedDate(), 14, 26);
          doc.autoTable({ html: table, startY: 32 });
          doc.save(`${name.replace(/\s+/g, '_').toLowerCase()}_attendance.pdf`);
        });
      }
    } else {
      console.error("jsPDF or jsPDF.autoTable not loaded properly.");
    }

    // Logout confirmation
    const logoutButtons = [
      document.getElementById("logout-btn"),
      document.getElementById("attendance-logout-btn"),
      document.getElementById("admin-logout-btn")
    ];

    logoutButtons.forEach(btn => {
      if (btn) {
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn); // remove existing listeners
        clone.addEventListener("click", (e) => {
          e.preventDefault();
          const confirmed = confirm("Are you sure you want to logout?");
          if (confirmed) {
            if (firebase && firebase.auth) {
              firebase.auth().signOut();
            }
          }
        });
      }
    });

    // Load devices on admin panel open (device tab)
    const loadDeviceTab = document.querySelector('[data-tab="devices"]');
    if (loadDeviceTab) {
      loadDeviceTab.addEventListener("click", loadAllUserDevices);
    }
  });

  async function registerDevice(user) {
    const detector = new DeviceDetector();
    const parsed = detector.parse(navigator.userAgent);
    const deviceInfo = {
      email: user.email,
      userAgent: navigator.userAgent,
      device: parsed.device?.type || 'Unknown',
      browser: parsed.client?.name || 'Unknown',
      os: parsed.os?.name || 'Unknown',
      date: Date.now()
    };

    const userRef = firebase.database().ref(`devices/${user.uid}`);
    const snapshot = await userRef.once('value');
    const existing = snapshot.val() || {};

    const maxDevicesSnap = await firebase.database().ref("settings/deviceLimit").once("value");
    const maxDevices = maxDevicesSnap.val() || 3;

    if (Object.keys(existing).length >= maxDevices) {
      alert("Device limit reached. Please remove an old device to continue.");
      return;
    }

    await userRef.push(deviceInfo);
  }

  async function loadAllUserDevices() {
    const container = document.getElementById("user-devices-list");
    if (!container) return;
    container.innerHTML = "";

    const detector = new DeviceDetector();
    const snapshot = await firebase.database().ref("devices").once("value");
    const allDevices = snapshot.val() || {};

    for (const userId in allDevices) {
      const userDevices = allDevices[userId];
      for (const key in userDevices) {
        const data = userDevices[key];
        const parsed = detector.parse(data.userAgent || "");

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.email}</td>
          <td>${parsed.device?.type || "Unknown"}</td>
          <td>${parsed.client?.name || "Unknown"}</td>
          <td>${parsed.os?.name || "Unknown"}</td>
          <td>${formatDateToDDMMYYYY(data.date)}</td>
          <td><button class="btn btn-danger" onclick="removeDevice('${userId}', '${key}')">Remove</button></td>
        `;
        container.appendChild(row);
      }
    }
  }

  function removeDevice(userId, deviceKey) {
    firebase.database().ref(`devices/${userId}/${deviceKey}`).remove().then(() => {
      loadAllUserDevices();
    });
  }
</script>

<script>
  window.addEventListener('load', () => {
    // Wait for splash screen duration
    setTimeout(() => {
      const whatsappBtn = document.querySelector('.whatsapp-all');
      if (whatsappBtn) {
        whatsappBtn.style.display = 'flex';
      }
    }, 6300); // ⏳ 2.5 seconds splash duration (change if needed)
  });
  document.getElementById("clear-log-type").addEventListener("change", function () {
  const val = this.value;
  document.getElementById("log-email-group").style.display = val === "user" ? "block" : "none";
});

document.getElementById("clear-log-btn").addEventListener("click", function () {
  const type = document.getElementById("clear-log-type").value;
  const email = document.getElementById("clear-log-email").value.trim().toLowerCase();
  const startDate = document.getElementById("clear-start-date").value;
  const endDate = document.getElementById("clear-end-date").value;
  const logsRef = firebase.database().ref("activityLogs");

  if (!type) {
    alert("⚠️ Please select a log clear option.");
    return;
  }

  logsRef.once("value").then(snapshot => {
    const updates = {};
    const startTS = startDate ? new Date(startDate).getTime() : null;
    const endTS = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : null;

    snapshot.forEach(child => {
      const log = child.val();
      const logTime = log.timestamp || 0;

      const inDateRange = (!startTS || logTime >= startTS) && (!endTS || logTime <= endTS);
      const isUser = type === "user" && log.userEmail?.toLowerCase() === email;
      const isAdmin = type === "admin" && log.userEmail?.toLowerCase().includes("admin");
      const isAdministrator = type === "administrator" && log.userName?.toLowerCase().includes("administrator");
      const isSuperClear = type === "all" && firebase.auth().currentUser.email === "czkarthikr@gmail.com";

      if ((isUser || isAdmin || isAdministrator || isSuperClear) && inDateRange) {
        updates[child.key] = null;
      }
    });

    if (Object.keys(updates).length === 0) {
      alert("📭 No logs matched your criteria.");
      return;
    }

    if (type === "all" && firebase.auth().currentUser.email !== "czkarthikr@gmail.com") {
      alert("⛔ Only Super Admin can clear all logs!");
      return;
    }

    logsRef.update(updates).then(() => {
      alert("✅ Logs cleared successfully!");
    }).catch(err => {
      alert("❌ Error clearing logs: " + err.message);
    });
  });
});
document.getElementById("save-admin-log-setting").addEventListener("click", function () {
  const enableLogging = document.getElementById("admin-log-toggle").value === "true";
  firebase.database().ref("settings/adminLogging").set(enableLogging)
    .then(() => {
      alert("✅ Administrator logging setting updated!");
    })
    .catch((err) => {
      alert("❌ Failed to save setting: " + err.message);
    });
});
function checkCorrectionWindow() {
  const classId = classSelectorMain.value;
  const date = new Date().toISOString().split('T')[0];
  const cooldownMs = 5 * 60 * 60 * 1000;

  firebase.database().ref(`sharedAbsentees/${classId}/${date}`).once("value").then(snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const submittedAt = data.timestamp || 0;
    const now = Date.now();

    if (now - submittedAt <= cooldownMs) {
      showCorrectionPanel(data.absentees);
    } else {
      document.getElementById("correction-ui").style.display = "none";
    }
  });
}


</script>
<!-- WhatsApp Floating Button -->
<a href= "https://chat.whatsapp.com/LXYe5XlUmzGG22di9Z74eS" class="whatsapp-all" id="whatsappBtn" style="display: none;" target="_blank">
  <img src="https://img.icons8.com/color/48/000000/whatsapp--v1.png" alt="WhatsApp" />
  <span>Talk to Team</span>
</a>


</body>
</html>
