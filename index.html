<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Diya Motors</title>
    <!-- PWA manifest tags -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta name="theme-color" content="#000000">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom CSS for body and login container */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .login-container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-img {
            height: 80px;
            margin: 0 auto 1.5rem;
            display: block;
        }

        .logo-caption {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .btn-primary {
            width: 100%;
            padding: 0.85rem 1.5rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        .error-message {
            color: #ef4444;
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="login-container">
        <!-- Diya Motors Logo - Placeholder URL, replace with actual logo -->
        <img src="https://cdn.imgchest.com/files/7pjcqkbmnz7.png" alt="Diya Motors Logo" class="logo-img">
        <p class="logo-caption">Admin Panel</p>

        <div id="email-password-section">
            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter your email" autocomplete="email" class="rounded-lg">
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password"
                    class="rounded-lg">
            </div>
            <button id="login-btn" class="btn-primary rounded-lg">
                Login
                <span id="login-spinner" class="loading-spinner hidden"></span>
            </button>
            <p id="error-message" class="error-message hidden"></p>
        </div>
    </div>

    <script type="module">
        // Firebase Modular SDK v10+ imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, setPersistence, browserLocalPersistence, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js';

        // Firebase configuration - Use global variables provided by Canvas environment
        const firebaseConfig = {
            apiKey: "AIzaSyBU3K7gRzqiqQt3o9thoEpd06ReLGVmm_w",
            authDomain: "diya-hero.firebaseapp.com",
            databaseURL: "https://diya-hero-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "diya-hero",
            storageBucket: "diya-hero.firebasestorage.app",
            messagingSenderId: "455829653263",
            appId: "1:455829653263:web:5a31c65bdab2b9cee0607a",
            measurementId: "G-DZYHPLQD3F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Set Firebase Auth persistence to LOCAL
        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                console.log("✅ Auth persistence set to LOCAL");
            })
            .catch((error) => {
                console.error("⚠️ Error setting auth persistence:", error);
                // Display error message to user if persistence fails
                showErrorMessage('Failed to set up login session. Please try again.');
            });

        // DOM Elements
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        const errorMessage = document.getElementById('error-message');

        // --- Utility Functions ---

        /**
         * Sanitizes input by removing potentially harmful characters.
         * @param {string} str The input string.
         * @returns {string} The sanitized string.
         */
        function sanitizeInput(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        /**
         * Shows a friendly error message in the UI.
         * @param {string} message The message to display.
         */
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /** Hides the error message. */
        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
        }

        /**
         * Manages UI loading state (spinner and button disabled state).
         * @param {boolean} isLoading - Whether to show or hide the loader.
         */
        function setLoadingState(isLoading) {
            loginSpinner.classList.toggle('hidden', !isLoading);
            loginBtn.disabled = isLoading;
        }

        // --- Rate Limiting Logic (Bonus) ---
        const MAX_FAILED_ATTEMPTS = 5;
        const COOLDOWN_PERIOD_MS = 5 * 60 * 1000; // 5 minutes

        /**
         * Retrieves failed login attempts for a given email from localStorage.
         * Resets count if cooldown period has passed.
         * @param {string} email
         * @returns {{count: number, lastAttempt: number}}
         */
        function getFailedAttempts(email) {
            const attempts = JSON.parse(localStorage.getItem(`failedLogin_${email}`)) || { count: 0, lastAttempt: 0 };
            if (Date.now() - attempts.lastAttempt > COOLDOWN_PERIOD_MS) {
                attempts.count = 0;
            }
            return attempts;
        }

        /**
         * Records a failed login attempt for a given email.
         * @param {string} email
         */
        function recordFailedAttempt(email) {
            let attempts = getFailedAttempts(email);
            attempts.count++;
            attempts.lastAttempt = Date.now();
            localStorage.setItem(`failedLogin_${email}`, JSON.stringify(attempts));
        }

        /**
         * Resets failed login attempts for a given email.
         * @param {string} email
         */
        function resetFailedAttempts(email) {
            localStorage.removeItem(`failedLogin_${email}`);
        }

        /**
         * Checks if the given email is currently rate-limited.
         * @param {string} email
         * @returns {boolean}
         */
        function isRateLimited(email) {
            const attempts = getFailedAttempts(email);
            return attempts.count >= MAX_FAILED_ATTEMPTS && (Date.now() - attempts.lastAttempt < COOLDOWN_PERIOD_MS);
        }

        // --- Main Login Logic ---

        loginBtn.addEventListener('click', async () => {
            hideErrorMessage();
            setLoadingState(true);

            const email = sanitizeInput(emailInput.value.trim());
            const password = passwordInput.value; // Do not sanitize password, spaces can be valid

            // Basic validation
            if (!email || !password) {
                showErrorMessage('Please enter both email and password.');
                setLoadingState(false);
                return;
            }

            // Rate limiting check
            if (isRateLimited(email)) {
                const attempts = getFailedAttempts(email);
                const timeLeftMinutes = Math.ceil((COOLDOWN_PERIOD_MS - (Date.now() - attempts.lastAttempt)) / 1000 / 60);
                showErrorMessage(`Too many failed login attempts. Please try again in ${timeLeftMinutes} minutes.`);
                setLoadingState(false);
                return;
            }

            try {
                // Authenticate with email and password
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Reset failed attempts on successful login
                resetFailedAttempts(email);

                // Fetch user role from Realtime Database
                const userRef = ref(db, `users/${user.uid}/role`);
                const snapshot = await get(userRef);
                const role = snapshot.val();

                // Redirect based on role
                if (role === 'Admin' || role === 'Dev') {
                    window.location.href = "admin.html";
                } else if (role === 'BranchAdmin') { // Corrected from 'Branch'
                    window.location.href = "home.html";
                } else {
                    // If role is not recognized, sign out and show error
                    showErrorMessage('Your account does not have a valid role. Please contact support.');
                    await signOut(auth);
                    setLoadingState(false);
                }

            } catch (error) {
                // Record failed attempt for rate limiting
                recordFailedAttempt(email);

                // Display friendly error messages based on Firebase error codes
                let errorMessageText = 'Login failed. Please check your credentials.';
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential': // Newer Firebase versions might use this
                        errorMessageText = 'Invalid email or password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessageText = 'Please enter a valid email address.';
                        break;
                    case 'auth/user-disabled':
                        errorMessageText = 'Your account has been disabled. Please contact support.';
                        break;
                    case 'auth/too-many-requests':
                        const attempts = getFailedAttempts(email);
                        const timeLeftMinutes = Math.ceil((COOLDOWN_PERIOD_MS - (Date.now() - attempts.lastAttempt)) / 1000 / 60);
                        errorMessageText = `Too many failed login attempts. Please try again in ${timeLeftMinutes} minutes.`;
                        break;
                    default:
                        console.error("Login error:", error);
                        errorMessageText = 'Something went wrong. Please check your email and password, then try again.';
                        break;

                }
                showErrorMessage(errorMessageText);
                setLoadingState(false);
            }
        });

        // --- Service Worker Registration (PWA Bonus) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(reg => {
                    console.log('Service Worker registered! Scope:', reg.scope);
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        if (installingWorker) {
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New version detected!
                                        // Using a custom modal/message box instead of confirm()
                                        const reloadPrompt = document.createElement('div');
                                        reloadPrompt.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                                        reloadPrompt.innerHTML = `
                                            <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                                                <p class="mb-4 text-lg font-semibold">A new version is available. Reload now?</p>
                                                <button id="reload-yes" class="bg-blue-500 text-white px-4 py-2 rounded-md mr-2 hover:bg-blue-600">Yes</button>
                                                <button id="reload-no" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">No</button>
                                            </div>
                                        `;
                                        document.body.appendChild(reloadPrompt);

                                        document.getElementById('reload-yes').addEventListener('click', () => {
                                            window.location.reload();
                                        });
                                        document.getElementById('reload-no').addEventListener('click', () => {
                                            document.body.removeChild(reloadPrompt);
                                        });
                                    }
                                }
                            };
                        }
                    };
                }).catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
            });
        }

        // --- Auto-redirect users already logged in ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("🔁 User already logged in:", user.email || user.phoneNumber);
                try {
                    const snapshot = await get(ref(db, `users/${user.uid}/role`));
                    const role = snapshot.val();

                    if (role === 'Admin' || role === 'Dev') {
                        window.location.href = "admin.html";
                    } else if (role === 'BranchAdmin') { // Corrected from 'Branch'
                        window.location.href = "home.html";
                    } else {
                        // If role is invalid or missing, sign out the user
                        console.warn("User has invalid or missing role, signing out.");
                        await signOut(auth);
                    }
                } catch (err) {
                    console.error("Error fetching user role:", err);
                    // If there's an error fetching role, sign out for security
                    await signOut(auth);
                }
            }
        });
    </script>
    <script>
  document.addEventListener("contextmenu", function (e) {
    e.preventDefault();
  });
</script>
<script>
  document.addEventListener("keydown", function (e) {
    // Block F12
    if (e.key === "F12") {
      e.preventDefault();
    }

    // Block Ctrl+Shift+I / Ctrl+Shift+J / Ctrl+U / Ctrl+S / Ctrl+P
    if (
      (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C")) ||
      (e.ctrlKey && (e.key === "U" || e.key === "S" || e.key === "P"))
    ) {
      e.preventDefault();
    }
  });
</script>

</body>

</html>