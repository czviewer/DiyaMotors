<script>
    // Firebase configuration - REPLACE WITH YOUR OWN CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCwbK4jLFqPcb6mecLre-Vg5Wt6v1wldQM",
        authDomain: "diya-motors-tracker.firebaseapp.com",
        databaseURL: "https://diya-motors-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "diya-motors-tracker",
        storageBucket: "diya-motors-tracker.appspot.com",
        messagingSenderId: "863309961024",
        appId: "1:863309961024:web:fec4992fe3cbd23bf60ca5",
        measurementId: "G-M992F46DFD"
    };

    // Initialize Firebase
    firebase.initializeApp({
        ...firebaseConfig,
        databaseURL: "https://diya-motors-tracker-default-rtdb.asia-southeast1.firebasedatabase.app"
    });

    const auth = firebase.auth();

    // DOM Elements
    const step1Indicator = document.getElementById('step1-indicator');
    const step2Indicator = document.getElementById('step2-indicator');
    const step1Form = document.getElementById('step1-form');
    const step2Form = document.getElementById('step2-form');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const otpContainer = document.getElementById('otp-container');
    const step1Error = document.getElementById("step1Error");
    const step2Error = document.getElementById('step2Error');
    const step2Success = document.getElementById('step2-success');
    const loader = document.getElementById('loader');

    let confirmationResult;
    // window.recaptchaVerifier and window.recaptchaWidgetId will be initialized in showStep(2)

    // Function to send OTP
    function sendOtp() {
        const phone = window.trustedPhoneNumber;
        const appVerifier = window.recaptchaVerifier; // This will be set by showStep(2)

        step2Error.innerText = "";
        step2Success.innerText = "";
        showLoader(true);

        if (!phone) {
            step2Error.innerText = "Phone number not available. Please go back to Step 1.";
            showLoader(false);
            return;
        }

        if (appVerifier && appVerifier.verify) { // Ensure appVerifier exists and has verify method
             // Firebase signInWithPhoneNumber automatically handles reCAPTCHA verification
             firebase.auth().signInWithPhoneNumber(phone, appVerifier)
                .then((result) => {
                    window.confirmationResult = result;
                    otpContainer.style.display = "block";
                    sendOtpBtn.style.display = "none"; // Hide send OTP button after sending
                    step2Success.innerText = "OTP sent successfully. Please enter it below.";
                    step2Success.style.display = "block";
                    grecaptcha.reset(window.recaptchaWidgetId); // Reset reCAPTCHA after sending OTP
                })
                .catch((error) => {
                    console.error("âŒ OTP send failed:", error);
                    handleAuthError(step2Error, error);
                    grecaptcha.reset(window.recaptchaWidgetId); // Reset reCAPTCHA on failure
                })
                .finally(() => {
                    showLoader(false);
                });
        } else {
            step2Error.innerText = "reCAPTCHA is not ready. Please ensure your internet connection is stable and try again.";
            showLoader(false);
        }
    }
    window.sendOtp = sendOtp; // Make it globally accessible

    // Show different step in the UI
    function showStep(stepNumber) {
        if (stepNumber === 1) {
            step1Indicator.classList.add('active');
            step2Indicator.classList.remove('active', 'completed');
            step1Form.classList.add('active');
            step2Form.classList.remove('active');
            // Reset reCAPTCHA if coming back to step 1
            if (window.recaptchaWidgetId) {
                grecaptcha.reset(window.recaptchaWidgetId);
            }
        } else if (stepNumber === 2) {
            step1Indicator.classList.remove('active');
            step1Indicator.classList.add('completed');
            step2Indicator.classList.add('active');
            step1Form.classList.remove('active');
            step2Form.classList.add('active');

            // Initialize reCAPTCHA only when Step 2 is shown and not already initialized
            if (!window.recaptchaVerifier) {
                console.log("Initializing reCAPTCHA for step 2...");
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    size: 'normal', // 'invisible' can also be used for a less intrusive experience
                    callback: (response) => {
                        console.log("âœ… reCAPTCHA solved by user interaction or automatically.");
                        // This callback fires when the user successfully solves the reCAPTCHA.
                        // You can now proceed to send the OTP if the button was clicked
                        // and this was the last step needed.
                    },
                    'expired-callback': () => {
                        console.warn("âš ï¸ reCAPTCHA expired, resetting...");
                        grecaptcha.reset(window.recaptchaWidgetId);
                    }
                });
                window.recaptchaVerifier.render().then((widgetId) => {
                    window.recaptchaWidgetId = widgetId;
                    console.log("reCAPTCHA rendered with widget ID:", widgetId);
                }).catch(error => {
                    console.error("Error rendering reCAPTCHA:", error);
                    step2Error.innerText = "Failed to load reCAPTCHA. Please check your internet connection.";
                    step2Error.style.display = "block";
                });
            } else {
                console.log("reCAPTCHA already initialized for step 2.");
                // If recaptchaVerifier already exists, ensure it's rendered if it was previously reset.
                // This might be redundant if the container is always visible in step 2.
                // grecaptcha.render(window.recaptchaWidgetId, {
                //     sitekey: "YOUR_RECAPTCHA_SITE_KEY", // You might need to specify the site key here again if re-rendering
                //     size: 'normal',
                //     callback: (response) => { console.log("reCAPTCHA solved on re-render"); },
                //     'expired-callback': () => { grecaptcha.reset(window.recaptchaWidgetId); }
                // });
            }
            // Reset state for step 2
            otpContainer.style.display = "none";
            sendOtpBtn.style.display = "block";
            hideError(step2Error);
            hideError(step2Success);
            showLoader(false);
        }
    }
    window.showStep = showStep; // Make it globally accessible

    // Display error message
    function showError(element, message) {
        element.textContent = message;
        element.style.display = 'block';
    }

    // Hide error message
    function hideError(element) {
        element.style.display = 'none';
    }

    // Show/hide loader
    function showLoader(show) {
        loader.style.display = show ? 'block' : 'none';
    }

    // Handle Firebase authentication errors
    function handleAuthError(element, error) {
        let message = 'An error occurred. Please try again.';

        switch (error.code) {
            case 'auth/invalid-email':
                message = 'Invalid email format';
                break;
            case 'auth/user-disabled':
                message = 'This account has been disabled';
                break;
            case 'auth/user-not-found':
                message = 'User not found';
                break;
            case 'auth/wrong-password':
                message = 'Incorrect password';
                break;
            case 'auth/invalid-phone-number':
                message = 'Invalid phone number format. Please check your database entry.';
                break;
            case 'auth/invalid-verification-code':
                message = 'Invalid verification code.';
                break;
            case 'auth/too-many-requests':
                message = 'Too many attempts. Please try again later.';
                break;
            case 'auth/missing-phone-number':
                message = 'Missing phone number. Please ensure your account has a phone number registered.';
                break;
            case 'auth/web-context-unauthorized':
                message = 'Web context unauthorized. Ensure your domain is authorized in Firebase console.';
                break;
            case 'auth/captcha-check-failed':
            case 'auth/internal-error': // Often related to reCAPTCHA or network issues
                message = 'Security check failed. Please refresh the page and try again.';
                break;
            default:
                message = error.message || message;
                break;
        }
        showError(element, message);
    }

    function startLogin() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        hideError(step1Error);
        showLoader(true); // Show loader for login attempt

        if (!email || !password) {
            showError(step1Error, "Please enter both email and password.");
            showLoader(false);
            return;
        }

        console.log("ðŸ‘‰ Attempting to sign in with Email:", email);

        firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                console.log("âœ… Firebase auth success");
                const user = userCredential.user; // Get the authenticated user object
                console.log("ðŸ“¦ Fetching phone for UID:", user.uid); // Use user.uid for database lookup

                // Use the user.uid to fetch the phone number from the database
                return firebase.database().ref("users/" + user.uid).once("value");
            })
            .then(snapshot => {
                const userData = snapshot.val();
                console.log("ðŸ“„ User data from DB:", userData);

                if (!userData || !userData.phone) {
                    throw new Error("Phone number not found for this user in the database. Please ensure it's linked to this account's UID.");
                }

                const phone = userData.phone;
                window.trustedPhoneNumber = phone;

                // Mask phone number for display
                const masked = phone.length > 2 ? "xxxxxxx" + phone.slice(-2) : phone;
                document.getElementById("masked-phone").innerText = masked;

                showStep(2); // Proceed to step 2 after successfully getting phone
            })
            .catch((error) => {
                console.error("âŒ Error during login:", error);
                handleAuthError(step1Error, error); // Use handleAuthError for detailed messages
            })
            .finally(() => {
                showLoader(false); // Hide loader regardless of success or failure
            });
    }
    window.startLogin = startLogin; // Make it globally accessible

    function verifyOtp() {
        const code = document.getElementById("otp").value.trim();
        const step2Success = document.getElementById("step2-success");

        hideError(step2Error);
        hideError(step2Success);

        if (!code || code.length !== 6) {
            showError(step2Error, "Please enter a valid 6-digit OTP.");
            return;
        }

        showLoader(true);
        if (window.confirmationResult) {
            window.confirmationResult.confirm(code)
                .then((result) => {
                    step2Success.innerText = "Verification successful! Redirecting...";
                    showError(step2Success, step2Success.innerText); // Re-use showError for success messages too
                    // Optionally, you might want to sign out if this is a temporary login or manage session
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 1500);
                })
                .catch((error) => {
                    console.error("âŒ OTP verification failed:", error);
                    handleAuthError(step2Error, error);
                })
                .finally(() => {
                    showLoader(false);
                });
        } else {
            showError(step2Error, "No OTP request pending. Please click 'Send OTP' first.");
            showLoader(false);
        }
    }
    window.verifyOtp = verifyOtp; // Make it globally accessible
</script>
