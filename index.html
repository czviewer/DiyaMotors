<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diya Motors - Secure Login</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .card {
            transition: all 0.4s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            overflow: hidden;
        }

        .logo-container {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        .otp-input {
            letter-spacing: 20px;
            font-size: 1.5rem;
            padding-left: 16px;
        }

        .slide-in {
            animation: slideIn 0.5s forwards;
        }

        .fade-in {
            animation: fadeIn 0.4s forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .btn-disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .password-toggle {
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }

        .progress-bar {
            height: 4px;
            background: #3b82f6;
            animation: progress 2s linear;
            border-radius: 2px;
        }

        @keyframes progress {
            0% {
                width: 0;
            }

            100% {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="w-full max-w-md">
        <div class="card bg-white">
            <!-- Logo Header -->
            <div class="logo-container text-white text-center py-8">
                <h1 class="text-3xl font-bold flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-2" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M12 3C7.03 3 3 7.03 3 12s4.03 9 9 9 9-4.03 9-9-4.03-9-9-9zm0 16c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7-3.14 7-7 7zm1-11h-2v6h4v-2h-2V8z" />
                    </svg>
                    Diya Motors
                </h1>
                <p class="mt-2 opacity-90">Secure Enterprise Portal</p>
            </div>

            <!-- Login Form -->
            <div id="loginSection" class="p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Sign in to your account</h2>

                <form id="loginForm" class="space-y-6">
                    <!-- Email Input -->
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                        <div class="relative">
                            <input id="email" name="email" type="email" autocomplete="email" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                placeholder="you@diyamotors.com">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Password Input -->
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <input id="password" name="password" type="password" autocomplete="current-password"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition pr-10"
                                placeholder="••••••••">
                            <button type="button" id="togglePassword"
                                class="password-toggle text-gray-400 hover:text-gray-600">
                                <svg id="showIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                    <path fill-rule="evenodd"
                                        d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <svg id="hideIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z"
                                        clip-rule="evenodd" />
                                    <path
                                        d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input id="remember" name="remember" type="checkbox"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="remember" class="ml-2 block text-sm text-gray-700">Remember me</label>
                        </div>
                        <div class="text-sm">
                            <a href="#" class="font-medium text-blue-600 hover:text-blue-500">Forgot password?</a>
                        </div>
                    </div>

                    <div>
                        <button id="loginBtn" type="submit"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                            Sign in
                        </button>
                    </div>
                </form>

                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">
                        © 2023 Diya Motors. All rights reserved.
                    </p>
                </div>
            </div>

            <!-- OTP Verification Section (Initially Hidden) -->
            <div id="otpSection" class="p-8 hidden">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Verify Your Identity</h2>
                    <p class="text-gray-600 mb-6">Enter the OTP sent to your phone</p>

                    <div class="bg-blue-50 inline-flex items-center px-4 py-2 rounded-full mb-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 mr-2" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                        </svg>
                        <span id="maskedPhone" class="font-medium text-blue-700">+91 ••••••9988</span>
                    </div>
                </div>

                <form id="otpForm" class="space-y-6">
                    <!-- OTP Input -->
                    <div>
                        <label for="otp" class="block text-sm font-medium text-gray-700 mb-1">Verification Code</label>
                        <div class="relative">
                            <input id="otp" name="otp" type="text" inputmode="numeric" pattern="\d{6}" maxlength="6"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition otp-input text-center"
                                placeholder="••••••">
                        </div>
                        <p id="otpTimer" class="mt-2 text-sm text-gray-500 text-center">Resend OTP in <span
                                id="countdown">60</span> seconds</p>
                    </div>

                    <div class="flex space-x-3">
                        <button id="resendBtn" type="button" disabled
                            class="flex-1 py-3 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition btn-disabled">
                            Resend OTP
                        </button>

                        <button id="verifyBtn" type="submit"
                            class="flex-1 py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                            Verify
                        </button>
                    </div>
                </form>

                <div class="mt-6 text-center">
                    <button id="backToLogin" class="text-sm font-medium text-blue-600 hover:text-blue-500">
                        ← Back to login
                    </button>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay"
                class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden">
                <div class="text-center">
                    <div
                        class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4">
                    </div>
                    <p id="loadingText" class="text-gray-700 font-medium">Authenticating...</p>
                    <div class="w-64 mx-auto mt-4">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="mt-4"></div>
    </div>

    <script>
        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const otpSection = document.getElementById('otpSection');
        const loginForm = document.getElementById('loginForm');
        const otpForm = document.getElementById('otpForm');
        const loginBtn = document.getElementById('loginBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        const resendBtn = document.getElementById('resendBtn');
        const backToLogin = document.getElementById('backToLogin');
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        const showIcon = document.getElementById('showIcon');
        const hideIcon = document.getElementById('hideIcon');
        const maskedPhone = document.getElementById('maskedPhone');
        const otpInput = document.getElementById('otp');
        const statusMessage = document.getElementById('statusMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const countdownEl = document.getElementById('countdown');
        const otpTimer = document.getElementById('otpTimer');

        // State variables
        let currentUser = null;
        let phoneNumber = '';
        let confirmationResult = null;
        let resendTimer = null;
        let countdown = 60;

        // Initialize Firebase
        function initializeFirebase() {
            try {
                // Firebase configuration - Replace with your actual config
                // For Firebase JS SDK v7.20.0 and later, measurementId is optional
                const firebaseConfig = {
                    apiKey: "AIzaSyCwbK4jLFqPcb6mecLre-Vg5Wt6v1wldQM",
                    authDomain: "diya-motors-tracker.firebaseapp.com",
                    databaseURL: "https://diya-motors-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "diya-motors-tracker",
                    storageBucket: "diya-motors-tracker.firebasestorage.app",
                    messagingSenderId: "863309961024",
                    appId: "1:863309961024:web:fec4992fe3cbd23bf60ca5",
                    measurementId: "G-M992F46DFD"
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);

                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showError("Failed to initialize authentication service. Please try again later.");
            }
        }
        async function handleOtpVerification(e) {
            e.preventDefault();

            const otp = otpInput.value;

            if (!otp || otp.length !== 6) {
                showError("Please enter a valid 6-digit OTP");
                return;
            }

            showLoading("Verifying OTP...");
            disableButton(verifyBtn, true);

            try {
                // Verify the OTP
                const credential = firebase.auth.PhoneAuthProvider.credential(
                    confirmationResult.verificationId,
                    otp
                );

                // Sign in with phone credential
                await firebase.auth().signInWithCredential(credential);


                // Redirect to home page
                redirectToHome();
            } catch (error) {
                console.error("OTP verification error:", error);
                showError(getErrorMessage(error));
            } finally {
                hideLoading();
                disableButton(verifyBtn, false);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showError("Email and password are required.");
                return;
            }

            showLoading("Verifying credentials...");
            disableButton(loginBtn, true);

            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const uid = user.uid;

                currentUser = user;

                const zeroOtp = await checkZeroOtpFlag();

                if (zeroOtp === true) {
                    // Skip OTP
                    redirectToHome();
                } else {
                    // Fetch phone and trigger OTP
                    const phone = await fetchUserPhone(uid);
                    if (!phone) throw new Error("No phone number found for user.");

                    phoneNumber = phone;
                    maskedPhone.textContent = maskPhoneNumber(phone);
                    await sendOtp(phone);
                    switchToOtpSection();
                    countdown = 60;
                    startResendTimer();
                }
            } catch (error) {
                console.error("Login error:", error);
                showError(getErrorMessage(error));
            } finally {
                hideLoading();
                disableButton(loginBtn, false);
            }
        }
        // Initialize Firebase when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            // Attach event listeners
            loginForm.addEventListener('submit', handleLogin);
            otpForm.addEventListener('submit', handleOtpVerification);
            togglePassword.addEventListener('click', togglePasswordVisibility);
            backToLogin.addEventListener('click', goBackToLogin);
            resendBtn.addEventListener('click', handleResendOtp);
        });

        // Handle login form submission

        // Handle OTP verification

        // Handle resend OTP
        async function handleResendOtp() {
            if (!phoneNumber) return;

            showLoading("Sending new OTP...");
            disableButton(resendBtn, true);
            clearInterval(resendTimer);

            try {
                await sendOtp(phoneNumber);
                countdown = 60;
                startResendTimer();
                showMessage("New OTP sent successfully", "success");
            } catch (error) {
                console.error("Resend OTP error:", error);
                showError(getErrorMessage(error));
            } finally {
                hideLoading();
            }
        }

        // Send OTP to phone number
        async function sendOtp(phone) {
            try {
                const appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible'
                });

                confirmationResult = await firebase.auth().signInWithPhoneNumber(phone, appVerifier);
                console.log("OTP sent successfully");
            } catch (error) {
                console.error("OTP sending error:", error);
                throw error;
            }
        }

        // Fetch user role from Realtime Database
        async function fetchUserRole(uid) {
            try {
                const snapshot = await firebase.database().ref(`users/${uid}/role`).once('value');
                return snapshot.val();
            } catch (error) {
                console.error("Error fetching user role:", error);
                throw new Error("Failed to fetch user information");
            }
        }

        // Fetch user phone from Realtime Database
        async function fetchUserPhone(uid) {
            try {
                const snapshot = await firebase.database().ref(`users/${uid}/phone`).once('value');
                return snapshot.val();
            } catch (error) {
                console.error("Error fetching user phone:", error);
                throw new Error("Failed to fetch user phone information");
            }
        }

        // Check zeroOtp flag
        async function checkZeroOtpFlag() {
            try {
                const snapshot = await firebase.database().ref('settings/zeroOtp').once('value');
                return snapshot.val() === true;
            } catch (error) {
                console.error("Error checking zeroOtp flag:", error);
                return false;
            }
        }

        // Helper Functions
        function maskPhoneNumber(phone) {
            if (!phone) return '+91 ••••••••••';
            const visibleDigits = 4;
            const masked = phone.slice(0, -visibleDigits).replace(/./g, '•') + phone.slice(-visibleDigits);
            return `+91 ${masked}`;
        }

        function showLoading(message) {
            loadingText.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showMessage(message, type = 'success') {
            statusMessage.innerHTML = `
                <div class="p-3 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}">
                    ${message}
                </div>
            `;

            // Auto hide after 5 seconds
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function disableButton(button, disabled) {
            if (disabled) {
                button.disabled = true;
                button.classList.add('btn-disabled');
            } else {
                button.disabled = false;
                button.classList.remove('btn-disabled');
            }
        }

        function togglePasswordVisibility() {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            showIcon.classList.toggle('hidden', !isPassword);
            hideIcon.classList.toggle('hidden', isPassword);
        }

        function switchToOtpSection() {
            loginSection.classList.add('hidden');
            otpSection.classList.remove('hidden');
            otpSection.classList.add('fade-in');
        }

        function goBackToLogin() {
            otpSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            loginSection.classList.add('slide-in');
            clearInterval(resendTimer);
        }

        function redirectToHome() {
            showLoading("Login successful! Redirecting...");
            setTimeout(() => {
                window.location.href = 'home.html';
            }, 1500);
        }

        function startResendTimer() {
            disableButton(resendBtn, true);
            countdownEl.textContent = countdown;
            otpTimer.classList.remove('hidden');

            resendTimer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(resendTimer);
                    disableButton(resendBtn, false);
                    otpTimer.classList.add('hidden');
                }
            }, 1000);
        }

        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/invalid-verification-code':
                    return 'Invalid OTP. Please enter the correct code.';
                case 'auth/code-expired':
                    return 'OTP has expired. Please request a new one.';
                case 'auth/too-many-requests':
                    return 'Too many attempts. Please try again later.';
                case 'auth/account-exists-with-different-credential':
                    return 'This account is already associated with another login method.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }
    </script>

    <!-- Invisible reCAPTCHA container -->
    <div id="recaptcha-container"></div>
</body>

</html>
