<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Diya Motors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .login-container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-img {
            height: 80px;
            margin: 0 auto 1.5rem;
            display: block;
        }

        .logo-caption {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .btn-primary {
            width: 100%;
            padding: 0.85rem 1.5rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        .error-message {
            color: #ef4444;
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* OTP specific styles */
        .otp-input-group {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .otp-input {
            width: 45px;
            height: 55px;
            text-align: center;
            font-size: 1.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: border-color 0.2s ease;
        }

        .otp-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .otp-timer {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .resend-otp-btn {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            margin-top: 0.5rem;
        }

        .resend-otp-btn:disabled {
            color: #93c5fd;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <img src="https://cdn.imgchest.com/files/y8xcnkao8r4.png" alt="Diya Motors Logo" class="logo-img">
        <p class="logo-caption">Diya Motors Attendance System</p>

        <!-- Email/Password Login Section -->
        <div id="email-password-section">
            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter your email" autocomplete="email">
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password">
            </div>
            <button id="login-btn" class="btn-primary">
                Login
                <span id="login-spinner" class="loading-spinner hidden"></span>
            </button>
        </div>

        <!-- OTP Verification Section -->
        <div id="otp-section" class="hidden">
            <p class="text-gray-700 mb-4">A 6-digit OTP has been sent to your registered phone number.</p>
            <div class="otp-input-group">
                <input type="text" id="otp-digit-1" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-digit-2" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-digit-3" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-digit-4" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-digit-5" class="otp-input" maxlength="1" inputmode="numeric">
                <input type="text" id="otp-digit-6" class="otp-input" maxlength="1" inputmode="numeric">
            </div>
            <p id="otp-timer" class="otp-timer">Resend OTP in 60s</p>
            <button id="resend-otp-btn" class="resend-otp-btn" disabled>Resend OTP</button>
            <button id="verify-otp-btn" class="btn-primary mt-4">
                Verify OTP
                <span id="otp-spinner" class="loading-spinner hidden"></span>
            </button>
        </div>

        <div id="recaptcha-container"></div>
        <p id="error-message" class="error-message hidden"></p>
    </div>

    <script>
        // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBU3K7gRzqiqQt3o9thoEpd06ReLGVmm_w",
            authDomain: "diya-hero.firebaseapp.com",
            databaseURL: "https://diya-hero-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "diya-hero",
            storageBucket: "diya-hero.firebasestorage.app",
            messagingSenderId: "455829653263",
            appId: "1:455829653263:web:5a31c65bdab2b9cee0607a",
            measurementId: "G-DZYHPLQD3F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // DOM Elements
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const loginSpinner = document.getElementById('login-spinner');
        const errorMessage = document.getElementById('error-message');

        const emailPasswordSection = document.getElementById('email-password-section');
        const otpSection = document.getElementById('otp-section');
        const otpInputs = Array.from({ length: 6 }, (_, i) => document.getElementById(`otp-digit-${i + 1}`));
        const otpTimerDisplay = document.getElementById('otp-timer');
        const resendOtpBtn = document.getElementById('resend-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const otpSpinner = document.getElementById('otp-spinner');
        const recaptchaContainer = document.getElementById('recaptcha-container');

        let confirmationResult = null;
        let userRole = null;
        let otpTimerInterval = null;
        let emailUID = null; // To store original UID

        const OTP_TIMEOUT_SECONDS = 60;


        // --- Utility Functions ---

        /**
         * Shows an error message in the UI.
         * @param {string} message The message to display.
         */
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /**
         * Hides the error message.
         */
        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
        }

        /**
         * Shows a loading spinner and disables a button.
         * @param {HTMLElement} spinnerElement The spinner element.
         * @param {HTMLElement} buttonElement The button element to disable.
         */
        function showLoading(spinnerElement, buttonElement) {
            spinnerElement.classList.remove('hidden');
            buttonElement.disabled = true;
        }

        /**
         * Hides a loading spinner and enables a button.
         * @param {HTMLElement} spinnerElement The spinner element.
         * @param {HTMLElement} buttonElement The button element to enable.
         */
        function hideLoading(spinnerElement, buttonElement) {
            spinnerElement.classList.add('hidden');
            buttonElement.disabled = false;
        }

        /**
         * Starts the OTP resend timer.
         */
        function startOtpTimer() {
            let timeLeft = OTP_TIMEOUT_SECONDS;
            resendOtpBtn.disabled = true;
            otpTimerDisplay.textContent = `Resend OTP in ${timeLeft}s`;

            otpTimerInterval = setInterval(() => {
                timeLeft--;
                otpTimerDisplay.textContent = `Resend OTP in ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(otpTimerInterval);
                    otpTimerDisplay.textContent = 'OTP expired.';
                    resendOtpBtn.disabled = false;
                }
            }, 1000);
        }

        /**
         * Gets the current timestamp in ISO format.
         * @returns {string} Current timestamp.
         */
        function getTimestamp() {
            return new Date().toISOString();
        }

        // --- Event Listeners ---

        // Login Button Click Handler
        loginBtn.addEventListener('click', async () => {
            hideErrorMessage();
            showLoading(loginSpinner, loginBtn);

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showErrorMessage('Please enter both email and password.');
                hideLoading(loginSpinner, loginBtn);
                return;
            }

            try {
                // Step 1: Authenticate user with email and password
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                emailUID = user.uid; // ✅ Save it

                // Step 2: Fetch user data from Realtime Database
                const userRef = db.ref(`users/${user.uid}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();

                if (!userData || (!userData.role || (userData.role !== 'Admin' && userData.role !== 'Dev'))) {
                    // Access Denied: Unauthorized Role
                    showErrorMessage('Access Denied. Unauthorized Role.');

                    // Send report for restricted login attempt
                    const reportsRef = db.ref(`reports/restrictedLogins/${user.uid}`);
                    await reportsRef.push({
                        timestamp: getTimestamp(),
                        attemptedRole: userData ? userData.role : 'N/A',
                        email: email,
                        browserInfo: navigator.userAgent
                    });

                    await auth.signOut(); // Sign out the unauthorized user
                    hideLoading(loginSpinner, loginBtn);
                    return;
                }

                userRole = userData.role; // Store the validated role
                const phoneNumber = userData.phone; // Assuming 'phone' field exists in user data

                if (!phoneNumber) {
                    showErrorMessage('No phone number registered for this account. Please contact support.');
                    await auth.signOut();
                    hideLoading(loginSpinner, loginBtn);
                    return;
                }

                // Initialize reCAPTCHA Verifier
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(recaptchaContainer, {
                    'size': 'invisible', // Invisible reCAPTCHA
                    'callback': (response) => {
                        // reCAPTCHA solved, now send OTP
                        // This callback might not always fire immediately for invisible recaptcha
                        // The explicit call after render() handles this.
                    },
                    'expired-callback': () => {
                        showErrorMessage('reCAPTCHA expired. Please try again.');
                        hideLoading(loginSpinner, loginBtn);
                        // Optionally, re-render reCAPTCHA
                        window.recaptchaVerifier.render().then(function (widgetId) {
                            grecaptcha.reset(widgetId);
                        });
                    }
                });

                // Render reCAPTCHA and then explicitly call sendOtp
                await window.recaptchaVerifier.render();
                sendOtp(phoneNumber); // Explicitly call sendOtp after reCAPTCHA renders

            } catch (error) {
                console.error("Login error:", error);
                let message = 'Login failed. Please check your credentials.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = 'Invalid email or password.';
                } else if (error.code === 'auth/network-request-failed') {
                    message = 'Network error. Please check your internet connection.';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'Too many failed login attempts. Please try again later.';
                }
                showErrorMessage(message);
            } finally {
                hideLoading(loginSpinner, loginBtn); // Ensure spinner is hidden in all cases
            }
        });

        /**
         * Sends OTP to the provided phone number.
         * @param {string} phoneNumber The phone number to send OTP to.
         */
        async function sendOtp(phoneNumber) {
            try {
                showLoading(loginSpinner, loginBtn); // Keep login spinner active during OTP send
                emailPasswordSection.classList.add('hidden'); // Hide email/password section
                otpSection.classList.remove('hidden'); // Show OTP section

                // Firebase signInWithPhoneNumber
                confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);

                hideLoading(loginSpinner, loginBtn);
                startOtpTimer(); // Start OTP timer
                otpInputs[0].focus(); // Focus on first OTP input
                showErrorMessage('OTP sent to your registered phone number.');

            } catch (error) {
                console.error("Error sending OTP:", error);
                let message = 'Failed to send OTP. Please try again.';
                if (error.code === 'auth/invalid-phone-number') {
                    message = 'The provided phone number is invalid.';
                } else if (error.code === 'auth/missing-phone-number') {
                    message = 'Phone number is missing for this account.';
                } else if (error.code === 'auth/quota-exceeded') {
                    message = 'OTP sending quota exceeded. Please try again later.';
                } else if (error.code === 'auth/captcha-check-failed') {
                    message = 'reCAPTCHA verification failed. Please try again.';
                }
                showErrorMessage(message);
                hideLoading(loginSpinner, loginBtn);
                emailPasswordSection.classList.remove('hidden'); // Show email/password section again
                otpSection.classList.add('hidden'); // Hide OTP section
                // Reset reCAPTCHA if it failed
                if (window.recaptchaVerifier && window.recaptchaVerifier.reset) {
                    window.recaptchaVerifier.reset();
                }
            }
        }

        // OTP Input Navigation
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', () => {
                if (input.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (event) => {
                if (event.key === 'Backspace' && input.value.length === 0 && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
        });

        // Resend OTP Button Click Handler
        resendOtpBtn.addEventListener('click', async () => {
            hideErrorMessage();
            const email = emailInput.value.trim();
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, passwordInput.value.trim());
                const user = userCredential.user;
                const userRef = db.ref(`users/${user.uid}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                const phoneNumber = userData.phone;

                if (window.recaptchaVerifier) {
                    window.recaptchaVerifier.render().then(function (widgetId) {
                        grecaptcha.reset(widgetId); // Reset reCAPTCHA for a new challenge
                        sendOtp(phoneNumber); // Re-send OTP
                    });
                } else {
                    // This case should ideally not happen if reCAPTCHA was initialized on first login attempt
                    showErrorMessage('reCAPTCHA not initialized. Please try logging in again.');
                }
            } catch (error) {
                console.error("Error re-sending OTP:", error);
                showErrorMessage('Failed to re-send OTP. Please try again.');
            }
        });

        // Verify OTP Button Click Handler
        verifyOtpBtn.addEventListener('click', async () => {
            hideErrorMessage();
            showLoading(otpSpinner, verifyOtpBtn);

            const otp = otpInputs.map(input => input.value).join('');
            if (otp.length !== 6) {
                showErrorMessage('Please enter a 6-digit OTP.');
                hideLoading(otpSpinner, verifyOtpBtn);
                return;
            }

            if (!confirmationResult || !auth.currentUser) {
                showErrorMessage('Something went wrong. Please try logging in again.');
                hideLoading(otpSpinner, verifyOtpBtn);
                return;
            }

            try {
                // ✅ Create phone credential from OTP
                const phoneCred = firebase.auth.PhoneAuthProvider.credential(
                    confirmationResult.verificationId,
                    otp
                );

                // ✅ Re-authenticate current email user with phone OTP
                const cred = firebase.auth.PhoneAuthProvider.credential(confirmationResult.verificationId, otp);

                // Decode the phone number from the credential (if needed)
                const verifiedPhone = cred.phoneNumber || phoneNumberUsedEarlier;

                const userPhone = (await db.ref(`users/${auth.currentUser.uid}/phone`).once('value')).val();

                if (!userPhone || userPhone !== verifiedPhone) {
                    showErrorMessage("OTP does not match your registered phone number.");
                    return;
                }


                console.log("✅ OTP verified for:", auth.currentUser.uid);

                // 🚫 DO NOT create/set anything in DB
                // ✅ Just proceed to redirect if user has valid role
                const uid = auth.currentUser.uid;
                const snap = await db.ref(`users/${uid}`).once("value");
                const userData = snap.val();

                if (!userData || (userData.role !== "Admin" && userData.role !== "Dev")) {
                    showErrorMessage("Access Denied. Unauthorized role.");
                    await auth.signOut();
                    hideLoading(otpSpinner, verifyOtpBtn);
                    return;
                }

                // ✅ Redirect based on role
                if (userData.role === "Admin") {
                    window.location.href = "admin.html";
                } else {
                    window.location.href = "home.html";
                }

            } catch (error) {
                console.error("❌ OTP verification failed:", error);
                showErrorMessage("Invalid OTP. Please try again.");
            } finally {
                hideLoading(otpSpinner, verifyOtpBtn);
            }
        });


        function proceedToDashboard() {
            db.ref("users/" + auth.currentUser.uid).once("value").then((snap) => {
                const userData = snap.val();
                if (!userData || (userData.role !== "Admin" && userData.role !== "Dev")) {
                    showErrorMessage("Access Denied. Unauthorized role.");
                    return auth.signOut();
                }

                if (userData.role === "Admin") {
                    window.location.href = "admin.html";
                } else {
                    window.location.href = "home.html";
                }
            });
        }

        // Ensure reCAPTCHA container is ready on page load
        document.addEventListener('DOMContentLoaded', () => {
            // This is where reCAPTCHA will be rendered. It needs to be present in the DOM.
            // The actual rendering happens when signInWithPhoneNumber is called.
        });
    </script>
</body>

</html>
