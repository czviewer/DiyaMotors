<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Diya Motors Attendance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            background: #f3f4f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .login-container {
            max-width: 400px;
            margin: 5% auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            width: 100px;
            margin-bottom: 0.5rem;
        }

        h2 {
            font-size: 1.5rem;
            color: #1f2937;
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .spinner-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.2);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #3b82f6;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            margin-bottom: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            background-color: #10b981;
        }

        .toast.error {
            background-color: #ef4444;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="logo-container">
            <img src="https://cdn.imgchest.com/files/4nec85r2kp4.png" alt="Logo" class="logo" />
            <h2>Attendance Tracker</h2>
        </div>

        <div id="step1">
            <div class="input-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="your.email@diyamotors.com" />
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="••••••••" />
            </div>
            <button class="btn" id="loginBtn">Login</button>
        </div>

        <div id="step2" style="display: none;">
            <p style="text-align:center;">Sending OTP to <strong id="maskedPhone"></strong></p>
            <div class="input-group">
                <label>Enter OTP</label>
                <input type="text" id="otp" placeholder="Enter 6-digit code" />
            </div>
            <div id="recaptcha-container" style="margin-bottom: 1rem;"></div>
            <button class="btn" id="verifyBtn">Verify OTP</button>
        </div>
    </div>

    <div class="spinner-overlay" id="spinner">
        <div class="spinner"></div>
    </div>
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCwbK4jLFqPcb6mecLre-Vg5Wt6v1wldQM",
            authDomain: "diya-motors-tracker.firebaseapp.com",
            databaseURL: "https://diya-motors-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "diya-motors-tracker",
            storageBucket: "diya-motors-tracker.firebasestorage.app",
            messagingSenderId: "863309961024",
            appId: "1:863309961024:web:fec4992fe3cbd23bf60ca5",
            measurementId: "G-M992F46DFD"
        };
        firebase.initializeApp(firebaseConfig);

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const otpInput = document.getElementById('otp');
        const verifyBtn = document.getElementById('verifyBtn');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const spinner = document.getElementById('spinner');
        const toastContainer = document.getElementById('toastContainer');
        const maskedPhone = document.getElementById('maskedPhone');

        let recaptchaVerifier, confirmationResult;

        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-info-circle"></i>${msg}`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showSpinner(show) {
            spinner.style.display = show ? 'flex' : 'none';
        }

        loginBtn.onclick = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) return showToast('Enter email & password', 'error');
            showSpinner(true);

            try {
                const { user } = await firebase.auth().signInWithEmailAndPassword(email, password);
                const uid = user.uid;
                const snap = await firebase.database().ref(`users/${uid}/phone`).once('value');
                const phone = snap.val();
                if (!phone) throw new Error('Phone number not found');

                maskedPhone.textContent = `+91 ******${phone.slice(-4)}`;
                step1.style.display = 'none';
                step2.style.display = 'block';

                setTimeout(async () => {
                    try {
                        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container');
                        await recaptchaVerifier.render();
                        confirmationResult = await firebase.auth().signInWithPhoneNumber(phone, recaptchaVerifier);
                        showToast('OTP sent.');
                        showSpinner(false); // ✅ Hides the infinite spinner

                    } catch (e) {
                        showToast('reCAPTCHA/OTP failed', 'error');
                        firebase.auth().signOut();
                        step1.style.display = 'block';
                        step2.style.display = 'none';
                    } finally {
                        showSpinner(false);
                    }
                }, 300);

            } catch (e) {
                showToast(e.message || 'Login failed', 'error');
                firebase.auth().signOut();
                showSpinner(false);
            }
        };

        verifyBtn.onclick = async () => {
            const code = otpInput.value.trim();
            if (code.length !== 6) return showToast('Enter valid 6-digit OTP', 'error');
            showSpinner(true);
            try {
                await confirmationResult.confirm(code);
                showToast('Login success');
                setTimeout(() => (window.location.href = 'home.html'), 1500);
            } catch {
                showToast('Invalid OTP', 'error');
            } finally {
                showSpinner(false);
            }
        };

        firebase.auth().signOut();
    </script>
</body>

</html>
