<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>



    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        const { jsPDF } = window.jspdf;

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import {
            getAuth,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInAnonymously
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';

        import {
            getDatabase,
            ref,
            get,
            set,
            update,
            remove,
            push
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js';

        import {
            getFunctions,
            httpsCallable
        } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-functions.js';





        const firebaseConfig = {
            apiKey: "AIzaSyBU3K7gRzqiqQt3o9thoEpd06ReLGVmm_w",
            authDomain: "diya-hero.firebaseapp.com",
            databaseURL: "https://diya-hero-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "diya-hero",
            storageBucket: "diya-hero.firebasestorage.app",
            messagingSenderId: "455829653263",
            appId: "1:455829653263:web:5a31c65bdab2b9cee0607a",
            measurementId: "G-DZYHPLQD3F"
        };


        // Initialize app
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Expose to window for console use
        window.db = db;
        window.auth = auth;
        window.ref = ref;
        window.get = get;


        const functions = getFunctions(app, 'asia-southeast1'); // Specify the region of your Cloud Function
        const dateInput = document.getElementById("datePicker");
        window.dateInput = dateInput;
        // Update Live Clock display
        function updateLiveClock() {
            const now = new Date(); // Use real system time
            const timeStr = now.toLocaleTimeString("en-IN", { hour12: true });
            const clockEl = document.getElementById("live-clock");
            if (clockEl) {
                clockEl.textContent = timeStr;
            }
        }

        // Start the live clock interval after initial load
        setInterval(updateLiveClock, 1000);

        // Global variable to store user role and name
        let currentUserRole = null;
        let currentUserName = "Unknown User";
        let currentEmployeeRecords = []; // Stores records for Employee Records tab for export
        let allHolidays = {}; // Global variable to store all fetched holidays

        // Function to show custom modal
        function showModal(message, onConfirm = null, isError = false, title = null) {
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalTitle = document.getElementById('modal-title');
            const singleHolidayDateInput = document.getElementById("single-holiday-date");
            const singleHolidayReasonInput = document.getElementById("single-holiday-reason");



            modalTitle.textContent = title || (isError ? "Error" : "Confirmation");
            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center

            // Reset button states and text
            modalConfirmBtn.classList.remove('hidden');
            modalCancelBtn.classList.remove('hidden');
            modalConfirmBtn.textContent = 'Confirm';
            modalCancelBtn.textContent = 'Cancel';

            if (onConfirm) {
                modalConfirmBtn.onclick = () => {
                    modal.style.display = 'none';
                    onConfirm(true);
                };
                modalCancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    onConfirm(false);
                };
            } else {
                // If no onConfirm, it's an alert-like modal, only show OK button
                modalConfirmBtn.textContent = 'OK';
                modalConfirmBtn.onclick = () => {
                    modal.style.display = 'none';
                };
                modalCancelBtn.classList.add('hidden'); // Hide cancel button
            }
        }

        function showLoadingModal(message) {
            const modal = document.getElementById('loading-modal'); // Assuming you have a loading modal
            const loadingMessageEl = document.getElementById('loading-message');
            loadingMessageEl.textContent = message;
            modal.style.display = 'flex';
        }

        function hideLoadingModal() {
            const modal = document.getElementById('loading-modal');
            modal.style.display = 'none';
        }

        // Tab functionality (main tabs)
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const editTabButton = document.getElementById('edit-tab-button'); // Get the employee management tab button
        const branchManagementTabButton = document.getElementById('branch-management-tab-button'); // Get the new branch management tab button
        const holidayManagerTabButton = document.getElementById('holiday-manager-tab-button'); // Get the new holiday manager tab button

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-tab');

                // Check role for 'edit' tab
                if (target === 'edit' && currentUserRole !== 'Admin' && currentUserRole !== 'Dev') { // Corrected roles
                    showModal("You do not have permission to access Employee Management.", null, true);
                    // Prevent switching to the tab if unauthorized
                    return;
                }

                // Check role for 'branch-management' tab
                if (target === 'branch-management' && currentUserRole !== 'Admin' && currentUserRole !== 'Dev') {
                    showModal("You do not have permission to access Branch & Subdivision Management.", null, true);
                    return;
                }

                // Check role for 'holiday-manager' tab
                if (target === 'holiday-manager' && currentUserRole !== 'Admin' && currentUserRole !== 'Dev') {
                    showModal("You do not have permission to access Holiday Manager.", null, true);
                    return;
                }

                tabButtons.forEach(b => {
                    b.classList.remove('text-blue-700', 'border-blue-700', 'font-semibold');
                    b.classList.add('text-gray-700');
                });

                btn.classList.add('text-blue-700', 'border-b-2', 'border-blue-700', 'font-semibold');

                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${target}`).classList.remove('hidden');

                if (target === 'summary') {
                    populateDistrictDropdown();
                }


                // If switching to the edit tab, ensure the first sub-tab is active
                if (target === 'edit') {
                    const firstEditTabButton = document.querySelector('.edit-tab-button[data-edit-tab="add-employee"]');
                    if (firstEditTabButton) {
                        firstEditTabButton.click(); // Simulate a click to activate the first sub-tab
                    }
                }
                if (target === 'signup-requests') {
                    loadSignupRequests(); // Ensures it fetches latest list
                }

                // If switching to branch management tab, populate it
                if (target === 'branch-management') {
                    populateBranchesAndSubdivisions();
                }
                // If switching to holiday manager tab, populate it
                if (target === 'holiday-manager') {
                    populateHolidaysList();
                }
            });
        });
        const summaryDistrict = document.getElementById("summary-district");
        const summaryBranch = document.getElementById("summary-branch");
        const summarySubdivision = document.getElementById("summary-subdivision");
        async function populateDistrictDropdown() {
            summaryDistrict.innerHTML = `<option value="All">All Districts</option>`;
            try {
                const snapshot = await get(ref(db, "districts"));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    for (const districtName in data) {
                        const option = document.createElement("option");
                        option.value = districtName;
                        option.textContent = districtName;
                        summaryDistrict.appendChild(option);
                    }
                }
            } catch (err) {
                console.error("Failed to load districts:", err);
            }
        }
        summaryDistrict.addEventListener("change", async () => {
            const selectedDistrict = summaryDistrict.value;
            summaryBranch.innerHTML = `<option value="All">All Branches</option>`;
            summarySubdivision.innerHTML = `<option value="All">All Subdivisions</option>`;
            summarySubdivision.disabled = true;

            if (selectedDistrict === "All") return;

            try {
                const snap = await get(ref(db, `districts/${selectedDistrict}/branches`));
                if (snap.exists()) {
                    const branches = snap.val();
                    Object.keys(branches).forEach(branchKey => {
                        const option = document.createElement("option");
                        option.value = branchKey;
                        option.textContent = branchKey;
                        summaryBranch.appendChild(option);
                    });
                }
            } catch (err) {
                console.error("Failed to load branches for district:", err);
            }
        });
        summaryBranch.addEventListener("change", async () => {
            const selectedBranch = summaryBranch.value;
            summarySubdivision.innerHTML = `<option value="All">All Subdivisions</option>`;
            summarySubdivision.disabled = true;

            if (selectedBranch === "All") return;

            try {
                const snap = await get(ref(db, `branches/${selectedBranch}/subdivisions`));
                if (snap.exists()) {
                    const subs = snap.val();
                    Object.keys(subs).forEach(subKey => {
                        const option = document.createElement("option");
                        option.value = subKey;
                        option.textContent = subKey;
                        summarySubdivision.appendChild(option);
                    });
                    summarySubdivision.disabled = false;
                }
            } catch (err) {
                console.error("Failed to load subdivisions:", err);
            }
        });
        populateDistrictDropdown();



        // Tab functionality (edit sub-tabs)
        const editTabButtons = document.querySelectorAll('.edit-tab-button');
        const editTabContents = document.querySelectorAll('.edit-tab-content');

        editTabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-edit-tab');

                editTabButtons.forEach(b => {
                    b.classList.remove('text-blue-700', 'border-blue-700', 'font-semibold');
                    b.classList.add('text-gray-700');
                });

                btn.classList.add('text-blue-700', 'border-b-2', 'border-blue-700', 'font-semibold');

                editTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`edit-tab-${target}`).classList.remove('hidden');
            });
        });

        // Auth and Role Logic for dropdowns
        onAuthStateChanged(auth, async user => {


            // If a user is now available (either logged in or anonymously signed in)
            if (user) {
                // Fetch user role and name from DB if not already set by temporary assignment
                if (!currentUserRole || !currentUserName) {
                    try {
                        const userRoleSnap = await get(ref(db, `users/${user.uid}/role`));
                        currentUserRole = userRoleSnap.val();
                        const userNameSnap = await get(ref(db, `users/${user.uid}/name`));
                        currentUserName = userNameSnap.val() || user.email || user.uid;
                    } catch (error) {
                        console.error("Error fetching user role:", error);
                        currentUserRole = 'user'; // Default to user if error
                        currentUserName = user.email || user.uid;
                    }
                }

                // Update user badge in header
                const userBadgeEl = document.getElementById('user-badge');
                const userNameEl = document.getElementById('user-name');
                const branchInfoEl = document.getElementById('branch-info');
                const logoutBtn = document.getElementById('logout-btn');
                const homeScreenBtn = document.getElementById('home-screen-btn');// Get admin panel button
                const activityLogsBtn = document.getElementById('activity-logs-btn');
                const topBar = document.getElementById('top-bar'); // Get the top-bar element

                if (userNameEl) userNameEl.textContent = currentUserName;
                // Changed this line to display the role clearly in the branch-info section for Admin Panel
                if (branchInfoEl) branchInfoEl.textContent = `Role: ${currentUserRole}`;
                if (userBadgeEl) {
                    userBadgeEl.classList.remove('user-badge-dev', 'user-badge-admin', 'user-badge-branch');
                    if (currentUserRole === 'Dev') {
                        userBadgeEl.classList.add('user-badge-dev');
                    } else if (currentUserRole === 'Admin') {
                        userBadgeEl.classList.add('user-badge-admin');
                    } else if (currentUserRole === 'Branch') {
                        userBadgeEl.classList.add('user-badge-branch');
                    }
                }

                // Apply top bar styling based on role
                if (topBar) {
                    topBar.classList.remove("top-bar-dev", "top-bar-admin", "top-bar-branch");
                    if (currentUserRole === "Dev") {
                        topBar.classList.add("top-bar-dev");
                    } else if (currentUserRole === "Admin") {
                        topBar.classList.add("top-bar-admin");
                    } else if (currentUserRole === "Branch") {
                        topBar.classList.add("top-bar-branch");
                    }
                }

                // Show/hide Admin Panel button (it's already hidden by default in header.html, but ensure logic)
                if (homeScreenBtn) {
                    if (currentUserRole === 'Admin' || currentUserRole === 'Dev') {
                        homeScreenBtn.style.display = 'inline-block';
                    } else {
                        homeScreenBtn.style.display = 'none';
                    }
                }

                // Hide edit, branch-management, and holiday-manager tabs if not Admin/Dev
                if (currentUserRole !== 'Admin' && currentUserRole !== 'Dev') {
                    editTabButton.classList.add('hidden');
                    branchManagementTabButton.classList.add('hidden');
                    holidayManagerTabButton.classList.add('hidden'); // Hide holiday manager tab
                } else {
                    editTabButton.classList.remove('hidden');
                    branchManagementTabButton.classList.remove('hidden');
                    holidayManagerTabButton.classList.remove('hidden'); // Show holiday manager tab
                }

                // Show/hide Activity Logs button based on role
                if (activityLogsBtn) {
                    if (currentUserRole === 'Admin' || currentUserRole === 'Dev') {
                        activityLogsBtn.style.display = 'block';
                    } else {
                        activityLogsBtn.style.display = 'none';
                    }
                }

                // Logout button logic
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        showModal("Are you sure you want to log out?", async (confirm) => {
                            if (confirm) {
                                try {
                                    await signOut(auth);
                                    window.location.href = "index.html"; // Redirect to login page
                                } catch (error) {
                                    console.error("Logout failed:", error);
                                    showModal("Logout failed: " + error.message, null, true);
                                }
                            }
                        });
                    });
                }
                // Home Screen button logic (newly added)
                if (homeScreenBtn) {
                    homeScreenBtn.addEventListener('click', () => {
                        window.location.href = 'home.html'; // Redirect to the home screen
                    });
                }
                // Activity Logs button logic
                if (activityLogsBtn) {
                    activityLogsBtn.addEventListener('click', () => {
                        window.location.href = 'activitylogs.html'; // Open in same tab
                    });
                }

            } else {
                // Should ideally not be reached due to anonymous sign-in, but as a fallback
                window.location.href = "index.html";
            }
        });

        // Helper to format time (handles timestamps or ISO strings)
        function formatTime(timeValue) {
            if (timeValue === null || timeValue === undefined) return 'Not Marked';
            let dateObj;
            if (typeof timeValue === 'number') { // If it's a timestamp
                dateObj = new Date(timeValue);
            } else if (typeof timeValue === 'string') { // If it's a time string like "HH:MM:SS" or ISO string
                // Try to parse as ISO string first
                dateObj = new Date(timeValue);
                // If parsing as ISO string results in invalid date, try as time string (assuming 24hr format for parsing)
                if (isNaN(dateObj.getTime())) {
                    // Attempt to parse as "HH:MM:SS" by prepending a dummy date
                    dateObj = new Date(`2000-01-01T${timeValue}`);
                }
            } else {
                return 'Not Marked';
            }

            if (isNaN(dateObj.getTime())) {
                return 'Not Marked'; // Invalid date
            }
            return dateObj.toLocaleTimeString("en-IN", { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        // Helper function to get employee details (handles both regular and special employees)
        async function getEmployeeDetails(employeeId, branchId = null, subdivisionId = null) {
            // 1️⃣ Special Employees
            const specialEmpSnap = await get(ref(db, `specialEmployees/${employeeId}`));
            if (specialEmpSnap.exists()) {
                const empData = specialEmpSnap.val();
                return { ...empData, id: employeeId, branch: 'N/A', subdivision: 'Special', isSpecial: true };
            }

            // 2️⃣ Direct branch/subdivision (if passed)
            if (branchId && subdivisionId) {
                const regularEmpSnap = await get(ref(db, `branches/${branchId}/subdivisions/${subdivisionId}/employees/${employeeId}`));
                if (regularEmpSnap.exists()) {
                    const empData = regularEmpSnap.val();
                    return { ...empData, id: employeeId, branch: branchId, subdivision: subdivisionId, isSpecial: false };
                }
            }

            // 3️⃣ Fallback: scan all branches/subdivisions
            const branchesSnap = await get(ref(db, 'branches'));
            if (branchesSnap.exists()) {
                for (const branchKey of Object.keys(branchesSnap.val())) {
                    const subdivisionsSnap = await get(ref(db, `branches/${branchKey}/subdivisions`));
                    if (subdivisionsSnap.exists()) {
                        for (const subKey of Object.keys(subdivisionsSnap.val())) {
                            const empSnap = await get(ref(db, `branches/${branchKey}/subdivisions/${subKey}/employees/${employeeId}`));
                            if (empSnap.exists()) {
                                const empData = empSnap.val();
                                return { ...empData, id: employeeId, branch: branchKey, subdivision: subKey, isSpecial: false };
                            }
                        }
                    }
                }
            }

            // 4️⃣ Last chance: check employee_ids → uid → users
            const idToUidSnap = await get(ref(db, `employee_ids/${employeeId}`));
            if (idToUidSnap.exists()) {
                const uid = idToUidSnap.val();
                const userSnap = await get(ref(db, `users/${uid}`));
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    return { ...userData, id: employeeId, uid, isSpecial: false };
                }
            }

            return null; // Final fallback failed
        }

        async function evaluateAttendanceStatus(attendance, isHoliday, holidayReason, currentDayOfWeek, leaveData) {
            let overallStatus = 'Absent';
            let leaveTaken = 0;
            let remarks = [];
            let isLate = false;
            let isInvalid = false;
            let workedOnHoliday = false;

            const morningMarked = attendance?.morning === true;
            const afternoonStatus = attendance?.afternoon || null;
            const anExitMarked = attendance?.anExit === true;
            const anExitTimeDate = attendance?.anExitTime ? new Date(attendance.anExitTime) : null;
            const isExitAtOrAfter3PM = anExitTimeDate && anExitTimeDate.getHours() + (anExitTimeDate.getTimezoneOffset() / -60) >= 15;


            // --- ⛔ Auto-holiday for Sunday ---
            if (currentDayOfWeek === 0) {
                isHoliday = true;
                holidayReason = "Weekly Off - Sunday";
            }

            const ignoreLeave = isHoliday;

            // 🔁 Late coming
            if (morningMarked && attendance?.morningTime) {
                const morningDate = new Date(attendance.morningTime);
                const h = morningDate.getHours();
                const m = morningDate.getMinutes();
                if (h > 9 || (h === 9 && m > 35)) {
                    remarks.push("LATE COMING");
                    isLate = true;
                }
            }

            // ✅ Exit handling (prevent contradictory remarks)
            if (anExitMarked) {
                if (!morningMarked && !afternoonStatus) {
                    overallStatus = "Invalid Entry";
                    isInvalid = true;
                    remarks.push("⚠️ Exit without Entry");
                } else if (attendance?.anExitTime) {
                    remarks.push("Exit Marked");
                } else {
                    remarks.push("Exit Marked (No Time)");
                }
            } else {
                remarks.push("Exit Not Marked");
            }

            // ✅ CASE 1: No punch, leave exists, and NOT holiday
            if (!attendance && leaveData && !ignoreLeave) {
                if (leaveData.type === 'full') {
                    overallStatus = 'Leave (Full Day)';
                    leaveTaken = 1.0;
                } else if (leaveData.type === 'half') {
                    overallStatus = 'Leave (Half Day)';
                    leaveTaken = 0.5;
                }
                return { overallStatus, leaveTaken, remarks: [...new Set(remarks)], isLate, isInvalid, workedOnHoliday };
            }

            // ✅ CASE 2: Holiday logic (worked or not)
            if (isHoliday) {
                const hasWorked =
                    attendance?.morning === true ||
                    attendance?.afternoon === 'Enters' ||
                    (attendance?.anExitTime && attendance.anExitTime !== 'Not Marked');

                if (hasWorked) {
                    remarks.push("Worked on Holiday");
                    workedOnHoliday = true;
                    overallStatus = `Holiday (${holidayReason})`;
                } else {
                    overallStatus = `Holiday (${holidayReason})`;
                }

                return { overallStatus, leaveTaken: 0, remarks: [...new Set(remarks)], isLate, isInvalid, workedOnHoliday };
            }

            // ✅ CASE 3: Regular attendance evaluation
            if (morningMarked) {
                if (anExitMarked && isExitAtOrAfter3PM) {
                    // Exit after 3 PM = Full Day regardless of afternoon log
                    overallStatus = 'Full Day';
                } else if (afternoonStatus === 'Leaves') {
                    overallStatus = 'Half Day';
                    leaveTaken = 0.5;
                    remarks.push("Left Early");
                } else if (afternoonStatus === 'Enters') {
                    overallStatus = 'Invalid Entry';
                    leaveTaken = 1.0;
                    isInvalid = true;
                    remarks.push("Invalid: Came twice");
                } else {
                    // Default fallback (no afternoon and no late exit) = Half Day
                    overallStatus = 'Half Day';
                    leaveTaken = 0.5;
                }
            }


            else {
                if (afternoonStatus === 'Enters') {
                    if (anExitMarked) {
                        overallStatus = 'Half Day';
                        leaveTaken = 0.5;
                        remarks.push("Came Afternoon Only");
                    } else {
                        overallStatus = 'Absent';
                        leaveTaken = 1.0;
                        remarks.push("Joined but no Exit — Marked Absent");
                    }
                } else if (afternoonStatus === 'Leaves') {
                    overallStatus = 'Invalid Entry';
                    leaveTaken = 1.0;
                    isInvalid = true;
                    remarks.push("Invalid: Leaves w/o Morning");
                } else {
                    overallStatus = 'Absent';
                    leaveTaken = 1.0;
                }
            }

            // ✅ Prevent any leave being counted on holiday/Sunday
            if (ignoreLeave) {
                leaveTaken = 0;
                remarks.push("Leave ignored on Holiday");
            }

            // 🚀 Ensure no duplicate/contradictory remarks
            return { overallStatus, leaveTaken, remarks: [...new Set(remarks)], isLate, isInvalid, workedOnHoliday };

            console.log("DEBUG exitTime:", attendance?.anExitTime);
            console.log("DEBUG UTC hour:", anExitTimeDate?.getHours());
            console.log("DEBUG IST hour:", new Date(anExitTimeDate.toLocaleString("en-US", { timeZone: "Asia/Kolkata" })).getHours());
            console.log("DEBUG isExitAtOrAfter3PM:", isExitAtOrAfter3PM);
            console.log("DEBUG Final Status:", overallStatus);

        }

        // --- Dropdowns for Employee Records Tab ---
        const recordBranchDropdown = document.getElementById("record-branch");
        const recordSubdivisionDropdown = document.getElementById("record-subdivision");
        const recordsTableBody = document.getElementById("records-table-body");
        const toggleTimesCheckbox = document.getElementById("toggle-times");

        // Get table headers for dynamic visibility
        const recordsTableHeaders = {
            'Enter/Leave Time': document.querySelector('#records-thead th:nth-child(7)'),
            'Branch': document.querySelector('#records-thead th:nth-child(3)'),
            'Subdivision': document.querySelector('#records-thead th:nth-child(4)')
        };

        // Populate Branch dropdown for Employee Records Tab
        get(ref(db, "branches"))
            .then(snap => {
                const branchesObj = snap.val() || {};
                recordBranchDropdown.innerHTML = `<option value="All">All</option>`;
                Object.keys(branchesObj).forEach(branchKey => {
                    const label = branchKey.charAt(0).toUpperCase() + branchKey.slice(1);
                    recordBranchDropdown.innerHTML += `<option value="${branchKey}">${label}</option>`;
                });
            })
            .catch(err => console.error("Error loading branches for record tab:", err));

        // When Branch is selected for Employee Records Tab, populate Subdivision
        recordBranchDropdown.addEventListener("change", () => {
            const selBranch = recordBranchDropdown.value;
            recordSubdivisionDropdown.innerHTML = `<option value="All">All</option>`;
            if (selBranch === "All") {
                recordSubdivisionDropdown.disabled = true;
            } else {
                get(ref(db, `branches/${selBranch}/subdivisions`))
                    .then(snap => {
                        const subsObj = snap.val() || {};
                        Object.keys(subsObj).forEach(subKey => {
                            const label = subKey.charAt(0).toUpperCase() + subKey.slice(1);
                            recordSubdivisionDropdown.innerHTML += `<option value="${subKey}">${label}</option>`;
                        });
                        recordSubdivisionDropdown.disabled = false;
                    })
                    .catch(err => console.error("Error loading subdivisions for record tab:", err));
            }
            // Re-render table to apply column visibility changes
            renderRecordsTable(currentEmployeeRecords);
        });

        recordSubdivisionDropdown.addEventListener("change", () => {
            // Re-render table to apply column visibility changes
            renderRecordsTable(currentEmployeeRecords);
        });

        toggleTimesCheckbox.addEventListener("change", () => {
            // Re-render table to apply column visibility changes
            renderRecordsTable(currentEmployeeRecords);
        });

        // Function to fetch all holidays within a date range
        async function fetchHolidays(fromDate, toDate) {
            const holidays = {};
            const holidaysRef = ref(db, 'holidays');
            const snapshot = await get(holidaysRef);
            if (snapshot.exists()) {
                snapshot.forEach(childSnap => {
                    const date = childSnap.key; // date is in yyyy-mm-dd format
                    const holidayData = childSnap.val();
                    const holidayDate = new Date(date);

                    // Check if the holiday falls within the requested date range
                    if (holidayDate >= fromDate && holidayDate <= toDate) {
                        holidays[date] = holidayData;
                    }
                });
            }
            return holidays;
        }

        function formatReadableTime(isoString) {
            if (!isoString) return "Not Marked";
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return "Invalid Time";
            return date.toLocaleTimeString("en-IN", {
                hour: "2-digit",
                minute: "2-digit",
                hour12: true,
                timeZone: "Asia/Kolkata"
            });
        }




        // --- Load Records Logic for Employee Records Tab (rewritten for vertical layout) ---
        document.getElementById("load-records-btn").addEventListener("click", async () => {
            const selectedBranch = recordBranchDropdown.value;
            const selectedSubdivision = recordSubdivisionDropdown.value;
            const fromDateStr = document.getElementById("record-from").value;
            const toDateStr = document.getElementById("record-to").value;
            const showTimes = toggleTimesCheckbox.checked;

            recordsTableBody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-4">Loading records...</td></tr>';
            currentEmployeeRecords = []; // Clear for new export

            if (!fromDateStr || !toDateStr) {
                showModal("Please select both 'From' and 'To' dates.", null, true);
                recordsTableBody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-4">Select filters and click "Load All Records" to view.</td></tr>';
                return;
            }

            const fromDate = new Date(fromDateStr);
            const toDate = new Date(toDateStr);

            if (fromDate > toDate) {
                showModal("From date cannot be after To date.", null, true);
                recordsTableBody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500 py-4">Select filters and click "Load All Records" to view.</td></tr>';
                return;
            }

            let allEmployees = {}; // Stores all employees to iterate through
            let fetchedRecords = [];

            try {
                // Fetch all holidays for the period
                const holidays = await fetchHolidays(fromDate, toDate);

                // First, get all employees based on filters
                if (selectedBranch === "All") {
                    const branchesSnap = await get(ref(db, "branches"));
                    for (const branchKey in (branchesSnap.val() || {})) {
                        const branchData = branchesSnap.val()[branchKey];
                        for (const subKey in (branchData.subdivisions || {})) {
                            if (selectedSubdivision === "All" || subKey === selectedSubdivision) {
                                const employeesInSub = branchData.subdivisions[subKey].employees || {};
                                for (const empId in employeesInSub) {
                                    allEmployees[empId] = { name: employeesInSub[empId].name, branch: branchKey, subdivision: subKey, isSpecial: false };
                                }
                            }
                        }
                    }
                } else {
                    const branchData = (await get(ref(db, `branches/${selectedBranch}`))).val() || {};
                    for (const subKey in (branchData.subdivisions || {})) {
                        if (selectedSubdivision === "All" || subKey === selectedSubdivision) {
                            const employeesInSub = branchData.subdivisions[subKey].employees || {};
                            for (const empId in employeesInSub) {
                                allEmployees[empId] = { name: employeesInSub[empId].name, branch: selectedBranch, subdivision: subKey, isSpecial: false };
                            }
                        }
                    }
                }

                // Add special employees if "All" branch/subdivision is selected or if no branch/subdivision is selected (meaning it's a global search)
                if (selectedBranch === "All" || selectedSubdivision === "All") {
                    const specialEmployeesSnap = await get(ref(db, "specialEmployees"));
                    for (const empId in (specialEmployeesSnap.val() || {})) {
                        allEmployees[empId] = { name: specialEmployeesSnap.val()[empId].name, branch: 'N/A', subdivision: 'Special', isSpecial: true };
                    }
                }

                for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
                    // ✅ Build currentDate from the loop variable
                    const year = String(d.getFullYear());
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const currentDate = `${year}-${month}-${day}`; // YYYY-MM-DD format

                    const hierarchy = {
                        [year]: {
                            [month]: {
                                [day]: {}
                            }
                        }
                    };
                    console.log(hierarchy);

                    const currentDayOfWeek = d.getDay(); // Use loop variable d
                    const isHoliday = holidays[currentDate] ? true : false;
                    const holidayReason = holidays[currentDate]?.reason || '';

                    for (const empId in allEmployees) {
                        const empDetails = allEmployees[empId];
                        let attendance = null;
                        let leaveData = null;

                        // 🔑 Build attendance path with new hierarchy
                        const attendancePath = empDetails.isSpecial
                            ? `attendance/${year}/${month}/${day}/${empId}`
                            : `attendance/${year}/${month}/${day}/${empDetails.branch}/${empDetails.subdivision}/${empId}`;

                        const attendanceSnap = await get(ref(db, attendancePath));
                        attendance = attendanceSnap.val();

                        // Leave path stays YYYY-MM-DD
                        const leaveSnap = await get(ref(db, `leaveLogs/${empId}/${currentDate}`));
                        leaveData = leaveSnap.val();

                        if (!attendance && !leaveData && !isHoliday) continue;

                        const evaluationResult = await evaluateAttendanceStatus(
                            attendance,
                            isHoliday,
                            holidayReason,
                            currentDayOfWeek,
                            leaveData
                        );

                        let morningStatusDisplay = '❌';
                        if (attendance?.morning === true) morningStatusDisplay = '✅';
                        else if (leaveData?.type) morningStatusDisplay = 'N/A';

                        let afternoonStatusDisplay = attendance?.afternoon || (leaveData?.type ? 'N/A' : 'None');

                        let enterLeaveParts = [];
                        if (showTimes && attendance) {
                            if (attendance.morningTime) enterLeaveParts.push(`Morning: ${formatTime(attendance.morningTime)}`);
                            if (attendance.anEnterTime) enterLeaveParts.push(`AN Enter: ${formatTime(attendance.anEnterTime)}`);
                            if (attendance.anLeaveTime) enterLeaveParts.push(`AN Leave: ${formatTime(attendance.anLeaveTime)}`);
                            if (attendance.anExitTime) enterLeaveParts.push(`Exit: ${formatTime(attendance.anExitTime)}`);
                        }
                        let enterLeaveTime = enterLeaveParts.length ? enterLeaveParts.join("<br>") : "Not Marked";

                        const enterTime = attendance?.morningTime || (attendance?.afternoon === "Enters" ? attendance?.anTime : null);
                        const exitTime = attendance?.anExitTime || (attendance?.afternoon === "Leaves" ? attendance?.anTime : null);

                        fetchedRecords.push({
                            date: currentDate,
                            employeeName: empDetails.name || empId,
                            branch: empDetails.branch,
                            subdivision: empDetails.subdivision,
                            morning: morningStatusDisplay,
                            morningTime: attendance?.morningTime || null,
                            afternoon: afternoonStatusDisplay,
                            enterTime,
                            exitTime,
                            status: evaluationResult.overallStatus,
                            remarks: evaluationResult.remarks,
                            isLate: evaluationResult.isLate,
                            isInvalid: evaluationResult.isInvalid,
                            workedOnHoliday: evaluationResult.workedOnHoliday,
                            holidayWorked: isHoliday && evaluationResult.workedOnHoliday === true,
                            isHoliday,
                            holidayReason
                        });
                    }
                }


                // Sort records by date, then by employee name
                fetchedRecords.sort((a, b) => {
                    const dateComparison = new Date(a.date) - new Date(b.date);
                    if (dateComparison !== 0) {
                        return dateComparison;
                    }
                    return a.employeeName.localeCompare(b.employeeName);
                });

                currentEmployeeRecords = fetchedRecords; // Store for export

                renderRecordsTable(fetchedRecords);

            } catch (error) {
                console.error("Error loading employee records:", error);
                recordsTableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading records.</td></tr>';
            }
        });

        function renderRecordsTable(records) {
            const tableBody = document.getElementById("records-table-body");
            tableBody.innerHTML = '';

            const showTimes = document.getElementById("toggle-times")?.checked ?? false;
            const selectedBranch = recordBranchDropdown.value;
            const selectedSubdivision = recordSubdivisionDropdown.value;

            // ✅ Toggle columns in header and rows
            document.querySelectorAll('#records-thead .indiv-time-col, .indiv-time-col').forEach(col => {
                col.classList.toggle('hidden', !showTimes);
            });
            document.querySelectorAll('#records-thead .branch-col, .branch-col').forEach(col => {
                col.classList.toggle('hidden', selectedBranch !== 'All');
            });
            document.querySelectorAll('#records-thead .subdivision-col, .subdivision-col').forEach(col => {
                col.classList.toggle('hidden', selectedSubdivision !== 'All');
            });

            if (records.length === 0) {
                tableBody.innerHTML = `
        <tr>
            <td colspan="12" class="text-center py-4 text-gray-500">
                No attendance records found for the selected criteria.
            </td>
        </tr>`;
                return;
            }

            records.forEach(record => {
                const row = document.createElement("tr");
                row.classList.add("border-b");

                const morning = record.morning ?? 'N/A';
                const afternoon = record.afternoon ?? 'N/A';
                const enterTime = record.enterTime;
                const exitTime = record.exitTime;
                const status = record.status ?? '-';
                const remarks = Array.isArray(record.remarks) ? record.remarks.join(', ') : (record.remarks || '-');
                const holidayWorked = record.workedOnHoliday ? '✔️' : '-';
                const employeeName = record.employeeName ?? '-';
                const branch = record.branch ?? '-';
                const subdivision = record.subdivision ?? '-';

                let statusIcon = '';
                let statusColorClass = 'status-pending';
                switch (status) {
                    case 'Full Day': statusIcon = '✅'; statusColorClass = 'status-full'; break;
                    case 'Half Day':
                    case 'Leave (Half Day)': statusIcon = '🌗'; statusColorClass = 'status-half'; break;
                    case 'Absent':
                    case 'Leave (Full Day)': statusIcon = '❌'; statusColorClass = 'status-absent'; break;
                    case 'Invalid Entry': statusIcon = '⚠️'; statusColorClass = 'bg-orange-400 text-white'; break;
                }

                row.innerHTML = `
<td class="py-2 px-4 text-left">${new Date(record.date).toLocaleDateString("en-IN")}</td>
<td class="py-2 px-4 text-left">${employeeName}</td>
<td class="py-2 px-4 text-left branch-col ${selectedBranch !== 'All' ? 'hidden' : ''}">${branch}</td>
<td class="py-2 px-4 text-left subdivision-col ${selectedSubdivision !== 'All' ? 'hidden' : ''}">${subdivision}</td>

<td class="py-2 px-4 text-center">
  <span class="status-badge ${morning === '✅' ? 'status-full' : (morning === 'N/A' ? 'status-pending' : 'status-absent')}">
    ${morning === '✅' ? 'Present' : (morning === 'N/A' ? 'N/A' : 'Absent')}
  </span>
</td>

<td class="py-2 px-4 text-right indiv-time-col ${!showTimes ? 'hidden' : ''}">
  ${enterTime ? formatTime(enterTime) : 'Not Marked'}
</td>

<td class="py-2 px-4 text-center">
  <span class="status-badge ${['Enters', 'Leaves'].includes(afternoon) ? 'status-full' : (afternoon === 'N/A' ? 'status-pending' : 'status-absent')}">
    ${afternoon}
  </span>
</td>

<td class="py-2 px-4 text-right indiv-time-col ${!showTimes ? 'hidden' : ''}">
  ${exitTime ? formatTime(exitTime) : 'Not Marked'}
</td>

<td class="py-2 px-4 text-center">
  <span class="status-badge ${statusColorClass}">${statusIcon} ${status}</span>
</td>

<td class="py-2 px-4 text-left">${remarks}</td>
<td class="py-2 px-4 text-center">${holidayWorked}</td>
`;

                tableBody.appendChild(row);
            });
        }
        function getTableWidthEstimate(headers, columnStyles) {
            let total = 0;
            headers.forEach((_, idx) => {
                const col = columnStyles[idx];
                total += col?.cellWidth || 30; // default fallback
            });
            return total;
        }

        // Helper function to sanitize text for PDF (remove non-ASCII characters)
        function sanitizeText(text) {
            // Convert to string, replace non-ASCII characters with a space or empty string
            // and remove multiple spaces, then trim.
            return String(text || '').replace(/[^\x00-\x7F]/g, '').replace(/\s+/g, ' ').trim();
        }

        // --- Export to PDF (Employee Records) ---
        // 🎯 Exports attendance as tailored PDF
        document.getElementById("export-pdf").addEventListener("click", () => {
            if (!currentEmployeeRecords?.length) {
                return showModal("No records to export. Please load records first.", null, true);
            }

            const fromDate = document.getElementById("record-from").value;
            const toDate = document.getElementById("record-to").value;

            const branch = recordBranchDropdown?.value || "All";
            const subdivision = recordSubdivisionDropdown?.value || "All";
            const district = document.getElementById("record-district")?.value || "All";

            const includeTimes = toggleTimesCheckbox.checked;

            const { jsPDF } = window.jspdf;
            const doc = createJsPdf(branch, subdivision, includeTimes);

            const headers = buildHeaders(branch, subdivision, includeTimes);
            const body = buildBody(currentEmployeeRecords, branch, subdivision, includeTimes);
            const columnStyles = buildColumnStyles(headers, branch, subdivision, includeTimes);

            const pageWidth = doc.internal.pageSize.getWidth();
            const tableContentWidth = getTableWidthEstimate(headers, columnStyles);
            const centeredMargin = (pageWidth - tableContentWidth) / 2;

            const showDistrict = (district && district !== "All") ? district : "";

            let tempY = 15; // base title
            tempY += 6; // Title line
            if (district && district !== "All") tempY += 6;
            if (fromDate && toDate) tempY += 6;
            if (branch && branch !== "All") tempY += 6;
            if (subdivision && subdivision !== "All") tempY += 6;

            // store header end so autoTable can start below it


            const startY = getHeaderHeight(fromDate, toDate, branch, subdivision, district);

            doc.autoTable({
                head: [headers],
                body: body,
                startY: startY, // ✅ Direct calculation, no pre-render
                theme: "striped",
                styles: {
                    fontSize: 8,
                    halign: "center",
                    overflow: "linebreak",
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [0, 102, 204],
                    textColor: 255,
                    fontStyle: "bold",
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245],
                },
                columnStyles,
                margin: { top: 30, left: centeredMargin, right: centeredMargin },
                didDrawPage: drawPageHeaderFooter(doc, fromDate, toDate, branch, subdivision, showDistrict)
            });


            const filename = `Attendance_Report_${branch === 'All' ? 'All_Branches' : branch}_${fromDate}_to_${toDate}.pdf`;
            doc.save(filename);
        });



        /**------- Helper Functions -------**/
        function createJsPdf(branch, subdivision, includeTimes) {
            const { jsPDF } = window.jspdf;

            // Force landscape for more horizontal space
            const doc = new jsPDF("landscape", "mm", "a4");

            doc.setFont("helvetica");
            return doc;
        }




        function computeSummary(records, holidays = {}) {
            const summary = { full: 0, half: 0, absent: 0, late: 0 };
            records.forEach(r => {
                const isHoliday = Boolean(holidays[r.date]);
                const worked = r.morningStatus === 'Present'
                    || r.afternoonStatus === 'Enters'
                    || (r.anExitTime && r.anExitTime !== 'Not Marked');

                r.remarks = r.remarks.filter(rem => !(rem === "Worked on Holiday" && !worked));
                if (r.status === 'Full Day') summary.full++;
                else if (['Half Day', 'Leave (Half Day)'].includes(r.status)) summary.half++;
                else if (['Absent', 'Leave (Full Day)'].includes(r.status)) summary.absent++;
                if (r.isLate) summary.late++;
            });
            return summary;
        }

        function buildHeaders(branch, subdivision, includeTimes) {
            const hdr = ["Date", "Employee"];
            if (branch === 'All') hdr.push("Branch");
            if (subdivision === 'All') hdr.push("Subdivision");
            hdr.push("Morning", "Afternoon");
            if (includeTimes) {
                hdr.push("Enter Time");
                hdr.push("Exit Time");
            }

            hdr.push("Status", "Remarks", "Holiday Worked");
            return hdr;
        }

        function buildBody(records, branch, subdivision, includeTimes) {
            return records.map(r => {
                const base = [
                    sanitizeText(new Date(r.date).toLocaleDateString("en-IN")),
                    sanitizeText(r.employeeName)
                ];
                if (branch === 'All') base.push(sanitizeText(r.branch));
                if (subdivision === 'All') base.push(sanitizeText(r.subdivision));
                base.push(
                    r.morning === '✅' ? 'Present' : (r.morning === 'N/A' ? 'N/A' : 'Absent'),
                    sanitizeText(r.afternoon)
                );
                if (includeTimes) {
                    const enterFormatted = r.enterTime ? formatTime(r.enterTime) : 'Not Marked';
                    const exitFormatted = r.exitTime ? formatTime(r.exitTime) : 'Not Marked';
                    base.push(enterFormatted, exitFormatted);
                }


                const statusStyled = {
                    content: sanitizeText(r.status),
                    styles: { fontStyle: 'bold' }
                };
                base.push(statusStyled, sanitizeText(r.remarks.join(', ') || '-'), r.workedOnHoliday ? 'Yes' : 'No');
                return base;
            });
        }

        function buildColumnStyles(headers, branch, subdivision, includeTimes) {
            const styles = {};
            let idx = 0;

            styles[idx++] = { halign: 'center', cellWidth: 22 }; // Date
            styles[idx++] = { halign: 'center', cellWidth: 30 };   // Employee

            if (branch === 'All') styles[idx++] = { halign: 'center', cellWidth: 24 }; // Branch
            if (subdivision === 'All') styles[idx++] = { halign: 'center', cellWidth: 24 }; // Subdivision

            styles[idx++] = { halign: 'center', cellWidth: 18 }; // Morning
            if (includeTimes) styles[idx++] = { halign: 'center', cellWidth: 24 }; // Enter Time

            styles[idx++] = { halign: 'center', cellWidth: 18 }; // Afternoon
            if (includeTimes) styles[idx++] = { halign: 'center', cellWidth: 24 }; // Exit Time

            styles[idx++] = { halign: 'center', cellWidth: 28 }; // Status
            styles[idx++] = { halign: 'center', cellWidth: 40 }; // Remarks
            styles[idx++] = { halign: 'center', cellWidth: 18 }; // Holiday Worked

            return styles;
        }


        function styleCell(data) {
            const colRaw = data.column?.raw;
            const raw = typeof data.cell.raw === 'string' ? data.cell.raw.toLowerCase() : '';
            if (colRaw === "Status") {
                if (raw.includes("full")) data.cell.styles.textColor = [0, 128, 0];
                else if (raw.includes("half")) data.cell.styles.textColor = [255, 165, 0];
                else if (raw.includes("absent")) data.cell.styles.textColor = [255, 0, 0];
                data.cell.styles.fontStyle = 'bold';
            }
            if (colRaw === "Remarks" && raw.includes("late coming")) {
                data.cell.styles.textColor = [255, 0, 0];
                data.cell.styles.fontStyle = 'bold';
            }
        }
        function getHeaderHeight(fromDate, toDate, branch, subdivision, district) {
            let y = 15; // base title line
            y += 6; // Title
            if (district && district !== "All") y += 6;
            if (fromDate && toDate) y += 6;
            if (branch && branch !== "All") y += 6;
            if (subdivision && subdivision !== "All") y += 6;
            return y + 4; // small gap before table
        }

        function drawPageHeaderFooter(doc, fromDate, toDate, branch, subdivision, district) {
            return function (data) {
                const { pageNumber } = data;
                const pageWidth = doc.internal.pageSize.getWidth();
                const centerX = pageWidth / 2;
                const footerY = doc.internal.pageSize.height - 10;
                const margin = data.settings.margin;

                if (pageNumber === 1) {
                    let y = 15;

                    doc.setFont("helvetica", "bold").setFontSize(14).setTextColor(33);
                    doc.text("Employee Attendance Report", centerX, y, { align: "center" });
                    y += 6;

                    if (district && district !== "All") {
                        doc.setFont("helvetica", "bold").setFontSize(12).setTextColor(60);
                        doc.text(district, centerX, y, { align: "center" });
                        y += 6;
                    }

                    if (fromDate && toDate) {
                        doc.setFont("helvetica", "normal").setFontSize(10).setTextColor(70);
                        doc.text(`From: ${fromDate}     To: ${toDate}`, centerX, y, { align: "center" });
                        y += 6;
                    }

                    if (branch && branch !== "All") {
                        doc.text(`Branch: ${branch}`, centerX, y, { align: "center" });
                        y += 6;
                    }

                    if (subdivision && subdivision !== "All") {
                        doc.text(`Subdivision: ${subdivision}`, centerX, y, { align: "center" });
                        y += 6;
                    }
                }

                const now = new Date();
                const timestamp = now.toLocaleDateString("en-IN") + " " +
                    now.toLocaleTimeString("en-IN", { hour: '2-digit', minute: '2-digit', hour12: true });

                doc.setFontSize(9).setTextColor(100);
                doc.text(`Generated: ${timestamp}`, margin.left, footerY);
                doc.text(`Page ${pageNumber}`, pageWidth - margin.right, footerY, { align: "right" });
            };
        }











        function addSummary(doc, { full, half, absent, late }) {
            const y = doc.autoTable.previous.finalY + 12;
            const lineSpacing = 6;

            doc.setFont("helvetica", "bold").setFontSize(12).setTextColor(40);
            doc.text("Summary:", 14, y);

            const lines = [
                `✅ Full Days: ${full}`,
                `🌗 Half Days: ${half}`,
                `❌ Absent: ${absent}`,
                `🕒 Late: ${late}`
            ];

            doc.setFont("helvetica", "normal").setFontSize(10).setTextColor(60);
            lines.forEach((line, i) => {
                doc.text(line, 20, y + (i + 1) * lineSpacing);
            });
        }


        // References
        const districtDropdown = document.getElementById("record-district");
        const branchDropdown = document.getElementById("record-branch");
        const subdivisionDropdown = document.getElementById("record-subdivision");

        // Get the visible container wrappers
        const branchWrapper = document.querySelector("#record-branch")?.closest(".form-group, .flex, div");
        const subdivisionWrapper = document.querySelector("#record-subdivision")?.closest(".form-group, .flex, div");

        // Function to update visibility
        function updateDropdownVisibility() {
            const districtVal = districtDropdown?.value || "";
            const branchVal = branchDropdown?.value || "";

            if (!districtVal || districtVal === "All") {
                if (branchWrapper) branchWrapper.style.display = "none";
                if (subdivisionWrapper) subdivisionWrapper.style.display = "none";
                return;
            }

            if (branchWrapper) branchWrapper.style.display = "block";

            if (!branchVal || branchVal === "All") {
                if (subdivisionWrapper) subdivisionWrapper.style.display = "none";
            } else {
                if (subdivisionWrapper) subdivisionWrapper.style.display = "block";
            }
        }

        // Run once on page load
        updateDropdownVisibility();

        // Attach listeners
        districtDropdown?.addEventListener("change", updateDropdownVisibility);
        branchDropdown?.addEventListener("change", updateDropdownVisibility);

        // ===================== Export Excel ===================== //

        document.getElementById("export-excel").addEventListener("click", async () => {
            if (!currentEmployeeRecords?.length) {
                return showModal("No records to export. Please load records first.", null, true);
            }

            const fromDate = document.getElementById("record-from").value || "N/A";
            const toDate = document.getElementById("record-to").value || "N/A";
            const branch = branchDropdown?.value || "All";
            const subdivision = subdivisionDropdown?.value || "All";
            const district = districtDropdown?.value || "All";

            const offset = 2; // Start from column C
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet("EmployeeRecords");

            // ===== 1. Define headers dynamically =====
            let headers = ["Date", "Employee"];
            // ✅ Show only if value === "All"
            if (district === "All") headers.push("District");
            if (branch === "All") headers.push("Branch");
            if (subdivision === "All") headers.push("Subdivision");
            headers.push("Morning", "Afternoon", "Status", "Remarks", "Holiday Worked");

            const headerCount = headers.length;

            // ===== 2. Title Row =====
            const titleRow = sheet.getRow(1);
            titleRow.getCell(offset + 1).value = "EMPLOYEE ATTENDANCE REPORT";
            sheet.mergeCells(1, offset + 1, 1, offset + headerCount);
            titleRow.getCell(offset + 1).font = { name: "Segoe UI", size: 22, bold: true, color: { argb: "FFFFFFFF" } };
            titleRow.getCell(offset + 1).fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF2C3E50" } };
            titleRow.getCell(offset + 1).alignment = { horizontal: "center", vertical: "middle" };
            titleRow.height = 35;

            // ===== 3. Metadata =====
            let metaStartRow = 2;
            let metaRows = [];
            if (district !== "All") metaRows.push([`📍 District: ${district}`]);
            if (fromDate && toDate) metaRows.push([`📅 Date Range: ${fromDate} → ${toDate}`]);
            if (branch !== "All") metaRows.push([`🏢 Branch: ${branch}`]);
            if (subdivision !== "All") metaRows.push([`📂 Subdivision: ${subdivision}`]);

            metaRows.forEach((line, idx) => {
                const rowIndex = metaStartRow + idx;
                const row = sheet.getRow(rowIndex);
                row.getCell(offset + 1).value = line[0];
                sheet.mergeCells(rowIndex, offset + 1, rowIndex, offset + headerCount);
                row.font = { name: "Segoe UI", size: 12, bold: true, color: { argb: "FF34495E" } };
                row.alignment = { horizontal: "left", vertical: "middle" };
                row.height = 20;
            });

            // Spacer row
            const spacerRowIndex = metaStartRow + metaRows.length;
            sheet.addRow([]);
            sheet.getRow(spacerRowIndex).height = 10;

            // ===== 4. Header Row =====
            const headerRow = sheet.addRow([]);
            headerRow.height = 25;
            headers.forEach((header, index) => {
                const cell = headerRow.getCell(offset + 1 + index);
                cell.value = header;
                cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF2C3E50" } };
                cell.font = { name: "Segoe UI", bold: true, color: { argb: "FFFFFFFF" } };
                cell.alignment = { horizontal: "center", vertical: "middle" };
                cell.border = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
            });

            // ===== 5. Data Rows =====
            currentEmployeeRecords.forEach(record => {
                const row = sheet.addRow([]);

                const cells = [];
                cells.push(record.date);
                cells.push(record.employeeName);

                // ✅ Show only if value === "All"
                if (district === "All") cells.push(record.district || "-");
                if (branch === "All") cells.push(record.branch || "-");
                if (subdivision === "All") cells.push(record.subdivision || "-");

                cells.push(
                    record.morning,
                    record.afternoon,
                    record.status,
                    (record.remarks && record.remarks.length ? record.remarks.join(", ") : "-"),
                    record.workedOnHoliday ? "Yes" : "No"
                );

                // Write into row cells (unchanged from before)...
                cells.forEach((value, index) => {
                    const cell = row.getCell(offset + 1 + index);
                    cell.value = value;
                    cell.font = { name: "Segoe UI", size: 11, color: { argb: "FF34495E" } };
                    cell.border = {
                        top: { style: "thin" }, bottom: { style: "thin" },
                        left: { style: "thin" }, right: { style: "thin" }
                    };

                    const remarksIndex = cells.length - 2;
                    cell.alignment = {
                        horizontal: (index === remarksIndex ? "left" : "center"),
                        vertical: "middle"
                    };
                });
                // Alternate row shading
                if (row.number % 2 === 0) {
                    row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                        if (colNumber > offset) {
                            cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFF8F9F9" } };
                        }
                    });
                }

                // Conditional formatting for status
                const statusIndex = cells.length - 3; // status is 3rd from end
                const statusCell = row.getCell(offset + 1 + statusIndex);
                const status = record.status?.toLowerCase() || "";

                if (status.includes("absent") || status.includes("leave")) {
                    statusCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFADBD8" } };
                    statusCell.font = { color: { argb: "FFC0392B" }, bold: true };
                } else if (status.includes("present") || status.includes("full day")) {
                    statusCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFD5F5E3" } };
                    statusCell.font = { color: { argb: "FF27AE60" }, bold: true };
                } else if (status.includes("half day")) {
                    statusCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFEF9E7" } };
                    statusCell.font = { color: { argb: "FFE67E22" }, bold: true };
                } else {
                    statusCell.value = `⚠️ ${record.status}`;
                    statusCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFFEAA7" } };
                    statusCell.font = { color: { argb: "FFD35400" }, bold: true };
                }
            });

            // ===== 6. Smart Auto Adjust Column Widths =====
            headers.forEach((header, index) => {
                const column = sheet.getColumn(offset + 1 + index);

                let maxLength = header.length;

                column.eachCell({ includeEmpty: true }, cell => {
                    const val = cell.value ? cell.value.toString() : "";
                    if (val.length > maxLength) {
                        maxLength = val.length;
                    }
                });

                // Default width calculation
                let width = maxLength + 2;

                // Special handling:
                if (header === "Remarks") {
                    width = Math.min(Math.max(maxLength / 2, 30), 60); // wider, but capped
                    column.alignment = { wrapText: true, vertical: "top" };
                } else if (header === "Employee") {
                    width = Math.min(Math.max(maxLength, 20), 40);
                } else if (header === "Status") {
                    width = Math.min(Math.max(maxLength, 15), 25);
                } else {
                    width = Math.min(Math.max(width, 12), 25); // keep short ones neat
                }

                column.width = width;
            });



            // ===== 7. Save File =====
            const sanitizeForFilename = (str) => str.replace(/[^\w\s-]/g, '').replace(/[-\s]+/g, '_');
            const safeBranch = sanitizeForFilename(branch);
            const safeFromDate = sanitizeForFilename(fromDate);
            const safeToDate = sanitizeForFilename(toDate);

            const filename = `Attendance_Report_${safeBranch}_${safeFromDate}_to_${safeToDate}.xlsx`;
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        });


        // --- Individual Records Tab Logic ---
        const indivBranchDropdown = document.getElementById("indiv-branch");
        const indivSubdivisionDropdown = document.getElementById("indiv-subdivision");
        const indivEmployeeDropdown = document.getElementById("indiv-employee");
        const indivFromDateInput = document.getElementById("indiv-from-date");
        const indivToDateInput = document.getElementById("indiv-to-date");
        const indivToggleTimesCheckbox = document.getElementById("indiv-toggle-times");
        const loadIndividualBtn = document.getElementById("load-individual-btn");
        const indivRecordsTableBody = document.getElementById("indiv-table-body");
        const indivTimeCols = document.querySelectorAll(".indiv-time-col");
        const indivSummary = document.getElementById("indiv-summary");
        const indivFullDays = document.getElementById("indiv-full-days");
        const indivHalfDays = document.getElementById("indiv-half-days");
        const indivAbsentDays = document.getElementById("indiv-absent-days");
        const indivLateDays = document.getElementById("indiv-late-days");
        const indivTotalLeaveCountEl = document.getElementById("indiv-total-leave-count");
        const indivHolidayWorkFullDays = document.getElementById("indiv-holiday-work-full-days"); // New summary element
        const indivHolidayWorkHalfDays = document.getElementById("indiv-holiday-work-half-days"); // New summary element
        const loadingIndividualIndicator = document.getElementById("loading-individual");
        const exportIndivPdfBtn = document.getElementById("export-indiv-pdf");
        const exportIndivExcelBtn = document.getElementById("export-indiv-excel");
        const indivEmployeeDetailsHeader = document.getElementById('indiv-employee-details-header'); // New element for employee details
        const searchByIdInput = document.getElementById('search-by-id-input'); // New search input
        const searchByIdBtn = document.getElementById('search-by-id-btn'); // New search button

        let currentIndividualRecords = []; // Store fetched data for export

        // Populate Branch dropdown for Individual Records Tab
        async function populateIndivBranches() {
            indivBranchDropdown.innerHTML = `<option value="All">All Branches</option>`;
            indivSubdivisionDropdown.innerHTML = `<option value="All">All Subdivisions</option>`;
            indivEmployeeDropdown.innerHTML = `<option value="All">All Employees</option>`;

            indivSubdivisionDropdown.disabled = true;
            indivEmployeeDropdown.disabled = true;

            try {
                const snapshot = await get(ref(db, "branchDirectory"));
                snapshot.forEach(branch => {
                    const option = document.createElement("option");
                    option.value = branch.key;
                    option.textContent = branch.key.charAt(0).toUpperCase() + branch.key.slice(1);
                    indivBranchDropdown.appendChild(option);
                });
                // If there are branches, enable subdivision and employee dropdowns to allow "All" selection
                if (snapshot.exists()) {
                    indivSubdivisionDropdown.disabled = false;
                    indivEmployeeDropdown.disabled = false;
                    await populateIndivEmployees(true, true); // Populate all employees initially
                }
            } catch (error) {
                console.error("Error populating individual branches:", error);
            }
        }

        // When Branch is selected for Individual Records Tab, populate Subdivision
        indivBranchDropdown.addEventListener("change", async () => {
            const selectedBranch = indivBranchDropdown.value;
            indivSubdivisionDropdown.innerHTML = `<option value="All">All Subdivisions</option>`;
            indivSubdivisionDropdown.disabled = true;
            indivEmployeeDropdown.innerHTML = `<option value="All">All Employees</option>`;
            indivEmployeeDropdown.disabled = true;

            if (selectedBranch === "All") {
                indivSubdivisionDropdown.disabled = false;
                indivEmployeeDropdown.disabled = false;
                await populateIndivEmployees(true, true); // All branches, all subdivisions
            } else if (selectedBranch) {
                try {
                    const snapshot = await get(ref(db, `branchDirectory/${selectedBranch}/subdivisions`));

                    if (snapshot.exists()) {

                        snapshot.forEach(subdivision => {
                            const option = document.createElement("option");
                            option.value = subdivision.key;
                            option.textContent = subdivision.key.charAt(0).toUpperCase() + subdivision.key.slice(1);
                            indivSubdivisionDropdown.appendChild(option);
                        });
                        indivSubdivisionDropdown.disabled = false;
                        indivEmployeeDropdown.disabled = false;
                        await populateIndivEmployees(false, true); // Specific branch, all subdivisions
                    } else {
                        indivSubdivisionDropdown.disabled = false;
                        indivEmployeeDropdown.disabled = false;
                        await populateIndivEmployees(false, true);
                    }
                } catch (error) {
                    console.error("Error loading individual subdivisions:", error);
                }
            }
        });

        // Populate Employee dropdown based on Subdivision selection
        indivSubdivisionDropdown.addEventListener("change", async () => {
            const selectedBranch = indivBranchDropdown.value;
            const selectedSubdivision = indivSubdivisionDropdown.value;
            indivEmployeeDropdown.innerHTML = `<option value="All">All Employees</option>`;
            indivEmployeeDropdown.disabled = true;

            if (selectedBranch === "All" && selectedSubdivision === "All") {
                indivEmployeeDropdown.disabled = false;
                await populateIndivEmployees(true, true); // All branches, all subdivisions
            } else if (selectedBranch !== "All" && selectedSubdivision === "All") {
                indivEmployeeDropdown.disabled = false;
                await populateIndivEmployees(false, true); // Specific branch, all subdivisions
            } else if (selectedBranch && selectedSubdivision && selectedSubdivision !== "All") {
                try {
                    const snapshot = await get(ref(db, `branches/${selectedBranch}/subdivisions/${selectedSubdivision}/employees`));
                    if (snapshot.exists()) {
                        snapshot.forEach(employee => {
                            const option = document.createElement("option");
                            option.value = employee.key;
                            option.textContent = employee.val().name;
                            indivEmployeeDropdown.appendChild(option);
                        });
                    }
                    indivEmployeeDropdown.disabled = false;
                } catch (error) {
                    console.error("Error populating individual employees:", error);
                }
            }
        });

        // Helper to populate employee dropdown based on branch/subdivision selection (including special employees)
        async function populateIndivEmployees(allBranches, allSubdivisions) {
            indivEmployeeDropdown.innerHTML = '<option value="All">All Employees</option>';
            const employeesMap = new Map(); // Use a Map to store unique employees

            try {
                // Fetch regular employees
                let branchesRef = ref(db, "branches");
                if (!allBranches && indivBranchDropdown.value !== "All") {
                    branchesRef = ref(db, `branches/${indivBranchDropdown.value}`);
                }

                const branchesSnap = await get(branchesRef);
                branchesSnap.forEach(branchSnap => {
                    const branchKey = branchSnap.key;
                    const branchData = branchSnap.val();
                    const subdivisions = branchData.subdivisions || {};

                    for (const subKey in subdivisions) {
                        if (allSubdivisions || indivSubdivisionDropdown.value === "All" || subKey === indivSubdivisionDropdown.value) {
                            const employees = subdivisions[subKey].employees || {};
                            for (const empId in employees) {
                                if (!employeesMap.has(empId)) {
                                    employeesMap.set(empId, { id: empId, name: employees[empId].name, branch: branchKey, subdivision: subKey, isSpecial: false });
                                }
                            }
                        }
                    }
                });

                // Fetch special employees
                const specialEmployeesSnap = await get(ref(db, "specialEmployees"));
                specialEmployeesSnap.forEach(specialEmp => {
                    if (!employeesMap.has(specialEmp.key)) {
                        employeesMap.set(specialEmp.key, { id: specialEmp.key, name: specialEmp.val().name, branch: 'N/A', subdivision: 'Special', isSpecial: true });
                    }
                });

                // Add employees to dropdown
                Array.from(employeesMap.values()).sort((a, b) => a.name.localeCompare(b.name)).forEach(emp => {
                    const option = document.createElement("option");
                    option.value = emp.id;
                    option.textContent = emp.name;
                    indivEmployeeDropdown.appendChild(option);
                });
                indivEmployeeDropdown.disabled = false;

            } catch (error) {
                console.error("Error populating employees for individual tab:", error);
            }
        }

        // Initial population on page load
        populateIndivBranches();

        // Event listener for toggling timesheet visibility
        indivToggleTimesCheckbox.addEventListener("change", () => {
            // Re-render the table to apply visibility changes to rows
            renderIndividualTable(currentIndividualRecords, indivToggleTimesCheckbox.checked);
        });

        // Search by Employee ID Logic
        searchByIdBtn.addEventListener('click', async () => {
            const employeeIdToSearch = searchByIdInput.value.trim();
            const searchMessage = document.getElementById('search-employee-id-message'); // Get the message div

            // Clear previous messages and styling
            searchMessage.textContent = '';
            searchMessage.classList.remove('text-red-500', 'text-green-500', 'block');
            searchByIdInput.classList.remove('border-red-500');

            if (!employeeIdToSearch) {
                searchMessage.textContent = "Please enter an Employee ID to search.";
                searchMessage.classList.add('text-red-500', 'block');
                searchByIdInput.classList.add('border-red-500');
                // Set a timeout to clear the message and border
                setTimeout(() => {
                    searchMessage.textContent = '';
                    searchMessage.classList.remove('block');
                    searchByIdInput.classList.remove('border-red-500');
                }, 3000); // Message disappears after 3 seconds
                return;
            }

            showLoadingModal(`Searching for employee ID: ${employeeIdToSearch}...`);
            try {
                // Use the new getEmployeeByEmployeeId function
                const employeeData = await getEmployeeDetails(employeeIdToSearch);

                if (employeeData) {
                    // Set dropdowns based on found employee
                    if (employeeData.isSpecial) {
                        indivBranchDropdown.value = "All";
                        indivSubdivisionDropdown.value = "All";
                        // Populate all employees and then select the specific one
                        await populateIndivEmployees(true, true);
                        indivEmployeeDropdown.value = employeeData.id;
                    } else {
                        indivBranchDropdown.value = employeeData.branch;
                        // Populate subdivisions for the selected branch
                        await populateSubdivisionDropdown(indivBranchDropdown, indivSubdivisionDropdown);
                        indivSubdivisionDropdown.value = employeeData.subdivision;
                        // Populate employees for the selected branch and subdivision
                        await populateEmployeeDropdown(indivBranchDropdown, indivSubdivisionDropdown, indivEmployeeDropdown);
                        indivEmployeeDropdown.value = employeeData.id;
                    }
                    hideLoadingModal();
                    loadIndividualBtn.click(); // Trigger load
                    searchMessage.textContent = `Employee "${employeeData.name}" found.`;
                    searchMessage.classList.add('text-green-500', 'block');
                    setTimeout(() => {
                        searchMessage.textContent = '';
                        searchMessage.classList.remove('block');
                    }, 3000);
                } else {
                    hideLoadingModal();
                    searchMessage.textContent = `Employee ID "${employeeIdToSearch}" not found.`;
                    searchMessage.classList.add('text-red-500', 'block');
                    searchByIdInput.classList.add('border-red-500');
                    setTimeout(() => {
                        searchMessage.textContent = '';
                        searchMessage.classList.remove('block');
                        searchByIdInput.classList.remove('border-red-500');
                    }, 3000);
                }
            } catch (error) {
                hideLoadingModal();
                console.error("Error searching by employee ID:", error);
                searchMessage.textContent = "An error occurred during search. Please try again.";
                searchMessage.classList.add('text-red-500', 'block');
                searchByIdInput.classList.add('border-red-500');
                setTimeout(() => {
                    searchMessage.textContent = '';
                    searchMessage.classList.remove('block');
                    searchByIdInput.classList.remove('border-red-500');
                }, 3000);
            }
        });
        function toggleIndivTimeColumns(show) {
            document.querySelectorAll(".indiv-time-col").forEach(el => {
                el.classList.toggle("hidden", !show);
            });
        }

        // Load Individual Records Button Click
        loadIndividualBtn.addEventListener("click", async () => {
            const selectedBranch = indivBranchDropdown.value;
            const selectedSubdivision = indivSubdivisionDropdown.value;
            const selectedEmployeeId = indivEmployeeDropdown.value;
            const fromDateStr = indivFromDateInput.value;
            const toDateStr = indivToDateInput.value;
            // Re-apply time toggle after rendering
            const showTimes = indivToggleTimesCheckbox.checked;
            document.querySelectorAll(".indiv-time-col").forEach(el => {
                el.classList.toggle("hidden", !showTimes);
            });

            indivRecordsTableBody.innerHTML = ''; // Clear table body
            indivSummary.classList.add('hidden'); // Hide summary
            indivEmployeeDetailsHeader.classList.add('hidden'); // Hide employee details header initially
            loadingIndividualIndicator.classList.remove('hidden'); // Show loading

            // Reset summary counts
            indivFullDays.textContent = '0';
            indivHalfDays.textContent = '0';
            indivAbsentDays.textContent = '0';
            indivLateDays.textContent = '0';
            indivTotalLeaveCountEl.textContent = '0 Days';
            indivHolidayWorkFullDays.textContent = '0';
            indivHolidayWorkHalfDays.textContent = '0';
            currentIndividualRecords = []; // Clear data for export

            if (!fromDateStr || !toDateStr) {
                showModal("Please select both 'From' and 'To' dates.", null, true);
                loadingIndividualIndicator.classList.add('hidden');
                return;
            }

            const fromDate = new Date(fromDateStr);
            const toDate = new Date(toDateStr);
            // Normalize times so comparing dates is reliable
            fromDate.setHours(0, 0, 0, 0);
            toDate.setHours(0, 0, 0, 0);

            if (fromDate > toDate) {
                showModal("From date cannot be after To date.", null, true);
                loadingIndividualIndicator.classList.add('hidden');
                return;
            }

            try {
                let employeesToFetch = new Map(); // Map to store { empId: { name, branch, subdivision, isSpecial, des } }
                let employeeDetailsForHeader = null; // To store details for the header

                // Fetch all holidays for the period (expects keys like "YYYY-MM-DD")
                const holidays = await fetchHolidays(fromDate, toDate);

                if (selectedEmployeeId === "All") {
                    // Fetch all employees based on branch/subdivision filters
                    let branchesSnapshot;
                    if (selectedBranch === "All") {
                        branchesSnapshot = await get(ref(db, "branches"));
                    } else {
                        branchesSnapshot = await get(ref(db, `branches/${selectedBranch}`));
                    }

                    branchesSnapshot.forEach(branchSnap => {
                        const branchKey = branchSnap.key;
                        const branchData = branchSnap.val() || {};
                        const subdivisions = branchData.subdivisions || {};

                        for (const subKey in subdivisions) {
                            if (selectedSubdivision === "All" || subKey === selectedSubdivision) {
                                const employees = subdivisions[subKey].employees || {};
                                for (const empId in employees) {
                                    employeesToFetch.set(empId, {
                                        name: employees[empId].name,
                                        branch: branchKey,
                                        subdivision: subKey,
                                        isSpecial: false,
                                        des: employees[empId].des || 'Not Set'
                                    });
                                }
                            }
                        }
                    });

                    // Add special employees if "All" branch/subdivision is selected
                    if (selectedBranch === "All" || selectedSubdivision === "All") {
                        const specialEmployeesSnap = await get(ref(db, "specialEmployees"));
                        specialEmployeesSnap.forEach(specialEmp => {
                            employeesToFetch.set(specialEmp.key, {
                                name: specialEmp.val().name,
                                branch: 'N/A',
                                subdivision: 'Special',
                                isSpecial: true,
                                des: specialEmp.val().des || 'Not Set'
                            });
                        });
                    }

                } else {
                    // Specific employee selected
                    const employeeData = await getEmployeeDetails(selectedEmployeeId, selectedBranch, selectedSubdivision);
                    if (!employeeData) {
                        indivRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Employee data not found.</td></tr>';
                        loadingIndividualIndicator.classList.add('hidden');
                        return;
                    }
                    employeesToFetch.set(selectedEmployeeId, employeeData);
                    employeeDetailsForHeader = employeeData; // Store for header
                }

                if (employeesToFetch.size === 0) {
                    indivRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No employees found for the selected filters.</td></tr>';
                    loadingIndividualIndicator.classList.add('hidden');
                    return;
                }

                const recordsToDisplay = [];
                let summaryFullDays = 0;
                let summaryHalfDays = 0;
                let summaryAbsentDays = 0;
                let summaryLateDays = 0;
                let summaryTotalLeave = 0;
                let summaryHolidayWorkFullDays = 0;
                let summaryHolidayWorkHalfDays = 0;

                // helper: zero-pad
                const pad = (n) => String(n).padStart(2, '0');

                // iterate dates (clone loop date so external fromDate not mutated)
                for (let loopDate = new Date(fromDate.getTime()); loopDate <= toDate; loopDate.setDate(loopDate.getDate() + 1)) {
                    // Build YYYY-MM-DD and year/month/day parts
                    const year = String(loopDate.getFullYear());
                    const month = pad(loopDate.getMonth() + 1);
                    const day = pad(loopDate.getDate());
                    const currentDate = `${year}-${month}-${day}`; // consistent key for holidays and display

                    const currentDayOfWeek = loopDate.getDay(); // 0 (Sun) - 6 (Sat)
                    const isHoliday = !!holidays[currentDate];
                    const holidayReason = holidays[currentDate]?.reason || '';

                    for (const [empId, empDetails] of employeesToFetch.entries()) {
                        // Build hierarchical attendance path
                        const attendancePath = empDetails.isSpecial
                            ? `attendance/${year}/${month}/${day}/${empId}`
                            : `attendance/${year}/${month}/${day}/${empDetails.branch}/${empDetails.subdivision}/${empId}`;

                        // leaveLogs hierarchical path
                        const leavePath = `leaveLogs/${empId}/${year}/${month}/${day}`;

                        // Fetch attendance & leave in sequence (keeps logic simple). If performance becomes issue, batch reads can be used.
                        const attendanceSnap = await get(ref(db, attendancePath));
                        const attendance = attendanceSnap.exists() ? attendanceSnap.val() : null;

                        const leaveSnap = await get(ref(db, leavePath));
                        const leaveData = leaveSnap.exists() ? leaveSnap.val() : null;

                        // ✅ Skip empty days (no attendance, no leave, not holiday)
                        if (!attendance && !leaveData && !isHoliday) continue;

                        // Evaluate attendance using your existing evaluator
                        const evaluationResult = await evaluateAttendanceStatus(attendance, isHoliday, holidayReason, currentDayOfWeek, leaveData);

                        // Morning display logic
                        let morningStatusDisplay = '❌';
                        if (attendance?.morning === true) morningStatusDisplay = '✅';
                        else if (leaveData?.type) morningStatusDisplay = 'N/A';

                        // Afternoon display logic
                        let afternoonStatusDisplay = 'None';
                        if (attendance?.afternoon) afternoonStatusDisplay = attendance.afternoon;
                        else if (leaveData?.type) afternoonStatusDisplay = 'N/A';

                        // Time displays (use raw stored times if present)
                        const morningTimeDisplay = attendance?.morningTime ? formatTime(attendance.morningTime) : 'Not Marked';
                        const anEnterTimeDisplay = attendance?.anEnterTime ? formatTime(attendance.anEnterTime) : 'Not Marked';
                        const anLeaveTimeDisplay = attendance?.anLeaveTime ? formatTime(attendance.anLeaveTime) : 'Not Marked';
                        const anExitTimeDisplay = attendance?.anExitTime ? formatTime(attendance.anExitTime) : 'Not Marked';

                        // Update summaries
                        if (evaluationResult.overallStatus === 'Full Day') summaryFullDays++;
                        else if (evaluationResult.overallStatus === 'Half Day') summaryHalfDays++;
                        else if (evaluationResult.overallStatus === 'Absent') summaryAbsentDays++;
                        else if (evaluationResult.overallStatus === 'Leave (Full Day)') summaryAbsentDays++;
                        else if (evaluationResult.overallStatus === 'Leave (Half Day)') summaryHalfDays++;

                        if (evaluationResult.isLate) summaryLateDays++;
                        if (evaluationResult.workedOnHoliday) {
                            if (evaluationResult.overallStatus === 'Full Day') summaryHolidayWorkFullDays++;
                            else if (evaluationResult.overallStatus === 'Half Day') summaryHolidayWorkHalfDays++;
                        }

                        summaryTotalLeave += evaluationResult.leaveTaken;

                        recordsToDisplay.push({
                            date: currentDate,
                            employeeName: empDetails.name,
                            morningStatus: morningStatusDisplay === '✅' ? 'Present' : (morningStatusDisplay === 'N/A' ? 'N/A (Leave)' : 'Absent'),
                            morningTime: attendance?.morningTime?.trim() || null,
                            afternoonStatus: afternoonStatusDisplay,
                            anEnterTime: attendance?.anEnterTime?.trim()
                                || attendance?.anTime?.trim()
                                || attendance?.morningTime?.trim()
                                || null,

                            anLeaveTime: anLeaveTimeDisplay,
                            anExitTime: attendance?.anExitTime?.trim() || null,
                            leaveValue: evaluationResult.leaveTaken,
                            leaveReason: leaveData?.reason || '',
                            overallStatus: evaluationResult.overallStatus,
                            remarks: evaluationResult.remarks,
                            isLate: evaluationResult.isLate,
                            isInvalid: evaluationResult.isInvalid,
                            workedOnHoliday: evaluationResult.workedOnHoliday,
                            branch: empDetails.branch,
                            subdivision: empDetails.subdivision,
                            employeeId: empId,
                            designation: empDetails.des || 'Not Set',
                            sundayWork: evaluationResult.workedOnHoliday === true,
                            isHoliday: isHoliday,
                            holidayReason: holidayReason
                        });
                    }
                }

                // Sort & render
                recordsToDisplay.sort((a, b) => {
                    // Sort by employee name, then by date
                    if (a.employeeName !== b.employeeName) {
                        return a.employeeName.localeCompare(b.employeeName);
                    }
                    return new Date(a.date) - new Date(b.date);
                });

                currentIndividualRecords = recordsToDisplay; // Store for export

                renderIndividualTable(recordsToDisplay, showTimes);

                indivFullDays.textContent = summaryFullDays;
                indivHalfDays.textContent = summaryHalfDays;
                indivAbsentDays.textContent = summaryAbsentDays;
                indivLateDays.textContent = summaryLateDays;
                indivTotalLeaveCountEl.textContent = `${summaryTotalLeave} Days`;
                indivHolidayWorkFullDays.textContent = summaryHolidayWorkFullDays;
                indivHolidayWorkHalfDays.textContent = summaryHolidayWorkHalfDays;
                indivSummary.classList.remove('hidden');

                // Update employee details header
                if (employeeDetailsForHeader) {
                    indivEmployeeDetailsHeader.innerHTML = `
                <p class="text-lg font-semibold text-gray-800">
                    Name: ${employeeDetailsForHeader.name || 'N/A'},
                    Designation: ${employeeDetailsForHeader.des || 'Not Set'}
                </p><p class="text-lg font-semibold text-gray-800">
                    Total Leave: <span id="indiv-total-leave-count-header">${summaryTotalLeave} Days</span></p>
            `;
                    indivEmployeeDetailsHeader.classList.remove('hidden');
                } else {
                    indivEmployeeDetailsHeader.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error loading individual records:", error);
                indivRecordsTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Error loading records.</td></tr>';
            } finally {
                loadingIndividualIndicator.classList.add('hidden');
            }
        });

        // Helper function to render the individual records table
        function renderIndividualTable(records, showTimes) {
            const tableBody = document.getElementById('indiv-table-body');
            tableBody.innerHTML = '';

            const morningTimeHeader = document.getElementById('indiv-thead').querySelector('.indiv-time-col:nth-child(3)');
            const anTimeHeader = document.getElementById('indiv-thead').querySelector('.indiv-time-col:nth-child(5)');
            if (morningTimeHeader) morningTimeHeader.classList.toggle('hidden', !showTimes);
            if (anTimeHeader) anTimeHeader.classList.toggle('hidden', !showTimes);

            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No attendance records found for the selected criteria.</td></tr>';
                return;
            }

            records.forEach(record => {
                const row = document.createElement("tr");
                row.classList.add("border-b");

                const morning = record.morningStatus ?? 'N/A';
                const afternoon = record.afternoonStatus ?? 'N/A';
                const morningTime = record.morningTime ?? null;
                const anEnterTime = record.anEnterTime ?? null;
                const anExitTime = record.anExitTime ?? null;
                const status = record.overallStatus ?? '-';

                const enterTime = (afternoon === "Enters" && anEnterTime)
                    ? formatTime(anEnterTime)
                    : (morningTime ? formatTime(morningTime) : 'Not Marked');

                const exitTime = (afternoon === "Leaves" && anEnterTime)
                    ? formatTime(anEnterTime)
                    : (anExitTime ? formatTime(anExitTime) : 'Not Marked');

                let statusIcon = '';
                let statusColorClass = 'status-pending';
                switch (status) {
                    case 'Full Day': statusIcon = '✅'; statusColorClass = 'status-full'; break;
                    case 'Half Day':
                    case 'Leave (Half Day)': statusIcon = '🌗'; statusColorClass = 'status-half'; break;
                    case 'Absent':
                    case 'Leave (Full Day)': statusIcon = '❌'; statusColorClass = 'status-absent'; break;
                    case 'Invalid Entry': statusIcon = '⚠️'; statusColorClass = 'bg-orange-400 text-white'; break;
                }

                const remarks = (record.remarks ?? []).map(remark => {
                    if (remark === "LATE COMING") return `<span class="text-red-600 font-bold">${remark}</span>`;
                    if (remark.includes("Invalid")) return `<span class="text-orange-600 font-bold">${remark}</span>`;
                    if (remark === "Worked on Holiday") return `<span class="text-gray-600 font-semibold">${remark}</span>`;
                    return remark;
                }).join(', ');

                row.innerHTML = `
        <td class="py-2 px-4 text-left">${new Date(record.date).toLocaleDateString("en-IN")}</td>

        <td class="py-2 px-4 text-center">
          <span class="status-badge ${morning === 'Present' ? 'status-full' : (morning === 'N/A' ? 'status-pending' : 'status-absent')}">
            ${morning}
          </span>
        </td>

        <td class="py-2 px-4 text-right indiv-time-col ${!showTimes ? 'hidden' : ''}">
          ${enterTime}
        </td>

        <td class="py-2 px-4 text-center">
          <span class="status-badge ${['Enters', 'Leaves'].includes(afternoon) ? 'status-full' : (afternoon === 'N/A' ? 'status-pending' : 'status-absent')}">
            ${afternoon}
          </span>
        </td>

        <td class="py-2 px-4 text-right indiv-time-col ${!showTimes ? 'hidden' : ''}">
          ${exitTime}
        </td>

        <td class="py-2 px-4 text-center">
          <span class="status-badge ${statusColorClass}">${statusIcon} ${status}</span>
        </td>

        <td class="py-2 px-4 text-left">${remarks || '-'}</td>

        <td class="py-2 px-4 text-center">
          ${record.workedOnHoliday ? '<span class="text-green-600 font-bold" title="Worked on Sunday">✔️</span>' : '-'}
        </td>`;

                tableBody.appendChild(row);
            });

            document.querySelectorAll(".indiv-time-col").forEach(el => {
                el.classList.toggle("hidden", !showTimes);
            });
        }

        exportIndivPdfBtn.addEventListener("click", () => {
            const employeeDropdown = document.getElementById("indiv-employee");
            const fromDate = document.getElementById("indiv-from-date");
            const toDate = document.getElementById("indiv-to-date");

            if (!employeeDropdown || !fromDate || !toDate) {
                showModal("Required fields are missing from the page.", null, true);
                return;
            }

            if (!employeeDropdown.value || !fromDate.value || !toDate.value) {
                showModal("Please select Employee, From Date, and To Date before exporting.", null, true);
                return;
            }

            if (currentIndividualRecords.length === 0) {
                showModal("No records to export. Please load records first.", null, true);
                return;
            }

            const employeeName = employeeDropdown.options[employeeDropdown.selectedIndex].text;
            const showTimes = document.getElementById("indiv-toggle-times").checked;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("landscape");

            // ✅ Define headers FIRST
            const pdfHeaders = [
                "Date",
                "Morning",
                "Afternoon",
                "Enter Time",
                "Exit Time",
                "Status",
                "Remarks",
                "Holiday Worked"
            ];

            // ✅ Build body
            const pdfBody = currentIndividualRecords.map(record => {
                let statusIcon = '';
                switch (record.overallStatus) {
                    case 'Full Day': statusIcon = '✅'; break;
                    case 'Half Day':
                    case 'Leave (Half Day)': statusIcon = '🌗'; break;
                    case 'Absent':
                    case 'Leave (Full Day)': statusIcon = '❌'; break;
                    case 'Invalid Entry': statusIcon = '⚠️'; break;
                    default: break;
                }
                if (record.isHoliday) statusIcon = '🏖️';
                if (record.workedOnHoliday) statusIcon = '🗓️';

                return [
                    sanitizeText(new Date(record.date).toLocaleDateString("en-CA")),
                    sanitizeText(record.morningStatus),
                    sanitizeText(record.afternoonStatus),
                    sanitizeText(formatReadableTime(record.anEnterTime)),
                    sanitizeText(formatReadableTime(record.anExitTime)),
                    sanitizeText(`${statusIcon} ${record.overallStatus}`),
                    sanitizeText((record.remarks || []).join(", ") || "-"),
                    sanitizeText(record.workedOnHoliday ? "Yes" : "No")
                ];
            });

            // ✅ Column styles
            const columnStyles = {
                0: { cellWidth: 20 },
                1: { cellWidth: 22 },
                2: { cellWidth: 22 },
                3: { cellWidth: 28 },
                4: { cellWidth: 28 },
                5: { cellWidth: 38 },
                6: { cellWidth: 55, halign: "center" },
                7: { cellWidth: 25 }
            };

            const pageWidth = doc.internal.pageSize.getWidth();
            const totalTableWidth = Object.values(columnStyles).reduce((sum, col) => sum + (col.cellWidth || 30), 0);
            const marginX = (pageWidth - totalTableWidth) / 2;

            // ✅ Header details
            const designation = document.querySelector('#indiv-employee-details-header p')
                ?.textContent.split("Designation: ")[1]?.split(",")[0]?.trim() || 'N/A';

            const districtDropdown = document.getElementById("indiv-district");
            let districtLabel = "";
            if (districtDropdown && districtDropdown.value && districtDropdown.value !== "All") {
                districtLabel = districtDropdown.options[districtDropdown.selectedIndex]?.text || "";
            }

            // ✅ Table with custom header/footer
            doc.autoTable({
                head: [pdfHeaders],
                body: pdfBody,
                startY: 40, // leave space for custom header
                theme: "striped",
                styles: {
                    fontSize: 8,
                    halign: "center",
                    overflow: "linebreak",
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [0, 102, 204],
                    textColor: 255,
                    fontStyle: "bold",
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245],
                },
                columnStyles,
                margin: { top: 30, left: marginX, right: marginX },
                didDrawPage: (data) => {
                    const { pageNumber } = data;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const centerX = pageWidth / 2;

                    // ✅ Header only on first page
                    if (pageNumber === 1) {
                        let y = 20;
                        doc.setFont("helvetica", "bold").setFontSize(14).setTextColor(33);
                        doc.text("Individual Attendance Report", centerX, y, { align: "center" });
                        y += 6;

                        doc.setFont("helvetica", "normal").setFontSize(11).setTextColor(50);
                        doc.text(`Employee: ${employeeName}`, centerX, y, { align: "center" });
                        y += 6;

                        doc.text(`Designation: ${designation}`, centerX, y, { align: "center" });
                        y += 6;

                        if (districtLabel) {
                            doc.text(`District: ${districtLabel}`, centerX, y, { align: "center" });
                            y += 6;
                        }

                        doc.text(`From: ${fromDate.value}  To: ${toDate.value}`, centerX, y, { align: "center" });
                    }

                    // ✅ Footer (all pages)
                    const now = new Date();
                    const timestamp = now.toLocaleDateString("en-IN") + " " +
                        now.toLocaleTimeString("en-IN", { hour: '2-digit', minute: '2-digit', hour12: true });

                    const footerY = doc.internal.pageSize.height - 10;
                    doc.setFontSize(9).setTextColor(100);
                    doc.text(`Generated: ${timestamp}`, data.settings.margin.left, footerY);
                    doc.text(`Page ${pageNumber}`, pageWidth - data.settings.margin.right, footerY, { align: "right" });
                }
            });

            // ✅ Save PDF
            doc.save(`Attendance_${employeeName}_${fromDate.value}_to_${toDate.value}.pdf`);
        });



        // --- Export to Excel (Individual Records) ---
        let indivExcelHolidayWorkFullDays = 0;
        let indivExcelHolidayWorkHalfDays = 0;

        document.addEventListener("DOMContentLoaded", () => {
            const exportIndivExcelBtn = document.getElementById("export-indiv-excel");

            exportIndivExcelBtn.addEventListener("click", () => {
                const employeeDropdown = document.getElementById("indiv-employee");
                const fromDate = document.getElementById("indiv-from-date");
                const toDate = document.getElementById("indiv-to-date");

                if (!employeeDropdown || !fromDate || !toDate) {
                    showModal("Required fields are missing from the page.", null, true);
                    return;
                }

                if (!employeeDropdown.value || !fromDate.value || !toDate.value) {
                    showModal("Please select Employee, From Date, and To Date before exporting.", null, true);
                    return;
                }

                if (currentIndividualRecords.length === 0) {
                    showModal("No records to export. Please load records first.", null, true);
                    return;
                }

                const employeeName = employeeDropdown.options[employeeDropdown.selectedIndex].text;
                const showTimes = document.getElementById("indiv-toggle-times").checked;
                const designation =
                    document.querySelector('#indiv-employee-details-header p')
                        ?.textContent.split("Designation: ")[1]?.split(",")[0]?.trim() || 'N/A';

                const ws_data = [
                    [`Individual Attendance Records for ${employeeName}`],
                    [`Designation: ${designation}`],
                    [`From: ${fromDate.value} To: ${toDate.value}`],
                    [],
                ];

                // Build headers dynamically
                const headers = ["Date", "Morning"];
                if (showTimes) headers.push("Morning Time");
                headers.push("Afternoon");
                if (showTimes) headers.push("AN Enter Time", "AN Leave Time", "Exit Time");
                headers.push("Status", "Remarks", "Holiday Worked");

                ws_data.push(headers);

                // ✅ Add data rows
                currentIndividualRecords.forEach(record => {
                    const row = [
                        new Date(record.date).toLocaleDateString("en-IN"),
                        record.morningStatus,
                    ];

                    if (showTimes) {
                        row.push(record.morningTime ? formatReadableTime(record.morningTime) : "Not Marked");
                    }

                    row.push(record.afternoonStatus);

                    if (showTimes) {
                        row.push(
                            record.anEnterTime ? formatReadableTime(record.anEnterTime) : "Not Marked",
                            record.anLeaveTime ? formatReadableTime(record.anLeaveTime) : "Not Marked",
                            record.anExitTime ? formatReadableTime(record.anExitTime) : "Not Marked"
                        );
                    }

                    row.push(
                        record.overallStatus,
                        (record.remarks || []).join(", ") || "-",
                        record.workedOnHoliday ? "Yes" : "No"
                    );

                    ws_data.push(row);
                });

                // ✅ Summary counts
                let fullDays = 0, halfDays = 0, absentDays = 0, lateDays = 0;
                currentIndividualRecords.forEach(r => {
                    if (r.overallStatus === "Full Day") fullDays++;
                    else if (["Half Day", "Leave (Half Day)"].includes(r.overallStatus)) halfDays++;
                    else if (["Absent", "Leave (Full Day)"].includes(r.overallStatus)) absentDays++;
                    if (r.isLate) lateDays++;
                });

                ws_data.push([]);
                ws_data.push(["Summary:"]);
                ws_data.push([`✅ Full Days: ${fullDays}`]);
                ws_data.push([`🌗 Half Days: ${halfDays}`]);
                ws_data.push([`❌ Absent: ${absentDays}`]);
                ws_data.push([`🕒 Late: ${lateDays}`]);

                // ✅ Export to XLSX
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                ws['!cols'] = [
                    { wch: 12 }, // Date
                    { wch: 14 }, // Morning
                    { wch: 18 }, // Morning Time
                    { wch: 14 }, // Afternoon
                    { wch: 18 }, // AN Enter
                    { wch: 18 }, // AN Leave
                    { wch: 18 }, // Exit
                    { wch: 28 }, // Status
                    { wch: 40 }, // Remarks
                    { wch: 15 }  // Holiday Worked
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "IndividualRecords");
                XLSX.writeFile(wb, `Individual_Records_${employeeName}_${fromDate.value}_to_${toDate.value}.xlsx`);
            });
        });

        function drawIndividualPdfHeader(doc, employeeName, designation, fromDate, toDate, districtLabel = "All") {
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 15;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(13);
            doc.text(`Individual Attendance Report: ${employeeName}`, pageWidth / 2, y, { align: "center" });
            y += 8;

            const districtClean = districtLabel.trim().toLowerCase();
            if (districtClean !== "all" && districtClean !== "all districts") {
                doc.setFontSize(11);
                doc.text(districtLabel.toUpperCase(), pageWidth / 2, y, { align: "center" });
                y += 7;
            }

            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.text(`From: ${fromDate}     To: ${toDate}`, pageWidth / 2, y, { align: "center" });

            y += 6;
            doc.setFontSize(9);
            doc.text(`Designation: ${designation}`, pageWidth / 2, y, { align: "center" });

            return y + 6; // ✅ Final Y position for table to start
        }

        // Draw header manually and get the end Y position


        function drawIndividualHeader(doc, employeeName, designation, fromDate, toDate, districtLabel = "All") {
            return function (data) {
                const pageWidth = doc.internal.pageSize.getWidth();
                let y = 15;

                doc.setFont("helvetica", "bold");
                doc.setFontSize(13);
                doc.text(`Individual Attendance Report: ${employeeName}`, pageWidth / 2, y, { align: "center" });
                y += 8;

                const districtClean = districtLabel.trim().toLowerCase();
                if (districtClean !== "all" && districtClean !== "all districts") {
                    doc.setFontSize(11);
                    doc.text(districtLabel.toUpperCase(), pageWidth / 2, y, { align: "center" });
                    y += 7;
                }

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.text(`From: ${fromDate}     To: ${toDate}`, pageWidth / 2, y, { align: "center" });

                y += 6;
                doc.setFontSize(9);
                doc.text(`Designation: ${designation}`, pageWidth / 2, y, { align: "center" });

                // ✅ Store final y to prevent overlap
                doc.__headerEndY = y + 6;
            };
        }


        // --- Dropdowns for Edit Employee Tab ---
        const addEmployeeBranchDropdown = document.getElementById("add-employee-branch");
        const addEmployeeSubdivisionDropdown = document.getElementById("add-employee-subdivision");
        const addSpecialEmployeeCheckbox = document.getElementById("add-special-employee");
        const addBranchSubContainer = document.getElementById("add-branch-sub-container");

        const editEmployeeBranchDropdown = document.getElementById("edit-employee-branch");
        const editEmployeeSubdivisionDropdown = document.getElementById("edit-employee-subdivision");
        const editEmployeeSelect = document.getElementById("edit-employee-select");
        const editSpecialEmployeeCheckbox = document.getElementById("edit-special-employee");
        const editBranchSubContainer = document.getElementById("edit-branch-sub-container");

        // New elements for Employee ID search and Device ID reset
        const searchEmployeeIdInput = document.getElementById('search-employee-id-input');
        const searchEmployeeIdBtn = document.getElementById('search-employee-id-btn');
        const searchEmployeeIdMessage = document.getElementById('search-employee-id-message'); // NEW: Message div for inline validation
        const deviceIdDisplay = document.getElementById('device-id-display');
        const resetDeviceIdBtn = document.getElementById('reset-device-id-btn');
        let currentEmployeeUid = null; // To store the UID of the currently loaded employee for device ID reset

        const removeEmployeeSearchInput = document.getElementById('remove-employee-search-input'); // New search input
        const removeEmployeeSearchBtn = document.getElementById('remove-employee-search-btn'); // New search button
        const removeEmployeeSelect = document.getElementById("remove-employee-select"); // Employee dropdown for removal
        const removeSpecialEmployeeCheckbox = document.getElementById("remove-special-employee");
        const removeBranchSubContainer = document.getElementById("remove-branch-sub-container");
        // NEW: References for remove employee dropdowns
        const removeEmployeeBranchDropdown = document.getElementById("remove-employee-branch");
        const removeEmployeeSubdivisionDropdown = document.getElementById("remove-employee-subdivision");

        // Function to populate branch dropdowns
        const populateBranchDropdowns = (branchDropdown) => {
            get(ref(db, "branches"))
                .then(snap => {
                    const branchesObj = snap.val() || {};
                    branchDropdown.innerHTML = `<option value="">Select Branch</option>`;
                    Object.keys(branchesObj).forEach(branchKey => {
                        const label = branchKey.charAt(0).toUpperCase() + branchKey.slice(1);
                        branchDropdown.innerHTML += `<option value="${branchKey}">${label}</option>`;
                    });
                })
                .catch(err => console.error("Error loading branches:", err));
        };

        // Function to populate subdivision dropdowns
        const populateSubdivisionDropdown = (branchDropdown, subdivisionDropdown) => {
            const selBranch = branchDropdown.value;
            subdivisionDropdown.innerHTML = `<option value="">Select Subdivision</option>`;
            subdivisionDropdown.disabled = true;
            if (!selBranch) {
                return Promise.resolve(); // Return a resolved promise if no branch selected
            }
            return get(ref(db, `branches/${selBranch}/subdivisions`))
                .then(snap => {
                    const subsObj = snap.val() || {};
                    Object.keys(subsObj).forEach(subKey => {
                        const label = subKey.charAt(0).toUpperCase() + subKey.slice(1);
                        subdivisionDropdown.innerHTML += `<option value="${subKey}">${label}</option>`;
                    });
                    subdivisionDropdown.disabled = false;
                })
                .catch(err => {
                    console.error("Error loading subdivisions:", err);
                    return Promise.reject(err); // Propagate the error
                });
        };

        // Function to populate employee dropdowns
        const populateEmployeeDropdown = async (branchDropdown, subdivisionDropdown, employeeDropdown) => {
            const selBranch = branchDropdown.value;
            const selSubdivision = subdivisionDropdown.value;
            employeeDropdown.innerHTML = `<option value="">Select Employee</option>`;
            employeeDropdown.disabled = true;

            if (!selBranch || !selSubdivision) {
                return;
            }

            try {
                const employeesSnap = await get(ref(db, `branches/${selBranch}/subdivisions/${selSubdivision}/employees`));
                const employeesObj = employeesSnap.val() || {};
                Object.entries(employeesObj).forEach(([empId, empData]) => {
                    employeeDropdown.innerHTML += `<option value="${empId}">${empData.name}</option>`;
                });
                employeeDropdown.disabled = false;
            } catch (err) {
                console.error("Error loading employees:", err);
            }
        };

        // NEW: Function to search for an employee by their employee ID across all users
        async function getEmployeeByEmployeeId(empId) {
            // 1️⃣ Try using employee_ids (recommended structure)
            const empIdRef = ref(db, `employee_ids/${empId}`);
            const empIdSnap = await get(empIdRef);

            if (empIdSnap.exists()) {
                const uid = empIdSnap.val();
                const userSnap = await get(ref(db, `users/${uid}`));
                if (userSnap.exists()) {
                    const userData = userSnap.val();
                    userData.uid = uid;
                    return userData;
                }
            }

            // 2️⃣ Fallback: Search in specialEmployees
            const specialSnap = await get(ref(db, `specialEmployees/${empId}`));
            if (specialSnap.exists()) {
                const specialData = specialSnap.val();
                return {
                    ...specialData,
                    id: empId,
                    uid: null,
                    branch: 'N/A',
                    subdivision: 'Special',
                    isSpecial: true
                };
            }

            // 3️⃣ Fallback: Search in all branches/subdivisions
            const branchesSnap = await get(ref(db, `branches`));
            const branches = branchesSnap.val() || {};

            for (const branchName in branches) {
                const subdivisions = branches[branchName].subdivisions || {};
                for (const subName in subdivisions) {
                    const employees = subdivisions[subName].employees || {};
                    if (employees[empId]) {
                        const emp = employees[empId];
                        return {
                            ...emp,
                            branch: branchName,
                            subdivision: subName,
                            id: empId,
                            uid: null,
                            isSpecial: false
                        };
                    }
                }
            }

            return null; // ❌ Not found anywhere
        }


        // Initial population for Add Employee
        populateBranchDropdowns(addEmployeeBranchDropdown);
        addEmployeeBranchDropdown.addEventListener("change", () => populateSubdivisionDropdown(addEmployeeBranchDropdown, addEmployeeSubdivisionDropdown));

        // Initial population for Edit Employee
        populateBranchDropdowns(editEmployeeBranchDropdown);
        editEmployeeBranchDropdown.addEventListener("change", () => {
            populateSubdivisionDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown);
            editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`; // Clear employee dropdown
            editEmployeeSelect.disabled = true;
            // Clear fields when branch changes
            document.getElementById("edit-employee-name").value = "";
            document.getElementById("edit-employee-phone").value = "";
            document.getElementById("edit-employee-email").value = "";
            document.getElementById("edit-employee-designation").value = "";
            deviceIdDisplay.textContent = "N/A";
            resetDeviceIdBtn.classList.add('hidden');
            currentEmployeeUid = null;
        });
        editEmployeeSubdivisionDropdown.addEventListener("change", () => populateEmployeeDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown, editEmployeeSelect));

        // Initial population for Remove Employee (Now handled in window.onload and search flow)
        // removeEmployeeBranchDropdown.addEventListener("change", () => {
        //     populateSubdivisionDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown);
        //     removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`; // Clear employee dropdown
        //     removeEmployeeSelect.disabled = true;
        // });
        // removeEmployeeSubdivisionDropdown.addEventListener("change", () => populateEmployeeDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown, removeEmployeeSelect));





        // Handle "Special Employee" checkbox for Add
        addSpecialEmployeeCheckbox.addEventListener('change', () => {
            if (addSpecialEmployeeCheckbox.checked) {
                addBranchSubContainer.classList.add('hidden');
                addEmployeeBranchDropdown.value = "";
                addEmployeeSubdivisionDropdown.value = "";
                addEmployeeSubdivisionDropdown.disabled = true;
            } else {
                addBranchSubContainer.classList.remove('hidden');
            }
        });

        // Handle "Special Employee" checkbox for Edit
        editSpecialEmployeeCheckbox.addEventListener('change', () => {
            if (editSpecialEmployeeCheckbox.checked) {
                editBranchSubContainer.classList.add('hidden');
                editEmployeeBranchDropdown.value = "";
                editEmployeeSubdivisionDropdown.value = "";
                editEmployeeSubdivisionDropdown.disabled = true;
                editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                editEmployeeSelect.disabled = false; // Enable for special employees
                populateSpecialEmployees(editEmployeeSelect);
            } else {
                editBranchSubContainer.classList.remove('hidden');
                editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                editEmployeeSelect.disabled = true;
                // Re-populate normal employees if branch/subdivision are selected
                if (editEmployeeBranchDropdown.value && editEmployeeSubdivisionDropdown.value) {
                    populateEmployeeDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown, editEmployeeSelect);
                }
            }
            // Clear fields and device ID display when special employee checkbox changes
            document.getElementById("edit-employee-name").value = "";
            document.getElementById("edit-employee-phone").value = "";
            document.getElementById("edit-employee-email").value = "";
            document.getElementById("edit-employee-designation").value = "";
            deviceIdDisplay.textContent = "N/A";
            resetDeviceIdBtn.classList.add('hidden');
            currentEmployeeUid = null;
        });

        // Handle "Special Employee" checkbox for Remove
        removeSpecialEmployeeCheckbox.addEventListener('change', () => {
            if (removeSpecialEmployeeCheckbox.checked) {
                removeBranchSubContainer.classList.add('hidden');
                removeEmployeeBranchDropdown.value = "";
                removeEmployeeSubdivisionDropdown.value = "";
                removeEmployeeSubdivisionDropdown.disabled = true;
                removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                removeEmployeeSelect.disabled = false; // Enable for special employees
                populateSpecialEmployees(removeEmployeeSelect);
            } else {
                removeBranchSubContainer.classList.remove('hidden');
                removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                removeEmployeeSelect.disabled = true;
                // Re-populate normal employees if branch/subdivision are selected
                if (removeEmployeeBranchDropdown.value && removeEmployeeSubdivisionDropdown.value) {
                    populateEmployeeDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown, removeEmployeeSelect);
                }
            }
        });

        // Function to populate special employees dropdown
        const populateSpecialEmployees = (employeeDropdown) => {
            get(ref(db, "specialEmployees"))
                .then(snap => {
                    const specialEmployeesObj = snap.val() || {};
                    employeeDropdown.innerHTML = `<option value="">Select Special Employee</option>`;
                    Object.entries(specialEmployeesObj).forEach(([empId, empData]) => {
                        employeeDropdown.innerHTML += `<option value="${empId}">${empData.name}</option>`;
                    });
                })
                .catch(err => console.error("Error loading special employees:", err));
        };

        // Populate employee details when selected for editing (via dropdown)
        editEmployeeSelect.addEventListener("change", async () => {
            const employeeId = editEmployeeSelect.value;
            if (!employeeId) {
                document.getElementById("edit-employee-name").value = "";
                document.getElementById("edit-employee-phone").value = "";
                document.getElementById("edit-employee-email").value = "";
                document.getElementById("edit-employee-designation").value = ""; // Clear designation
                deviceIdDisplay.textContent = "Not Marked";
                resetDeviceIdBtn.classList.add('hidden');
                currentEmployeeUid = null;
                return;
            }

            try {
                let employeeData = null;
                if (editSpecialEmployeeCheckbox.checked) {
                    const snap = await get(ref(db, `specialEmployees/${employeeId}`));
                    employeeData = snap.val();
                    currentEmployeeUid = null; // Special employees don't have a direct UID in 'users'
                } else {
                    const branch = editEmployeeBranchDropdown.value;
                    const subdivision = editEmployeeSubdivisionDropdown.value;
                    if (branch && subdivision) {
                        const snap = await get(ref(db, `branches/${branch}/subdivisions/${subdivision}/employees/${employeeId}`));
                        employeeData = snap.val();
                        // Find the UID associated with this employeeId in the 'users' node
                        const usersSnap = await get(ref(db, 'users'));
                        usersSnap.forEach(userChild => {
                            const userData = userChild.val();
                            if (userData.id === employeeId) {
                                currentEmployeeUid = userChild.key;
                                return true; // Break forEach
                            }
                        });
                    }
                }

                if (employeeData) {
                    document.getElementById("edit-employee-name").value = employeeData.name || "";
                    document.getElementById("edit-employee-phone").value = employeeData.phone || "";
                    document.getElementById("edit-employee-email").value = employeeData.email || "";
                    document.getElementById("edit-employee-designation").value = employeeData.des || ""; // Populate designation

                    // Display Device ID if available and show reset button
                    if (currentEmployeeUid) {
                        const userProfileSnap = await get(ref(db, `users/${currentEmployeeUid}`));
                        const userProfileData = userProfileSnap.val();
                        // Changed from deviceId to boundDevice
                        if (userProfileData && userProfileData.boundDevice) {
                            deviceIdDisplay.textContent = userProfileData.boundDevice;
                            resetDeviceIdBtn.classList.remove('hidden');
                        } else {
                            deviceIdDisplay.textContent = "Not Marked";
                            resetDeviceIdBtn.classList.add('hidden');
                        }
                    } else {
                        deviceIdDisplay.textContent = "Not Marked";
                        resetDeviceIdBtn.classList.add('hidden');
                    }

                } else {
                    document.getElementById("edit-employee-name").value = "";
                    document.getElementById("edit-employee-phone").value = "";
                    document.getElementById("edit-employee-email").value = "";
                    document.getElementById("edit-employee-designation").value = ""; // Clear designation
                    deviceIdDisplay.textContent = "Not Marked";
                    resetDeviceIdBtn.classList.add('hidden');
                    currentEmployeeUid = null;
                }
            } catch (error) {
                console.error("Error fetching employee details for edit:", error);
                deviceIdDisplay.textContent = "Not Marked";
                resetDeviceIdBtn.classList.add('hidden');
                currentEmployeeUid = null;
            }
        });

        // NEW: Search Employee by ID button click handler
        searchEmployeeIdBtn.addEventListener('click', async () => {
            const empIdToSearch = searchEmployeeIdInput.value.trim();
            const searchMessage = document.getElementById('search-employee-id-message'); // Get the message div

            // Clear previous messages and styling
            searchMessage.textContent = '';
            searchMessage.classList.remove('text-red-500', 'text-green-500', 'block');
            searchEmployeeIdInput.classList.remove('border-red-500');

            if (!empIdToSearch) {
                searchMessage.textContent = "Please enter an Employee ID to search.";
                searchMessage.classList.add('text-red-500', 'block');
                searchEmployeeIdInput.classList.add('border-red-500');
                // Set a timeout to clear the message and border
                setTimeout(() => {
                    searchMessage.textContent = '';
                    searchMessage.classList.remove('block');
                    searchEmployeeIdInput.classList.remove('border-red-500');
                }, 3000); // Message disappears after 3 seconds
                return;
            }

            showLoadingModal(`Searching for employee ID: ${empIdToSearch}...`);
            try {
                const employeeData = await getEmployeeByEmployeeId(empIdToSearch);

                if (employeeData) {
                    // Autofill fields
                    document.getElementById("edit-employee-name").value = employeeData.name || "";
                    document.getElementById("edit-employee-phone").value = employeeData.phone || "";
                    document.getElementById("edit-employee-email").value = employeeData.email || "";
                    document.getElementById("edit-employee-designation").value = employeeData.des || "";

                    // Set dropdowns
                    if (employeeData.isSpecial) {
                        editSpecialEmployeeCheckbox.checked = true;
                        editBranchSubContainer.classList.add('hidden');
                        editEmployeeBranchDropdown.value = "";
                        editEmployeeSubdivisionDropdown.value = "";
                        editEmployeeSubdivisionDropdown.disabled = true;
                        // Populate special employees dropdown and select the found one
                        await populateSpecialEmployees(editEmployeeSelect);
                        editEmployeeSelect.value = employeeData.id;
                    } else {
                        editSpecialEmployeeCheckbox.checked = false;
                        editBranchSubContainer.classList.remove('hidden');
                        editEmployeeBranchDropdown.value = employeeData.branch;
                        await populateSubdivisionDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown);
                        editEmployeeSubdivisionDropdown.value = employeeData.subdivision;
                        await populateEmployeeDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown, editEmployeeSelect);
                        editEmployeeSelect.value = employeeData.id;
                    }

                    // Store the UID if found, for Device ID reset
                    currentEmployeeUid = employeeData.uid || null;

                    // Display Device ID and show reset button if applicable
                    // Changed from deviceId to boundDevice
                    if (employeeData.boundDevice) {
                        deviceIdDisplay.textContent = employeeData.boundDevice;
                        resetDeviceIdBtn.classList.remove('hidden');
                    } else {
                        deviceIdDisplay.textContent = "Not Marked";
                        resetDeviceIdBtn.classList.add('hidden');
                    }
                    searchMessage.textContent = `Employee "${employeeData.name}" (ID: ${empIdToSearch}) found and loaded.`;
                    searchMessage.classList.add('text-green-500', 'block');
                    setTimeout(() => {
                        searchMessage.textContent = '';
                        searchMessage.classList.remove('block');
                    }, 3000);
                } else {
                    searchMessage.textContent = `Employee ID "${empIdToSearch}" not found.`;
                    searchMessage.classList.add('text-red-500', 'block');
                    searchEmployeeIdInput.classList.add('border-red-500');
                    setTimeout(() => {
                        searchMessage.textContent = '';
                        searchMessage.classList.remove('block');
                        searchEmployeeIdInput.classList.remove('border-red-500');
                    }, 3000);
                    // Clear all fields if not found
                    document.getElementById("edit-employee-name").value = "";
                    document.getElementById("edit-employee-phone").value = "";
                    document.getElementById("edit-employee-email").value = "";
                    document.getElementById("edit-employee-designation").value = "";
                    editEmployeeSelect.value = "";
                    deviceIdDisplay.textContent = "Not Marked";
                    resetDeviceIdBtn.classList.add('hidden');
                    currentEmployeeUid = null;
                }
            } catch (error) {
                console.error("Error during employee ID search:", error);
                searchMessage.textContent = "An error occurred during search. Please try again.";
                searchMessage.classList.add('text-red-500', 'block');
                searchEmployeeIdInput.classList.add('border-red-500');
                setTimeout(() => {
                    searchMessage.textContent = '';
                    searchMessage.classList.remove('block');
                    searchEmployeeIdInput.classList.remove('border-red-500');
                }, 3000);
            } finally {
                hideLoadingModal();
            }
        });

        // NEW: Reset Device ID button click handler
        resetDeviceIdBtn.addEventListener('click', async () => {
            if (!currentEmployeeUid) {
                showModal("No employee selected or UID not found to reset Device ID.", null, true);
                return;
            }

            showModal("Are you sure you want to reset this employee's Device ID? They will need to log in again on their device.", async (confirm) => {
                if (!confirm) return;

                showLoadingModal("Resetting Device ID...");
                try {
                    const userRef = ref(db, `users/${currentEmployeeUid}`);
                    await update(userRef, { boundDevice: null }); // Set to null to remove the field

                    // Log activity
                    const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                    const newLogRef = push(activityLogsRef);
                    await set(newLogRef, {
                        timestamp: (new Date()).toISOString(),
                        by: currentUserName,
                        action: "Device ID Reset",
                        section: "Employee Management",
                        employeeId: document.getElementById("edit-employee-select").value || searchEmployeeIdInput.value,
                        employeeName: document.getElementById("edit-employee-name").value,
                        targetUid: currentEmployeeUid
                    });

                    deviceIdDisplay.textContent = "Not Marked";
                    resetDeviceIdBtn.classList.add('hidden');
                    showModal("Device ID has been cleared. Employee can now login from a new device.");
                } catch (error) {
                    console.error("Error resetting Device ID:", error);
                    showModal("Failed to reset Device ID: " + error.message, null, true);
                } finally {
                    hideLoadingModal();
                }
            });
        });

        // --- Add Employee Logic ---
        document.getElementById("add-employee-btn").addEventListener("click", async () => {
            const empId = document.getElementById("add-employee-id").value.trim(); // New Employee ID field
            const name = document.getElementById("add-employee-name").value.trim();
            const phone = document.getElementById("add-employee-phone").value.trim();
            const email = document.getElementById("add-employee-email").value.trim();
            const designation = document.getElementById("add-employee-designation").value.trim(); // New designation field
            const isSpecial = addSpecialEmployeeCheckbox.checked;
            const branch = addEmployeeBranchDropdown.value;
            const subdivision = addEmployeeSubdivisionDropdown.value;

            if (!empId || !name || !designation) { // Designation is now required
                showModal("Please fill in Employee ID, Name, and Designation.", null, true);
                return;
            }

            if (!isSpecial && (!branch || !subdivision)) {
                showModal("Please select Branch and Subdivision for regular employees.", null, true);
                return;
            }

            showModal(`Are you sure you want to add employee "${name}" with ID "${empId}" and Designation "${designation}"?`, async (confirm) => {
                if (confirm) {
                    showLoadingModal("Adding employee...");
                    try {
                        let employeeExists = false;

                        // 1. Check if empId exists in any user's profile (users/{uid}/id)
                        const usersRef = ref(db, "users");
                        const usersSnapshot = await get(usersRef);
                        usersSnapshot.forEach(userSnap => {
                            const userData = userSnap.val();
                            if (userData.id === empId) { // Check against 'id' field, not 'empId'
                                employeeExists = true;
                                return true; // Break forEach
                            }
                        });

                        if (employeeExists) {
                            hideLoadingModal();
                            showModal(`Employee ID "${empId}" is already assigned to a user. Please use a different ID.`, null, true);
                            return;
                        }

                        // 2. Check if empId exists in branches/{selectedBranch}/employees/{empId} or specialEmployees/{empId}
                        if (isSpecial) {
                            const specialEmpSnap = await get(ref(db, `specialEmployees/${empId}`));
                            if (specialEmpSnap.exists()) {
                                employeeExists = true;
                            }
                        } else {
                            const branchEmpSnap = await get(ref(db, `branches/${branch}/subdivisions/${subdivision}/employees/${empId}`));
                            if (branchEmpSnap.exists()) {
                                employeeExists = true;
                            }
                        }

                        if (employeeExists) {
                            hideLoadingModal();
                            showModal(`Employee ID "${empId}" already exists in the employee database. Please use a different ID or modify the existing employee.`, null, true);
                            return;
                        }

                        const employeeData = {
                            id: empId,
                            name: name,
                            phone: phone || null, // Allow phone to be optional
                            email: email || null, // Allow email to be optional
                            des: designation, // Store designation
                            isSpecial: isSpecial || null
                        };

                        let employeeDbPath;
                        if (isSpecial) {
                            employeeDbPath = `specialEmployees/${empId}`;
                        } else {
                            employeeDbPath = `branches/${branch}/subdivisions/${subdivision}/employees/${empId}`;
                        }

                        await set(ref(db, employeeDbPath), employeeData);

                        // Log activity - CORRECTED USAGE OF PUSH
                        const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                        const newLogRef = push(activityLogsRef); // Generate a new unique key
                        await set(newLogRef, {
                            timestamp: (new Date()).toISOString(),
                            by: currentUserName,
                            action: "Employee Added",
                            section: "Employee Management",
                            employeeId: empId,
                            employeeName: name,
                            phone: phone,
                            email: email,
                            designation: designation, // Log designation
                            isSpecial: isSpecial,
                            branch: isSpecial ? 'N/A' : branch,
                            subdivision: isSpecial ? 'Special' : subdivision
                        });

                        hideLoadingModal();
                        showModal(`Employee "${name}" added successfully with ID: ${empId}!`);

                        // Clear form
                        document.getElementById("add-employee-id").value = "";
                        document.getElementById("add-employee-name").value = "";
                        document.getElementById("add-employee-phone").value = "";
                        document.getElementById("add-employee-email").value = "";
                        document.getElementById("add-employee-designation").value = ""; // Clear designation
                        addSpecialEmployeeCheckbox.checked = false;
                        addBranchSubContainer.classList.remove('hidden');
                        addEmployeeBranchDropdown.value = "";
                        addEmployeeSubdivisionDropdown.value = "";
                        addEmployeeSubdivisionDropdown.disabled = true;

                        // Re-populate dropdowns (for edit/remove tabs to reflect new employee)
                        populateBranchDropdowns(editEmployeeBranchDropdown);
                        // populateBranchDropdowns(removeEmployeeBranchDropdown); // Not needed with search
                    } catch (error) {
                        hideLoadingModal();
                        console.error("Error adding employee:", error);
                        showModal("Failed to add employee: " + error.message, null, true);
                    }
                }
            });
        });


        // --- Save Employee Changes Logic ---
        document.getElementById("save-employee-btn").addEventListener("click", async () => {
            const employeeId = editEmployeeSelect.value;
            const name = document.getElementById("edit-employee-name").value.trim();
            const phone = document.getElementById("edit-employee-phone").value.trim();
            const email = document.getElementById("edit-employee-email").value.trim();
            const designation = document.getElementById("edit-employee-designation").value.trim(); // Get designation
            const isSpecial = editSpecialEmployeeCheckbox.checked;
            const branch = editEmployeeBranchDropdown.value;
            const subdivision = editEmployeeSubdivisionDropdown.value;

            if (!employeeId) {
                showModal("Please select an employee to edit.", null, true);
                return;
            }

            if (!name || !designation) { // Name and Designation are compulsory
                showModal("Employee Name and Designation are compulsory.", null, true);
                return;
            }

            if (!isSpecial && (!branch || !subdivision)) {
                showModal("Please select Branch and Subdivision for regular employees.", null, true);
                return;
            }

            showModal(`Are you sure you want to save changes for employee "${name}"?`, async (confirm) => {
                if (confirm) {
                    showLoadingModal("Saving changes...");
                    try {
                        let employeeRefPath;
                        let oldEmployeeData = null;

                        if (isSpecial) {
                            employeeRefPath = `specialEmployees/${employeeId}`;
                        } else {
                            employeeRefPath = `branches/${branch}/subdivisions/${subdivision}/employees/${employeeId}`;
                        }
                        const employeeRef = ref(db, employeeRefPath);
                        const snap = await get(employeeRef);
                        oldEmployeeData = snap.val();

                        if (!oldEmployeeData) {
                            hideLoadingModal();
                            showModal("Employee not found for update.", null, true);
                            return;
                        }

                        const updatedData = {
                            name: name,
                            phone: phone || null,
                            email: email || null,
                            des: designation, // Update designation
                            isSpecial: isSpecial || null
                        };

                        await update(employeeRef, updatedData);

                        // Also update the 'users' node if a corresponding user exists
                        if (currentEmployeeUid) {
                            const userRef = ref(db, `users/${currentEmployeeUid}`);
                            const userUpdates = {
                                name: name,
                                email: email || null,
                                phone: phone || null,
                                des: designation,
                                branch: isSpecial ? 'N/A' : branch, // Update branch/subdivision in user node
                                subdivision: isSpecial ? 'Special' : subdivision
                            };
                            await update(userRef, userUpdates);
                        }

                        // Log activity - CORRECTED USAGE OF PUSH
                        const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                        const newLogRef = push(activityLogsRef); // Generate a new unique key
                        await set(newLogRef, {
                            timestamp: (new Date()).toISOString(),
                            by: currentUserName,
                            action: "Employee Updated",
                            section: "Employee Management",
                            employeeId: employeeId,
                            before: oldEmployeeData,
                            after: { ...oldEmployeeData, ...updatedData } // Merge old with new for 'after'
                        });

                        hideLoadingModal();
                        showModal(`Changes saved for employee "${name}" successfully!`);

                        // Clear form and reset dropdowns
                        document.getElementById("edit-employee-name").value = "";
                        document.getElementById("edit-employee-phone").value = "";
                        document.getElementById("edit-employee-email").value = "";
                        document.getElementById("edit-employee-designation").value = ""; // Clear designation
                        editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                        editEmployeeSelect.disabled = true;
                        editSpecialEmployeeCheckbox.checked = false;
                        editBranchSubContainer.classList.remove('hidden');
                        editEmployeeBranchDropdown.value = "";
                        editEmployeeSubdivisionDropdown.value = "";
                        editEmployeeSubdivisionDropdown.disabled = true;
                        deviceIdDisplay.textContent = "Not Marked";
                        resetDeviceIdBtn.classList.add('hidden');
                        currentEmployeeUid = null;
                        searchEmployeeIdInput.value = ""; // Clear search input

                        // Re-populate dropdowns
                        populateBranchDropdowns(editEmployeeBranchDropdown);
                        // populateBranchDropdowns(removeEmployeeBranchDropdown); // Not needed with search
                    } catch (error) {
                        hideLoadingModal();
                        console.error("Error saving employee changes:", error);
                        showModal("Failed to save employee changes: " + error.message, null, true);
                    }
                }
            });
        });

        // --- Remove Employee Logic ---
        // NEW: Search Employee by ID for Removal
        removeEmployeeSearchBtn.addEventListener('click', async () => {
            const empIdToSearch = removeEmployeeSearchInput.value.trim();
            if (!empIdToSearch) {
                showModal("Please enter an Employee ID to search for removal.", null, false, "Input Required"); // Changed to Input Required
                return;
            }

            showLoadingModal(`Searching for employee ID: ${empIdToSearch}...`);
            try {
                const employeeData = await getEmployeeDetails(empIdToSearch);

                if (employeeData) {
                    // Set dropdowns and fields based on found employee for confirmation
                    if (employeeData.isSpecial) {
                        removeSpecialEmployeeCheckbox.checked = true;
                        removeBranchSubContainer.classList.add('hidden');
                        removeEmployeeBranchDropdown.value = "";
                        removeEmployeeSubdivisionDropdown.value = "";
                        removeEmployeeSubdivisionDropdown.disabled = true;
                        await populateSpecialEmployees(removeEmployeeSelect); // Populate special employees dropdown
                        removeEmployeeSelect.value = employeeData.id;
                    } else {
                        removeSpecialEmployeeCheckbox.checked = false;
                        removeBranchSubContainer.classList.remove('hidden');
                        removeEmployeeBranchDropdown.value = employeeData.branch;
                        await populateSubdivisionDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown);
                        removeEmployeeSubdivisionDropdown.value = employeeData.subdivision;
                        await populateEmployeeDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown, removeEmployeeSelect);
                        removeEmployeeSelect.value = employeeData.id;
                    }
                    removeEmployeeSelect.disabled = false; // Enable the select once an employee is found

                    hideLoadingModal();
                    showModal(`Employee "${employeeData.name}" (ID: ${empIdToSearch}) found. You can now proceed with removal.`, null, false, "Employee Found");
                } else {
                    hideLoadingModal();
                    showModal(`Employee ID "${empIdToSearch}" not found in the database.`, null, true);
                    // Clear and disable dropdowns if not found
                    removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                    removeEmployeeSelect.disabled = true;
                    removeSpecialEmployeeCheckbox.checked = false;
                    removeBranchSubContainer.classList.remove('hidden');
                    removeEmployeeBranchDropdown.value = "";
                    removeEmployeeSubdivisionDropdown.value = "";
                    removeEmployeeSubdivisionDropdown.disabled = true;
                }
            } catch (error) {
                hideLoadingModal();
                console.error("Error during employee ID search for removal:", error);
                showModal("An error occurred during search. Please try again.", null, true);
            }
        });

        document.getElementById("remove-employee-btn").addEventListener("click", async () => {
            const empId = removeEmployeeSelect.value;

            if (!empId) {
                showModal("⚠️ Please search for and select an employee to remove.", null, true);
                return;
            }

            showLoadingModal("Checking if employee has a user account...");
            try {
                const empIdSnap = await get(ref(db, `employee_ids/${empId}`));
                hideLoadingModal();

                if (empIdSnap.exists()) {
                    // ✅ Registered user — has UID
                    const uid = empIdSnap.val();
                    await deleteEmployee(uid, empId); // Cloud function: deletes DB + Auth + logs
                } else {
                    // ✅ Not registered — no UID
                    showModal(`Employee ID "${empId}" has no linked user account. Proceed with DB-only removal?`, async (confirm) => {
                        if (confirm) {
                            showLoadingModal("Removing employee data from database...");

                            try {
                                const isSpecial = removeSpecialEmployeeCheckbox.checked;
                                if (isSpecial) {
                                    await remove(ref(db, `specialEmployees/${empId}`));
                                } else {
                                    const branch = removeEmployeeBranchDropdown.value;
                                    const subdivision = removeEmployeeSubdivisionDropdown.value;
                                    await remove(ref(db, `branches/${branch}/subdivisions/${subdivision}/employees/${empId}`));
                                }

                                // ✅ Log manually (since Cloud Function won't run)
                                const today = new Date().toISOString().split("T")[0];
                                const logRef = push(ref(db, `activityLogs/${today}`));
                                await set(logRef, {
                                    timestamp: new Date().toISOString(),
                                    by: currentUserName,
                                    action: "Employee Removed (No UID)",
                                    section: "Employee Management",
                                    employeeId: empId,
                                    isSpecial: removeSpecialEmployeeCheckbox.checked,
                                    branch: removeSpecialEmployeeCheckbox.checked ? "N/A" : removeEmployeeBranchDropdown.value,
                                    subdivision: removeSpecialEmployeeCheckbox.checked ? "Special" : removeEmployeeSubdivisionDropdown.value
                                });

                                hideLoadingModal();
                                showModal(`✅ Employee "${empId}" removed from database (no Auth account found).`);

                                // ✅ Reset UI
                                removeEmployeeSearchInput.value = "";
                                removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                                removeEmployeeSelect.disabled = true;
                                removeSpecialEmployeeCheckbox.checked = false;
                                removeBranchSubContainer.classList.remove('hidden');
                                removeEmployeeBranchDropdown.value = "";
                                removeEmployeeSubdivisionDropdown.value = "";
                                removeEmployeeSubdivisionDropdown.disabled = true;
                            } catch (err) {
                                hideLoadingModal();
                                console.error("Error removing DB-only employee:", err);
                                showModal("❌ Failed to remove employee from database.", null, true);
                            }
                        }
                    }, false, "Confirm DB-only Removal");
                }
            } catch (error) {
                hideLoadingModal();
                console.error("Error retrieving UID:", error);
                showModal("❌ Failed to check employee UID. Try again.", null, true);
            }
        });

        // --- Branch & Subdivision Management Logic ---
        const createBranchNameInput = document.getElementById('create-branch-name');
        const createBranchLatInput = document.getElementById('create-branch-lat');
        const createBranchLngInput = document.getElementById('create-branch-lng');
        const createBranchRadiusInput = document.getElementById('create-branch-radius');
        const createBranchBtn = document.getElementById('create-branch-btn');

        const addSubdivisionBranchDropdown = document.getElementById('add-subdivision-branch');
        const addSubdivisionNameInput = document.getElementById('add-subdivision-name');
        const addSubdivisionBtn = document.getElementById('add-subdivision-btn');

        // New elements for editing branches and subdivisions
        const editBranchDropdown = document.getElementById('edit-branch-dropdown');
        const editBranchNameInputContainer = document.getElementById('edit-branch-name-input-container');
        const editBranchNameInput = document.getElementById('edit-branch-name-input');
        const saveBranchNameBtn = document.getElementById('save-branch-name-btn');

        const editSubdivisionBranchDropdown = document.getElementById('edit-subdivision-branch-dropdown');
        const editSubdivisionDropdown = document.getElementById('edit-subdivision-dropdown');
        const editSubdivisionNameInputContainer = document.getElementById('edit-subdivision-name-input-container');
        const editSubdivisionNameInput = document.getElementById('edit-subdivision-name-input');
        const saveSubdivisionNameBtn = document.getElementById('save-subdivision-name-btn');

        const branchesListContainer = document.getElementById('branches-list-container');

        /**
         * Populates the branch dropdown for adding subdivisions and renders the list of existing branches and subdivisions.
         */
        async function populateDistrictDropdownForRecords(selectEl) {
            selectEl.innerHTML = `<option value="All">All Districts</option>`;
            try {
                const snapshot = await get(ref(db, "districts"));
                if (snapshot.exists()) {
                    const districts = snapshot.val();
                    for (const districtName in districts) {
                        const option = document.createElement("option");
                        option.value = districtName;
                        option.textContent = districtName;
                        selectEl.appendChild(option);
                    }
                }
            } catch (err) {
                console.error("Failed to load districts:", err);
            }
        }


        populateDistrictDropdownForRecords(document.getElementById("record-district"));
        populateDistrictDropdownForRecords(document.getElementById("indiv-district"));

        document.getElementById("record-district").addEventListener("change", async () => {
            const selectedDistrict = document.getElementById("record-district").value;
            const branchDropdown = document.getElementById("record-branch");
            const subDropdown = document.getElementById("record-subdivision");

            branchDropdown.innerHTML = `<option value="All">All</option>`;
            subDropdown.innerHTML = `<option value="All">All</option>`;
            subDropdown.disabled = true;

            try {
                let branchesToShow = [];

                if (selectedDistrict === "All") {
                    const snap = await get(ref(db, `branches`));
                    if (snap.exists()) {
                        branchesToShow = Object.keys(snap.val());
                    }
                } else {
                    const snap = await get(ref(db, `districts/${selectedDistrict}/branches`));
                    if (snap.exists()) {
                        branchesToShow = Object.keys(snap.val());
                    }
                }

                branchesToShow.forEach(branchKey => {
                    const option = document.createElement("option");
                    option.value = branchKey;
                    option.textContent = branchKey;
                    branchDropdown.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading branches:", err);
            }
        });


        document.getElementById("indiv-district").addEventListener("change", async () => {
            const selectedDistrict = document.getElementById("indiv-district").value;
            const branchDropdown = document.getElementById("indiv-branch");
            const subDropdown = document.getElementById("indiv-subdivision");

            branchDropdown.innerHTML = `<option value="All">All</option>`;
            subDropdown.innerHTML = `<option value="All">All</option>`;
            subDropdown.disabled = true;

            try {
                let branchesToShow = [];

                if (selectedDistrict === "All") {
                    const snap = await get(ref(db, `branches`));
                    if (snap.exists()) {
                        branchesToShow = Object.keys(snap.val());
                    }
                } else {
                    const snap = await get(ref(db, `districts/${selectedDistrict}/branches`));
                    if (snap.exists()) {
                        branchesToShow = Object.keys(snap.val());
                    }
                }

                branchesToShow.forEach(branchKey => {
                    const option = document.createElement("option");
                    option.value = branchKey;
                    option.textContent = branchKey;
                    branchDropdown.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading branches:", err);
            }
        });

        //------------------------------------------------------------------------------------------------------------------



        window.addEventListener("load", () => {
            const loadBtn = document.getElementById("summary-load-btn");
            if (loadBtn) {
                loadBtn.addEventListener("click", () => {
                    const d = document.getElementById("summary-district").value;
                    const b = document.getElementById("summary-branch").value;
                    const s = document.getElementById("summary-subdivision").value;
                    const f = document.getElementById("summary-from").value;
                    const t = document.getElementById("summary-to").value;

                    console.log("✅ Load clicked");
                    console.log("District:", d, "Branch:", b, "Subdivision:", s);
                    console.log("From:", f, "To:", t);

                    document.getElementById("summary-loading").classList.remove("hidden");

                });
            } else {
                console.error("❌ summary-load-btn not found in DOM. Check ID and timing.");
            }
        });
        // Full Production-Ready Attendance Summary Logic
        // Ensure this is inside window.onload or after DOM loads

        document.getElementById("summary-load-btn").addEventListener("click", async () => {
            const summaryDistrict = document.getElementById("summary-district").value;
            const summaryBranch = document.getElementById("summary-branch").value;
            const summarySubdivision = document.getElementById("summary-subdivision").value;
            const fromDateStr = document.getElementById("summary-from").value;
            const toDateStr = document.getElementById("summary-to").value;

            const summaryBody = document.getElementById("summary-table-body");
            const summaryHead = document.getElementById("summary-table-head");
            const summaryLoading = document.getElementById("summary-loading");

            if (!fromDateStr || !toDateStr) {
                alert("Please select a valid date range.");
                return;
            }

            summaryLoading.classList.remove("hidden");
            summaryBody.innerHTML = `<tr><td colspan='7' class='text-center text-gray-500 py-4'>Loading summary...</td></tr>`;

            const fromDate = new Date(fromDateStr);
            const toDate = new Date(toDateStr);

            const summaryMap = new Map();
            const holidays = await fetchSummaryHolidays(fromDate, toDate);

            const branchesToSearch = await getBranchesFromSelection(summaryDistrict, summaryBranch);

            for (const branch of branchesToSearch) {
                const subsToSearch = await getSubdivisionsFromSelection(branch, summarySubdivision);
                for (const subdivision of subsToSearch) {
                    const empSnap = await get(ref(db, `branches/${branch}/subdivisions/${subdivision}/employees`));
                    if (!empSnap.exists()) continue;

                    const employees = empSnap.val();
                    for (const empId in employees) {
                        const empName = employees[empId].name || empId;
                        if (!summaryMap.has(empId)) {
                            summaryMap.set(empId, {
                                name: empName,
                                branch,
                                subdivision,
                                leave: 0,
                                late: 0,
                                half: 0,
                                holidayWork: 0
                            });
                        }
                    }
                }
            }

            // Now compute per day per employee
            for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const isHoliday = holidays[dateStr] ? true : false;
                const holidayReason = holidays[dateStr]?.reason || '';
                const dow = d.getDay();

                for (const [empId, empData] of summaryMap.entries()) {
                    const [year, month, day] = dateStr.split("-");
                    const attPath = `attendance/${year}/${month}/${day}/${empData.branch}/${empData.subdivision}/${empId}`;
                    const leavePath = `leaveLogs/${empId}/${dateStr}`;

                    const attSnap = await get(ref(db, attPath));
                    const leaveSnap = await get(ref(db, leavePath));

                    const attendance = attSnap.val();
                    const leaveData = leaveSnap.val();

                    // 🚫 Skip if no attendance and no leave recorded
                    if (!attendance && !leaveData) continue;

                    const result = await evaluateAttendanceStatus(attendance, isHoliday, holidayReason, dow, leaveData);

                    empData.leave += result.leaveTaken;
                    if (result.isLate) empData.late++;
                    if (result.overallStatus.includes("Half Day")) empData.half++;
                    if (result.workedOnHoliday) empData.holidayWork++;
                }
            }


            // Render table
            summaryLoading.classList.add("hidden");
            summaryHead.innerHTML = "<th>Name</th>";
            if (summaryBranch === "All") summaryHead.innerHTML += "<th>Branch</th>";
            if (summarySubdivision === "All") summaryHead.innerHTML += "<th>Subdivision</th>";
            summaryHead.innerHTML += `
    <th>Total Leave</th>
    <th>Total Late Comings</th>
    <th>Total Half Days</th>
    <th>Holiday Work</th>`;

            summaryBody.innerHTML = "";
            for (const data of summaryMap.values()) {
                const row = document.createElement("tr");
                row.classList.add("border-b");
                row.innerHTML = `
      <td class="py-2 px-4">${data.name}</td>
      ${summaryBranch === "All" ? `<td class="py-2 px-4">${data.branch}</td>` : ""}
      ${summarySubdivision === "All" ? `<td class="py-2 px-4">${data.subdivision}</td>` : ""}
      <td class="py-2 px-4 text-center">${data.leave}</td>
      <td class="py-2 px-4 text-center">${data.late}</td>
      <td class="py-2 px-4 text-center">${data.half}</td>
      <td class="py-2 px-4 text-center">${data.holidayWork}</td>`;
                summaryBody.appendChild(row);
            }
        });

        // Fetch holidays within range
        async function fetchSummaryHolidays(fromDate, toDate) {

            const holidays = {};
            const holidaysRef = ref(db, 'holidays');
            const snapshot = await get(holidaysRef);
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const date = child.key;
                    const dt = new Date(date);
                    if (dt >= fromDate && dt <= toDate) {
                        holidays[date] = child.val();
                    }
                });
            }
            return holidays;
        }




        //------------------------------------------------------------------------------------------------------------




        async function populateBranchesAndSubdivisions() {
            addSubdivisionBranchDropdown.innerHTML = `<option value="">Select Branch</option>`;
            editBranchDropdown.innerHTML = `<option value="">Select Branch to Edit</option>`; // Populate for edit branch
            editSubdivisionBranchDropdown.innerHTML = `<option value="">Select Branch</option>`; // Populate for edit subdivision
            editSubdivisionDropdown.innerHTML = `<option value="">Select Subdivision to Edit</option>`;
            editSubdivisionDropdown.disabled = true; // Disable until branch is selected

            branchesListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Loading branches...</p>';

            try {
                const snapshot = await get(ref(db, "branches"));
                const branchesData = snapshot.val() || {};

                if (Object.keys(branchesData).length === 0) {
                    branchesListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No branches found. Create a new branch.</p>';
                    return;
                }

                let branchesHtml = '';
                Object.entries(branchesData).forEach(([branchName, branchDetails]) => {
                    // Populate dropdowns for adding and editing
                    const branchLabel = branchName.charAt(0).toUpperCase() + branchName.slice(1);
                    addSubdivisionBranchDropdown.innerHTML += `<option value="${branchName}">${branchLabel}</option>`;
                    editBranchDropdown.innerHTML += `<option value="${branchName}">${branchLabel}</option>`;
                    editSubdivisionBranchDropdown.innerHTML += `<option value="${branchName}">${branchLabel}</option>`;

                    // Build HTML for branches list
                    branchesHtml += `
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-4 border border-gray-200"><div class="flex justify-between items-center mb-2"><h4 class="text-lg font-semibold text-gray-800">${branchLabel} (${branchDetails.latitude}, ${branchDetails.longitude}, ${branchDetails.radius}m)</h4><button class="delete-branch-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm" data-branch-name="${branchName}">Delete Branch</button></div><p class="text-sm text-gray-600 mb-2">Subdivisions:</p><ul class="list-disc list-inside ml-4">
                    `;

                    const subdivisions = branchDetails.subdivisions || {};
                    if (Object.keys(subdivisions).length === 0) {
                        branchesHtml += `<li class="text-gray-500">No subdivisions yet.</li>`;
                    } else {
                        Object.entries(subdivisions).forEach(([subdivisionName, subDetails]) => {
                            const subLabel = subdivisionName.charAt(0).toUpperCase() + subdivisionName.slice(1);
                            branchesHtml += `
                                <li class="flex justify-between items-center text-gray-700 py-1"><span>${subLabel}</span><button class="delete-subdivision-btn bg-red-400 hover:bg-red-500 text-white px-2 py-0.5 rounded text-xs" data-branch-name="${branchName}" data-subdivision-name="${subdivisionName}">Delete</button></li>
                            `;
                        });
                    }
                    branchesHtml += `
                            </ul></div>
                    `;
                });
                branchesListContainer.innerHTML = branchesHtml;

                // Attach event listeners to newly created delete buttons
                document.querySelectorAll('.delete-branch-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteBranch);
                });
                document.querySelectorAll('.delete-subdivision-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteSubdivision);
                });

            } catch (error) {
                console.error("Error populating branches and subdivisions:", error);
                branchesListContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error loading branches and subdivisions.</p>';
            }
        }

        // --- Create New Branch Logic ---
        createBranchBtn.addEventListener('click', async () => {
            const branchName = createBranchNameInput.value.trim();
            const lat = parseFloat(createBranchLatInput.value);
            const lng = parseFloat(createBranchLngInput.value);
            const radius = parseFloat(createBranchRadiusInput.value);
            const selectedDistrict = document.getElementById('district-select').value;

            if (!branchName || isNaN(lat) || isNaN(lng) || isNaN(radius) || !selectedDistrict) {
                showModal("Please fill in all branch details including district.", null, true);
                return;
            }

            if (radius <= 0) {
                showModal("Radius must be a positive number.", null, true);
                return;
            }

            showModal(`Are you sure you want to create a new branch: "${branchName}" under district "${selectedDistrict}"?`, async (confirm) => {
                if (!confirm) return;

                showLoadingModal("Creating branch...");
                try {
                    const branchRef = ref(db, `branches/${branchName}`);
                    const existingBranch = await get(branchRef);

                    if (existingBranch.exists()) {
                        hideLoadingModal();
                        showModal(`Branch "${branchName}" already exists.`, null, true);
                        return;
                    }

                    function toTitleCase(str) {
                        return str.replace(/\w\S*/g, txt =>
                            txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase()
                        );
                    }

                    await Promise.all([
                        // Set in branches
                        set(branchRef, {
                            latitude: lat,
                            longitude: lng,
                            radius: radius,
                            subdivisions: {}
                        }),

                        // Public directory
                        set(ref(db, `branchDirectory/${branchName}`), {
                            displayName: toTitleCase(branchName),
                            subdivisions: {}
                        }),

                        // ✅ Add branch under selected district
                        set(ref(db, `districts/${selectedDistrict}/branches/${branchName}`), true)
                    ]);

                    // Log activity
                    const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                    const newLogRef = push(activityLogsRef);
                    await set(newLogRef, {
                        timestamp: (new Date()).toISOString(),
                        by: currentUserName,
                        action: "Branch Created",
                        section: "Branch Management",
                        branchName: branchName,
                        district: selectedDistrict,
                        details: { lat, lng, radius }
                    });

                    hideLoadingModal();
                    showModal(`Branch "${branchName}" created under "${selectedDistrict}" successfully!`);
                    createBranchNameInput.value = '';
                    createBranchLatInput.value = '';
                    createBranchLngInput.value = '';
                    createBranchRadiusInput.value = '';
                    document.getElementById('district-select').value = '';
                    populateBranchesAndSubdivisions(); // Refresh
                } catch (error) {
                    hideLoadingModal();
                    console.error("Error creating branch:", error);
                    showModal("Failed to create branch: " + error.message, null, true);
                }
            });
        });


        async function populateDistrictSelect() {
            const districtSelect = document.getElementById('district-select');
            districtSelect.innerHTML = `<option value="">Select District</option>`;

            try {
                const snapshot = await get(ref(db, "districts"));
                if (snapshot.exists()) {
                    const districts = snapshot.val();
                    Object.keys(districts).forEach(districtName => {
                        const option = document.createElement('option');
                        option.value = districtName;
                        option.textContent = districtName;
                        districtSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Failed to load districts:", error);
            }
        }

        populateDistrictSelect(); // 📌 Call this on page load

        // --- Add Subdivision Logic ---
        addSubdivisionBtn.addEventListener('click', async () => {
            // Role-based access check
            if (currentUserRole !== 'Admin' && currentUserRole !== 'Dev') {
                showModal("Access Denied: You do not have permission to add subdivisions.", null, true);
                return;
            }

            const branchName = addSubdivisionBranchDropdown.value;
            const subdivisionName = addSubdivisionNameInput.value.trim().toLowerCase();

            // Input validation
            if (!branchName) {
                showModal("Please select a branch.", null, true);
                return;
            }
            if (!subdivisionName) {
                showModal("Please enter a subdivision name.", null, true);
                return;
            }

            showModal(`Are you sure you want to add subdivision "${subdivisionName}" to branch "${branchName}"?`, async (confirm) => {
                if (!confirm) return; // If user cancels, stop.

                showLoadingModal("Adding subdivision..."); // Show loading indicator
                try {
                    // Reference to the potential new subdivision location
                    const subdivisionRef = ref(db, `branches/${branchName}/subdivisions/${subdivisionName}`);
                    // Check if a subdivision with this name already exists under the selected branch
                    const existingSubdivision = await get(subdivisionRef);

                    if (existingSubdivision.exists()) {
                        hideLoadingModal(); // Hide loading indicator
                        showModal(`Subdivision "${subdivisionName}" already exists under "${branchName}".`, null, true); // Inform user about duplicate
                        return; // Stop execution
                    }

                    // Construct the data to be written for the new subdivision
                    const newSubdivisionData = {
                        employees: {}, // Initialize with an empty employees object
                        createdBy: currentUserName, // Store the name of the admin/dev user who created it
                        timestamp: (new Date()).toISOString() // Store the creation timestamp
                    };

                    // Perform the actual write operation to Firebase Realtime Database
                    await set(subdivisionRef, newSubdivisionData);
                    await update(ref(db, `branchDirectory/${branchName}/subdivisions`), {
                        [subdivisionName]: subdivisionName
                    });

                    // Log the activity after successful database write
                    const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                    const newLogRef = push(activityLogsRef); // Generate a new unique key for the log entry
                    await set(newLogRef, {
                        timestamp: (new Date()).toISOString(),
                        by: currentUserName,
                        action: "Subdivision Added",
                        section: "Branch Management",
                        branchName: branchName,
                        subdivisionName: subdivisionName
                    });

                    hideLoadingModal(); // Hide loading indicator
                    showModal(`Subdivision "${subdivisionName}" added successfully to "${branchName}"!`); // Show success message

                    // Clear the input field and refresh the list to reflect the new subdivision
                    addSubdivisionNameInput.value = '';
                    populateBranchesAndSubdivisions(); // Re-populate the list of branches and subdivisions
                } catch (error) {
                    hideLoadingModal(); // Hide loading indicator on error
                    console.error("Error adding subdivision:", error); // Log the detailed error to console
                    showModal("Failed to add subdivision: " + error.message, null, true); // Show a user-friendly error message
                }
            });
        });




        // Get allowed branches under district
        async function getBranchesFromSelection(district, branch) {
            if (branch !== "All") return [branch];
            if (district === "All") {
                const snap = await get(ref(db, "branches"));
                return Object.keys(snap.val() || {});
            } else {
                const snap = await get(ref(db, `districts/${district}/branches`));
                return Object.keys(snap.val() || {});
            }
        }

        // Get allowed subdivisions under branch
        async function getSubdivisionsFromSelection(branch, subdivision) {
            if (subdivision !== "All") return [subdivision];
            const snap = await get(ref(db, `branches/${branch}/subdivisions`));
            return Object.keys(snap.val() || {});
        }


        // --- Delete Branch Logic ---
        async function handleDeleteBranch(event) {
            const branchName = event.target.dataset.branchName;
            showModal(
                `WARNING: Are you sure you want to delete the entire branch "${branchName}"? This will also delete all its subdivisions and associated employee records! This action cannot be undone.`,
                async (confirm) => {
                    if (!confirm) return;

                    showLoadingModal(`Deleting branch "${branchName}"...`);
                    try {
                        // Remove the branch and all its contents
                        await remove(ref(db, `branches/${branchName}`));
                        await remove(ref(db, `branchDirectory/${branchName}`));

                        // ✅ Also remove from all districts
                        const districtsRef = ref(db, "districts");
                        const districtsSnap = await get(districtsRef);
                        if (districtsSnap.exists()) {
                            const updates = {};
                            districtsSnap.forEach(districtChild => {
                                const districtId = districtChild.key;
                                if (districtChild.child(`branches/${branchName}`).exists()) {
                                    updates[`${districtId}/branches/${branchName}`] = null;
                                }
                            });
                            if (Object.keys(updates).length > 0) {
                                await update(districtsRef, updates);
                            }
                        }

                        // Log activity
                        const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                        const newLogRef = push(activityLogsRef);
                        await set(newLogRef, {
                            timestamp: (new Date()).toISOString(),
                            by: currentUserName,
                            action: "Branch Deleted",
                            section: "Branch Management",
                            branchName: branchName,
                            details: "Entire branch and its subdivisions/employees removed, including district references."
                        });

                        hideLoadingModal();
                        showModal(`Branch "${branchName}" and all its contents deleted successfully.`);
                        populateBranchesAndSubdivisions(); // Refresh the list and dropdowns
                    } catch (error) {
                        hideLoadingModal();
                        console.error("Error deleting branch:", error);
                        showModal("Failed to delete branch: " + error.message, null, true);
                    }
                },
                true // warning modal
            );
        }

        // --- Delete Subdivision Logic ---
        async function handleDeleteSubdivision(event) {
            const branchName = event.target.dataset.branchName;
            const subdivisionName = event.target.dataset.subdivisionName;
            showModal(`Are you sure you want to delete subdivision "${subdivisionName}" from branch "${branchName}"? This will also delete its associated employee records.`, async (confirm) => {
                if (!confirm) return;

                showLoadingModal(`Deleting subdivision "${subdivisionName}"...`);
                try {
                    // Remove the subdivision and its contents
                    await remove(ref(db, `branches/${branchName}/subdivisions/${subdivisionName}`));
                    await remove(ref(db, `branchDirectory/${branchName}/subdivisions/${subdivisionName}`));


                    // Log activity
                    const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                    const newLogRef = push(activityLogsRef);
                    await set(newLogRef, {
                        timestamp: (new Date()).toISOString(),
                        by: currentUserName,
                        action: "Subdivision Deleted",
                        section: "Branch Management",
                        branchName: branchName,
                        subdivisionName: subdivisionName
                    });

                    hideLoadingModal();
                    showModal(`Subdivision "${subdivisionName}" deleted successfully from "${branchName}".`);
                    populateBranchesAndSubdivisions(); // Refresh the list
                } catch (error) {
                    hideLoadingModal();
                    console.error("Error deleting subdivision:", error);
                    showModal("Failed to delete subdivision: " + error.message, null, true);
                }
            }, true); // Pass true for isError to make it a warning modal
        }

        // --- Edit Branch Name Logic ---
        editBranchDropdown.addEventListener('change', () => {
            const selectedBranch = editBranchDropdown.value;
            if (selectedBranch) {
                editBranchNameInput.value = selectedBranch.charAt(0).toUpperCase() + selectedBranch.slice(1);
                editBranchNameInputContainer.classList.remove('hidden');
            } else {
                editBranchNameInput.value = '';
                editBranchNameInputContainer.classList.add('hidden');
            }
        });

        saveBranchNameBtn.addEventListener('click', async () => {
            if (currentUserRole !== 'Admin' && currentUserRole !== 'Dev') {
                showModal("Access Denied: You do not have permission to edit branches.", null, true);
                return;
            }

            const oldBranchName = editBranchDropdown.value;
            const newBranchName = editBranchNameInput.value.trim();

            if (!oldBranchName) {
                showModal("Please select a branch to edit.", null, true);
                return;
            }
            if (!newBranchName) {
                showModal("New branch name cannot be empty.", null, true);
                return;
            }
            if (oldBranchName === newBranchName) {
                showModal("New branch name is the same as the old name.", null, true);
                return;
            }

            showModal(`Are you sure you want to rename branch "${oldBranchName}" to "${newBranchName}"? This will update all associated records.`, async (confirm) => {
                if (!confirm) return;

                showLoadingModal(`Renaming branch "${oldBranchName}" to "${newBranchName}"...`);
                try {
                    // Check if new branch name already exists
                    const newBranchRef = ref(db, `branches/${newBranchName}`);
                    const newBranchSnap = await get(newBranchRef);
                    if (newBranchSnap.exists()) {
                        hideLoadingModal();
                        showModal(`Branch "${newBranchName}" already exists. Please choose a different name.`, null, true);
                        return;
                    }

                    // Get old branch data
                    const oldBranchRef = ref(db, `branches/${oldBranchName}`);
                    const oldBranchSnap = await get(oldBranchRef);
                    const branchData = oldBranchSnap.val();

                    if (!branchData) {
                        hideLoadingModal();
                        showModal(`Branch "${oldBranchName}" not found.`, null, true);
                        return;
                    }

                    // 1. Copy data to new branch name
                    await set(newBranchRef, branchData);

                    // 2. Delete old branch entry
                    await remove(oldBranchRef);

                    // 3. Update user references in 'users' node
                    const usersRef = ref(db, 'users');
                    const usersSnap = await get(usersRef);
                    const updates = {};
                    usersSnap.forEach(userChild => {
                        const userData = userChild.val();
                        if (userData.branch === oldBranchName) {
                            updates[`${userChild.key}/branch`] = newBranchName;
                        }
                    });
                    if (Object.keys(updates).length > 0) {
                        await update(usersRef, updates);
                    }
                    // 5. Update branchDirectory (rename)
                    const oldDirRef = ref(db, `branchDirectory/${oldBranchName}`);
                    const oldDirSnap = await get(oldDirRef);
                    if (oldDirSnap.exists()) {
                        const dirData = oldDirSnap.val();
                        await Promise.all([
                            set(ref(db, `branchDirectory/${newBranchName}`), {
                                displayName: newBranchName.charAt(0).toUpperCase() + newBranchName.slice(1),
                                subdivisions: dirData.subdivisions || {}
                            }),
                            remove(oldDirRef)
                        ]);
                    }

                    // 6. Update districts branch reference
                    const districtsRef = ref(db, 'districts');
                    const districtsSnap = await get(districtsRef);

                    const districtUpdates = {};
                    districtsSnap.forEach(districtChild => {
                        const districtId = districtChild.key;
                        const districtBranches = districtChild.child('branches').val() || {};

                        if (districtBranches[oldBranchName]) {
                            // Copy old branch data to new branch key
                            districtUpdates[`${districtId}/branches/${newBranchName}`] = districtBranches[oldBranchName];
                            // Remove old branch key
                            districtUpdates[`${districtId}/branches/${oldBranchName}`] = null;
                        }
                    });

                    if (Object.keys(districtUpdates).length > 0) {
                        await update(districtsRef, districtUpdates);
                    }


                    // 4. Update attendance records
                    const attendanceRef = ref(db, 'attendance');
                    const attendanceSnap = await get(attendanceRef);
                    const attendanceUpdates = {};

                    attendanceSnap.forEach(yearChild => {
                        const year = yearChild.key;
                        yearChild.forEach(monthChild => {
                            const month = monthChild.key;
                            monthChild.forEach(dayChild => {
                                const day = dayChild.key;
                                const dateData = dayChild.val();

                                for (const branchKey in dateData) {
                                    if (branchKey === oldBranchName) {
                                        const branchContent = dateData[branchKey];
                                        attendanceUpdates[`${year}/${month}/${day}/${newBranchName}`] = branchContent;
                                        attendanceUpdates[`${year}/${month}/${day}/${oldBranchName}`] = null; // Delete old entry
                                    }
                                }
                            });
                        });
                    });

                    if (Object.keys(attendanceUpdates).length > 0) {
                        await update(attendanceRef, attendanceUpdates);
                    }

                    // Log activity
                    const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                    const newLogRef = push(activityLogsRef);
                    await set(newLogRef, {
                        timestamp: (new Date()).toISOString(),
                        by: currentUserName,
                        action: "Branch Renamed",
                        section: "Branch Management",
                        before: { branch: oldBranchName },
                        after: { branch: newBranchName }
                    });

                    hideLoadingModal();
                    showModal(`Branch "${oldBranchName}" successfully renamed to "${newBranchName}"!`);
                    editBranchNameInput.value = '';
                    editBranchNameInputContainer.classList.add('hidden');
                    editBranchDropdown.value = '';
                    populateBranchesAndSubdivisions(); // Refresh all dropdowns and lists
                } catch (error) {
                    hideLoadingModal();
                    console.error("Error renaming branch:", error);
                    showModal("Failed to rename branch: " + error.message, null, true);
                }
            });
        });

        // --- Edit Subdivision Name Logic ---
        editSubdivisionBranchDropdown.addEventListener('change', async () => {
            const selectedBranch = editSubdivisionBranchDropdown.value;
            editSubdivisionDropdown.innerHTML = `<option value="">Select Subdivision to Edit</option>`;
            editSubdivisionDropdown.disabled = true;
            editSubdivisionNameInput.value = '';
            editSubdivisionNameInputContainer.classList.add('hidden');

            if (selectedBranch) {
                try {
                    const snap = await get(ref(db, `branches/${selectedBranch}/subdivisions`));
                    const subdivisions = snap.val() || {};
                    Object.keys(subdivisions).forEach(subKey => {
                        const option = document.createElement("option");
                        option.value = subKey;
                        option.textContent = subKey.charAt(0).toUpperCase() + subKey.slice(1);
                        editSubdivisionDropdown.appendChild(option);
                    });
                    editSubdivisionDropdown.disabled = false;
                } catch (error) {
                    console.error("Error loading subdivisions for edit:", error);
                }
            }
        });
        document.getElementById("summary-pdf-btn").addEventListener("click", () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("landscape", "mm", "a4");

            // Filters
            const district = document.getElementById("summary-district").value;
            const branch = document.getElementById("summary-branch").value;
            const subdivision = document.getElementById("summary-subdivision").value;
            const from = document.getElementById("summary-from").value;
            const to = document.getElementById("summary-to").value;

            const pageWidth = doc.internal.pageSize.getWidth();

            // Title (centered)
            doc.setFont("helvetica", "bold").setFontSize(16);
            doc.text("Attendance Summary Report", pageWidth / 2, 15, { align: "center" });

            // Multi-line filter info (centered)
            doc.setFont("helvetica", "normal").setFontSize(11);
            let y = 25;
            doc.text(`${district}`, pageWidth / 2, y, { align: "center" });
            y += 6;
            doc.text(`Branch: ${branch}`, pageWidth / 2, y, { align: "center" });
            y += 6;
            doc.text(`Subdivision: ${subdivision}`, pageWidth / 2, y, { align: "center" });
            y += 6;
            doc.text(`Date Range: ${from} to ${to}`, pageWidth / 2, y, { align: "center" });

            // Table from HTML (starting lower so it doesn't overlap filters)
            const tableElement = document.getElementById("summary-table");
            doc.autoTable({
                html: tableElement,
                startY: y + 6,
                theme: "striped",
                styles: { fontSize: 10, halign: "center" },
                headStyles: { fillColor: [0, 102, 204], textColor: 255, fontStyle: "bold" },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });

            // Save without summary totals
            doc.save(`Summary_${district}_${from}_to_${to}.pdf`.replace(/\s+/g, "_"));
        });


        document.getElementById("summary-export-btn").addEventListener("click", () => {
            const table = document.getElementById("summary-table");

            // 📌 Add header with filters
            const district = document.getElementById("summary-district").value;
            const branch = document.getElementById("summary-branch").value;
            const subdivision = document.getElementById("summary-subdivision").value;
            const from = document.getElementById("summary-from").value;
            const to = document.getElementById("summary-to").value;

            const summaryInfo = [
                ["Attendance Summary"],
                [`District: ${district}`],
                [`Branch: ${branch}`],
                [`Subdivision: ${subdivision}`],
                [`Date Range: ${from} to ${to}`],
                [""], // Empty row before table
            ];

            // Convert table to array of arrays
            const worksheet = XLSX.utils.table_to_sheet(table);
            XLSX.utils.sheet_add_aoa(worksheet, summaryInfo, { origin: "A1" });

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Summary");

            const filename = `Summary_${district}_${from}_to_${to}.xlsx`.replace(/\\s+/g, "_");
            XLSX.writeFile(workbook, filename);
        });


        editSubdivisionDropdown.addEventListener('change', () => {
            const selectedSubdivision = editSubdivisionDropdown.value;
            if (selectedSubdivision) {
                editSubdivisionNameInput.value = selectedSubdivision.charAt(0).toUpperCase() + selectedSubdivision.slice(1);
                editSubdivisionNameInputContainer.classList.remove('hidden');
            } else {
                editSubdivisionNameInput.value = '';
                editSubdivisionNameInputContainer.classList.add('hidden');
            }
        });

        saveSubdivisionNameBtn.addEventListener('click', async () => {
            if (currentUserRole !== 'Admin' && currentUserRole !== 'Dev') {
                showModal("Access Denied: You do not have permission to edit subdivisions.", null, true);
                return;
            }

            const selectedBranch = editSubdivisionBranchDropdown.value;
            const oldSubdivisionName = editSubdivisionDropdown.value;
            const newSubdivisionName = editSubdivisionNameInput.value.trim();

            if (!selectedBranch) {
                showModal("Please select a branch first.", null, true);
                return;
            }
            if (!oldSubdivisionName) {
                showModal("Please select a subdivision to edit.", null, true);
                return;
            }
            if (!newSubdivisionName) {
                showModal("New subdivision name cannot be empty.", null, true);
                return;
            }
            if (oldSubdivisionName === newSubdivisionName) {
                showModal("New subdivision name is the same as the old name.", null, true);
                return;
            }

            showModal(`Are you sure you want to rename subdivision "${oldSubdivisionName}" to "${newSubdivisionName}" under branch "${selectedBranch}"? This will update all associated records.`, async (confirm) => {
                if (!confirm) return;

                showLoadingModal(`Renaming subdivision "${oldSubdivisionName}" to "${newSubdivisionName}"...`);
                try {
                    // Check if new subdivision name already exists under the same branch
                    const newSubdivisionRef = ref(db, `branches/${selectedBranch}/subdivisions/${newSubdivisionName}`);
                    const newSubdivisionSnap = await get(newSubdivisionRef);
                    if (newSubdivisionSnap.exists()) {
                        hideLoadingModal();
                        showModal(`Subdivision "${newSubdivisionName}" already exists under "${selectedBranch}". Please choose a different name.`, null, true);
                        return;
                    }

                    // Get old subdivision data
                    const oldSubdivisionRef = ref(db, `branches/${selectedBranch}/subdivisions/${oldSubdivisionName}`);
                    const oldSubdivisionSnap = await get(oldSubdivisionRef);
                    const subdivisionData = oldSubdivisionSnap.val();

                    if (!subdivisionData) {
                        hideLoadingModal();
                        showModal(`Subdivision "${oldSubdivisionName}" not found under "${selectedBranch}".`, null, true);
                        return;
                    }

                    // 1. Copy data to new subdivision name
                    await set(newSubdivisionRef, subdivisionData);

                    // 2. Delete old subdivision entry
                    await remove(oldSubdivisionRef);

                    // 3. Update user references in 'users' node
                    const usersRef = ref(db, 'users');
                    const usersSnap = await get(usersRef);
                    const updates = {};
                    usersSnap.forEach(userChild => {
                        const userData = userChild.val();
                        if (userData.branch === selectedBranch && userData.subdivision === oldSubdivisionName) {
                            updates[`${userChild.key}/subdivision`] = newSubdivisionName;
                        }
                    });
                    if (Object.keys(updates).length > 0) {
                        await update(usersRef, updates);
                    }
                    // 5. Update branchDirectory subdivisions
                    await set(ref(db, `branchDirectory/${selectedBranch}/subdivisions/${newSubdivisionName}`), newSubdivisionName);
                    await remove(ref(db, `branchDirectory/${selectedBranch}/subdivisions/${oldSubdivisionName}`));

                    // 4. Update attendance records
                    // 4. Update attendance records
                    const attendanceBranchRef = ref(db, `attendance`);
                    const attendanceSnap = await get(attendanceBranchRef);
                    const attendanceUpdates = {};

                    attendanceSnap.forEach(yearChild => {
                        const year = yearChild.key;
                        yearChild.forEach(monthChild => {
                            const month = monthChild.key;
                            monthChild.forEach(dayChild => {
                                const day = dayChild.key;
                                const dateData = dayChild.val();

                                if (dateData[selectedBranch] && dateData[selectedBranch][oldSubdivisionName]) {
                                    const oldSubdivisionContent = dateData[selectedBranch][oldSubdivisionName];
                                    attendanceUpdates[`${year}/${month}/${day}/${selectedBranch}/${newSubdivisionName}`] = oldSubdivisionContent;
                                    attendanceUpdates[`${year}/${month}/${day}/${selectedBranch}/${oldSubdivisionName}`] = null; // Delete old entry
                                }
                            });
                        });
                    });

                    if (Object.keys(attendanceUpdates).length > 0) {
                        await update(attendanceBranchRef, attendanceUpdates);
                    }


                    // Log activity
                    const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                    const newLogRef = push(activityLogsRef);
                    await set(newLogRef, {
                        timestamp: (new Date()).toISOString(),
                        by: currentUserName,
                        action: "Subdivision Renamed",
                        section: "Branch Management",
                        branch: selectedBranch,
                        before: { subdivision: oldSubdivisionName },
                        after: { subdivision: newSubdivisionName }
                    });

                    hideLoadingModal();
                    showModal(`Subdivision "${oldSubdivisionName}" successfully renamed to "${newSubdivisionName}"!`);
                    editSubdivisionNameInput.value = '';
                    editSubdivisionNameInputContainer.classList.add('hidden');
                    editSubdivisionBranchDropdown.value = '';
                    editSubdivisionDropdown.innerHTML = `<option value="">Select Subdivision to Edit</option>`;
                    editSubdivisionDropdown.disabled = true;
                    populateBranchesAndSubdivisions(); // Refresh all dropdowns and lists
                } catch (error) {
                    hideLoadingModal();
                    console.error("Error renaming subdivision:", error);
                    showModal("Failed to rename subdivision: " + error.message, null, true);
                }
            });
        });

        async function deleteEmployee(uid, empId = null) {
            if (currentUserRole !== 'Admin' && currentUserRole !== 'Dev') {
                showModal('❌ Access denied – only Admin or Dev can delete employees.', null, true, "Permission Denied");
                return;
            }

            const displayId = empId || 'Unknown';
            showModal(`⚠️ Are you sure you want to permanently delete this employee?\n\n🆔 Employee ID: ${displayId}`, async (confirm) => {
                if (!confirm) return;

                showLoadingModal('🗑️ Deleting employee and removing Auth account...');

                try {
                    const callable = httpsCallable(functions, 'deleteEmployeeAccount');
                    const response = await callable({ uid, empId });

                    hideLoadingModal();

                    showModal(`✅ Employee deleted successfully.\n\n- Firebase Auth removed\n- DB entries cleared\n- Audit logged`, null, false, "Success");

                    // Optionally refresh UI or dropdowns here
                    // await populateEmployeeDropdown(...);

                } catch (err) {
                    hideLoadingModal();

                    let errorMessage = 'An unexpected error occurred.';
                    if (err.code === 'unauthenticated') {
                        errorMessage = '⚠️ You are not logged in.';
                    } else if (err.code === 'permission-denied') {
                        errorMessage = '❌ You do not have permission to delete this employee.';
                    } else if (err.code === 'invalid-argument') {
                        errorMessage = '⚠️ The provided UID or Employee ID is invalid.';
                    } else if (err.code === 'internal') {
                        errorMessage = '🔥 Internal server error. Please check Cloud Logs.';
                    } else if (err.message) {
                        errorMessage = `❌ ${err.message}`;
                    }

                    console.error("deleteEmployee error:", err);
                    showModal(errorMessage, null, true, "Delete Failed");
                }
            }, true, "Confirm Delete");
        }

        // --- Holiday Management Logic ---
        const singleHolidayDateInput = document.getElementById('single-holiday-date');
        const singleHolidayReasonInput = document.getElementById('single-holiday-reason');
        const addSingleHolidayBtn = document.getElementById('add-single-holiday-btn');

        const bulkHolidayDatesInput = document.getElementById('bulk-holiday-dates');
        const bulkHolidayReasonInput = document.getElementById('bulk-holiday-reason');
        const addBulkHolidayBtn = document.getElementById('add-bulk-holiday-btn');

        const holidaysListTableBody = document.getElementById('holidays-list-table-body');

        // Function to add a holiday
        async function addHoliday(date, reason) {
            const holidayRef = ref(db, `holidays/${date}`);
            const existingHoliday = await get(holidayRef);

            if (existingHoliday.exists()) {
                showModal(`Holiday on ${date} (${existingHoliday.val().reason}) already exists. Skipping.`, null, false, "Duplicate Holiday");
                return false;
            }

            await set(holidayRef, {
                reason: reason,
                type: "full"
            });

            // Log activity
            const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
            const newLogRef = push(activityLogsRef);
            await set(newLogRef, {
                timestamp: (new Date()).toISOString(),
                by: currentUserName,
                action: "Holiday Added",
                section: "Holiday Management",
                date: date,
                reason: reason
            });
            return true;
        }

        // Function to delete a holiday
        async function deleteHoliday(date, reason) {
            showModal(`Are you sure you want to delete the holiday on ${date} (${reason})?`, async (confirm) => {
                if (!confirm) return;

                showLoadingModal(`Deleting holiday on ${date}...`);
                try {
                    await remove(ref(db, `holidays/${date}`));

                    // Log activity
                    const activityLogsRef = ref(db, `activityLogs/${(new Date()).toISOString().split('T')[0]}`);
                    const newLogRef = push(activityLogsRef);
                    await set(newLogRef, {
                        timestamp: (new Date()).toISOString(),
                        by: currentUserName,
                        action: "Holiday Deleted",
                        section: "Holiday Management",
                        date: date,
                        reason: reason
                    });

                    hideLoadingModal();
                    showModal(`Holiday on ${date} deleted successfully.`);
                    populateHolidaysList(); // Refresh the list
                } catch (error) {
                    hideLoadingModal();
                    console.error("Error deleting holiday:", error);
                    showModal("Failed to delete holiday: " + error.message, null, true);
                }
            }, true); // Use true for isError to make it a warning modal
        }

        // Function to populate the holidays list table
        // Function to populate the holidays list table
        async function populateHolidaysList() {
            holidaysListTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">Loading holidays...</td></tr>';
            allHolidays = {}; // Clear global holidays map

            try {
                const snapshot = await get(ref(db, "holidays"));
                const holidaysData = snapshot.val() || {};

                holidaysListTableBody.innerHTML = ''; // Clear loading message

                const visibleHolidays = Object.entries(holidaysData)
                    .filter(([_, details]) => details.visible !== false);

                if (visibleHolidays.length === 0) {
                    holidaysListTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No holidays configured yet.</td></tr>';
                    return;
                }

                // ✅ Hide past holidays
                const today = new Date();
                today.setHours(0, 0, 0, 0); // midnight for date-only compare

                const upcomingHolidays = visibleHolidays.filter(([date]) => {
                    const holidayDate = new Date(date);
                    return holidayDate >= today; // keep only today or future
                });

                if (upcomingHolidays.length === 0) {
                    holidaysListTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No upcoming holidays.</td></tr>';
                    return;
                }

                const sortedHolidays = upcomingHolidays.sort(
                    ([dateA], [dateB]) => new Date(dateA) - new Date(dateB)
                );

                sortedHolidays.forEach(([date, details]) => {
                    allHolidays[date] = details; // Store in global map
                    const row = document.createElement("tr");
                    row.classList.add("border-b");
                    row.innerHTML = `
                <td class="py-2 px-4">${new Date(date).toLocaleDateString("en-IN", { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                <td class="py-2 px-4">${details.reason}</td>
                <td class="py-2 px-4">
                    <button class="delete-holiday-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm"
                        data-date="${date}" data-reason="${details.reason}">Delete</button>
                </td>
            `;
                    holidaysListTableBody.appendChild(row);
                });

                // Attach delete button listeners
                document.querySelectorAll('.delete-holiday-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const date = event.target.dataset.date;
                        const reason = event.target.dataset.reason;
                        deleteHoliday(date, reason);
                    });
                });

            } catch (error) {
                console.error("Error populating holidays list:", error);
                holidaysListTableBody.innerHTML = '<tr><td colspan="3" class="text-red-500 text-center py-4">Error loading holidays.</td></tr>';
            }
        }

        document.getElementById("toggle-times").addEventListener("change", (e) => {
            const showTimes = e.target.checked;
            const toggleCols = document.querySelectorAll(".show-times-col");

            toggleCols.forEach(col => {
                col.classList.toggle("hidden", !showTimes);
            });
        });

        // Event listener for adding a single holiday
        addSingleHolidayBtn.addEventListener('click', async () => {
            const date = singleHolidayDateInput.value;
            const reason = singleHolidayReasonInput.value.trim();

            if (!date || !reason) {
                showModal("Please select a date and enter a reason for the holiday.", null, true);
                return;
            }

            showLoadingModal("Adding holiday...");
            try {
                const success = await addHoliday(date, reason);
                hideLoadingModal();
                if (success) {
                    showModal(`Holiday "${reason}" on ${new Date(date).toLocaleDateString("en-IN")} added successfully!`);
                    singleHolidayDateInput.value = '';
                    singleHolidayReasonInput.value = '';
                    populateHolidaysList(); // Refresh the list
                }
            } catch (error) {
                hideLoadingModal();
                console.error("Error adding single holiday:", error);
                showModal("Failed to add holiday: " + error.message, null, true);
            }
        });

        // Event listener for adding bulk holidays
        addBulkHolidayBtn.addEventListener('click', async () => {
            const datesString = bulkHolidayDatesInput.value.trim();
            const reason = bulkHolidayReasonInput.value.trim();

            if (!datesString || !reason) {
                showModal("Please enter dates (comma-separated) and a reason for bulk holidays.", null, true);
                return;
            }

            const dates = datesString.split(',').map(d => d.trim()).filter(d => d);
            if (dates.length === 0) {
                showModal("No valid dates entered for bulk holiday. Please use YYYY-MM-DD format.", null, true);
                return;
            }

            showLoadingModal("Adding bulk holidays...");
            let addedCount = 0;
            let skippedCount = 0;

            for (const dateStr of dates) {
                // Validate date format (simple check)
                if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    showModal(`Invalid date format: ${dateStr}. Please use YYYY-MM-DD. Skipping this date.`, null, false, "Invalid Date");
                    continue;
                }
                try {
                    const success = await addHoliday(dateStr, reason);
                    if (success) {
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                } catch (error) {
                    console.error(`Error adding holiday ${dateStr}:`, error);
                    showModal(`Error adding holiday ${dateStr}: ${error.message}. Skipping.`, null, true);
                }
            }
            hideLoadingModal();
            showModal(`Bulk holidays added. Successfully added: ${addedCount}, Skipped (duplicates/errors): ${skippedCount}.`);
            bulkHolidayDatesInput.value = '';
            bulkHolidayReasonInput.value = '';
            populateHolidaysList(); // Refresh the list
        });

        // Call populateBranchesAndSubdivisions on window load to ensure the initial list is rendered
        window.onload = function () {
            populateBranchesAndSubdivisions();
            populateHolidaysList(); // Also populate holidays on load
            // NEW: Initialize remove employee dropdowns on load
            populateBranchDropdowns(removeEmployeeBranchDropdown);
            // Add change listener for removeEmployeeBranchDropdown to populate subdivisions
            removeEmployeeBranchDropdown.addEventListener("change", () => {
                populateSubdivisionDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown);
                removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`; // Clear employee dropdown
                removeEmployeeSelect.disabled = true;
            });
            removeEmployeeSubdivisionDropdown.addEventListener("change", () => populateEmployeeDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown, removeEmployeeSelect));

            // Add event listener to clear inline message when typing in the search input
            searchEmployeeIdInput.addEventListener('input', () => {
                searchEmployeeIdMessage.textContent = '';
                searchEmployeeIdMessage.classList.remove('text-red-500', 'text-green-500', 'block');
                searchEmployeeIdInput.classList.remove('border-red-500');
            });
        };

        // ⛔ Block selecting future dates in date inputs
        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date().toISOString().split("T")[0];

            const fromInput = document.getElementById("record-from");
            const toInput = document.getElementById("record-to");
            const indivFromInput = document.getElementById("indiv-from-date");
            const indivToInput = document.getElementById("indiv-to-date");

            if (fromInput) fromInput.max = today;
            if (toInput) toInput.max = today;
            if (indivFromInput) indivFromInput.max = today;
            if (indivToInput) indivToDateInput.max = today; // Corrected ID
        });

        async function loadSignupRequests() {
            const container = document.getElementById("signup-requests-list");
            if (!container) {
                console.error("❌ signup-requests-list element not found");
                return;
            }
            container.innerHTML = "<p>Loading...</p>";

            try {
                const dbRef = ref(db, "signupRequests");
                const snapshot = await get(dbRef);

                if (!snapshot.exists()) {
                    container.innerHTML = "<p>No pending signup requests.</p>";
                    return;
                }

                const data = snapshot.val();
                container.innerHTML = "";

                Object.entries(data).forEach(([requestId, request]) => {
                    const card = document.createElement("div");
                    card.className = "bg-white p-4 rounded shadow mb-4";

                    card.innerHTML = `
        <p><strong>Name:</strong> ${request.name}</p>
        <p><strong>Email:</strong> ${request.email}</p>
        <p><strong>Phone:</strong> ${request.phone}</p>
        <p><strong>Employee ID:</strong> ${request.employeeId}</p>
        <p><strong>Branch:</strong> ${request.branch}</p>
        <p><strong>Subdivision:</strong> ${request.subdivision}</p>
        <div class="mt-2 flex gap-2">
          <button class="approve-btn bg-green-600 text-white px-3 py-1 rounded" data-id="${requestId}">Approve</button>
          <button class="decline-btn bg-red-600 text-white px-3 py-1 rounded" data-id="${requestId}">Decline</button>
        </div>
      `;
                    container.appendChild(card);
                });

                // Add event listeners for buttons
                container.querySelectorAll(".approve-btn").forEach(btn => {
                    btn.addEventListener("click", async () => {
                        const requestId = btn.getAttribute("data-id");
                        const idToken = await auth.currentUser.getIdToken();

                        try {
                            // ⏳ Show loading modal immediately
                            showLoadingModal("Approving signup... Please wait");

                            const response = await fetch(
                                "https://asia-southeast1-diya-hero.cloudfunctions.net/approveSignupRequest",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "Authorization": "Bearer " + idToken
                                    },
                                    body: JSON.stringify({ requestId })
                                }
                            );

                            const result = await response.json();

                            // ✅ Always hide loading before showing result
                            hideLoadingModal();

                            if (!response.ok) {
                                const errMsg = result?.error?.toLowerCase() || "unknown";

                                if (errMsg.includes("employee id") && errMsg.includes("already")) {
                                    showModal("❌ This employee ID is already in use. Please check for duplicate requests.", null, true, "Duplicate ID");
                                } else if (errMsg.includes("signup request not found")) {
                                    showModal("❌ This request no longer exists. It may have been processed already.", null, true, "Request Missing");
                                } else if (errMsg.includes("only admin")) {
                                    showModal("❌ Only Admin or Dev accounts can approve signup requests.", null, true, "Access Denied");
                                } else {
                                    showModal(`❌ Server rejected approval.\n\nError: ${result.error}`, null, true, "Approval Error");
                                }
                                return;
                            }

                            // ✅ Success
                            showModal("✅ Signup approved successfully!", null, false, "Success");
                            await loadSignupRequests();

                        } catch (err) {
                            hideLoadingModal(); // 🔑 Ensure loading is closed on error too
                            console.error("❌ Approve error:", err);

                            if (err.message?.includes("Failed to fetch")) {
                                showModal("❌ Network error. Please check your connection and try again.", null, true, "Connection Failed");
                            } else if (err.message?.includes("Unexpected token")) {
                                showModal("❌ Server response was malformed. Try again later.", null, true, "Server Error");
                            } else {
                                showModal(`❌ Unknown error occurred.\n\n${err.message || err}`, null, true, "Approval Failed");
                            }
                        }
                    });
                });


                container.querySelectorAll(".decline-btn").forEach(btn => {
                    btn.addEventListener("click", async () => {
                        const requestId = btn.getAttribute("data-id");
                        try {
                            await remove(ref(db, `signupRequests/${requestId}`));
                            alert("Request declined.");
                            loadSignupRequests(); // reload after decline
                        } catch (err) {
                            console.error("Decline error:", err);
                            alert("Error declining request.");
                        }
                    });
                });

            } catch (error) {
                console.error("Signup Requests Load Error:", error);
                container.innerHTML = "<p>Error loading signup requests.</p>";
            }
        }

        function strictlyBlockAllInIndividualDropdowns() {
            const dropdownIds = [
                "indiv-district",
                "indiv-branch",
                "indiv-subdivision",
                "indiv-employee"
            ];

            dropdownIds.forEach(id => {
                const dropdown = document.getElementById(id);
                if (!dropdown) return;

                // Always ensure "None" option exists at the top
                ensureNoneOption(dropdown);

                // Prevent selecting "All"
                dropdown.addEventListener("change", () => {
                    if (dropdown.value.toLowerCase() === "all") {
                        alert("❌ 'All' is not allowed in Individual tab.");
                        dropdown.selectedIndex = 0;
                    }
                });

                // Observe for dynamic changes (subdivision → employee etc.)
                const observer = new MutationObserver(() => {
                    setTimeout(() => {
                        removeAllAndEnsureNone(dropdown);
                    }, 100);
                });

                observer.observe(dropdown, {
                    childList: true,
                    subtree: false,
                });
            });

            function ensureNoneOption(dropdown) {
                const hasNone = [...dropdown.options].some(opt => opt.value === "");
                if (!hasNone) {
                    const noneOption = new Option("None", "", true, true); // selected by default
                    dropdown.insertBefore(noneOption, dropdown.firstChild);
                }
            }

            function removeAllAndEnsureNone(dropdown) {
                for (let i = dropdown.options.length - 1; i >= 0; i--) {
                    if (dropdown.options[i].value.toLowerCase() === "all") {
                        dropdown.remove(i);
                    }
                }
                ensureNoneOption(dropdown);
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            strictlyBlockAllInIndividualDropdowns();
        });

    </script>
    <script>
        /*      document.addEventListener("keydown", function (e) {
                  // Block F12
                  if (e.key === "F12") {
                      e.preventDefault();
                  }
      
                  // Block Ctrl+Shift+I / Ctrl+Shift+J / Ctrl+U / Ctrl+S / Ctrl+P
                  if (
                      (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C")) ||
                      (e.ctrlKey && (e.key === "U" || e.key === "S" || e.key === "P"))
                  ) {
                      e.preventDefault();
                  }
              }); */
    </script>
    <script>
        //   document.addEventListener("contextmenu", function (e) {
        //     e.preventDefault();
        //you.html   });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>


</head>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #b0bbca;
    }

    /* Styles for the top-bar (header.html content) */
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4.5px 20px;
        background-color: #e1e1e1;
        color: #333;
        font-family: 'Segoe UI', sans-serif;
        border-bottom: 1px solid #000000;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    .top-bar .logo-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .top-bar .logo-img {
        height: 55px;
    }

    .top-bar .app-name {
        font-size: 26px;
        font-weight: bold;
        color: #333;
        /* Default color for app name in top-bar */
    }

    .top-bar .clock-container {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        /* Default color for clock in top-bar */
    }

    .top-bar .user-section {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .top-bar #user-badge {
        border-radius: 8px;
        padding: 8px 12px;
        color: hsl(0, 86%, 39%);
        font-family: "Segoe UI", sans-serif;
        font-size: 13px;
        line-height: 1.4;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        min-width: 150px;
        background-color: #010d18;
        /* Dark background for user badge */
        border-left: 4px solid transparent;
    }

    .top-bar #user-name {
        font-weight: 600;
        font-size: 14px;
        color: #03feedd1;
    }

    .top-bar #branch-info {
        font-size: 12px;
        color: #ffffff;
    }

    .top-bar .user-badge-dev {
        background-color: #000000;
        border-left: 4px solid #000000;
    }

    .top-bar .user-badge-admin {
        background-color: #31d8ae;
        border-left: 4px solid #010d18;
    }

    .top-bar .user-badge-branch {
        background-color: #28a745;
        border-left: 4px solid #2e7d32;
    }

    .top-bar .btn {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        color: #333;
    }

    .top-bar .btn:hover {
        background-color: #e9e9e9;
    }

    .top-bar #admin-panel-btn {
        background-color: #374785;
        color: white;
        padding: 6px 14px;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .top-bar #admin-panel-btn:hover {
        background-color: #2c3769;
    }

    .top-bar #logout-btn {
        border-color: #d9534f;
        background-color: #f8d7da;
        color: #a94442;
    }

    /* Role-based background colors for the top-bar */
    .top-bar.top-bar-dev {
        background-color: #e1e1e1;
    }

    .top-bar.top-bar-admin {
        background-color: #e1e1e1;
    }

    .top-bar.top-bar-branch {
        background-color: #2e7d32;
    }

    /* General styles below */
    .container {
        padding: 20px;
    }

    .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        flex-direction: column;
    }

    .control-group select,
    .control-group button {
        padding: 8px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .attendance-table-container {
        overflow-x: auto;
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
    }

    th,
    td {
        padding: 10px;
        border: 1px solid #ccc;
        text-align: center;
    }

    th {
        background-color: #003366;
        color: white;
    }

    .radio-group {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .summary-section {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
    }

    .summary-item {
        background-color: white;
        padding: 10px 20px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .summary-count {
        font-size: 24px;
        font-weight: bold;
    }

    .count-full {
        color: green;
    }

    .count-half {
        color: orange;
    }

    .count-absent {
        color: red;
    }

    .count-late {
        color: #ff3300;
    }

    .save-btn {
        padding: 10px 20px;
        font-size: 16px;
        background-color: green;
        color: white;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }

    .save-btn:disabled {
        background-color: gray;
        cursor: not-allowed;
    }

    .status-badge {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 6px;
        display: inline-block;
    }

    .status-full {
        background-color: #28a745;
        color: white;
    }

    .status-half {
        background-color: #ffc107;
        color: black;
    }

    .status-absent {
        background-color: #dc3545;
        color: white;
    }

    .status-pending {
        background-color: #cccccc;
        color: #333;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
    }

    .late-indicator {
        color: red;
        font-weight: bold;
    }

    input[type="checkbox"]:disabled {
        background-color: #0052f5 !important;
        border: 1px solid #f70a0aad;
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Custom Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
    }

    .modal-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .modal-buttons button {
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
    }

    .modal-buttons .confirm {
        background-color: #dc3545;
        color: white;
        border: none;
    }

    .modal-buttons .cancel {
        background-color: #6c757d;
        color: white;
        border: none;
    }
</style>

<body class="bg-gray-100 min-h-screen"><!-- Header content from header.html -->
    <div id="top-bar" class="top-bar">
        <div class="logo-section"><img src="https://cdn.imgchest.com/files/7pjcqkbmnz7.png" alt="Diya Motors Logo"
                class="logo-img" /></div>
        <div class="clock-container"><span id="live-clock">--:--:--</span></div>
        <div class="user-section">
            <div id="user-badge" class="user-badge">
                <div id="user-name">Loading...</div>
                <div id="branch-info"></div>
            </div><!-- Changed styling for home-screen-btn and corrected redirection --><button
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-medium" id="home-screen-btn"
                style="display: none;">Home Screen</button><!-- New Activity Logs Button --><button
                id="activity-logs-btn"
                class="btn bg-yellow-500 text-black px-4 py-2 rounded hover:bg-yellow-600 transition"
                style="display: none;">Activity Logs</button><button id="logout-btn" class="btn">Logout</button>
        </div>
    </div>
    <div class="container mx-auto px-4 py-6">
        <div class="mb-6">
            <nav class="flex space-x-4 border-b">
                <button class="tab-button px-4 py-2 text-blue-700 border-b-2 border-blue-700 font-semibold"
                    data-tab="records">Branch Wise Records</button>
                <button class="tab-button px-4 py-2 text-gray-700 hover:text-blue-700" data-tab="individual">Individual
                    Records</button>
                <button class="tab-button" data-tab="summary">Summary</button>

                <button class="tab-button px-4 py-2 text-gray-700 hover:text-blue-700" id="edit-tab-button"
                    data-tab="edit">Employee Management
                </button><button class="tab-button px-4 py-2 text-gray-700 hover:text-blue-700"
                    id="branch-management-tab-button" data-tab="branch-management">Branch & Subdivision Management
                </button><!-- NEW: Holiday Manager Tab Button --><button
                    class="tab-button px-4 py-2 text-gray-700 hover:text-blue-700" id="holiday-manager-tab-button"
                    data-tab="holiday-manager">Holiday Manager
                </button>
                <button class="tab-button px-4 py-2 text-gray-700 hover:text-blue-700" id="signup-requests-tab-button"
                    data-tab="signup-requests">
                    Signup Requests
                </button>
            </nav>
        </div>
        <div id="tab-records" class="tab-content">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label for="record-district" class="block text-sm font-medium text-gray-700">District</label>
                        <select id="record-district"
                            class="form-select border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                            <option value="All">All Districts</option>
                        </select>
                    </div>


                    <div><label class="block text-sm font-medium text-gray-700">Branch</label>
                        <select id="record-branch" class="form-select border rounded px-3 py-2">
                            <option value="All">All</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">Subdivision</label><select
                            id="record-subdivision" class="form-select border rounded px-3 py-2" disabled>
                            <option value="All">All</option>
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700">From</label><input type="date"
                            id="record-from" class="form-input border rounded px-3 py-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">To</label><input type="date"
                            id="record-to" class="form-input border rounded px-3 py-2"></div>
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const dateInput = document.getElementById("datePicker");
                            if (dateInput) {
                                const today = new Date().toISOString().split('T')[0];
                                dateInput.max = today;         // ⛔ Blocks all future dates
                                dateInput.value = today;       // ✅ Optional: set default to today
                            }
                        });
                    </script>

                    <div class="flex items-center gap-2"><input type="checkbox" id="toggle-times"
                            class="form-checkbox h-4 w-4 text-blue-600 rounded"><label for="toggle-times"
                            class="text-sm font-medium text-gray-700">Show Times</label></div><button
                        id="load-records-btn" class="bg-blue-600 text-white px-4 py-2 rounded font-medium">
                        Load All Records
                    </button>
                </div>
                <div class="overflow-auto max-h-[70vh]">
                    <table class="min-w-full border text-sm" id="employee-records-table">
                        <thead id="records-thead" class="bg-gray-100 font-semibold">
                            <tr>
                                <th class="border px-4 py-2 text-left">Date</th>
                                <th class="border px-4 py-2 text-left">Employee</th>
                                <th class="border px-4 py-2 text-left branch-col">Branch</th>
                                <th class="border px-4 py-2 text-left subdivision-col">Subdivision</th>
                                <th class="border px-4 py-2 text-center">Morning</th>
                                <th class="border px-4 py-2 text-right indiv-time-col">Enter Time</th>
                                <th class="border px-4 py-2 text-center">Afternoon</th>
                                <th class="border px-4 py-2 text-right indiv-time-col">Exit Time</th>
                                <th class="border px-4 py-2 text-center">Status</th>
                                <th class="border px-4 py-2 text-left">Remarks</th>
                                <th class="border px-4 py-2 text-center">Holiday Worked</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body"><!-- Vertical records will be appended here --></tbody>
                    </table>
                </div><!-- Removed the summary section -->
                <div class="flex justify-end gap-3 mt-4"><button id="export-pdf"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">📄 Export
                        PDF</button><button id="export-excel"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">📊
                        Export Excel</button></div>
            </div>
        </div>


        <div id="tab-individual" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <div class="flex flex-wrap gap-4 items-end mb-4"><!-- Search by Employee ID -->
                    <div class="flex-grow"><label class="block text-sm font-medium text-gray-700">Search by Employee
                            ID</label>
                        <div class="flex gap-2"><input type="text" id="search-by-id-input"
                                class="form-input border rounded px-3 py-2 w-full"
                                placeholder="Enter Employee ID"><button id="search-by-id-btn"
                                class="bg-blue-600 text-white px-4 py-2 rounded font-medium">Search</button></div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label for="indiv-district" class="block text-sm font-medium text-gray-700">District</label>
                        <select id="indiv-district"
                            class="form-select border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                            <option value="All">All Districts</option>
                        </select>
                    </div>


                    <div><label class="block text-sm font-medium text-gray-700">Branch</label><select id="indiv-branch"
                            class="form-select border rounded px-3 py-2">
                            <option value="All">All Branches</option>
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Subdivision</label><select
                            id="indiv-subdivision" class="form-select border rounded px-3 py-2" disabled>
                            <option value="All">All Subdivisions</option>
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Employee</label><select
                            id="indiv-employee" class="form-select border rounded px-3 py-2" disabled>
                            <option value="All">All Employees</option>
                        </select></div>
                    <div><label class="block text-sm font-medium text-gray-700">From</label><input type="date"
                            id="indiv-from-date" class="form-input border rounded px-3 py-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">To</label><input type="date"
                            id="indiv-to-date" class="form-input border rounded px-3 py-2"></div>
                    <div class="flex items-center gap-2"><input type="checkbox" id="indiv-toggle-times"
                            class="form-checkbox h-4 w-4 text-blue-600 rounded"><label for="indiv-toggle-times"
                            class="text-sm font-medium text-gray-700">Show Times</label></div><button
                        id="load-individual-btn"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium">
                        👤 Load Individual Records
                    </button>
                </div><!-- Employee Details Header -->
                <div id="indiv-employee-details-header" class="bg-gray-100 p-3 rounded-md shadow-sm mt-4 hidden">
                    <!-- Details will be dynamically inserted here -->
                </div>
                <div id="loading-individual" class="text-center text-gray-500 py-4 hidden">
                    <div class="flex items-center justify-center"><svg
                            class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        Loading records...
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full border text-sm" id="indiv-records-table">
                        <thead id="indiv-thead" class="bg-gray-100 font-semibold">
                            <tr>
                                <th class="border px-4 py-2 text-left">Date</th>
                                <th class="border px-4 py-2 text-center">Morning</th>
                                <th class="border px-4 py-2 text-right indiv-time-col">Enter Time</th>
                                <th class="border px-4 py-2 text-center">Afternoon</th>
                                <th class="border px-4 py-2 text-right indiv-time-col">Exit Time</th>
                                <th class="border px-4 py-2 text-center">Status</th>
                                <th class="border px-4 py-2 text-left">Remarks</th>
                                <th class="border px-4 py-2 text-center">Holiday Worked</th>
                            </tr>
                        </thead>
                        <tbody id="indiv-table-body"><!-- Rows will be dynamically generated here --></tbody>
                    </table>
                </div>
                <div id="indiv-summary" class="bg-white p-4 rounded shadow mt-4 hidden">
                    <p class="text-lg font-semibold text-gray-800">Summary:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Total Full Days: <span id="indiv-full-days" class="font-bold text-green-600">0</span></li>
                        <li>Total Half Days: <span id="indiv-half-days" class="font-bold text-orange-600">0</span></li>
                        <li>Total Absent Days: <span id="indiv-absent-days" class="font-bold text-red-600">0</span></li>
                        <li>Total Late Days: <span id="indiv-late-days" class="font-bold text-red-600">0</span></li>
                        <li>Total Leave Taken: <span id="indiv-total-leave-count" class="font-bold text-blue-600">0
                                Days</span></li><!-- NEW: Holiday Work Days Summary -->
                        <li>Holiday Work Days (Full): <span id="indiv-holiday-work-full-days"
                                class="font-bold text-purple-600">0</span></li>
                        <li>Holiday Work Days (Half): <span id="indiv-holiday-work-half-days"
                                class="font-bold text-purple-600">0</span></li>
                    </ul>
                </div>
                <div class="flex justify-end gap-3 mt-4"><button id="export-indiv-pdf"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">📄
                        Export
                        PDF</button><button id="export-indiv-excel"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">📊
                        Export Excel</button></div>
            </div>
        </div>

        <div id="tab-summary" class="tab-content hidden px-4 py-6">
            <h2 class="text-xl font-semibold mb-4">📊 Summary Attendance Report</h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block font-medium mb-1">Select District</label>
                    <select id="summary-district" class="w-full border rounded px-2 py-1"></select>
                </div>
                <div>
                    <label class="block font-medium mb-1">Select Branch</label>
                    <select id="summary-branch" class="w-full border rounded px-2 py-1"></select>
                </div>
                <div>
                    <label class="block font-medium mb-1">Select Subdivision</label>
                    <select id="summary-subdivision" class="w-full border rounded px-2 py-1"></select>
                </div>
                <div>
                    <label class="block font-medium mb-1">From Date</label>
                    <input type="date" id="summary-from" class="w-full border rounded px-2 py-1" />
                </div>
                <div>
                    <label class="block font-medium mb-1">To Date</label>
                    <input type="date" id="summary-to" class="w-full border rounded px-2 py-1" />
                </div>
            </div>

            <button id="summary-load-btn" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                🔍 Load Summary
            </button>
            <button id="summary-pdf-btn" class="ml-2 bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700">
                🖨️ Export to PDF
            </button>

            <button id="summary-export-btn"
                class="ml-4 bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
                📁 Export to Excel
            </button>


            <div id="summary-loading" class="mt-4 hidden text-blue-600 font-semibold">Loading summary...</div>

            <div class="overflow-x-auto mt-6">
                <table class="min-w-full border text-sm text-left" id="summary-table">
                    <thead class="bg-gray-100">
                        <tr id="summary-table-head"></tr>
                    </thead>
                    <tbody id="summary-table-body">
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-500">Please select filters and click "Load
                                Summary".</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>


        <div id="tab-edit" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-4">Employee Management</h2>
                <div class="flex space-x-4 border-b mb-4"><button
                        class="edit-tab-button px-4 py-2 text-blue-700 border-b-2 border-blue-700 font-semibold"
                        data-edit-tab="add-employee">Add Employee</button><button
                        class="edit-tab-button px-4 py-2 text-gray-700 hover:text-blue-700"
                        data-edit-tab="edit-employee">Edit Employee</button><button
                        class="edit-tab-button px-4 py-2 text-gray-700 hover:text-blue-700"
                        data-edit-tab="remove-employee">Remove Employee</button></div><!-- Add Employee Tab Content -->
                <div id="edit-tab-add-employee" class="edit-tab-content">
                    <h3 class="text-md font-semibold mb-3">Add New Employee</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Employee ID <span
                                    class="text-red-500">*</span></label><input type="text" id="add-employee-id"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., emp001"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Employee Name <span
                                    class="text-red-500">*</span></label><input type="text" id="add-employee-name"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="Enter employee name">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700">Designation <span
                                    class="text-red-500">*</span></label><input type="text"
                                id="add-employee-designation" class="form-input border rounded px-3 py-2 w-full"
                                placeholder="e.g., Sales Executive"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Phone (Optional)</label><input
                                type="text" id="add-employee-phone" class="form-input border rounded px-3 py-2 w-full"
                                placeholder="Enter phone number"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Email (Optional)</label><input
                                type="email" id="add-employee-email" class="form-input border rounded px-3 py-2 w-full"
                                placeholder="Enter email address"></div>
                        <div class="flex items-center mt-2 col-span-full"><input type="checkbox"
                                id="add-special-employee" class="form-checkbox h-4 w-4 text-blue-600 rounded"><label
                                for="add-special-employee" class="ml-2 text-sm font-medium text-gray-700">Special
                                Employee</label></div>
                        <div id="add-branch-sub-container" class="col-span-full grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Branch <span
                                        class="text-red-500">*</span></label><select id="add-employee-branch"
                                    class="form-select border rounded px-3 py-2 w-full">
                                    <option value="">Select Branch</option>
                                </select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Subdivision <span
                                        class="text-red-500">*</span></label><select id="add-employee-subdivision"
                                    class="form-select border rounded px-3 py-2 w-full" disabled>
                                    <option value="">Select Subdivision</option>
                                </select></div>
                        </div>
                    </div><button id="add-employee-btn"
                        class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                        Add Employee
                    </button>
                </div><!-- Edit Employee Tab Content -->
                <div id="edit-tab-edit-employee" class="edit-tab-content hidden">
                    <h3 class="text-md font-semibold mb-3">Edit Existing Employee</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><!-- New Search by Employee ID section -->
                        <div class="col-span-full mb-4"><label class="block text-sm font-medium text-gray-700">Search
                                Employee by ID</label>
                            <div class="flex gap-2"><input type="text" id="search-employee-id-input"
                                    class="form-input border rounded px-3 py-2 w-full"
                                    placeholder="Enter Employee ID to search"><button id="search-employee-id-btn"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-medium">Search</button>
                            </div><!-- NEW: Inline message for search validation -->
                            <div id="search-employee-id-message" class="text-sm mt-1 hidden"></div>
                        </div>
                        <div class="flex items-center mt-2 col-span-full"><input type="checkbox"
                                id="edit-special-employee" class="form-checkbox h-4 w-4 text-blue-600 rounded"><label
                                for="edit-special-employee" class="ml-2 text-sm font-medium text-gray-700">Special
                                Employee</label></div>
                        <div id="edit-branch-sub-container" class="col-span-full grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Branch</label><select
                                    id="edit-employee-branch" class="form-select border rounded px-3 py-2 w-full">
                                    <option value="">Select Branch</option>
                                </select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Subdivision</label><select
                                    id="edit-employee-subdivision" class="form-select border rounded px-3 py-2 w-full"
                                    disabled>
                                    <option value="">Select Subdivision</option>
                                </select></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700">Employee</label><select
                                id="edit-employee-select" class="form-select border rounded px-3 py-2 w-full" disabled>
                                <option value="">Select Employee</option>
                            </select></div>

                        <div><label class="block text-sm font-medium text-gray-700">Employee Name</label><input
                                type="text" id="edit-employee-name" class="form-input border rounded px-3 py-2 w-full"
                                placeholder="Enter employee name"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Designation</label><input
                                type="text" id="edit-employee-designation"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="Enter designation">
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700">Phone</label><input type="text"
                                id="edit-employee-phone" class="form-input border rounded px-3 py-2 w-full"
                                placeholder="Enter phone number"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email"
                                id="edit-employee-email" class="form-input border rounded px-3 py-2 w-full"
                                placeholder="Enter email address"></div><!-- Device ID Display and Reset Button -->
                        <div
                            class="col-span-full flex flex-col sm:flex-row items-center gap-4 mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
                            <p class="text-sm font-medium text-gray-700">Device ID:</p><span id="device-id-display"
                                class="font-bold text-gray-800 flex-grow">Not Marked</span><button
                                id="reset-device-id-btn"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-medium hidden">
                                Reset Device ID
                            </button>
                        </div>
                    </div><button id="save-employee-btn"
                        class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                        Save Changes
                    </button>
                </div><!-- Remove Employee Tab Content -->
                <div id="edit-tab-remove-employee" class="edit-tab-content hidden">
                    <h3 class="text-md font-semibold mb-3">Remove Employee</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><!-- Search by Employee ID for Removal -->
                        <div class="col-span-full mb-4"><label class="block text-sm font-medium text-gray-700">Search
                                Employee by ID to
                                Remove</label>
                            <div class="flex gap-2"><input type="text" id="remove-employee-search-input"
                                    class="form-input border rounded px-3 py-2 w-full"
                                    placeholder="Enter Employee ID"><button id="remove-employee-search-btn"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-medium">Search</button>
                            </div>
                        </div>
                        <div class="flex items-center mt-2 col-span-full"><input type="checkbox"
                                id="remove-special-employee" class="form-checkbox h-4 w-4 text-blue-600 rounded"><label
                                for="remove-special-employee" class="ml-2 text-sm font-medium text-gray-700">Special
                                Employee</label></div>
                        <div id="remove-branch-sub-container"
                            class="col-span-full grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Branch</label><select
                                    id="remove-employee-branch" class="form-select border rounded px-3 py-2 w-full">
                                    <option value="">Select Branch</option>
                                </select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Subdivision</label><select
                                    id="remove-employee-subdivision" class="form-select border rounded px-3 py-2 w-full"
                                    disabled>
                                    <option value="">Select Subdivision</option>
                                </select></div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700">Employee</label><select
                                id="remove-employee-select" class="form-select border rounded px-3 py-2 w-full"
                                disabled>
                                <option value="">Select Employee</option>
                            </select></div>
                    </div><button id="remove-employee-btn"
                        class="mt-6 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium">
                        Remove Employee
                    </button>
                </div>
            </div>
        </div><!-- Branch & Subdivision Management Tab Content -->
        <div id="tab-branch-management" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-4">Branch & Subdivision Management</h2>
                <!-- Create New Branch Form -->
                <div class="border p-4 rounded-lg bg-gray-50">
                    <h3 class="text-md font-semibold mb-3">Create New Branch</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- District Dropdown -->
                        <div>
                            <label for="district-select" class="block text-sm font-medium text-gray-700">
                                Select District <span class="text-red-500">*</span>
                            </label>
                            <select id="district-select" class="form-select border rounded px-3 py-2 w-full shadow-sm">
                                <option value="">Select District</option>
                            </select>
                        </div>

                        <!-- Branch Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">
                                Branch Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="create-branch-name"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., Chennai">
                        </div>



                        <!-- Latitude -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">
                                Latitude <span class="text-red-500">*</span>
                            </label>
                            <input type="number" step="any" id="create-branch-lat"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., 12.99">
                        </div>

                        <!-- Longitude -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">
                                Longitude <span class="text-red-500">*</span>
                            </label>
                            <input type="number" step="any" id="create-branch-lng"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., 80.2">
                        </div>

                        <!-- Radius -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">
                                Radius (m) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" step="0.1" id="create-branch-radius"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., 0.5">
                        </div>
                    </div>
                    <button id="create-branch-btn"
                        class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                        Create Branch
                    </button>
                </div><!-- Add Subdivision Form -->
                <div class="border p-4 rounded-lg bg-gray-50 mt-6">
                    <h3 class="text-md font-semibold mb-3">Add Subdivision to Branch</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Select Branch <span
                                    class="text-red-500">*</span></label><select id="add-subdivision-branch"
                                class="form-select border rounded px-3 py-2 w-full">
                                <option value="">Select Branch</option>
                            </select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Subdivision Name <span
                                    class="text-red-500">*</span></label><input type="text" id="add-subdivision-name"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., Sales"></div>
                    </div><button id="add-subdivision-btn"
                        class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                        Add Subdivision
                    </button>
                </div><!-- Edit Branch Name Form -->
                <div class="border p-4 rounded-lg bg-gray-50 mt-6">
                    <h3 class="text-md font-semibold mb-3">Edit Branch Name</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div><label class="block text-sm font-medium text-gray-700">Select Branch</label><select
                                id="edit-branch-dropdown" class="form-select border rounded px-3 py-2 w-full">
                                <option value="">Select Branch to Edit</option>
                            </select></div>
                        <div id="edit-branch-name-input-container" class="hidden"><label
                                class="block text-sm font-medium text-gray-700">New Branch Name <span
                                    class="text-red-500">*</span></label>
                            <div class="flex gap-2"><input type="text" id="edit-branch-name-input"
                                    class="form-input border rounded px-3 py-2 w-full"
                                    placeholder="Enter new branch name"><button id="save-branch-name-btn"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-medium">Save</button>
                            </div>
                        </div>
                    </div>
                </div><!-- Edit Subdivision Name Form -->
                <div class="border p-4 rounded-lg bg-gray-50 mt-6">
                    <h3 class="text-md font-semibold mb-3">Edit Subdivision Name</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div><label class="block text-sm font-medium text-gray-700">Select Branch</label><select
                                id="edit-subdivision-branch-dropdown"
                                class="form-select border rounded px-3 py-2 w-full">
                                <option value="">Select Branch</option>
                            </select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Select Subdivision</label><select
                                id="edit-subdivision-dropdown" class="form-select border rounded px-3 py-2 w-full"
                                disabled>
                                <option value="">Select Subdivision to Edit</option>
                            </select></div>
                        <div id="edit-subdivision-name-input-container" class="hidden col-span-full md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">New Subdivision Name <span
                                    class="text-red-500">*</span></label>
                            <div class="flex gap-2"><input type="text" id="edit-subdivision-name-input"
                                    class="form-input border rounded px-3 py-2 w-full"
                                    placeholder="Enter new subdivision name"><button id="save-subdivision-name-btn"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-medium">Save</button>
                            </div>
                        </div>
                    </div>
                </div><!-- Manage Existing Branches & Subdivisions -->
                <div class="mt-6">
                    <h3 class="text-md font-semibold mb-3">Manage Existing Branches & Subdivisions</h3>
                    <div id="branches-list-container" class="space-y-4">
                        <!-- Branches and subdivisions will be dynamically loaded here -->
                        <p class="text-gray-500 text-center py-4">Loading branches...</p>
                    </div>
                </div>
            </div>
        </div><!-- NEW: Holiday Manager Tab Content -->
        <div id="tab-holiday-manager" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-4">Holiday Manager</h2><!-- Single Holiday Add -->
                <div class="border p-4 rounded-lg bg-gray-50">
                    <h3 class="text-md font-semibold mb-3">Add Single Holiday</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Date <span
                                    class="text-red-500">*</span></label><input type="date" id="single-holiday-date"
                                class="form-input border rounded px-3 py-2 w-full"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Reason <span
                                    class="text-red-500">*</span></label><input type="text" id="single-holiday-reason"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., Eid-ul-Adha">
                        </div>
                    </div><button id="add-single-holiday-btn"
                        class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                        Add Holiday
                    </button>
                </div><!-- Bulk Manual Holiday Entry -->
                <div class="border p-4 rounded-lg bg-gray-50 mt-6">
                    <h3 class="text-md font-semibold mb-3">Bulk Manual Holiday Entry</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Dates (Comma-separated, YYYY-MM-DD)
                                <span class="text-red-500">*</span></label><textarea id="bulk-holiday-dates"
                                class="form-textarea border rounded px-3 py-2 w-full h-24"
                                placeholder="e.g., 2025-01-01, 2025-01-26, 2025-08-15"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700">Shared Reason <span
                                    class="text-red-500">*</span></label><input type="text" id="bulk-holiday-reason"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="e.g., Public Holiday">
                        </div>
                    </div><button id="add-bulk-holiday-btn"
                        class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                        Add Bulk Holidays
                    </button>
                </div><!-- List & Delete Holidays -->
                <div class="mt-6">
                    <h3 class="text-md font-semibold mb-3">Configured Holidays</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border text-sm">
                            <thead class="bg-gray-100 font-semibold">
                                <tr>
                                    <th class="border px-4 py-2">Date</th>
                                    <th class="border px-4 py-2">Reason</th>
                                    <th class="border px-4 py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="holidays-list-table-body"><!-- Holidays will be dynamically loaded here -->
                                <tr>
                                    <td colspan="3" class="text-gray-500 text-center py-4">Loading holidays...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- 👇 New: Signup Requests Panel -->
        <div id="tab-signup-requests" class="tab-content hidden">
            <div id="signup-requests-list" class="space-y- 4"></div>
        </div>




    </div><!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h2>
            <p id="modal-message" class="text-lg font-semibold text-gray-800">Are you sure you want to proceed?</p>
            <div class="modal-buttons"><button id="modal-confirm-btn" class="confirm">Confirm</button><button
                    id="modal-cancel-btn" class="cancel">Cancel</button></div>
        </div>
    </div><!-- Loading Modal -->
    <div id="loading-modal" class="modal">
        <div class="modal-content flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mb-4"></div>
            <p id="loading-message" class="text-lg font-semibold text-gray-800">Loading...</p>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

</body>

</html>