<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | AbsentEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration and Initialization
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBU3K7gRzqiqQt3o9thoEpd06ReLGVmm_w",
  authDomain: "diya-hero.firebaseapp.com",
  projectId: "diya-hero",
      databaseURL: "https://diya-hero-default-rtdb.asia-southeast1.firebasedatabase.app", 
  storageBucket: "diya-hero.firebasestorage.app",
  messagingSenderId: "455829653263",
  appId: "1:455829653263:web:5a31c65bdab2b9cee0607a",
  measurementId: "G-DZYHPLQD3F"
};

        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.database();

        // Fake Time Control (for Admin Panel)
        let testMode = false;
        let testNow = null;

        // Safe Time Getter: Returns real time or fake time based on testMode
        function getNow() {
            if (testMode && testNow instanceof Date) {
                return new Date(testNow);
            }
            return new Date();
        }

        // Simulate time ticking (only if testMode is active)
        setInterval(() => {
            if (testMode && testNow instanceof Date) {
                testNow.setSeconds(testNow.getSeconds() + 1);
            }
        }, 1000);

        // Update Live Clock display
        function updateLiveClock() {
            const now = getNow();
            const timeStr = now.toLocaleTimeString("en-IN", { hour12: true });
            const clockEl = document.getElementById("live-clock");
            if (clockEl) {
                clockEl.textContent = timeStr;
            }
        }

        // Load fake time setting from DB and start clock
        firebase.database().ref("settings").once("value").then(snapshot => {
            const settings = snapshot.val();
            if (settings?.testMode && settings?.fakeTime) {
                testMode = true;
                testNow = new Date(settings.fakeTime);
                console.log("üß™ Test Mode Enabled in Admin:", testNow.toLocaleString());
            } else {
                testMode = false;
                testNow = null;
                console.log("üïí Real Time Mode in Admin");
            }
            // Initialize clock display immediately after settings are loaded
            updateLiveClock();
        }).catch(err => {
            console.warn("‚ö†Ô∏è Failed to load test settings:", err.message);
            testMode = false; // Fallback to real time if there's an error
            testNow = null;
            updateLiveClock(); // Initialize clock display even on error
        });

        // Start the live clock interval after initial load
        setInterval(updateLiveClock, 1000);

    </script>
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #b0bbca;
    }

    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #003366;
        color: white;
        padding: 10px 20px;
    }

    .logo-section {
        display: flex;
        align-items: inherit;
        gap: 11px;
        row-gap: 16px;
        column-gap: 10px;
    }

    .logo-img {
        height: 60px;
    }

    .app-name {
        font-size: 26px;
        font-weight: bold;
    }

    .clock-container {
        font-size: 18px;
        font-weight: bold;
    }

    .container {
        padding: 20px;
    }

    .controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        flex-direction: column;
    }

    .control-group select,
    .control-group button {
        padding: 8px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .attendance-table-container {
        overflow-x: auto;
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
    }

    th,
    td {
        padding: 10px;
        border: 1px solid #ccc;
        text-align: center;
    }

    th {
        background-color: #003366;
        color: white;
    }

    .radio-group {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .summary-section {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
    }

    .summary-item {
        background-color: white;
        padding: 10px 20px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .summary-count {
        font-size: 24px;
        font-weight: bold;
    }

    .count-full {
        color: green;
    }

    .count-half {
        color: orange;
    }

    .count-absent {
        color: red;
    }

    .count-late {
        color: #ff3300;
    }

    .save-section {
        text-align: center;
        margin-top: 20px;
    }

    .save-btn {
        padding: 10px 20px;
        font-size: 16px;
        background-color: green;
        color: white;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }

    .save-btn:disabled {
        background-color: gray;
        cursor: not-allowed;
    }

    .status-badge {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 6px;
        display: inline-block;
    }

    .status-full {
        background-color: #28a745;
        color: white;
    }

    .status-half {
        background-color: #ffc107;
        color: black;
    }

    .status-absent {
        background-color: #dc3545;
        color: white;
    }

    .status-pending {
        background-color: #cccccc;
        color: #333;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
    }

    .late-indicator {
        color: red;
        font-weight: bold;
    }

    input[type="checkbox"]:disabled {
        background-color: #0052f5 !important;
        border: 1px solid #f70a0aad;
        opacity: 0.6;
        cursor: not-allowed;
    }

    .user-section {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    #user-badge {
        border-radius: 8px;
        padding: 8px 12px;
        color: hsl(0, 86%, 39%);
        font-family: "Segoe UI", sans-serif;
        font-size: 13px;
        line-height: 1.4;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        min-width: 150px;
    }

    #user-name {
        font-weight: 600;
        font-size: 14px;
        color: #03feedd1;
    }

    #branch-info {
        font-size: 12px;
        color: #ffffff;
    }

    .user-badge-dev {
        background-color: #6f42c1;
        border-left: 4px solid #6f42c1;
    }

    .user-badge-admin {
        background-color: #31d8ae;
        border-left: 4px solid #010d18;
    }

    .user-badge-branch {
        background-color: #28a745;
        border-left: 4px solid #2e7d32;
    }

    .top-bar-dev {
        background-color: #5e35b1;
    }

    .top-bar-admin {
        background-color: #3f0e0e00;
    }

    .top-bar-branch {
        background-color: #2e7d32;
    }

    .logo {
        font-size: 20px;
        font-weight: bold;
    }

    .btn {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        color: #333;
    }

    .btn:hover {
        background-color: #e9e9e9;
    }

    #admin-panel-btn {
        background-color: #374785;
        color: white;
        padding: 6px 14px;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    #admin-panel-btn:hover {
        background-color: #2c3769;
    }

    #logout-btn {
        border-color: #d9534f;
        background-color: #f8d7da;
        color: #a94442;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4.5px 20px;
        background-color: #e1e1e1;
        color: #333;
        font-family: 'Segoe UI', sans-serif;
        border-bottom: 1px solid #000000;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    .logo img {
        height: 55px;
    }

    #save-btn {
        background-color: #d32f2f;
        color: #fff;
        padding: 8px 18px;
        border: none;
        font-weight: 600;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        transition: background 0.2s ease;
    }

    #save-btn:hover {
        background-color: #b71c1c;
    }

    .user-badge {
        width: auto;
        max-width: 10%;
        white-space: nowrap;
        padding: 10px 14px;
        border-radius: 8px;
        background-color: #4f505e;
        color: #333;
        text-align: center;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(10, 218, 55, 0.06);
        border-left: 4px solid transparent;
    }

    /* Custom Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
    }

    .modal-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .modal-buttons button {
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
    }

    .modal-buttons .confirm {
        background-color: #dc3545;
        color: white;
        border: none;
    }

    .modal-buttons .cancel {
        background-color: #6c757d;
        color: white;
        border: none;
    }
</style>

<body class="bg-gray-100 min-h-screen">

    <div id="header-container"></div>


    <div class="container mx-auto px-4 py-6">
        <div class="mb-6">
            <nav class="flex space-x-4 border-b">
                <button class="tab-button px-4 py-2 text-blue-700 border-b-2 border-blue-700 font-semibold"
                    data-tab="records">Employee Records</button>
                <button class="tab-button px-4 py-2 text-gray-700 hover:text-blue-700" data-tab="individual">Individual
                    Records</button>
                <button class="tab-button px-4 py-2 text-gray-700 hover:text-blue-700" id="edit-tab-button"
                    data-tab="edit">Edit Employee
                    Records</button>
            </nav>
        </div>

        <div id="tab-records" class="tab-content">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Branch</label>
                        <select id="record-branch" class="form-select border rounded px-3 py-2">
                            <option value="All">All</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Subdivision</label>
                        <select id="record-subdivision" class="form-select border rounded px-3 py-2" disabled>
                            <option value="All">All</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">From</label>
                        <input type="date" id="record-from" class="form-input border rounded px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">To</label>
                        <input type="date" id="record-to" class="form-input border rounded px-3 py-2">
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="toggle-times" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                        <label for="toggle-times" class="text-sm font-medium text-gray-700">Show Times</label>
                    </div>

                    <button id="load-records-btn" class="bg-blue-600 text-white px-4 py-2 rounded font-medium">
                        Load All Records
                    </button>
                </div>

                <div class="overflow-auto max-h-[70vh]">
                    <table class="min-w-full border text-sm" id="employee-records-table">
                        <thead id="records-thead" class="bg-gray-100 font-semibold">
                            <tr>
                                <th class="border px-4 py-2">Date</th>
                                <th class="border px-4 py-2">Employee</th>
                                <th class="border px-4 py-2">Branch</th>
                                <th class="border px-4 py-2">Subdivision</th>
                                <th class="border px-4 py-2">Morning</th>
                                <th class="border px-4 py-2">Afternoon</th>
                                <th class="border px-4 py-2">Enter/Leave Time</th>
                                <th class="border px-4 py-2">Status</th>
                                <th class="border px-4 py-2">Late?</th>
                            </tr>
                        </thead>
                        <tbody id="records-table-body">
                            <!-- Vertical records will be appended here -->
                        </tbody>
                    </table>
                </div>

                <div id="records-summary" class="bg-white p-4 rounded shadow mt-4 hidden">
                    <p class="text-lg font-semibold text-gray-800">Summary:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Total Full Days: <span id="records-full-days" class="font-bold text-green-600">0</span></li>
                        <li>Total Half Days: <span id="records-half-days" class="font-bold text-orange-600">0</span></li>
                        <li>Total Absent Days: <span id="records-absent-days" class="font-bold text-red-600">0</span></li>
                        <li>Total Late Days: <span id="records-late-days" class="font-bold text-red-600">0</span></li>
                        <li>Total Leave Taken: <span id="records-total-leave-count" class="font-bold text-blue-600">0 Days</span></li>
                    </ul>
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button id="export-pdf" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">üìÑ Export
                        PDF</button>
                    <button id="export-excel" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">üìä
                        Export Excel</button>
                </div>
            </div>

        </div>

        <div id="tab-individual" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <div class="flex flex-wrap gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Branch</label>
                        <select id="indiv-branch" class="form-select border rounded px-3 py-2">
                            <option value="All">All Branches</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Subdivision</label>
                        <select id="indiv-subdivision" class="form-select border rounded px-3 py-2" disabled>
                            <option value="All">All Subdivisions</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Employee</label>
                        <select id="indiv-employee" class="form-select border rounded px-3 py-2" disabled>
                            <option value="All">All Employees</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">From</label>
                        <input type="date" id="indiv-from-date" class="form-input border rounded px-3 py-2">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">To</label>
                        <input type="date" id="indiv-to-date" class="form-input border rounded px-3 py-2">
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="indiv-toggle-times"
                            class="form-checkbox h-4 w-4 text-blue-600 rounded">
                        <label for="indiv-toggle-times" class="text-sm font-medium text-gray-700">Show Times</label>
                    </div>

                    <button id="load-individual-btn"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium">
                        üë§ Load Individual Records
                    </button>
                </div>

                <div id="loading-individual" class="text-center text-gray-500 py-4 hidden">
                    <div class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        Loading records...
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full border text-sm" id="indiv-records-table">
                        <thead id="indiv-thead" class="bg-gray-100 font-semibold">
                            <tr>
                                <th class="border px-4 py-2">Date</th>
                                <th class="border px-4 py-2">Morning</th>
                                <th class="border px-4 py-2 indiv-time-col">Enter Time</th>
                                <th class="border px-4 py-2">Afternoon</th>
                                <th class="border px-4 py-2 indiv-time-col">Enter/Leave Time</th>
                                <th class="border px-4 py-2">Status</th>
                                <th class="border px-4 py-2">Late?</th>
                            </tr>
                        </thead>
                        <tbody id="indiv-table-body">
                            <!-- Rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>

                <div id="indiv-summary" class="bg-white p-4 rounded shadow mt-4 hidden">
                    <p class="text-lg font-semibold text-gray-800">Summary:</p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Total Full Days: <span id="indiv-full-days" class="font-bold text-green-600">0</span></li>
                        <li>Total Half Days: <span id="indiv-half-days" class="font-bold text-orange-600">0</span></li>
                        <li>Total Absent Days: <span id="indiv-absent-days" class="font-bold text-red-600">0</span></li>
                        <li>Total Late Days: <span id="indiv-late-days" class="font-bold text-red-600">0</span></li>
                        <li>Total Leave Taken: <span id="indiv-total-leave-count" class="font-bold text-blue-600">0
                                Days</span></li>
                    </ul>
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button id="export-indiv-pdf" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">üìÑ
                        Export
                        PDF</button>
                    <button id="export-indiv-excel"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">üìä
                        Export Excel</button>
                </div>
            </div>
        </div>

        <div id="tab-edit" class="tab-content hidden">
            <div class="bg-white p-6 rounded shadow space-y-6">
                <h2 class="text-lg font-semibold mb-4">Employee Management</h2>

                <div class="flex space-x-4 border-b mb-4">
                    <button class="edit-tab-button px-4 py-2 text-blue-700 border-b-2 border-blue-700 font-semibold"
                        data-edit-tab="add-employee">Add Employee</button>
                    <button class="edit-tab-button px-4 py-2 text-gray-700 hover:text-blue-700"
                        data-edit-tab="edit-employee">Edit Employee</button>
                    <button class="edit-tab-button px-4 py-2 text-gray-700 hover:text-blue-700"
                        data-edit-tab="remove-employee">Remove Employee</button>
                </div>

                <!-- Add Employee Tab Content -->
                <div id="edit-tab-add-employee" class="edit-tab-content">
                    <h3 class="text-md font-semibold mb-3">Add New Employee</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Employee Name</label>
                            <input type="text" id="add-employee-name" class="form-input border rounded px-3 py-2 w-full"
                                placeholder="Enter employee name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" id="add-employee-phone"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="Enter phone number">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="add-employee-email"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="Enter email address">
                        </div>
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="add-special-employee"
                                class="form-checkbox h-4 w-4 text-blue-600 rounded">
                            <label for="add-special-employee" class="ml-2 text-sm font-medium text-gray-700">Special
                                Employee</label>
                        </div>
                        <div id="add-branch-sub-container">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Branch</label>
                                <select id="add-employee-branch" class="form-select border rounded px-3 py-2 w-full">
                                    <option value="">Select Branch</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">Subdivision</label>
                                <select id="add-employee-subdivision"
                                    class="form-select border rounded px-3 py-2 w-full" disabled>
                                    <option value="">Select Subdivision</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button id="add-employee-btn"
                        class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                        Add Employee
                    </button>
                </div>

                <!-- Edit Employee Tab Content -->
                <div id="edit-tab-edit-employee" class="edit-tab-content hidden">
                    <h3 class="text-md font-semibold mb-3">Edit Existing Employee</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center mt-2 col-span-full">
                            <input type="checkbox" id="edit-special-employee"
                                class="form-checkbox h-4 w-4 text-blue-600 rounded">
                            <label for="edit-special-employee" class="ml-2 text-sm font-medium text-gray-700">Special
                                Employee</label>
                        </div>
                        <div id="edit-branch-sub-container">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Branch</label>
                                <select id="edit-employee-branch" class="form-select border rounded px-3 py-2 w-full">
                                    <option value="">Select Branch</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">Subdivision</label>
                                <select id="edit-employee-subdivision"
                                    class="form-select border rounded px-3 py-2 w-full" disabled>
                                    <option value="">Select Subdivision</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Employee</label>
                            <select id="edit-employee-select" class="form-select border rounded px-3 py-2 w-full"
                                disabled>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Employee Name</label>
                            <input type="text" id="edit-employee-name"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="Enter employee name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" id="edit-employee-phone"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="Enter phone number">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="edit-employee-email"
                                class="form-input border rounded px-3 py-2 w-full" placeholder="Enter email address">
                        </div>
                    </div>
                    <button id="save-employee-btn"
                        class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                        Save Changes
                    </button>
                </div>

                <!-- Remove Employee Tab Content -->
                <div id="edit-tab-remove-employee" class="edit-tab-content hidden">
                    <h3 class="text-md font-semibold mb-3">Remove Employee</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center mt-2 col-span-full">
                            <input type="checkbox" id="remove-special-employee"
                                class="form-checkbox h-4 w-4 text-blue-600 rounded">
                            <label for="remove-special-employee" class="ml-2 text-sm font-medium text-gray-700">Special
                                Employee</label>
                        </div>
                        <div id="remove-branch-sub-container">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Branch</label>
                                <select id="remove-employee-branch" class="form-select border rounded px-3 py-2 w-full">
                                    <option value="">Select Branch</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700">Subdivision</label>
                                <select id="remove-employee-subdivision"
                                    class="form-select border rounded px-3 py-2 w-full" disabled>
                                    <option value="">Select Subdivision</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Employee</label>
                            <select id="remove-employee-select" class="form-select border rounded px-3 py-2 w-full"
                                disabled>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                    </div>
                    <button id="remove-employee-btn"
                        class="mt-6 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium">
                        Remove Employee
                    </button>
                </div>
            </div>
        </div>

        <div id="activity-logs" class="bg-white p-6 rounded shadow mt-6 hidden">
            <h2 class="text-lg font-semibold mb-4">Activity Logs</h2>
            <div class="flex flex-wrap gap-4 items-end mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">From Date</label>
                    <input type="date" id="log-from-date" class="form-input border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">To Date</label>
                    <input type="date" id="log-to-date" class="form-input border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Filter By User</label>
                    <select id="log-user-filter" class="form-select border rounded px-3 py-2">
                        <option value="All">All Users</option>
                    </select>
                </div>
                <button id="load-logs-btn" class="bg-blue-600 text-white px-4 py-2 rounded font-medium">
                    Load Logs
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full border text-sm" id="logs-table">
                    <thead class="bg-gray-100 font-semibold">
                        <tr>
                            <th class="border px-4 py-2">Time</th>
                            <th class="border px-4 py-2">User (Name + Branch)</th>
                            <th class="border px-4 py-2">Action</th>
                            <th class="border px-4 py-2">Section</th>
                            <th class="border px-4 py-2">Changes</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body">
                        <tr>
                            <td colspan="5" class="text-center text-gray-500 py-4">Select filters and click "Load Logs"
                                to view activity.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="export-logs-pdf" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">üìÑ Export
                    PDF</button>
                <button id="export-logs-excel" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">üìä
                    Export Excel</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="text-lg font-semibold text-gray-800">Are you sure you want to proceed?</p>
            <div class="modal-buttons">
                <button id="modal-confirm-btn" class="confirm">Confirm</button>
                <button id="modal-cancel-btn" class="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Global variable to store user role and name
        let currentUserRole = null;
        let currentUserName = "Unknown User";
        let currentDisplayedLogs = []; // Stores logs currently displayed in the table for export
        let currentEmployeeRecords = []; // Stores records for Employee Records tab for export

        // Function to show custom modal
        function showModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center

            modalConfirmBtn.onclick = () => {
                modal.style.display = 'none';
                onConfirm(true);
            };

            modalCancelBtn.onclick = () => {
                modal.style.display = 'none';
                onConfirm(false);
            };
        }


        // Tab functionality (main tabs)
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const editTabButton = document.getElementById('edit-tab-button'); // Get the edit tab button

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-tab');

                // Check role for 'edit' tab
                if (target === 'edit' && currentUserRole !== 'Admin' && currentUserRole !== 'Dev') { // Corrected roles
                    alert("You do not have permission to access Employee Management.");
                    // Prevent switching to the tab if unauthorized
                    return;
                }

                tabButtons.forEach(b => {
                    b.classList.remove('text-blue-700', 'border-blue-700', 'font-semibold');
                    b.classList.add('text-gray-700');
                });

                btn.classList.add('text-blue-700', 'border-b-2', 'border-blue-700', 'font-semibold');

                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`tab-${target}`).classList.remove('hidden');

                // If switching to the edit tab, ensure the first sub-tab is active
                if (target === 'edit') {
                    const firstEditTabButton = document.querySelector('.edit-tab-button[data-edit-tab="add-employee"]');
                    if (firstEditTabButton) {
                        firstEditTabButton.click(); // Simulate a click to activate the first sub-tab
                    }
                }
            });
        });

        // Tab functionality (edit sub-tabs)
        const editTabButtons = document.querySelectorAll('.edit-tab-button');
        const editTabContents = document.querySelectorAll('.edit-tab-content');

        editTabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-edit-tab');

                editTabButtons.forEach(b => {
                    b.classList.remove('text-blue-700', 'border-blue-700', 'font-semibold');
                    b.classList.add('text-gray-700');
                });

                btn.classList.add('text-blue-700', 'border-b-2', 'border-blue-700', 'font-semibold');

                editTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`edit-tab-${target}`).classList.remove('hidden');
            });
        });


        // Load header.html and set up its specific event listeners
        fetch("header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header-container").innerHTML = data;

                // Update user badge in header
                const userBadgeEl = document.getElementById('user-badge');
                const userNameEl = document.getElementById('user-name');
                const branchInfoEl = document.getElementById('branch-info');
                const logoutBtn = document.getElementById('logout-btn'); // Get logout button
                const logsBtn = document.getElementById('logs-btn'); // Get logs button

                const activityLogs = document.getElementById("activity-logs");

                // Logout button logic
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        showModal("Are you sure you want to log out?", async (confirm) => {
                            if (confirm) {
                                try {
                                    await auth.signOut();
                                    window.location.href = "index.html"; // Redirect to login page
                                } catch (error) {
                                    console.error("Logout failed:", error);
                                    alert("Logout failed: " + error.message);
                                }
                            }
                        });
                    });
                }

                // Logs button logic
                if (logsBtn && activityLogs) {
                    logsBtn.addEventListener("click", () => {
                        activityLogs.classList.toggle("hidden");
                        if (!activityLogs.classList.contains("hidden")) {
                            activityLogs.scrollIntoView({ behavior: "smooth" });
                        }
                    });
                }

                // Auth and Role Logic for dropdowns
                auth.onAuthStateChanged(async user => {
                    if (!user) {
                        // Redirect to login if not authenticated
                        window.location.href = "index.html";
                        return;
                    }

                    // Fetch user role and name
                    try {
                        const userRoleSnap = await db.ref(`users/${user.uid}/role`).once('value');
                        currentUserRole = userRoleSnap.val();
                        const userNameSnap = await db.ref(`users/${user.uid}/name`).once('value');
                        currentUserName = userNameSnap.val() || user.email || user.uid;

                        // Update user badge
                        if (userNameEl) userNameEl.textContent = currentUserName;
                        if (branchInfoEl) branchInfoEl.textContent = currentUserRole;
                        if (userBadgeEl) {
                            userBadgeEl.classList.remove('user-badge-dev', 'user-badge-admin', 'user-badge-branch');
                            if (currentUserRole === 'Dev') {
                                userBadgeEl.classList.add('user-badge-dev');
                            } else if (currentUserRole === 'Admin') {
                                userBadgeEl.classList.add('user-badge-admin');
                            } else if (currentUserRole === 'Branch') {
                                userBadgeEl.classList.add('user-badge-branch');
                            }
                        }


                        // Hide edit tab if not Admin/Dev
                        if (currentUserRole !== 'Admin' && currentUserRole !== 'Dev') { // Corrected roles
                            editTabButton.classList.add('hidden'); // Hide the button
                        } else {
                            editTabButton.classList.remove('hidden'); // Ensure button is visible for authorized users
                        }

                        // Declare activity log elements here
                        const logFromDateInput = document.getElementById("log-from-date");
                        const logToDateInput = document.getElementById("log-to-date");
                        const logUserFilterDropdown = document.getElementById("log-user-filter");
                        const loadLogsBtn = document.getElementById("load-logs-btn");
                        const logsTableBody = document.getElementById("logs-table-body");

                        // Populate user filter for activity logs
                        populateUserFilter();

                    } catch (error) {
                        console.error("Error fetching user role:", error);
                        currentUserRole = 'user'; // Default to user if error
                        editTabButton.classList.add('hidden'); // Hide on error
                    }

                    // Helper to format time (handles "HH:MM:SS am/pm" or "HH:MM:SS")
                    function formatTime(timeString) {
                        if (!timeString) return '-';
                        // Create a dummy date to parse the time correctly
                        const dummyDate = new Date(`2000-01-01 ${timeString}`);
                        return dummyDate.toLocaleTimeString("en-IN", { hour: '2-digit', minute: '2-digit', hour12: true });
                    }

                    // Helper function to get employee details (handles both regular and special employees)
                    async function getEmployeeDetails(employeeId, branchId = null, subdivisionId = null) {
                        // First, try to get from specialEmployees
                        const specialEmpSnap = await db.ref(`specialEmployees/${employeeId}`).once('value');
                        if (specialEmpSnap.exists()) {
                            const empData = specialEmpSnap.val();
                            return { ...empData, id: employeeId, branch: 'N/A', subdivision: 'Special', isSpecial: true };
                        }

                        // Then, try to get from regular employees (requires branch and subdivision)
                        if (branchId && subdivisionId) {
                            const regularEmpSnap = await db.ref(`branches/${branchId}/subdivisions/${subdivisionId}/employees/${employeeId}`).once('value');
                            if (regularEmpSnap.exists()) {
                                const empData = regularEmpSnap.val();
                                return { ...empData, id: employeeId, branch: branchId, subdivision: subdivisionId, isSpecial: false };
                            }
                        }

                        return null; // Employee not found
                    }

                    // --- Dropdowns for Employee Records Tab ---
                    const recordBranchDropdown = document.getElementById("record-branch");
                    const recordSubdivisionDropdown = document.getElementById("record-subdivision");
                    const recordsTableBody = document.getElementById("records-table-body");
                    const recordsSummary = document.getElementById("records-summary");
                    const recordsFullDays = document.getElementById("records-full-days");
                    const recordsHalfDays = document.getElementById("records-half-days");
                    const recordsAbsentDays = document.getElementById("records-absent-days");
                    const recordsLateDays = document.getElementById("records-late-days");
                    const recordsTotalLeaveCountEl = document.getElementById("records-total-leave-count");

                    // Populate Branch dropdown for Employee Records Tab
                    db.ref("branches").once("value")
                        .then(snap => {
                            const branchesObj = snap.val() || {};
                            recordBranchDropdown.innerHTML = `<option value="All">All</option>`;
                            Object.keys(branchesObj).forEach(branchKey => {
                                const label = branchKey.charAt(0).toUpperCase() + branchKey.slice(1);
                                recordBranchDropdown.innerHTML += `<option value="${branchKey}">${label}</option>`;
                            });
                        })
                        .catch(err => console.error("Error loading branches for record tab:", err));

                    // When Branch is selected for Employee Records Tab, populate Subdivision
                    recordBranchDropdown.addEventListener("change", () => {
                        const selBranch = recordBranchDropdown.value;
                        recordSubdivisionDropdown.innerHTML = `<option value="All">All</option>`;
                        if (selBranch === "All") {
                            recordSubdivisionDropdown.disabled = true;
                            return;
                        }
                        db.ref(`branches/${selBranch}/subdivisions`).once("value")
                            .then(snap => {
                                const subsObj = snap.val() || {};
                                Object.keys(subsObj).forEach(subKey => {
                                    const label = subKey.charAt(0).toUpperCase() + subKey.slice(1);
                                    recordSubdivisionDropdown.innerHTML += `<option value="${subKey}">${label}</option>`;
                                });
                                recordSubdivisionDropdown.disabled = false;
                            })
                            .catch(err => console.error("Error loading subdivisions for record tab:", err));
                    });

                    // --- Load Records Logic for Employee Records Tab (rewritten for vertical layout) ---
                    document.getElementById("load-records-btn").addEventListener("click", async () => {
                        const selectedBranch = recordBranchDropdown.value;
                        const selectedSubdivision = recordSubdivisionDropdown.value;
                        const fromDateStr = document.getElementById("record-from").value;
                        const toDateStr = document.getElementById("record-to").value;
                        const showTimes = document.getElementById("toggle-times").checked;

                        recordsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">Loading records...</td></tr>';
                        recordsSummary.classList.add('hidden');
                        currentEmployeeRecords = []; // Clear for new export

                        // Reset summary counts
                        recordsFullDays.textContent = '0';
                        recordsHalfDays.textContent = '0';
                        recordsAbsentDays.textContent = '0';
                        recordsLateDays.textContent = '0';
                        recordsTotalLeaveCountEl.textContent = '0 Days';

                        if (!fromDateStr || !toDateStr) {
                            alert("Please select both 'From' and 'To' dates.");
                            recordsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">Select filters and click "Load All Records" to view.</td></tr>';
                            return;
                        }

                        const fromDate = new Date(fromDateStr);
                        const toDate = new Date(toDateStr);
                        toDate.setDate(toDate.getDate() + 1); // Include the end date

                        if (fromDate > toDate) {
                            alert("From date cannot be after To date.");
                            recordsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">Select filters and click "Load All Records" to view.</td></tr>';
                            return;
                        }

                        let allEmployees = {}; // Stores all employees to iterate through
                        let fetchedRecords = [];
                        let summaryFullDays = 0;
                        let summaryHalfDays = 0;
                        let summaryAbsentDays = 0;
                        let summaryLateDays = 0;
                        let summaryTotalLeave = 0;

                        try {
                            // First, get all employees based on filters
                            if (selectedBranch === "All") {
                                const branchesSnap = await db.ref("branches").once("value");
                                for (const branchKey in (branchesSnap.val() || {})) {
                                    const branchData = branchesSnap.val()[branchKey];
                                    for (const subKey in (branchData.subdivisions || {})) {
                                        if (selectedSubdivision === "All" || subKey === selectedSubdivision) {
                                            const employeesInSub = branchData.subdivisions[subKey].employees || {};
                                            for (const empId in employeesInSub) {
                                                allEmployees[empId] = { name: employeesInSub[empId].name, branch: branchKey, subdivision: subKey, isSpecial: false };
                                            }
                                        }
                                    }
                                }
                            } else {
                                const branchData = (await db.ref(`branches/${selectedBranch}`).once("value")).val() || {};
                                for (const subKey in (branchData.subdivisions || {})) {
                                    if (selectedSubdivision === "All" || subKey === selectedSubdivision) {
                                        const employeesInSub = branchData.subdivisions[subKey].employees || {};
                                        for (const empId in employeesInSub) {
                                            allEmployees[empId] = { name: employeesInSub[empId].name, branch: selectedBranch, subdivision: subKey, isSpecial: false };
                                        }
                                    }
                                }
                            }

                            // Add special employees if "All" branch/subdivision is selected or if no branch/subdivision is selected (meaning it's a global search)
                            if (selectedBranch === "All" || selectedSubdivision === "All") {
                                const specialEmployeesSnap = await db.ref("specialEmployees").once("value");
                                for (const empId in (specialEmployeesSnap.val() || {})) {
                                    allEmployees[empId] = { name: specialEmployeesSnap.val()[empId].name, branch: 'N/A', subdivision: 'Special', isSpecial: true };
                                }
                            }

                            for (let d = new Date(fromDate); d < toDate; d.setDate(d.getDate() + 1)) {
                                const currentDate = d.toISOString().split('T')[0]; //YYYY-MM-DD

                                for (const empId in allEmployees) {
                                    const empDetails = allEmployees[empId];
                                    let attendance = null;
                                    let leaveData = null;

                                    let attendancePath;
                                    if (empDetails.isSpecial) {
                                        attendancePath = `attendance/${currentDate}/${empId}`;
                                    } else {
                                        attendancePath = `attendance/${currentDate}/${empDetails.branch}/${empDetails.subdivision}/${empId}`;
                                    }

                                    const attendanceSnap = await db.ref(attendancePath).once('value');
                                    attendance = attendanceSnap.val();

                                    if (!attendance) {
                                        const leaveSnap = await db.ref(`leaves/${empId}/${currentDate}`).once('value');
                                        leaveData = leaveSnap.val();
                                    }

                                    if (attendance || leaveData) {
                                        let morningStatus = 'Absent';
                                        let afternoonStatus = 'None';
                                        let enterLeaveTime = '-';
                                        let overallStatus = 'Absent';
                                        let lateIndicator = '';

                                        if (attendance) {
                                            if (attendance.morning === true) {
                                                morningStatus = 'Present';
                                            }

                                            if (attendance.afternoon) {
                                                afternoonStatus = attendance.afternoon;
                                            }

                                            if (attendance.morningTime) {
                                                enterLeaveTime = `Enter: ${formatTime(attendance.morningTime)}`;
                                            }
                                            if (attendance.anTime) {
                                                enterLeaveTime += (enterLeaveTime !== '-' ? ' / ' : '') + `${attendance.afternoon === 'Enters' ? 'Enter' : 'Exit'}: ${formatTime(attendance.anTime)}`;
                                            }

                                            if (attendance.late) {
                                                lateIndicator = `(LATE: ${formatTime(attendance.lateTime)})`;
                                                summaryLateDays++;
                                            }

                                            // Determine overall status based on attendance
                                            if (morningStatus === 'Present' && afternoonStatus === 'None') {
                                                overallStatus = 'Full Day';
                                                summaryFullDays++;
                                            } else if (
                                                (morningStatus === 'Present' && (afternoonStatus === 'Leaves' || afternoonStatus === 'Enters')) ||
                                                (morningStatus === 'Absent' && afternoonStatus === 'Enters')
                                            ) {
                                                overallStatus = 'Half Day';
                                                summaryHalfDays++;
                                                summaryTotalLeave += 0.5;
                                            } else if (morningStatus === 'Absent' && afternoonStatus === 'None') {
                                                overallStatus = 'Absent';
                                                summaryAbsentDays++;
                                                summaryTotalLeave += 1;
                                            }

                                        } else if (leaveData) { // If no attendance but there is leave data
                                            if (leaveData.type === 'full') {
                                                overallStatus = 'Leave (Full Day)';
                                                summaryTotalLeave += 1;
                                            } else if (leaveData.type === 'half') {
                                                overallStatus = 'Leave (Half Day)';
                                                summaryTotalLeave += 0.5;
                                            }
                                            morningStatus = 'N/A';
                                            afternoonStatus = 'N/A';
                                            enterLeaveTime = '-';
                                            lateIndicator = '-';
                                        }

                                        fetchedRecords.push({
                                            date: currentDate,
                                            employeeName: empDetails.name || empId, // Fallback name
                                            branch: empDetails.branch,
                                            subdivision: empDetails.subdivision,
                                            morning: morningStatus,
                                            afternoon: afternoonStatus,
                                            enterLeaveTime: showTimes ? enterLeaveTime : '-',
                                            status: overallStatus,
                                            late: lateIndicator,
                                            isLate: !!lateIndicator // Boolean for conditional styling
                                        });
                                    }
                                }
                            }

                            // Sort records by date, then by employee name
                            fetchedRecords.sort((a, b) => {
                                const dateComparison = new Date(a.date) - new Date(b.date);
                                if (dateComparison !== 0) {
                                    return dateComparison;
                                }
                                return a.employeeName.localeCompare(b.employeeName);
                            });

                            currentEmployeeRecords = fetchedRecords; // Store for export

                            renderRecordsTable(fetchedRecords);

                            recordsFullDays.textContent = summaryFullDays;
                            recordsHalfDays.textContent = summaryHalfDays;
                            recordsAbsentDays.textContent = summaryAbsentDays;
                            recordsLateDays.textContent = summaryLateDays;
                            recordsTotalLeaveCountEl.textContent = `${summaryTotalLeave} Days`;
                            recordsSummary.classList.remove('hidden');

                        } catch (error) {
                            console.error("Error loading employee records:", error);
                            recordsTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500">Error loading records.</td></tr>';
                        }
                    });

                    function renderRecordsTable(records) {
                        const tableBody = document.getElementById("records-table-body");
                        tableBody.innerHTML = ''; // Clear previous records

                        if (records.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4">No attendance records found for the selected criteria.</td></tr>';
                            return;
                        }

                        records.forEach(record => {
                            const row = document.createElement("tr");
                            row.classList.add("border-b");

                            let morningStatusClass = '';
                            if (record.morning === 'Present') morningStatusClass = 'status-full';
                            else if (record.morning === 'Absent') morningStatusClass = 'status-absent';
                            else morningStatusClass = 'status-pending';

                            let afternoonStatusClass = '';
                            if (record.afternoon === 'Enters' || record.afternoon === 'Leaves') afternoonStatusClass = 'status-full';
                            else if (record.afternoon === 'None') afternoonStatusClass = 'status-absent';
                            else afternoonStatusClass = 'status-pending';

                            let overallStatusClass = '';
                            switch (record.status) {
                                case 'Full Day':
                                    overallStatusClass = 'status-full';
                                    break;
                                case 'Half Day':
                                case 'Leave (Half Day)':
                                    overallStatusClass = 'status-half';
                                    break;
                                case 'Absent':
                                case 'Leave (Full Day)':
                                    overallStatusClass = 'status-absent';
                                    break;
                                default:
                                    overallStatusClass = 'status-pending';
                            }

                            row.innerHTML = `
                                <td class="py-2 px-4">${new Date(record.date).toLocaleDateString("en-IN")}</td>
                                <td class="py-2 px-4">${record.employeeName}</td>
                                <td class="py-2 px-4">${record.branch}</td>
                                <td class="py-2 px-4">${record.subdivision}</td>
                                <td class="py-2 px-4">
                                    <span class="status-badge ${morningStatusClass}">
                                        ${record.morning}
                                    </span>
                                </td>
                                <td class="py-2 px-4">
                                    <span class="status-badge ${afternoonStatusClass}">
                                        ${record.afternoon}
                                    </span>
                                </td>
                                <td class="py-2 px-4">${record.enterLeaveTime}</td>
                                <td class="py-2 px-4">
                                    <span class="status-badge ${overallStatusClass}">
                                        ${record.status}
                                    </span>
                                </td>
                                <td class="py-2 px-4 ${record.isLate ? 'text-red-600 font-bold' : ''}">${record.late || '-'}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }

                    // --- Export to PDF (Employee Records) ---
                    document.getElementById("export-pdf").addEventListener("click", () => {
                        if (currentEmployeeRecords.length === 0) {
                            alert("No records to export. Please load records first.");
                            return;
                        }

                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();

                        doc.setFont('helvetica', 'normal'); // Set a common font
                        doc.setFontSize(14);
                        doc.text("Employee Attendance Records", 14, 15);
                        doc.setFontSize(10);
                        doc.text(`From: ${document.getElementById("record-from").value || 'N/A'} To: ${document.getElementById("record-to").value || 'N/A'}`, 14, 22);
                        doc.text(`Branch: ${recordBranchDropdown.value || 'All'} | Subdivision: ${recordSubdivisionDropdown.value || 'All'}`, 14, 27);

                        const pdfHeaders = [
                            "Date", "Employee", "Branch", "Subdivision", "Morning", "Afternoon", "Enter/Leave Time", "Status", "Late?"
                        ];

                        const pdfBody = currentEmployeeRecords.map(record => {
                            const rowData = [
                                new Date(record.date).toLocaleDateString("en-IN"),
                                record.employeeName,
                                record.branch,
                                record.subdivision,
                                record.morning,
                                record.afternoon,
                                record.enterLeaveTime,
                                record.status,
                                record.late || '-',
                            ];
                            return rowData;
                        });

                        doc.autoTable({
                            head: [pdfHeaders],
                            body: pdfBody,
                            startY: 35,
                            theme: "striped",
                            styles: {
                                fontSize: 8,
                                halign: "center",
                                cellWidth: "wrap",
                                font: 'helvetica',
                                textColor: [0, 0, 0] // Default text color
                            },
                            columnStyles: {
                                8: { // "Late?" column
                                    cellWidth: 15,
                                    fontStyle: 'bold',
                                    textColor: [255, 0, 0] // Red color for Late column
                                }
                            },
                            headStyles: {
                                fillColor: [0, 102, 204], // Blue background
                                textColor: 255, // White text
                                fontStyle: "bold",
                            },
                            alternateRowStyles: {
                                fillColor: [245, 245, 245], // Light grey for alternate rows
                            },
                            margin: { top: 30 }
                        });

                        const fullDays = recordsFullDays.textContent;
                        const halfDays = recordsHalfDays.textContent;
                        const absentDays = recordsAbsentDays.textContent;
                        const lateDays = recordsLateDays.textContent;
                        const totalLeave = recordsTotalLeaveCountEl.textContent;

                        let finalY = doc.autoTable.previous.finalY;
                        doc.setFontSize(10);
                        doc.text(`Summary:`, 14, finalY + 10);
                        doc.text(`Total Full Days: ${fullDays}`, 14, finalY + 15);
                        doc.text(`Total Half Days: ${halfDays}`, 14, finalY + 20);
                        doc.text(`Total Absent Days: ${absentDays}`, 14, finalY + 25);
                        doc.text(`Total Late Days: ${lateDays}`, 14, finalY + 30);
                        doc.text(`Total Leave Taken: ${totalLeave}`, 14, finalY + 35);


                        doc.save("Employee_Records_Report.pdf");
                    });

                    // --- Export to Excel (Employee Records) ---
                    document.getElementById("export-excel").addEventListener("click", () => {
                        if (currentEmployeeRecords.length === 0) {
                            alert("No records to export. Please load records first.");
                            return;
                        }

                        const ws_data = [
                            ["Employee Attendance Records"],
                            [`From: ${document.getElementById("record-from").value || 'N/A'} To: ${document.getElementById("record-to").value || 'N/A'}`],
                            [`Branch: ${recordBranchDropdown.value || 'All'} | Subdivision: ${recordSubdivisionDropdown.value || 'All'}`],
                            [], // Empty row for spacing
                            ["Date", "Employee", "Branch", "Subdivision", "Morning", "Afternoon", "Enter/Leave Time", "Status", "Late?"] // Headers
                        ];

                        currentEmployeeRecords.forEach(record => {
                            ws_data.push([
                                new Date(record.date).toLocaleDateString("en-IN"),
                                record.employeeName,
                                record.branch,
                                record.subdivision,
                                record.morning,
                                record.afternoon,
                                record.enterLeaveTime,
                                record.status,
                                record.late || '-',
                            ]);
                        });

                        const fullDays = recordsFullDays.textContent;
                        const halfDays = recordsHalfDays.textContent;
                        const absentDays = recordsAbsentDays.textContent;
                        const lateDays = recordsLateDays.textContent;
                        const totalLeave = recordsTotalLeaveCountEl.textContent;

                        ws_data.push([]);
                        ws_data.push(["Summary:"]);
                        ws_data.push([`Total Full Days: ${fullDays}`]);
                        ws_data.push([`Total Half Days: ${halfDays}`]);
                        ws_data.push([`Total Absent Days: ${absentDays}`]);
                        ws_data.push([`Total Late Days: ${lateDays}`]);
                        ws_data.push([`Total Leave Taken: ${totalLeave}`]);

                        const ws = XLSX.utils.aoa_to_sheet(ws_data);

                        // Set column widths (example, adjust as needed)
                        ws['!cols'] = [
                            { wch: 12 }, // Date
                            { wch: 20 }, // Employee
                            { wch: 15 }, // Branch
                            { wch: 15 }, // Subdivision
                            { wch: 10 }, // Morning
                            { wch: 10 }, // Afternoon
                            { wch: 20 }, // Enter/Leave Time
                            { wch: 15 }, // Status
                            { wch: 15 }  // Late?
                        ];

                        // Apply bold to headers
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cell = ws[XLSX.utils.encode_cell({ r: 4, c: C })]; // Assuming headers are on row 5 (index 4)
                            if (cell) {
                                cell.s = { font: { bold: true } };
                            }
                        }

                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "EmployeeRecords");
                        XLSX.writeFile(wb, "Employee_Records_Report.xlsx");
                    });


                    // --- Individual Records Tab Logic ---
                    const indivBranchDropdown = document.getElementById("indiv-branch");
                    const indivSubdivisionDropdown = document.getElementById("indiv-subdivision");
                    const indivEmployeeDropdown = document.getElementById("indiv-employee");
                    const indivFromDateInput = document.getElementById("indiv-from-date");
                    const indivToDateInput = document.getElementById("indiv-to-date");
                    const indivToggleTimesCheckbox = document.getElementById("indiv-toggle-times");
                    const loadIndividualBtn = document.getElementById("load-individual-btn");
                    const indivRecordsTableBody = document.getElementById("indiv-table-body");
                    const indivTimeCols = document.querySelectorAll(".indiv-time-col");
                    const indivSummary = document.getElementById("indiv-summary");
                    const indivFullDays = document.getElementById("indiv-full-days");
                    const indivHalfDays = document.getElementById("indiv-half-days");
                    const indivAbsentDays = document.getElementById("indiv-absent-days");
                    const indivLateDays = document.getElementById("indiv-late-days");
                    const indivTotalLeaveCountEl = document.getElementById("indiv-total-leave-count");
                    const loadingIndividualIndicator = document.getElementById("loading-individual");
                    const exportIndivPdfBtn = document.getElementById("export-indiv-pdf");
                    const exportIndivExcelBtn = document.getElementById("export-indiv-excel");

                    let currentIndividualRecords = []; // Store fetched data for export


                    // Populate Branch dropdown for Individual Records Tab
                    async function populateIndivBranches() {
                        indivBranchDropdown.innerHTML = `<option value="All">All Branches</option>`;
                        indivSubdivisionDropdown.innerHTML = `<option value="All">All Subdivisions</option>`;
                        indivEmployeeDropdown.innerHTML = `<option value="All">All Employees</option>`;

                        indivSubdivisionDropdown.disabled = true;
                        indivEmployeeDropdown.disabled = true;

                        try {
                            const snapshot = await db.ref("branches").once("value");
                            snapshot.forEach(branch => {
                                const option = document.createElement("option");
                                option.value = branch.key;
                                option.textContent = branch.key.charAt(0).toUpperCase() + branch.key.slice(1);
                                indivBranchDropdown.appendChild(option);
                            });
                            // If there are branches, enable subdivision and employee dropdowns to allow "All" selection
                            if (snapshot.exists()) {
                                indivSubdivisionDropdown.disabled = false;
                                indivEmployeeDropdown.disabled = false;
                                await populateIndivEmployees(true, true); // Populate all employees initially
                            }
                        } catch (error) {
                            console.error("Error populating individual branches:", error);
                        }
                    }

                    // Populate Subdivision dropdown based on Branch selection
                    indivBranchDropdown.addEventListener("change", async () => {
                        const selectedBranch = indivBranchDropdown.value;
                        indivSubdivisionDropdown.innerHTML = `<option value="All">All Subdivisions</option>`;
                        indivSubdivisionDropdown.disabled = true;
                        indivEmployeeDropdown.innerHTML = `<option value="All">All Employees</option>`;
                        indivEmployeeDropdown.disabled = true;

                        if (selectedBranch === "All") {
                            indivSubdivisionDropdown.disabled = false;
                            indivEmployeeDropdown.disabled = false;
                            await populateIndivEmployees(true, true); // All branches, all subdivisions
                        } else if (selectedBranch) {
                            try {
                                const snapshot = await db.ref(`branches/${selectedBranch}/subdivisions`).once("value");
                                if (snapshot.exists()) {
                                    snapshot.forEach(subdivision => {
                                        const option = document.createElement("option");
                                        option.value = subdivision.key;
                                        option.textContent = subdivision.key.charAt(0).toUpperCase() + subdivision.key.slice(1);
                                        indivSubdivisionDropdown.appendChild(option);
                                    });
                                    indivSubdivisionDropdown.disabled = false;
                                    indivEmployeeDropdown.disabled = false;
                                    await populateIndivEmployees(false, true); // Specific branch, all subdivisions
                                } else {
                                    indivSubdivisionDropdown.disabled = false;
                                    indivEmployeeDropdown.disabled = false;
                                    await populateIndivEmployees(false, true);
                                }
                            } catch (error) {
                                console.error("Error loading individual subdivisions:", error);
                            }
                        }
                    });

                    // Populate Employee dropdown based on Subdivision selection
                    indivSubdivisionDropdown.addEventListener("change", async () => {
                        const selectedBranch = indivBranchDropdown.value;
                        const selectedSubdivision = indivSubdivisionDropdown.value;
                        indivEmployeeDropdown.innerHTML = `<option value="All">All Employees</option>`;
                        indivEmployeeDropdown.disabled = true;

                        if (selectedBranch === "All" && selectedSubdivision === "All") {
                            indivEmployeeDropdown.disabled = false;
                            await populateIndivEmployees(true, true); // All branches, all subdivisions
                        } else if (selectedBranch !== "All" && selectedSubdivision === "All") {
                            indivEmployeeDropdown.disabled = false;
                            await populateIndivEmployees(false, true); // Specific branch, all subdivisions
                        } else if (selectedBranch && selectedSubdivision && selectedSubdivision !== "All") {
                            try {
                                const snapshot = await db.ref(`branches/${selectedBranch}/subdivisions/${selectedSubdivision}/employees`).once("value");
                                if (snapshot.exists()) {
                                    snapshot.forEach(employee => {
                                        const option = document.createElement("option");
                                        option.value = employee.key;
                                        option.textContent = employee.val().name;
                                        indivEmployeeDropdown.appendChild(option);
                                    });
                                }
                                indivEmployeeDropdown.disabled = false;
                            } catch (error) {
                                console.error("Error populating individual employees:", error);
                            }
                        }
                    });

                    // Helper to populate employee dropdown based on branch/subdivision selection (including special employees)
                    async function populateIndivEmployees(allBranches, allSubdivisions) {
                        indivEmployeeDropdown.innerHTML = '<option value="All">All Employees</option>';
                        const employeesMap = new Map(); // Use a Map to store unique employees

                        try {
                            // Fetch regular employees
                            let branchesRef = db.ref("branches");
                            if (!allBranches && indivBranchDropdown.value !== "All") {
                                branchesRef = db.ref(`branches/${indivBranchDropdown.value}`);
                            }

                            const branchesSnap = await branchesRef.once("value");
                            branchesSnap.forEach(branchSnap => {
                                const branchKey = branchSnap.key;
                                const branchData = branchSnap.val();
                                const subdivisions = branchData.subdivisions || {};

                                for (const subKey in subdivisions) {
                                    if (allSubdivisions || indivSubdivisionDropdown.value === "All" || subKey === indivSubdivisionDropdown.value) {
                                        const employees = subdivisions[subKey].employees || {};
                                        for (const empId in employees) {
                                            if (!employeesMap.has(empId)) {
                                                employeesMap.set(empId, { id: empId, name: employees[empId].name, branch: branchKey, subdivision: subKey, isSpecial: false });
                                            }
                                        }
                                    }
                                }
                            });

                            // Fetch special employees
                            const specialEmployeesSnap = await db.ref("specialEmployees").once("value");
                            specialEmployeesSnap.forEach(specialEmp => {
                                if (!employeesMap.has(specialEmp.key)) {
                                    employeesMap.set(specialEmp.key, { id: specialEmp.key, name: specialEmp.val().name, branch: 'N/A', subdivision: 'Special', isSpecial: true });
                                }
                            });

                            // Add employees to dropdown
                            Array.from(employeesMap.values()).sort((a, b) => a.name.localeCompare(b.name)).forEach(emp => {
                                const option = document.createElement("option");
                                option.value = emp.id;
                                option.textContent = emp.name;
                                indivEmployeeDropdown.appendChild(option);
                            });
                            indivEmployeeDropdown.disabled = false;

                        } catch (error) {
                            console.error("Error populating employees for individual tab:", error);
                        }
                    }

                    // Initial population on page load
                    populateIndivBranches();

                    // Event listener for toggling timesheet visibility
                    indivToggleTimesCheckbox.addEventListener("change", () => {
                        indivTimeCols.forEach(col => {
                            col.classList.toggle('hidden', !indivToggleTimesCheckbox.checked);
                        });
                        // Re-render the table to apply visibility changes to rows
                        renderIndividualTable(currentIndividualRecords, indivToggleTimesCheckbox.checked);
                    });

                    // Load Individual Records Button Click
                    loadIndividualBtn.addEventListener("click", async () => {
                        const selectedBranch = indivBranchDropdown.value;
                        const selectedSubdivision = indivSubdivisionDropdown.value;
                        const selectedEmployeeId = indivEmployeeDropdown.value;
                        const fromDateStr = indivFromDateInput.value;
                        const toDateStr = indivToDateInput.value;
                        const showTimes = indivToggleTimesCheckbox.checked;

                        indivRecordsTableBody.innerHTML = ''; // Clear table body
                        indivSummary.classList.add('hidden'); // Hide summary
                        loadingIndividualIndicator.classList.remove('hidden'); // Show loading

                        // Reset summary counts
                        indivFullDays.textContent = '0';
                        indivHalfDays.textContent = '0';
                        indivAbsentDays.textContent = '0';
                        indivLateDays.textContent = '0';
                        indivTotalLeaveCountEl.textContent = '0 Days';
                        currentIndividualRecords = []; // Clear data for export

                        if (!fromDateStr || !toDateStr) {
                            alert("Please select both 'From' and 'To' dates.");
                            loadingIndividualIndicator.classList.add('hidden');
                            return;
                        }

                        const fromDate = new Date(fromDateStr);
                        const toDate = new Date(toDateStr);
                        toDate.setDate(toDate.getDate() + 1); // Include the end date

                        if (fromDate > toDate) {
                            alert("From date cannot be after To date.");
                            loadingIndividualIndicator.classList.add('hidden');
                            return;
                        }

                        try {
                            let employeesToFetch = new Map(); // Map to store { empId: { name, branch, subdivision, isSpecial } }

                            if (selectedEmployeeId === "All") {
                                // Fetch all employees based on branch/subdivision filters
                                let branchesSnapshot;
                                if (selectedBranch === "All") {
                                    branchesSnapshot = await db.ref("branches").once("value");
                                } else {
                                    branchesSnapshot = await db.ref(`branches/${selectedBranch}`).once("value");
                                }

                                branchesSnapshot.forEach(branchSnap => {
                                    const branchKey = branchSnap.key;
                                    const branchData = branchSnap.val() || {};
                                    const subdivisions = branchData.subdivisions || {};

                                    for (const subKey in subdivisions) {
                                        if (selectedSubdivision === "All" || subKey === selectedSubdivision) {
                                            const employees = subdivisions[subKey].employees || {};
                                            for (const empId in employees) {
                                                employeesToFetch.set(empId, { name: employees[empId].name, branch: branchKey, subdivision: subKey, isSpecial: false });
                                            }
                                        }
                                    }
                                });

                                // Add special employees if "All" branch/subdivision is selected
                                if (selectedBranch === "All" || selectedSubdivision === "All") {
                                    const specialEmployeesSnap = await db.ref("specialEmployees").once("value");
                                    specialEmployeesSnap.forEach(specialEmp => {
                                        employeesToFetch.set(specialEmp.key, { name: specialEmp.val().name, branch: 'N/A', subdivision: 'Special', isSpecial: true });
                                    });
                                }

                            } else {
                                // Specific employee selected
                                const employeeData = await getEmployeeDetails(selectedEmployeeId, selectedBranch, selectedSubdivision);
                                if (!employeeData) {
                                    indivRecordsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Employee data not found.</td></tr>';
                                    loadingIndividualIndicator.classList.add('hidden');
                                    return;
                                }
                                employeesToFetch.set(selectedEmployeeId, employeeData);
                            }

                            if (employeesToFetch.size === 0) {
                                indivRecordsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No employees found for the selected filters.</td></tr>';
                                loadingIndividualIndicator.classList.add('hidden');
                                return;
                            }

                            const recordsToDisplay = [];
                            let summaryFullDays = 0;
                            let summaryHalfDays = 0;
                            let summaryAbsentDays = 0;
                            let summaryLateDays = 0;
                            let summaryTotalLeave = 0;

                            for (let d = new Date(fromDate); d < toDate; d.setDate(d.getDate() + 1)) {
                                const currentDate = d.toISOString().split('T')[0]; //YYYY-MM-DD

                                for (const [empId, empDetails] of employeesToFetch.entries()) {
                                    let attendance = null;
                                    let leaveData = null;

                                    let attendancePath;
                                    if (empDetails.isSpecial) {
                                        attendancePath = `attendance/${currentDate}/${empId}`;
                                    } else {
                                        attendancePath = `attendance/${currentDate}/${empDetails.branch}/${empDetails.subdivision}/${empId}`;
                                    }

                                    const attendanceSnap = await db.ref(attendancePath).once('value');
                                    attendance = attendanceSnap.val();

                                    if (!attendance) {
                                        const leaveSnap = await db.ref(`leaves/${empId}/${currentDate}`).once('value');
                                        leaveData = leaveSnap.val();
                                    }

                                    if (attendance || leaveData) { // Only process if there's an entry (attendance or leave)
                                        let morningStatus = '‚ùå';
                                        let morningTime = '-';
                                        let afternoonStatus = 'None';
                                        let afternoonTime = '-';
                                        let overallStatus = 'Absent'; // Default, will be updated
                                        let lateIndicator = '';

                                        if (attendance) {
                                            if (attendance.morning === true) {
                                                morningStatus = '‚úÖ';
                                                morningTime = formatTime(attendance.morningTime);
                                            }

                                            if (attendance.afternoon) {
                                                afternoonStatus = attendance.afternoon;
                                                afternoonTime = formatTime(attendance.anTime);
                                            }

                                            if (attendance.late) {
                                                lateIndicator = `(LATE: ${formatTime(attendance.lateTime)})`;
                                                summaryLateDays++;
                                            }

                                            // Determine overall status based on attendance
                                            if (morningStatus === '‚úÖ' && afternoonStatus === 'None') {
                                                overallStatus = 'Full Day';
                                                summaryFullDays++;
                                            } else if (
                                                (morningStatus === '‚úÖ' && (afternoonStatus === 'Leaves' || afternoonStatus === 'Enters')) ||
                                                (morningStatus === '‚ùå' && afternoonStatus === 'Enters')
                                            ) {
                                                overallStatus = 'Half Day';
                                                summaryHalfDays++;
                                                summaryTotalLeave += 0.5;
                                            } else if (morningStatus === '‚ùå' && afternoonStatus === 'None') {
                                                overallStatus = 'Absent';
                                                summaryAbsentDays++;
                                                summaryTotalLeave += 1;
                                            }

                                        } else if (leaveData) { // If no attendance but there is leave data
                                            if (leaveData.type === 'full') {
                                                overallStatus = 'Leave (Full Day)';
                                                summaryTotalLeave += 1;
                                            } else if (leaveData.type === 'half') {
                                                overallStatus = 'Leave (Half Day)';
                                                summaryTotalLeave += 0.5;
                                            }
                                            // For leave days, morning and afternoon status are N/A
                                            morningStatus = 'N/A';
                                            morningTime = '-';
                                            afternoonStatus = 'N/A';
                                            afternoonTime = '-';
                                            lateIndicator = '-'; // No late for leave days
                                        }

                                        recordsToDisplay.push({
                                            date: currentDate,
                                            employeeName: empDetails.name,
                                            morningStatus: morningStatus,
                                            morningTime: morningTime,
                                            afternoonStatus: afternoonStatus,
                                            afternoonTime: afternoonTime,
                                            overallStatus: overallStatus,
                                            lateIndicator: lateIndicator,
                                            branch: empDetails.branch,
                                            subdivision: empDetails.subdivision,
                                            employeeId: empId
                                        });
                                    }
                                }
                            }

                            recordsToDisplay.sort((a, b) => {
                                // Sort by employee name, then by date
                                if (a.employeeName !== b.employeeName) {
                                    return a.employeeName.localeCompare(b.employeeName);
                                }
                                return new Date(a.date) - new Date(b.date);
                            });

                            currentIndividualRecords = recordsToDisplay; // Store for export

                            renderIndividualTable(recordsToDisplay, showTimes);

                            indivFullDays.textContent = summaryFullDays;
                            indivHalfDays.textContent = summaryHalfDays;
                            indivAbsentDays.textContent = summaryAbsentDays;
                            indivLateDays.textContent = summaryLateDays;
                            indivTotalLeaveCountEl.textContent = `${summaryTotalLeave} Days`;
                            indivSummary.classList.remove('hidden');

                        } catch (error) {
                            console.error("Error loading individual records:", error);
                            indivRecordsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error loading records.</td></tr>';
                        } finally {
                            loadingIndividualIndicator.classList.add('hidden');
                        }
                    });

                    // Helper function to render the individual records table
                    function renderIndividualTable(records, showTimes) {
                        indivRecordsTableBody.innerHTML = '';

                        // Show/hide time columns based on checkbox
                        indivTimeCols.forEach(col => {
                            col.classList.toggle('hidden', !showTimes);
                        });

                        if (records.length === 0) {
                            indivRecordsTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No attendance records found for the selected criteria.</td></tr>';
                            return;
                        }

                        records.forEach(record => {
                            const row = document.createElement("tr");
                            row.classList.add("border-b");

                            let morningStatusClass = record.morningStatus === '‚úÖ' ? 'status-full' : (record.morningStatus === 'N/A' ? 'status-pending' : 'status-absent');
                            let afternoonStatusClass = 'status-pending';
                            if (record.afternoonStatus === 'Enters' || record.afternoonStatus === 'Leaves') {
                                afternoonStatusClass = 'status-full';
                            } else if (record.afternoonStatus === 'None') {
                                afternoonStatusClass = 'status-absent';
                            } else if (record.afternoonStatus === 'N/A') {
                                afternoonStatusClass = 'status-pending';
                            }

                            let overallStatusClass = '';
                            switch (record.overallStatus) {
                                case 'Full Day':
                                    overallStatusClass = 'status-full';
                                    break;
                                case 'Half Day':
                                case 'Leave (Half Day)':
                                    overallStatusClass = 'status-half';
                                    break;
                                case 'Absent':
                                case 'Leave (Full Day)':
                                    overallStatusClass = 'status-absent';
                                    break;
                                default:
                                    overallStatusClass = 'status-pending';
                            }

                            row.innerHTML = `
                                <td class="py-2 px-4">${new Date(record.date).toLocaleDateString("en-CA")}</td>
                                <td class="py-2 px-4">
                                    <span class="status-badge ${morningStatusClass}">
                                        ${record.morningStatus === '‚úÖ' ? 'Present' : (record.morningStatus === 'N/A' ? 'N/A' : 'Absent')}
                                    </span>
                                </td>
                                <td class="py-2 px-4 ${showTimes ? '' : 'hidden'}">${record.morningTime}</td>
                                <td class="py-2 px-4">
                                    <span class="status-badge ${afternoonStatusClass}">
                                        ${record.afternoonStatus}
                                    </span>
                                </td>
                                <td class="py-2 px-4 ${showTimes ? '' : 'hidden'}">${record.afternoonTime}</td>
                                <td class="py-2 px-4">
                                    <span class="status-badge ${overallStatusClass}">
                                        ${record.overallStatus}
                                    </span>
                                </td>
                                <td class="py-2 px-4 ${record.lateIndicator ? 'text-red-600 font-bold' : ''}">${record.lateIndicator || '-'}</td>
                            `;
                            indivRecordsTableBody.appendChild(row);
                        });
                    }


                    // --- Export to PDF (Individual Records) ---
                    exportIndivPdfBtn.addEventListener("click", () => {
                        if (currentIndividualRecords.length === 0) {
                            alert("No records to export. Please load records first.");
                            return;
                        }

                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();

                        const employeeName = indivEmployeeDropdown.options[indivEmployeeDropdown.selectedIndex].text;
                        const fromDate = indivFromDateInput.value;
                        const toDate = indivToDateInput.value;
                        const showTimes = indivToggleTimesCheckbox.checked;

                        doc.text(`Individual Attendance Records for ${employeeName}`, 14, 15);
                        doc.text(`From: ${fromDate} To: ${toDate}`, 14, 22);

                        const pdfHeaders = [
                            "Date",
                            "Morning",
                        ];
                        if (showTimes) {
                            pdfHeaders.push("Morning Time");
                        }
                        pdfHeaders.push("Afternoon");
                        if (showTimes) {
                            pdfHeaders.push("Afternoon Time");
                        }
                        pdfHeaders.push("Status", "Late?");

                        const pdfBody = [];
                        currentIndividualRecords.forEach(record => {
                            const rowData = [
                                new Date(record.date).toLocaleDateString("en-CA"),
                                record.morningStatus === '‚úÖ' ? 'Present' : (record.morningStatus === 'N/A' ? 'N/A' : 'Absent'),
                            ];
                            if (showTimes) {
                                rowData.push(record.morningTime);
                            }
                            rowData.push(record.afternoonStatus);
                            if (showTimes) {
                                rowData.push(record.afternoonTime);
                            }
                            rowData.push(record.overallStatus);
                            rowData.push(record.lateIndicator || '-');
                            pdfBody.push(rowData);
                        });

                        doc.autoTable({
                            head: [pdfHeaders],
                            body: pdfBody,
                            startY: 30,
                            theme: "striped",
                            styles: {
                                fontSize: 8,
                                halign: "center",
                                cellWidth: "wrap"
                            },
                            headStyles: {
                                fillColor: [0, 102, 204],
                                textColor: 255,
                                fontStyle: "bold",
                            },
                            alternateRowStyles: {
                                fillColor: [245, 245, 245],
                            },
                            columnStyles: {
                                'Late?': {
                                    textColor: [255, 0, 0], // Red color for Late column
                                }
                            },
                            margin: { top: 28 }
                        });

                        const fullDays = indivFullDays.textContent;
                        const halfDays = indivHalfDays.textContent;
                        const absentDays = indivAbsentDays.textContent;
                        const lateDays = indivLateDays.textContent;
                        const totalLeave = indivTotalLeaveCountEl.textContent;

                        let finalY = doc.autoTable.previous.finalY;
                        doc.setFontSize(10);
                        doc.text(`Summary:`, 14, finalY + 10);
                        doc.text(`Total Full Days: ${fullDays}`, 14, finalY + 15);
                        doc.text(`Total Half Days: ${halfDays}`, 14, finalY + 20);
                        doc.text(`Total Absent Days: ${absentDays}`, 14, finalY + 25);
                        doc.text(`Total Late Days: ${lateDays}`, 14, finalY + 30);
                        doc.text(`Total Leave Taken: ${totalLeave}`, 14, finalY + 35);


                        doc.save(`Individual_Records_${employeeName}.pdf`);
                    });

                    // --- Export to Excel (Individual Records) ---
                    exportIndivExcelBtn.addEventListener("click", () => {
                        if (currentIndividualRecords.length === 0) {
                            alert("No records to export. Please load records first.");
                            return;
                        }

                        const employeeName = indivEmployeeDropdown.options[indivEmployeeDropdown.selectedIndex].text;
                        const fromDate = indivFromDateInput.value;
                        const toDate = indivToDateInput.value;
                        const showTimes = indivToggleTimesCheckbox.checked;

                        const ws_data = [
                            [`Individual Attendance Records for ${employeeName}`],
                            [`From: ${fromDate} To: ${toDate}`],
                            [],
                        ];

                        const headers = [
                            "Date",
                            "Morning",
                        ];
                        if (showTimes) {
                            headers.push("Morning Time");
                        }
                        headers.push("Afternoon");
                        if (showTimes) {
                            headers.push("Afternoon Time");
                        }
                        headers.push("Status", "Late?");

                        ws_data.push(headers);

                        currentIndividualRecords.forEach(record => {
                            const rowData = [
                                new Date(record.date).toLocaleDateString("en-CA"),
                                record.morningStatus === '‚úÖ' ? 'Present' : (record.morningStatus === 'N/A' ? 'N/A' : 'Absent'),
                            ];
                            if (showTimes) {
                                rowData.push(record.morningTime);
                            }
                            rowData.push(record.afternoonStatus);
                            if (showTimes) {
                                rowData.push(record.afternoonTime);
                            }
                            rowData.push(record.overallStatus);
                            rowData.push(record.lateIndicator || '-');
                            ws_data.push(rowData);
                        });

                        const fullDays = indivFullDays.textContent;
                        const halfDays = indivHalfDays.textContent;
                        const absentDays = indivAbsentDays.textContent;
                        const lateDays = indivLateDays.textContent;
                        const totalLeave = indivTotalLeaveCountEl.textContent;

                        ws_data.push([]);
                        ws_data.push(["Summary:"]);
                        ws_data.push([`Total Full Days: ${fullDays}`]);
                        ws_data.push([`Total Half Days: ${halfDays}`]);
                        ws_data.push([`Total Absent Days: ${absentDays}`]);
                        ws_data.push([`Total Late Days: ${lateDays}`]);
                        ws_data.push([`Total Leave Taken: ${totalLeave}`]);


                        const ws = XLSX.utils.aoa_to_sheet(ws_data);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "IndividualRecords");
                        XLSX.writeFile(wb, `Individual_Records_${employeeName}.xlsx`);
                    });


                    // --- Dropdowns for Edit Employee Tab ---
                    const addEmployeeBranchDropdown = document.getElementById("add-employee-branch");
                    const addEmployeeSubdivisionDropdown = document.getElementById("add-employee-subdivision");
                    const addSpecialEmployeeCheckbox = document.getElementById("add-special-employee");
                    const addBranchSubContainer = document.getElementById("add-branch-sub-container");

                    const editEmployeeBranchDropdown = document.getElementById("edit-employee-branch");
                    const editEmployeeSubdivisionDropdown = document.getElementById("edit-employee-subdivision");
                    const editEmployeeSelect = document.getElementById("edit-employee-select");
                    const editSpecialEmployeeCheckbox = document.getElementById("edit-special-employee");
                    const editBranchSubContainer = document.getElementById("edit-branch-sub-container");


                    const removeEmployeeBranchDropdown = document.getElementById("remove-employee-branch");
                    const removeEmployeeSubdivisionDropdown = document.getElementById("remove-employee-subdivision");
                    const removeEmployeeSelect = document.getElementById("remove-employee-select");
                    const removeSpecialEmployeeCheckbox = document.getElementById("remove-special-employee");
                    const removeBranchSubContainer = document.getElementById("remove-branch-sub-container");


                    // Function to populate branch dropdowns
                    const populateBranchDropdowns = (branchDropdown) => {
                        db.ref("branches").once("value")
                            .then(snap => {
                                const branchesObj = snap.val() || {};
                                branchDropdown.innerHTML = `<option value="">Select Branch</option>`;
                                Object.keys(branchesObj).forEach(branchKey => {
                                    const label = branchKey.charAt(0).toUpperCase() + branchKey.slice(1);
                                    branchDropdown.innerHTML += `<option value="${branchKey}">${label}</option>`;
                                });
                            })
                            .catch(err => console.error("Error loading branches:", err));
                    };

                    // Function to populate subdivision dropdowns
                    const populateSubdivisionDropdown = (branchDropdown, subdivisionDropdown) => {
                        const selBranch = branchDropdown.value;
                        subdivisionDropdown.innerHTML = `<option value="">Select Subdivision</option>`;
                        subdivisionDropdown.disabled = true;
                        if (!selBranch) {
                            return;
                        }
                        db.ref(`branches/${selBranch}/subdivisions`).once("value")
                            .then(snap => {
                                const subsObj = snap.val() || {};
                                Object.keys(subsObj).forEach(subKey => {
                                    const label = subKey.charAt(0).toUpperCase() + subKey.slice(1);
                                    subdivisionDropdown.innerHTML += `<option value="${subKey}">${label}</option>`;
                                });
                                subdivisionDropdown.disabled = false;
                            })
                            .catch(err => console.error("Error loading subdivisions:", err));
                    };

                    // Function to populate employee dropdowns
                    const populateEmployeeDropdown = async (branchDropdown, subdivisionDropdown, employeeDropdown) => {
                        const selBranch = branchDropdown.value;
                        const selSubdivision = subdivisionDropdown.value;
                        employeeDropdown.innerHTML = `<option value="">Select Employee</option>`;
                        employeeDropdown.disabled = true;

                        if (!selBranch || !selSubdivision) {
                            return;
                        }

                        try {
                            const employeesSnap = await db.ref(`branches/${selBranch}/subdivisions/${selSubdivision}/employees`).once('value');
                            const employeesObj = employeesSnap.val() || {};
                            Object.entries(employeesObj).forEach(([empId, empData]) => {
                                employeeDropdown.innerHTML += `<option value="${empId}">${empData.name}</option>`;
                            });
                            employeeDropdown.disabled = false;
                        } catch (err) {
                            console.error("Error loading employees:", err);
                        }
                    };

                    // Initial population for Add Employee
                    populateBranchDropdowns(addEmployeeBranchDropdown);
                    addEmployeeBranchDropdown.addEventListener("change", () => populateSubdivisionDropdown(addEmployeeBranchDropdown, addEmployeeSubdivisionDropdown));

                    // Initial population for Edit Employee
                    populateBranchDropdowns(editEmployeeBranchDropdown);
                    editEmployeeBranchDropdown.addEventListener("change", () => {
                        populateSubdivisionDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown);
                        editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`; // Clear employee dropdown
                        editEmployeeSelect.disabled = true;
                    });
                    editEmployeeSubdivisionDropdown.addEventListener("change", () => populateEmployeeDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown, editEmployeeSelect));

                    // Initial population for Remove Employee
                    populateBranchDropdowns(removeEmployeeBranchDropdown);
                    removeEmployeeBranchDropdown.addEventListener("change", () => {
                        populateSubdivisionDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown);
                        removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`; // Clear employee dropdown
                        removeEmployeeSelect.disabled = true;
                    });
                    removeEmployeeSubdivisionDropdown.addEventListener("change", () => populateEmployeeDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown, removeEmployeeSelect));


                    // Handle "Special Employee" checkbox for Add
                    addSpecialEmployeeCheckbox.addEventListener('change', () => {
                        if (addSpecialEmployeeCheckbox.checked) {
                            addBranchSubContainer.classList.add('hidden');
                            addEmployeeBranchDropdown.value = "";
                            addEmployeeSubdivisionDropdown.value = "";
                            addEmployeeSubdivisionDropdown.disabled = true;
                        } else {
                            addBranchSubContainer.classList.remove('hidden');
                        }
                    });

                    // Handle "Special Employee" checkbox for Edit
                    editSpecialEmployeeCheckbox.addEventListener('change', () => {
                        if (editSpecialEmployeeCheckbox.checked) {
                            editBranchSubContainer.classList.add('hidden');
                            editEmployeeBranchDropdown.value = "";
                            editEmployeeSubdivisionDropdown.value = "";
                            editEmployeeSubdivisionDropdown.disabled = true;
                            editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                            editEmployeeSelect.disabled = false; // Enable for special employees
                            populateSpecialEmployees(editEmployeeSelect);
                        } else {
                            editBranchSubContainer.classList.remove('hidden');
                            editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                            editEmployeeSelect.disabled = true;
                            // Re-populate normal employees if branch/subdivision are selected
                            if (editEmployeeBranchDropdown.value && editEmployeeSubdivisionDropdown.value) {
                                populateEmployeeDropdown(editEmployeeBranchDropdown, editEmployeeSubdivisionDropdown, editEmployeeSelect);
                            }
                        }
                    });

                    // Handle "Special Employee" checkbox for Remove
                    removeSpecialEmployeeCheckbox.addEventListener('change', () => {
                        if (removeSpecialEmployeeCheckbox.checked) {
                            removeBranchSubContainer.classList.add('hidden');
                            removeEmployeeBranchDropdown.value = "";
                            removeEmployeeSubdivisionDropdown.value = "";
                            removeEmployeeSubdivisionDropdown.disabled = true;
                            removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                            removeEmployeeSelect.disabled = false; // Enable for special employees
                            populateSpecialEmployees(removeEmployeeSelect);
                        } else {
                            removeBranchSubContainer.classList.remove('hidden');
                            removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                            removeEmployeeSelect.disabled = true;
                            // Re-populate normal employees if branch/subdivision are selected
                            if (removeEmployeeBranchDropdown.value && removeEmployeeSubdivisionDropdown.value) {
                                populateEmployeeDropdown(removeEmployeeBranchDropdown, removeEmployeeSubdivisionDropdown, removeEmployeeSelect);
                            }
                        }
                    });


                    // Function to populate special employees dropdown
                    const populateSpecialEmployees = (employeeDropdown) => {
                        db.ref("specialEmployees").once("value")
                            .then(snap => {
                                const specialEmployeesObj = snap.val() || {};
                                employeeDropdown.innerHTML = `<option value="">Select Special Employee</option>`;
                                Object.entries(specialEmployeesObj).forEach(([empId, empData]) => {
                                    employeeDropdown.innerHTML += `<option value="${empId}">${empData.name}</option>`;
                                });
                            })
                            .catch(err => console.error("Error loading special employees:", err));
                    };

                    // Populate employee details when selected for editing
                    editEmployeeSelect.addEventListener("change", async () => {
                        const employeeId = editEmployeeSelect.value;
                        if (!employeeId) {
                            document.getElementById("edit-employee-name").value = "";
                            document.getElementById("edit-employee-phone").value = "";
                            document.getElementById("edit-employee-email").value = "";
                            return;
                        }

                        try {
                            let employeeData = null;
                            if (editSpecialEmployeeCheckbox.checked) {
                                const snap = await db.ref(`specialEmployees/${employeeId}`).once('value');
                                employeeData = snap.val();
                            } else {
                                const branch = editEmployeeBranchDropdown.value;
                                const subdivision = editEmployeeSubdivisionDropdown.value;
                                if (branch && subdivision) {
                                    const snap = await db.ref(`branches/${branch}/subdivisions/${subdivision}/employees/${employeeId}`).once('value');
                                    employeeData = snap.val();
                                }
                            }

                            if (employeeData) {
                                document.getElementById("edit-employee-name").value = employeeData.name || "";
                                document.getElementById("edit-employee-phone").value = employeeData.phone || "";
                                document.getElementById("edit-employee-email").value = employeeData.email || "";
                            } else {
                                console.warn("Employee data not found for ID:", employeeId);
                                document.getElementById("edit-employee-name").value = "";
                                document.getElementById("edit-employee-phone").value = "";
                                document.getElementById("edit-employee-email").value = "";
                            }
                        } catch (error) {
                            console.error("Error fetching employee details for edit:", error);
                        }
                    });


                    // --- Add Employee Logic ---
                    document.getElementById("add-employee-btn").addEventListener("click", () => {
                        const name = document.getElementById("add-employee-name").value.trim();
                        const phone = document.getElementById("add-employee-phone").value.trim();
                        const email = document.getElementById("add-employee-email").value.trim();
                        const isSpecial = addSpecialEmployeeCheckbox.checked;
                        const branch = addEmployeeBranchDropdown.value;
                        const subdivision = addEmployeeSubdivisionDropdown.value;

                        if (!name || !phone || !email) {
                            alert("Please fill in all employee details (Name, Phone, Email).");
                            return;
                        }

                        if (!isSpecial && (!branch || !subdivision)) {
                            alert("Please select Branch and Subdivision for regular employees.");
                            return;
                        }

                        showModal(`Are you sure you want to add employee "${name}"?`, async (confirm) => {
                            if (confirm) {
                                try {
                                    const empId = name.trim().toLowerCase().replace(/\s+/g, ''); // Generate empId from the name, remove spaces
                                    let baseRef;

                                    if (isSpecial) {
                                        baseRef = db.ref("specialEmployees");
                                    } else {
                                        baseRef = db.ref(`branches/${branch}/subdivisions/${subdivision}/employees`);
                                    }

                                    // Check if the generated empId already exists
                                    const existingEmployeeSnap = await baseRef.child(empId).get();
                                    if (existingEmployeeSnap.exists()) {
                                        alert(`Employee ID "${empId}" already exists. Please use a different name or modify the existing employee.`);
                                        return; // Cancel creation
                                    }

                                    // Store the id field explicitly inside the object
                                    await baseRef.child(empId).set({ id: empId, name, phone, email, isSpecial: isSpecial || null });

                                    alert(`Employee "${name}" added successfully with ID: ${empId}!`);

                                    // Clear form
                                    document.getElementById("add-employee-name").value = "";
                                    document.getElementById("add-employee-phone").value = "";
                                    document.getElementById("add-employee-email").value = "";
                                    addSpecialEmployeeCheckbox.checked = false;
                                    addBranchSubContainer.classList.remove('hidden');
                                    addEmployeeBranchDropdown.value = "";
                                    addEmployeeSubdivisionDropdown.value = "";
                                    addEmployeeSubdivisionDropdown.disabled = true;

                                    // Re-populate dropdowns (for edit/remove tabs to reflect new employee)
                                    populateBranchDropdowns(editEmployeeBranchDropdown);
                                    populateBranchDropdowns(removeEmployeeBranchDropdown);
                                } catch (error) {
                                    console.error("Error adding employee:", error);
                                    alert("Failed to add employee: " + error.message);
                                }
                            }
                        });
                    });

                    // --- Save Employee Changes Logic ---
                    document.getElementById("save-employee-btn").addEventListener("click", () => {
                        const employeeId = editEmployeeSelect.value;
                        const name = document.getElementById("edit-employee-name").value.trim();
                        const phone = document.getElementById("edit-employee-phone").value.trim();
                        const email = document.getElementById("edit-employee-email").value.trim();
                        const isSpecial = editSpecialEmployeeCheckbox.checked;
                        const branch = editEmployeeBranchDropdown.value;
                        const subdivision = editEmployeeSubdivisionDropdown.value;

                        if (!employeeId) {
                            alert("Please select an employee to edit.");
                            return;
                        }

                        if (!name || !phone || !email) {
                            alert("Please fill in all employee details (Name, Phone, Email).");
                            return;
                        }

                        if (!isSpecial && (!branch || !subdivision)) {
                            alert("Please select Branch and Subdivision for regular employees.");
                            return;
                        }

                        showModal(`Are you sure you want to save changes for employee "${name}"?`, async (confirm) => {
                            if (confirm) {
                                try {
                                    let employeeRef;
                                    if (isSpecial) {
                                        employeeRef = db.ref(`specialEmployees/${employeeId}`);
                                    } else {
                                        employeeRef = db.ref(`branches/${branch}/subdivisions/${subdivision}/employees/${employeeId}`);
                                    }

                                    await employeeRef.update({ name, phone, email, isSpecial: isSpecial || null });
                                    alert(`Changes saved for employee "${name}" successfully!`);

                                    // Clear form and reset dropdowns
                                    document.getElementById("edit-employee-name").value = "";
                                    document.getElementById("edit-employee-phone").value = "";
                                    document.getElementById("edit-employee-email").value = "";
                                    editEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                                    editEmployeeSelect.disabled = true;
                                    editSpecialEmployeeCheckbox.checked = false;
                                    editBranchSubContainer.classList.remove('hidden');
                                    editEmployeeBranchDropdown.value = "";
                                    editEmployeeSubdivisionDropdown.value = "";
                                    editEmployeeSubdivisionDropdown.disabled = true;

                                    // Re-populate dropdowns
                                    populateBranchDropdowns(editEmployeeBranchDropdown);
                                    populateBranchDropdowns(removeEmployeeBranchDropdown);
                                } catch (error) {
                                    console.error("Error saving employee changes:", error);
                                    alert("Failed to save employee changes: " + error.message);
                                }
                            }
                        });
                    });

                    // --- Remove Employee Logic ---
                    document.getElementById("remove-employee-btn").addEventListener("click", () => {
                        const employeeId = removeEmployeeSelect.value;
                        const isSpecial = removeSpecialEmployeeCheckbox.checked;
                        const branch = removeEmployeeBranchDropdown.value;
                        const subdivision = removeEmployeeSubdivisionDropdown.value;

                        if (!employeeId) {
                            alert("Please select an employee to remove.");
                            return;
                        }

                        if (!isSpecial && (!branch || !subdivision)) {
                            alert("Please select Branch and Subdivision for regular employees.");
                            return;
                        }

                        showModal(`Are you sure you want to remove this employee? This action cannot be undone.`, async (confirm) => {
                            if (confirm) {
                                try {
                                    let employeeRef;
                                    if (isSpecial) {
                                        employeeRef = db.ref(`specialEmployees/${employeeId}`);
                                    } else {
                                        employeeRef = db.ref(`branches/${branch}/subdivisions/${subdivision}/employees/${employeeId}`);
                                    }

                                    await employeeRef.remove();
                                    alert("Employee removed successfully!");

                                    // Clear form and reset dropdowns
                                    removeEmployeeSelect.innerHTML = `<option value="">Select Employee</option>`;
                                    removeEmployeeSelect.disabled = true;
                                    removeSpecialEmployeeCheckbox.checked = false;
                                    removeBranchSubContainer.classList.remove('hidden');
                                    removeEmployeeBranchDropdown.value = "";
                                    removeEmployeeSubdivisionDropdown.value = "";
                                    removeEmployeeSubdivisionDropdown.disabled = true;

                                    // Re-populate dropdowns
                                    populateBranchDropdowns(editEmployeeBranchDropdown);
                                    populateBranchDropdowns(removeEmployeeBranchDropdown);
                                } catch (error) {
                                    console.error("Error removing employee:", error);
                                    alert("Failed to remove employee: " + error.message);
                                }
                            }
                        });
                    });



                    // --- Activity Logs Tab Logic ---
                    const logFromDateInput = document.getElementById("log-from-date");
                    const logToDateInput = document.getElementById("log-to-date");
                    const logUserFilterDropdown = document.getElementById("log-user-filter");
                    const loadLogsBtn = document.getElementById("load-logs-btn");
                    const logsTableBody = document.getElementById("logs-table-body");

                    let uidToRoleMap = {}; // Map UID to Role
                    let uidToNameMap = {}; // Map UID to Name
                    let nameToUidMap = {}; // Map Name to UID

                    // Function to populate user filter dropdown
                    async function populateUserFilter() {
                        logUserFilterDropdown.innerHTML = `<option value="All">All Users</option>`;
                        uidToRoleMap = {};
                        uidToNameMap = {};
                        nameToUidMap = {};

                        try {
                            const usersSnap = await db.ref("users").once('value');
                            const usersObj = usersSnap.val() || {};
                            Object.entries(usersObj).forEach(([uid, userData]) => {
                                if (userData.name && userData.role) {
                                    logUserFilterDropdown.innerHTML += `<option value="${userData.name}">${userData.name}</option>`;
                                    uidToRoleMap[uid] = userData.role;
                                    uidToNameMap[uid] = userData.name;
                                    nameToUidMap[userData.name] = uid;
                                }
                            });
                        } catch (error) {
                            console.error("Error populating user filter:", error);
                        }
                    }

                    loadLogsBtn.addEventListener("click", async () => {
                        const fromDateStr = logFromDateInput.value;
                        const toDateStr = logToDateInput.value;
                        const filterByUser = logUserFilterDropdown.value;

                        logsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Loading logs...</td></tr>';
                        currentDisplayedLogs = []; // Clear for new export

                        if (!fromDateStr || !toDateStr) {
                            alert("Please select both 'From Date' and 'To Date' for activity logs.");
                            logsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Select filters and click "Load Logs" to view activity.</td></tr>';
                            return;
                        }

                        const fromDate = new Date(fromDateStr);
                        const toDate = new Date(toDateStr);
                        toDate.setDate(toDate.getDate() + 1); // Include the end date

                        if (fromDate > toDate) {
                            alert("From date cannot be after To date.");
                            logsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Select filters and click "Load Logs" to view activity.</td></tr>';
                            return;
                        }

                        let logs = [];
                        try {
                            const logsRef = db.ref("activityLogs");
                            const logsSnap = await logsRef.orderByKey().startAt(fromDateStr).endAt(toDateStr).once("value");
                            const dailyLogs = logsSnap.val() || {};

                            for (const dateKey in dailyLogs) {
                                const dayLogs = dailyLogs[dateKey];
                                for (const logId in dayLogs) {
                                    const log = dayLogs[logId];
                                    // Filter by selected user name
                                    if (filterByUser !== "All" && log.by !== filterByUser) {
                                        continue;
                                    }

                                    // Role-based filtering
                                    if (currentUserRole === 'Admin') {
                                        const performerUid = nameToUidMap[log.by]; // Get UID from name
                                        if (performerUid && uidToRoleMap[performerUid] === 'Dev') {
                                            continue; // Admin cannot see Dev actions
                                        }
                                    }
                                    // Dev can see all, no filtering needed for Dev role

                                    logs.push(log);
                                }
                            }

                            // Sort logs by timestamp (newest first)
                            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                            // Limit to latest 100 logs
                            logs = logs.slice(0, 100);

                            currentDisplayedLogs = logs; // Store for export

                            if (logs.length === 0) {
                                logsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No activity logs found for the selected criteria.</td></tr>';
                                return;
                            }

                            let logHtml = '';
                            logs.forEach(log => {
                                const logDateTime = new Date(log.timestamp);
                                const logTimeFormatted = logDateTime.toLocaleDateString("en-IN", { day: '2-digit', month: 'short', year: 'numeric' }) + ", " + logDateTime.toLocaleTimeString("en-IN", { hour: '2-digit', minute: '2-digit', hour12: true });
                                const userAndBranch = `${log.by || 'N/A'} ${log.branch ? `(${log.branch})` : ''}`;
                                const changesContent = formatLogChanges(log); // Use new function for changes
                                const section = log.section || 'N/A';

                                logHtml += `
                                    <tr>
                                        <td class="border px-4 py-2">${logTimeFormatted}</td>
                                        <td class="border px-4 py-2">${userAndBranch}</td>
                                        <td class="border px-4 py-2">${log.action || 'N/A'}</td>
                                        <td class="border px-4 py-2">${section}</td>
                                        <td class="border px-4 py-2 text-left">${changesContent}</td>
                                    </tr>
                                `;
                            });
                            logsTableBody.innerHTML = logHtml;

                        } catch (error) {
                            console.error("Error loading activity logs:", error);
                            logsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-4">Failed to load logs: ${error.message}</td></tr>`;
                        }
                    });

                    // Function to format log details for the "Changes" column
                    function formatLogChanges(log) {
                        let details = "";
                        if (log.before || log.after) {
                            details += `<details><summary class="cursor-pointer text-blue-600 hover:underline">View Changes</summary><pre class="text-xs bg-gray-50 p-2 rounded overflow-auto max-h-40">`;
                            if (log.before) {
                                details += `<strong>Before:</strong>\n${JSON.stringify(log.before, null, 2)}\n`;
                            }
                            if (log.after) {
                                details += `<strong>After:</strong>\n${JSON.stringify(log.after, null, 2)}`;
                            }
                            details += `</pre></details>`;
                        } else if (log.details) {
                            details = log.details;
                        } else {
                            // Fallback for actions that might not have explicit before/after or details
                            switch (log.action) {
                                case "Attendance Saved":
                                    details = `For ${log.employeeName} (${log.employeeId}). Status: ${log.status}. Check-in: ${log.checkIn || 'N/A'}. Check-out: ${log.checkOut || 'N/A'}.`;
                                    if (log.lateBy) {
                                        details += ` Late by: ${log.lateBy}.`;
                                    }
                                    if (log.reason) {
                                        details += ` Reason: ${log.reason}.`;
                                    }
                                    break;
                                case "Employee Added":
                                    details = `Name: ${log.employeeName}. Phone: ${log.phone}. Email: ${log.email}. Special Employee: ${log.isSpecial ? 'Yes' : 'No'}. Branch: ${log.branch || 'N/A'}. Subdivision: ${log.subdivision || 'N/A'}.`;
                                    break;
                                case "Employee Updated":
                                    details = `Employee ID: ${log.employeeId}. New Name: ${log.newName}. New Phone: ${log.newPhone}. New Email: ${log.newEmail}. Was Special: ${log.wasSpecial ? 'Yes' : 'No'}. Now Special: ${log.isSpecial ? 'Yes' : 'No'}. New Branch: ${log.newBranch || 'N/A'}. New Subdivision: ${log.newSubdivision || 'N/A'}.`;
                                    break;
                                case "Employee Removed":
                                    details = `Employee ID: ${log.employeeId}. Name: ${log.employeeName}. Was Special: ${log.wasSpecial ? 'Yes' : 'No'}. Branch: ${log.branch || 'N/A'}. Subdivision: ${log.subdivision || 'N/A'}.`;
                                    break;
                                case "Leave Applied":
                                    details = `For ${log.employeeName} (${log.employeeId}). Dates: ${log.leaveDates.join(', ')}. Type: ${log.leaveType}. Reason: ${log.reason}.`;
                                    break;
                                case "Leave Status Updated":
                                    details = `For ${log.employeeName} (${log.employeeId}). Date: ${log.leaveDate}. Old Status: ${log.oldStatus}. New Status: ${log.newStatus}.`;
                                    break;
                                case "Check-in Location Updated":
                                    details = `For ${log.employeeName} (${log.employeeId}). New Location: ${log.newLocation}.`;
                                    break;
                                case "Password Reset":
                                    details = `For user: ${log.targetEmail}.`;
                                    break;
                                case "User Role Changed":
                                    details = `For user: ${log.targetEmail}. Old Role: ${log.oldRole}. New Role: ${log.newRole}.`;
                                    break;
                                case "Firebase Settings Updated":
                                    details = `Updated settings: ${JSON.stringify(log.updatedSettings)}.`;
                                    break;
                                default:
                                    // If no specific details or before/after, stringify the whole log for debugging
                                    details = `<details><summary class="cursor-pointer text-gray-500 hover:underline">View Raw Log</summary><pre class="text-xs bg-gray-50 p-2 rounded overflow-auto max-h-40">${JSON.stringify(log, null, 2)}</pre></details>`;
                            }
                        }
                        return details;
                    }


                    // --- Export Activity Logs to PDF ---
                    document.getElementById("export-logs-pdf").addEventListener("click", () => {
                        if (currentDisplayedLogs.length === 0) {
                            alert("No logs to export. Please load logs first.");
                            return;
                        }

                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('landscape'); // Use landscape for more width

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(14);
                        doc.text("Activity Logs Report", 14, 15);
                        doc.setFontSize(10);
                        doc.text(`From: ${logFromDateInput.value || 'N/A'} To: ${logToDateInput.value || 'N/A'}`, 14, 22);
                        doc.text(`Filtered By User: ${logUserFilterDropdown.value || 'All'}`, 14, 27);


                        const pdfHeaders = ["Time", "User (Name + Branch)", "Action", "Section", "Changes"];
                        const pdfBody = [];

                        currentDisplayedLogs.forEach(log => {
                            const logDateTime = new Date(log.timestamp);
                            const logTimeFormatted = logDateTime.toLocaleDateString("en-IN", { day: '2-digit', month: 'short', year: 'numeric' }) + ", " + logDateTime.toLocaleTimeString("en-IN", { hour: '2-digit', minute: '2-digit', hour12: true });
                            const userAndBranch = `${log.by || 'N/A'} ${log.branch ? `(${log.branch})` : ''}`;
                            // For PDF, simplify changes to avoid complex HTML rendering
                            let changesText = "";
                            if (log.before || log.after) {
                                changesText += "Before: " + (log.before ? JSON.stringify(log.before) : "N/A") + "\n";
                                changesText += "After: " + (log.after ? JSON.stringify(log.after) : "N/A");
                            } else if (log.details) {
                                changesText = log.details;
                            } else {
                                changesText = "No specific changes recorded.";
                            }

                            pdfBody.push([logTimeFormatted, userAndBranch, log.action || 'N/A', log.section || 'N/A', changesText]);
                        });

                        doc.autoTable({
                            head: [pdfHeaders],
                            body: pdfBody,
                            startY: 35,
                            theme: "striped",
                            styles: {
                                fontSize: 8,
                                halign: "left", // Align text left for better readability in Changes column
                                cellWidth: "wrap"
                            },
                            columnStyles: {
                                0: { cellWidth: 30 }, // Time
                                1: { cellWidth: 35 }, // User
                                2: { cellWidth: 35 }, // Action
                                3: { cellWidth: 30 }, // Section
                                4: { cellWidth: 90 }  // Changes (increased width)
                            },
                            headStyles: {
                                fillColor: [0, 102, 204],
                                textColor: 255,
                                fontStyle: "bold",
                            },
                            alternateRowStyles: {
                                fillColor: [245, 245, 245],
                            },
                            margin: { top: 30 }
                        });

                        doc.save("Activity_Logs_Report.pdf");
                    });

                    // --- Export Activity Logs to Excel ---
                    document.getElementById("export-logs-excel").addEventListener("click", () => {
                        if (currentDisplayedLogs.length === 0) {
                            alert("No logs to export. Please load logs first.");
                            return;
                        }

                        const ws_data = [
                            ["Activity Logs Report"],
                            [`From: ${logFromDateInput.value || 'N/A'} To: ${logToDateInput.value || 'N/A'}`],
                            [`Filtered By User: ${logUserFilterDropdown.value || 'All'}`],
                            [], // Empty row for spacing
                            ["Time", "User (Name + Branch)", "Action", "Section", "Changes"] // Headers
                        ];

                        currentDisplayedLogs.forEach(log => {
                            const logDateTime = new Date(log.timestamp);
                            const logTimeFormatted = logDateTime.toLocaleDateString("en-IN", { day: '2-digit', month: 'short', year: 'numeric' }) + ", " + logDateTime.toLocaleTimeString("en-IN", { hour: '2-digit', minute: '2-digit', hour12: true });
                            const userAndBranch = `${log.by || 'N/A'} ${log.branch ? `(${log.branch})` : ''}`;

                            // For Excel, flatten changes into a string
                            let changesText = "";
                            if (log.before || log.after) {
                                changesText += "Before: " + (log.before ? JSON.stringify(log.before) : "N/A") + "\n";
                                changesText += "After: " + (log.after ? JSON.stringify(log.after) : "N/A");
                            } else if (log.details) {
                                changesText = log.details;
                            } else {
                                changesText = "No specific changes recorded.";
                            }
                            ws_data.push([logTimeFormatted, userAndBranch, log.action || 'N/A', log.section || 'N/A', changesText]);
                        });

                        const ws = XLSX.utils.aoa_to_sheet(ws_data);

                        // Set column widths
                        ws['!cols'] = [
                            { wch: 25 }, // Time
                            { wch: 25 }, // User (Name + Branch)
                            { wch: 20 }, // Action
                            { wch: 20 }, // Section
                            { wch: 60 }  // Changes
                        ];

                        // Apply bold to headers
                        const range = XLSX.utils.decode_range(ws['!ref']);
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cell = ws[XLSX.utils.encode_cell({ r: 4, c: C })]; // Assuming headers are on row 5 (index 4)
                            if (cell) {
                                cell.s = { font: { bold: true } };
                            }
                        }

                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "ActivityLogs");
                        XLSX.writeFile(wb, "Activity_Logs_Report.xlsx");
                    });

                });
            })
            .catch(error => console.error("Error loading header:", error));
    </script>
</body>

</html>
