<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AbsentEase | Diya Motors Attendance System</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #b0bbca;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #003366;
            color: white;
            padding: 10px 20px;
        }

        .logo-section {
            display: flex;
            align-items: inherit;
            gap: 11px;
            row-gap: 16px;
            column-gap: 10px;
        }

        .logo-img {
            height: 60px;
        }

        .app-name {
            font-size: 26px;
            font-weight: bold;
        }

        .clock-container {
            font-size: 18px;
            font-weight: bold;
        }

        .container {
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group select,
        .control-group button {
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .attendance-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }

        th {
            background-color: #003366;
            color: white;
        }

        .radio-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Styles for radio button appearance */
        .radio-group input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #333;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            position: relative;
        }

        .radio-group input[type="radio"]:checked {
            background-color: #007bff;
            border-color: #007bff;
        }

        .radio-group input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radio-group input[type="radio"]:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #eee;
        }

        .radio-group input[type="radio"]:disabled:checked {
            background-color: #a0a0a0;
            border-color: #a0a0a0;
        }


        .summary-section {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .summary-item {
            background-color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-count {
            font-size: 24px;
            font-weight: bold;
        }

        .count-full {
            color: green;
        }

        .count-half {
            color: orange;
        }

        .count-absent {
            color: red;
        }

        .count-late {
            color: #ff3300;
        }

        .save-section {
            text-align: center;
            margin-top: 20px;
        }

        .save-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: green;
            color: white;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .save-btn:disabled {
            background-color: gray;
            cursor: not-allowed;
        }

        .status-badge {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .status-full {
            background-color: #28a745;
            color: white;
        }

        .status-half {
            background-color: #ffc107;
            color: black;
        }

        .status-absent {
            background-color: #dc3545;
            color: white;
        }

        .late-indicator {
            color: red;
            font-weight: bold;
        }

        input[type="checkbox"]:disabled {
            background-color: #0052f5 !important;
            border: 1px solid #f70a0aad;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        #user-badge {
            border-radius: 8px;
            padding: 8px 12px;
            color: hsl(0, 86%, 39%);
            font-family: "Segoe UI", sans-serif;
            font-size: 13px;
            line-height: 1.4;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            min-width: 150px;
        }

        #user-name {
            font-weight: 600;
            font-size: 14px;
            color: #03feedd1;
        }

        #branch-info {
            font-size: 12px;
            color: #ffffff;
        }

        .user-badge-dev {
            background-color: #6f42c1;
            border-left: 4px solid #6f42c1;
        }

        .user-badge-admin {
            background-color: #31d8ae;
            border-left: 4px solid #010d18;
        }

        .user-badge-branch {
            background-color: #28a745;
            border-left: 4px solid #2e7d32;
        }

        .top-bar-dev {
            background-color: #5e35b1;
        }

        .top-bar-admin {
            background-color: #3f0e0e00;
        }

        .top-bar-branch {
            background-color: #2e7d32;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            color: #333;
        }

        .btn:hover {
            background-color: #e9e9e9;
        }

        #admin-panel-btn {
            background-color: #374785;
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        #admin-panel-btn:hover {
            background-color: #2c3769;
        }

        #logout-btn {
            border-color: #d9534f;
            background-color: #f8d7da;
            color: #a94442;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4.5px 20px;
            background-color: #e1e1e1;
            color: #333;
            font-family: 'Segoe UI', sans-serif;
            border-bottom: 1px solid #000000;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        .logo img {
            height: 55px;
        }

        #save-btn {
            background-color: #d32f2f;
            color: #fff;
            padding: 8px 18px;
            border: none;
            font-weight: 600;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        #save-btn:hover {
            background-color: #b71c1c;
        }

        .user-badge {
            width: auto;
            max-width: 10%;
            white-space: nowrap;
            padding: 10px 14px;
            border-radius: 8px;
            background-color: #000000;
            color: #333;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(10, 218, 55, 0.06);
            border-left: 4px solid transparent;
        }
    </style>
</head>

<body>
    <div id="header-container"></div>

    <div class="container">
        <div class="controls" id="controls-section" style="display: none;">
            <div class="control-group">
                <label for="branch-select">Branch</label>
                <select id="branch-select">
                    <option value="">Select Branch</option>
                </select>
            </div>

            <div class="control-group">
                <label for="subdivision-select">Sub-division</label>
                <select id="subdivision-select" disabled>
                    <option value="">Select Sub-division</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <button id="load-btn" class="btn" style="background-color: #007bff; color: white;">Load
                    Employees</button>
            </div>
        </div>
        <div class="attendance-table-container">
            <table>
                <thead>
                    <tr>
                        <th>Employee Name</th>
                        <th>Morning ‚úÖ</th>
                        <th>Afternoon Status</th>
                        <th>Status</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="attendance-table-body">
                </tbody>
            </table>
        </div>
        <div class="summary-section">
            <div class="summary-item">
                <div class="summary-count count-full" id="full-day-count">0</div>
                <div class="summary-label">Full Day</div>
            </div>
            <div class="summary-item">
                <div class="summary-count count-half" id="half-day-count">0</div>
                <div class="summary-label">Half Day</div>
            </div>
            <div class="summary-item">
                <div class="summary-count count-absent" id="absent-count">0</div>
                <div class="summary-label">Absent</div>
            </div>
            <div class="summary-item">
                <div class="summary-count count-late" id="late-count">0</div>
                <div class="summary-label">Late Arrivals</div>
            </div>
        </div>

        <div class="save-section">
            <button id="save-btn" class="btn btn-success save-btn">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z" />
                </svg>
                Save
            </button>
        </div>


    </div>
    <script>
        // ‚úÖ Firebase Configuration and Initialization
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBU3K7gRzqiqQt3o9thoEpd06ReLGVmm_w",
            authDomain: "diya-hero.firebaseapp.com",
            databaseURL: "https://diya-hero-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "diya-hero",
            storageBucket: "diya-hero.firebasestorage.app",
            messagingSenderId: "455829653263",
            appId: "1:455829653263:web:5a31c65bdab2b9cee0607a",
            measurementId: "G-DZYHPLQD3F"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ‚úÖ Global Test Mode Controller
        let testMode = false;
        let testNow = null;

        // ‚úÖ Safe Time Getter: Returns real time or fake time based on testMode
        function getNow() {
            if (testMode && testNow instanceof Date) {
                return new Date(testNow);
            }
            return new Date();
        }

        // ‚úÖ Clock Updater: Updates the live clock display in the header
        function updateClock() {
            const now = getNow();
            const hoursRaw = now.getHours();
            const hours = hoursRaw % 12 || 12;
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const ampm = hoursRaw >= 12 ? 'PM' : 'AM';

            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();

            const fullClock = `${hours}:${minutes}:${seconds} ${ampm} | ${day}-${month}-${year}`;

            const clockEl = document.getElementById('live-clock');
            if (clockEl) {
                clockEl.textContent = fullClock;
            }
        }

        // ‚úÖ Detect and mark LATE entries
        function isLateNow() {
            const now = getNow();
            const h = now.getHours();
            const m = now.getMinutes();
            // Assuming late after 9:35 AM
            return h > 9 || (h === 9 && m >= 36);
        }

        // Capitalize utility
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ‚úÖ Calculate Full / Half / Absent status
        function calculateStatus(data) {
            const now = getNow();
            const h = now.getHours();
            const m = now.getMinutes();
            const after3PM = h > 15 || (h === 15 && m >= 0); // After 3:00 PM

            const morning = data.morning;
            const an = data.afternoon || 'None';

            // Use saved AN time if available, otherwise current time
            const anHour = data.anTime ? parseInt(data.anTime.split(':')[0]) : h;
            const anMin = data.anTime ? parseInt(data.anTime.split(':')[1]) : m;
            const anAfter3 = anHour > 15 || (anHour === 15 && anMin >= 0);

            if (morning) {
                if (an === 'Leaves') {
                    return anAfter3
                        ? { type: 'full', text: `Full Day${data.late ? ' (Late)' : ''}` }
                        : { type: 'half', text: `Half Day${data.late ? ' (Late)' : ''}` };
                }
                if (an === 'None') {
                    return after3PM
                        ? { type: 'half', text: `Half Day${data.late ? ' (Late)' : ''}` }
                        : { type: 'pending', text: 'Pending' };
                }
            } else {
                if (an === 'Enters') {
                    return { type: 'half', text: 'Half Day' };
                }
                if (an === 'None') {
                    return after3PM
                        ? { type: 'absent', text: 'Absent' }
                        : { type: 'pending', text: 'Pending' };
                }
            }

            return { type: 'pending', text: 'Pending' }; // fallback
        }

        // ‚úÖ Summary Section Count Update
        function updateSummary() {
            let full = 0, half = 0, absent = 0, late = 0;

            Object.keys(attendanceData).forEach(id => {
                const data = attendanceData[id];
                const result = calculateStatus(data);

                if (result.type === 'full') full++;
                else if (result.type === 'half') half++;
                else if (result.type === 'absent') absent++;

                if (data.late) late++;
            });

            fullDayCount.textContent = full;
            halfDayCount.textContent = half;
            absentCount.textContent = absent;
            lateCount.textContent = late;
        }

        // ‚úÖ Render dynamic attendance table with all logic applied
        function renderAttendanceTable() {
            tableBody.innerHTML = '';

            const nowTime = getNow(); // ‚úÖ Get time only once
            const after12PM = nowTime.getHours() > 12 || (nowTime.getHours() === 12 && nowTime.getMinutes() >= 0); // After 12:00 PM

            employees.forEach(emp => {
                const row = document.createElement('tr');
                const data = attendanceData[emp.id];

                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = emp.name;

                // Morning checkbox
                const morningCell = document.createElement('td');
                const morningCheckbox = document.createElement('input');
                morningCheckbox.type = 'checkbox';
                morningCheckbox.id = `morning-check-${emp.id}`; // Unique ID
                morningCheckbox.checked = data.morning;
                // Disable if already locked or after 12 PM
                const isDevOrAdmin = userRole === 'Dev' || userRole === 'Admin';
                morningCheckbox.disabled = !isDevOrAdmin && (data.morningLocked || after12PM);


                morningCheckbox.addEventListener('change', () => {
                    data.morning = morningCheckbox.checked;
                    data.late = data.morning && isLateNow(); // update late flag
                    renderAttendanceTable(); // Re-render to update UI for late/status
                });

                morningCheckbox.className = 'morning-check';
                morningCheckbox.setAttribute("data-id", emp.id);
                morningCell.appendChild(morningCheckbox);

                // AN radio buttons
                const anCell = document.createElement('td');
                const anGroup = document.createElement('div');
                anGroup.className = 'radio-group';

                if (!data.afternoon || !['Enters', 'Leaves', 'None'].includes(data.afternoon)) {
                    data.afternoon = 'None';
                }
                ['Enters', 'Leaves', 'None'].forEach(status => {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `an-status-${emp.id}`; // Unique name for each employee's radio group
                    radio.id = `an-${emp.id}-${status}`; // Unique ID for each radio button
                    radio.value = status;
                    radio.checked = data.afternoon === status;

                    // ‚úÖ Disable only if explicitly locked (saved)
                    const isLocked = data.anLocked === true;
                    const isDevOrAdmin = userRole === 'Dev' || userRole === 'Admin';

                    if (!isDevOrAdmin && isLocked) {
                        radio.disabled = true;
                    }
                    else {
                        // ‚è± Time-based rules apply only if not locked
                        if (!isDevOrAdmin && !after12PM) {
                            radio.disabled = true;
                            radio.addEventListener('click', () => {
                                alert("Afternoon attendance can be marked only after 12 PM.");
                            });
                        }
                        else {
                            if (!isDevOrAdmin && data.morning && status === 'Enters') {
                                radio.disabled = true;
                                radio.addEventListener('click', () => {
                                    alert("Already present since morning. AN Joining not applicable.");
                                });
                            }
                            else if (!isDevOrAdmin && !data.morning && status === 'Leaves') {
                                radio.disabled = true;
                                radio.addEventListener('click', () => {
                                    alert("No Morning attendance. AN Leaving not allowed.");
                                });
                            }

                        }
                    }

                    radio.addEventListener('change', () => {
                        data.afternoon = status;
                        renderAttendanceTable(); // Re-render to update UI
                    });

                    const label = document.createElement('label');
                    label.htmlFor = `an-${emp.id}-${status}`; // Link label to input
                    label.appendChild(radio);
                    label.appendChild(document.createTextNode(" " + status));
                    anGroup.appendChild(label);
                });

                anCell.appendChild(anGroup);

                // Attendance Status
                const statusCell = document.createElement('td');
                const badge = document.createElement('span');
                const status = calculateStatus(data);
                badge.className = `status-badge status-${status.type}`;
                badge.textContent = status.text;
                statusCell.appendChild(badge);

                // Remarks (Late Coming)
                const remarksCell = document.createElement('td');
                if (data.late) {
                    const lateRemark = document.createElement('div');
                    lateRemark.className = 'late-indicator';
                    lateRemark.textContent = 'LATE COMING';
                    remarksCell.appendChild(lateRemark);
                }

                // Append all cells
                row.appendChild(nameCell);
                row.appendChild(morningCell);
                row.appendChild(anCell);
                row.appendChild(statusCell);
                row.appendChild(remarksCell);
                tableBody.appendChild(row);
            });

            updateSummary(); // ‚úÖ Update summary after re-render
        }

        // ‚úÖ Load Employees from Firebase based on Branch + Sub-division
        function loadEmployees(branchArg = '', subdivisionArg = '') {
            const branch = branchArg || (branchSelect?.value || userBranch);
            const subdivision = subdivisionArg || (subdivisionSelect?.value || userSubdivision);

            if (!branch || !subdivision) {
                alert("‚ö†Ô∏è Please select both Branch and Sub-division.");
                return;
            }

            const empRef = db.ref(`branches/${branch}/subdivisions/${subdivision}/employees`);
            empRef.once("value")
                .then(snapshot => {
                    const empData = snapshot.val();
                    if (!empData) {
                        alert("‚ùå No employees found for the selected subdivision.");
                        tableBody.innerHTML = "";
                        return;
                    }

                    employees = Object.values(empData); // Format employee list and set global
                    attendanceData = {}; // Clear previous attendance data for new load

                    // Initialize attendanceData for each employee
                    employees.forEach(emp => {
                        attendanceData[emp.id] = {
                            morning: false,
                            afternoon: "None",
                            late: false,
                            morningLocked: false,
                            anLocked: false
                        };
                    });

                    renderAttendanceTable();

                    // Load today's attendance records if available
                    const today = getNow().toISOString().split('T')[0];
                    const savedRef = db.ref(`attendance/${today}/${branch}/${subdivision}`);

                    savedRef.once("value").then(snapshot => {
                        const savedData = snapshot.val();
                        if (savedData) {
                            Object.keys(savedData).forEach(empId => {
                                const saved = savedData[empId];
                                if (attendanceData[empId]) {
                                    attendanceData[empId].morning = saved.morning || false;
                                    attendanceData[empId].afternoon = saved.afternoon || "None";
                                    attendanceData[empId].late = saved.late || false;
                                    attendanceData[empId].morningLocked = saved.morningLocked === true;
                                    attendanceData[empId].anLocked = saved.anLocked === true;
                                }
                            });
                            renderAttendanceTable(); // Re-render with loaded data
                            saveBtn.textContent = 'Partial Attendance Loaded ‚úÖ';
                        }
                    });
                })
                .catch(err => {
                    alert("üö´ Failed to fetch employee data: " + err.message);
                });
        }

        // ‚úÖ Load Test Mode Settings from Firebase
        function loadTestSettings() {
            const settingsRef = firebase.database().ref("settings");
            settingsRef.once("value").then(snapshot => {
                const settings = snapshot.val();
                testMode = settings?.testMode === true;
                if (testMode && settings?.fakeTime) {
                    testNow = new Date(settings.fakeTime);
                    console.log("üß™ Test Mode Enabled:", testNow.toLocaleString());
                } else {
                    console.log("‚è±Ô∏è Real Time Mode");
                }
            }).catch(err => {
                console.warn("‚ö†Ô∏è Failed to load test settings:", err.message);
            });
        }


        // ‚úÖ DOM ELEMENT REFERENCES
        const branchSelect = document.getElementById('branch-select');
        const subdivisionSelect = document.getElementById('subdivision-select');
        const loadBtn = document.getElementById('load-btn');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const tableBody = document.getElementById('attendance-table-body');
        const fullDayCount = document.getElementById('full-day-count');
        const halfDayCount = document.getElementById('half-day-count');
        const absentCount = document.getElementById('absent-count');
        const lateCount = document.getElementById('late-count');
        const saveBtn = document.getElementById('save-btn');
        let currentUser = null;
        let userRole = '';
        let userBranch = '';
        let userSubdivision = '';
        let employees = [];
        let attendanceData = {};
        let triggeredByAutoSave = false;
        let autoSavedAfter3 = false;


        // ‚úÖ Initialize the App: Authenticates user, loads header, sets up UI based on role
        function initApp() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    db.ref("users/" + user.uid).once("value").then(snapshot => {
                        const userData = snapshot.val();
                        if (!userData) {
                            alert("User not found in database.");
                            window.location.href = "index.html"; // Redirect to login if user data not found
                            return;
                        }

                        // Load header.html content first
                        fetch("header.html")
                            .then(response => response.text())
                            .then(headerHtml => {
                                document.getElementById("header-container").innerHTML = headerHtml;

                                // Set user badge information in the header
                                const userNameDiv = document.getElementById("user-name");
                                const branchInfoDiv = document.getElementById("branch-info");
                                const topBar = document.getElementById("top-bar");

                                if (userNameDiv) userNameDiv.textContent = `${userData.name} (${userData.role})`;
                                if (branchInfoDiv) branchInfoDiv.textContent = userData.subdivision ? `${userData.branch} - ${userData.subdivision}` : userData.branch;

                                // Apply top bar styling based on role
                                topBar.classList.remove("top-bar-dev", "top-bar-admin", "top-bar-branch");
                                if (userData.role === "Dev") {
                                    topBar.classList.add("top-bar-dev");
                                } else if (userData.role === "Admin") {
                                    topBar.classList.add("top-bar-admin");
                                } else if (userData.role === "Branch") {
                                    topBar.classList.add("top-bar-branch");
                                }

                                // Header specific event listeners
                                const logButton = document.getElementById("logs-btn");
                                const activityLogs = document.getElementById("activity-logs");
                                if (logButton && activityLogs) {
                                    logButton.addEventListener("click", () => {
                                        activityLogs.classList.toggle("hidden");
                                        activityLogs.scrollIntoView({ behavior: "smooth" });
                                    });
                                }

                                const adminBtn = document.getElementById("admin-panel-btn");
                                if (adminBtn) {
                                    adminBtn.addEventListener("click", () => {
                                        if (!window.location.href.includes("admin")) {
                                            window.location.href = "admin.html";
                                        }
                                    });
                                }

                                const logoutBtnHeader = document.getElementById("logout-btn");
                                if (logoutBtnHeader) {
                                    logoutBtnHeader.addEventListener('click', () => {
                                        if (confirm("Are you sure you want to log out?")) {
                                            auth.signOut().then(() => {
                                                window.location.href = "index.html";
                                            }).catch(error => {
                                                alert("‚ùå Error during logout: " + error.message);
                                            });
                                        }
                                    });
                                }

                                // Now, proceed with home.html specific UI setup
                                currentUser = userData;
                                userRole = userData.role;
                                userBranch = userData.branch;
                                userSubdivision = userData.subdivision || '';

                                if (userRole === 'Admin' || userRole === 'Dev') {
                                    document.getElementById('controls-section').style.display = 'flex';
                                    if (adminBtn) adminBtn.style.display = 'inline-block'; // Ensure admin button is visible
                                    populateBranchDropdown();
                                } else {
                                    document.getElementById('controls-section').style.display = 'none';
                                    branchSelect.value = userBranch; // Pre-select user's branch
                                    subdivisionSelect.innerHTML = `<option value="${userSubdivision}">${userSubdivision}</option>`; // Pre-select user's subdivision
                                    loadEmployees(userBranch, userSubdivision); // Load employees for the specific branch/sub
                                }
                            })
                            .catch(error => {
                                console.error("Error fetching header.html:", error);
                            });

                    }).catch(err => {
                        alert("Error fetching user data: " + err.message);
                        window.location.href = 'index.html';
                    });
                } else {
                    window.location.href = 'index.html'; // Redirect if no user
                }
            });
        }


        // ‚úÖ Populate Branch Dropdown on load for Admin/Dev
        function populateBranchDropdown() {
            const ref = db.ref("branches");
            ref.once("value").then(snapshot => {
                const branches = snapshot.val();
                branchSelect.innerHTML = `<option value="">Select Branch</option>`;
                for (let branch in branches) {
                    const opt = document.createElement("option");
                    opt.value = branch;
                    opt.textContent = capitalize(branch);
                    branchSelect.appendChild(opt);
                }
            });
        }

        // ‚úÖ Populate Sub-division Dropdown after Branch selected
        branchSelect.addEventListener('change', () => {
            const selectedBranch = branchSelect.value;

            subdivisionSelect.innerHTML = `<option value="">Select Sub-division</option>`;
            subdivisionSelect.disabled = true; // reset always

            if (!selectedBranch) return;

            db.ref(`branches/${selectedBranch}/subdivisions`).once("value").then(snapshot => {
                const subdivisions = snapshot.val();
                if (!subdivisions) {
                    alert("‚ö†Ô∏è No subdivisions found for selected branch.");
                    return;
                }

                for (let sub in subdivisions) {
                    const opt = document.createElement("option");
                    opt.value = sub;
                    opt.textContent = capitalize(sub);
                    subdivisionSelect.appendChild(opt);
                }

                subdivisionSelect.disabled = false; // ‚úÖ ENABLE after filling options
            }).catch(err => {
                alert("‚ùå Error loading subdivisions: " + err.message);
            });
        });

        // üì• Load Employees Button
        loadBtn.addEventListener("click", () => {
            loadEmployees();
        });


        // ‚úÖ Save Attendance to Firebase on button click
        saveBtn.addEventListener('click', (e) => {
            const isAuto = triggeredByAutoSave;
            triggeredByAutoSave = false; // Reset after use

            if (!isAuto) { // Only show confirmation for manual saves
                const confirmSave = confirm("Do you want to save today's attendance?");
                if (!confirmSave) return;
            }

            const branch = branchSelect?.value || userBranch;
            const subdivision = subdivisionSelect?.value || userSubdivision;

            if (!branch || !subdivision) {
                alert("‚ö†Ô∏è Please select both branch and sub-division.");
                return;
            }

            const today = getNow().toISOString().split('T')[0];
            const attendanceRef = db.ref(`attendance/${today}/${branch}/${subdivision}`);
            const leaveRef = db.ref(`leave-logs/${today}/${branch}/${subdivision}`);

            const attendancePayload = {};
            const leaveSummary = {};
            let saveCount = 0;

            for (let emp of employees) {
                const data = attendanceData[emp.id];
                const status = calculateStatus(data);

                // ‚úÖ Allow all rows, even pending, but continue only if morning or afternoon are touched
                if (
                    data.morning === false &&
                    (data.afternoon === undefined || data.afternoon === 'None')
                ) {
                    continue; // Skip rows with no interaction (neither morning checked nor afternoon status set)
                }

                // Leave calculation:
                // 0 = Full day present (Morning + No AN Leave)
                // 0.5 = Half day present (Morning + AN Leaves OR No Morning + AN Enters)
                // 1 = Absent (No Morning + No AN Enters/Leaves after 3PM or if manually marked)
                let leaveValue = 0;
                if (status.type === 'half') {
                    leaveValue = 0.5;
                } else if (status.type === 'absent') {
                    leaveValue = 1;
                }



                // Save payload
                const payload = {
                    name: emp.name,
                    morning: data.morning,
                    afternoon: data.afternoon || 'None',
                    late: data.late || false,
                    lateTime: data.late ? getNow().toLocaleTimeString("en-IN", { hour12: true }) : null,
                    morningTime: data.morning === true ? getNow().toLocaleTimeString("en-IN", { hour12: true }) : null,
                    anTime: (data.afternoon === 'Enters' || data.afternoon === 'Leaves') ? getNow().toLocaleTimeString("en-IN", { hour12: true }) : null,
                    leave: leaveValue,
                    morningLocked: data.morning === true,
                    anLocked: data.afternoon === 'Enters' || data.afternoon === 'Leaves',
                    timestamp: getNow().toISOString()
                };


                attendancePayload[emp.id] = payload;
                leaveSummary[emp.id] = leaveValue;

                // üîí Update local attendanceData to reflect locked state immediately
                attendanceData[emp.id].morningLocked = payload.morningLocked;
                attendanceData[emp.id].anLocked = payload.anLocked;

                saveCount++;
            }

            if (saveCount === 0) {
                if (!isAuto) {
                    alert("‚ö†Ô∏è No new entries to save.");
                }
                return;
            }

            attendanceRef.update(attendancePayload).then(() => {
                leaveRef.update(leaveSummary).then(() => {
                    renderAttendanceTable(); // Refresh table after save to show disabled states
                    if (!isAuto) { // Only show success message for manual saves
                        alert("‚úÖ Attendance saved successfully!");
                    } else {
                        saveBtn.textContent = 'Auto-Saved ‚úÖ';
                    }
                }).catch(err => {
                    alert("‚ùå Error saving leave data: " + err.message);
                });
            }).catch(err => {
                alert("‚ùå Error saving attendance: " + err.message);
            });
        });


        // ‚öôÔ∏è When DOM Ready ‚Üí Initialize App and load settings
        document.addEventListener('DOMContentLoaded', () => {
            loadTestSettings(); // Load test time first
            initApp(); // Authenticate and Setup UI
            // Set up a single interval for both clock update and auto-save logic
            setInterval(() => {
                if (testMode && testNow instanceof Date) {
                    testNow.setSeconds(testNow.getSeconds() + 1); // Simulate time ticking
                }
                updateClock(); // Update clock display

                // ‚úÖ Auto Save after 3 PM
                const now = getNow();
                const isAfter3PM = now.getHours() > 15 || (now.getHours() === 15 && now.getMinutes() >= 0);

                if (isAfter3PM && !autoSavedAfter3) {
                    const saveButtonElement = document.getElementById('save-btn');
                    if (saveButtonElement) {
                        // Check if there are any employees loaded and any attendance data has been interacted with
                        const hasEntriesToSave = employees.some(emp => {
                            const data = attendanceData[emp.id];
                            return data.morning || (data.afternoon && data.afternoon !== "None");
                        });

                        if (hasEntriesToSave) {
                            triggeredByAutoSave = true; // Mark auto-trigger
                            saveButtonElement.click(); // Trigger save button click
                            autoSavedAfter3 = true; // Prevent multiple auto-saves today
                            console.log("‚úÖ Auto-saved attendance at 3PM.");
                        } else {
                            autoSavedAfter3 = true; // Prevent re-checking if no data
                            console.log("‚è≠Ô∏è No data to save for auto-save. Skipped.");
                        }
                    }
                }
                // Re-render table if employees are loaded to update status/disabling based on time
                if (employees.length > 0) {
                    renderAttendanceTable();
                }
            }, 1000); // Tick every second for clock and auto-save check
        });
    </script>
</body>

</html>
